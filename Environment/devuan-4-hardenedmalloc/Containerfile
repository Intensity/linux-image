#!/usr/bin/env -vS podman build -t intensity/linux-image:devuan-4-hardenedmalloc . -f

FROM docker://devuan/devuan:stable AS devuan-4

RUN \
  packages_devuan_xen=" \
    xen-hypervisor-common \
    xen-system-amd64 \
    xen-tools \
    xenstore-utils \
  " && \
  packages_devuan_base=" \
    acl \
    age \
    amd64-microcode \
    apt-transport-https \
    arptables \
    attr \
    auditd \
    bash-completion \
    bash-static \
    bc \
    bcache-tools \
    bcachefs-tools \
    bindfs \
    binutils \
    blktool \
    bridge-utils \
    brotli \
    bsdiff \
    btrfs-progs \
    bubblewrap \
    buffer \
    busybox-static \
    bzip2 \
    ca-certificates \
    care \
    catatonit \
    ccrypt \
    cdebootstrap-static \
    cgroup-tools \
    cgroupfs-mount \
    chromium-sandbox \
    chrootuid \
    chrpath \
    conmon \
    containernetworking-plugins \
    containers-storage \
    cpio \
    crun \
    cryptmount \
    cryptsetup \
    cryptsetup-bin \
    cu \
    curl \
    daemon \
    daemonize \
    daemontools \
    dar-static \
    datefudge \
    dateutils \
    dc \
    detachtty \
    dmraid \
    dmsetup \
    dnscrypt-proxy \
    dnsmasq \
    dnsmasq-utils \
    dnsproxy \
    dosfstools \
    dropbear \
    dropbear-bin \
    dtach \
    e2fsck-static \
    e2tools \
    ebtables \
    ecdsautils \
    ed \
    encfs \
    ethtool \
    eudev \
    exfat-fuse \
    exfat-utils \
    ext3grep \
    ext4magic \
    extlinux \
    extundelete \
    f2fs-tools \
    fake-hwclock \
    fakechroot \
    fakeroot \
    fakeroot-ng \
    faketime \
    fdisk \
    file \
    firehol \
    firehol-common \
    firehol-tools \
    firejail \
    firejail-profiles \
    fireqos \
    fping \
    fscrypt \
    fuse-overlayfs \
    fuse2fs \
    fuse3 \
    fuseext2 \
    fusefat \
    fuseiso \
    gawk \
    gdisk \
    genisoimage \
    gfsecret \
    git-crypt \
    git-lfs \
    git-secrets \
    gnupg1 \
    gnupg1-l10n \
    gocryptfs \
    golang-github-containers-common \
    golang-github-containers-image \
    gostsum \
    gpart \
    gpgv-static \
    gpgv1 \
    gzrt \
    hashdeep \
    haveged \
    hdparm \
    ifenslave \
    ifupdown \
    ifupdown-extra \
    imvirt \
    imvirt-helper \
    inetutils-tools \
    inetutils-traceroute \
    initscripts \
    intel-microcode \
    iproute2 \
    ipset \
    iptables \
    iputils-arping \
    iputils-ping \
    iputils-tracepath \
    isc-dhcp-client \
    isc-dhcp-common \
    jfsutils \
    jitterentropy-rngd \
    jq \
    klibc-utils \
    kmod \
    kpartx \
    less \
    libarchive-tools \
    lockfile-progs \
    lrzip \
    lshw \
    lsof \
    lsscsi \
    ltrace \
    luksmeta \
    lvm2 \
    lxc \
    lxc-templates \
    lxcfs \
    lxctl \
    lynx \
    lz4 \
    lzip \
    lziprecover \
    lzop \
    makefs \
    makepatch \
    man-db \
    mandoc \
    manpages \
    manpages-dev \
    mbuffer \
    mdadm \
    mergerfs \
    metastore \
    moreutils \
    net-tools \
    netbase \
    netcat-openbsd \
    nettle-bin \
    nftables \
    nilfs-tools \
    ntpdate \
    ntpstat \
    nvme-cli \
    openssl \
    par2 \
    parchive \
    parted \
    patch \
    patchutils \
    pax \
    paxctl \
    pciutils \
    pinentry-curses \
    pinentry-tty \
    procinfo \
    procps \
    proot \
    psmisc \
    psutils \
    pv \
    qemu-utils \
    quota \
    quotatool \
    randomsound \
    rdate \
    rdiff \
    reiser4progs \
    reiserfsprogs \
    rfkill \
    rhash \
    ripgrep \
    rng-tools \
    rng-tools-debian \
    rootlesskit \
    rsync \
    rsyncrypto \
    runc \
    rush \
    sdparm \
    seccomp \
    seccure \
    securefs \
    sharutils \
    signify-openbsd \
    silversearcher-ag \
    slirp \
    slirp4netns \
    socat \
    squashfs-tools \
    squashfs-tools-ng \
    squashfuse \
    ssss \
    strace \
    syslinux \
    syslinux-common \
    syslinux-efi \
    syslinux-utils \
    sysstat \
    tar-scripts \
    tar-split \
    tardiff \
    tardy \
    tcpdump \
    tcpflow-nox \
    tcplay \
    tcptraceroute \
    time \
    tini \
    tinysshd \
    tmux \
    traceroute \
    tsocks \
    uanytun \
    ucspi-proxy \
    ucspi-tcp-ipv6 \
    ucspi-unix \
    udftools \
    udhcpc \
    uidmap \
    unionfs-fuse \
    unzip \
    usbutils \
    vim-tiny \
    vlan \
    vlock \
    vmfs6-tools \
    w3m \
    wget \
    wireguard-tools \
    xdelta \
    xdelta3 \
    xen-hypervisor-4.14-amd64 \
    xorriso \
    xxhash \
    xz-utils \
    zip \
    zpaq \
    zsh-autosuggestions \
    zsh-static \
    zsh-syntax-highlighting \
    zstd \
  " && \
  packages_idempotent=" \
    adduser \
    apt \
    base-files \
    base-passwd \
    bash \
    bsdutils \
    coreutils \
    dash \
    debconf \
    debian-archive-keyring \
    debianutils \
    devuan-keyring \
    diffutils \
    dpkg \
    e2fsprogs \
    findutils \
    gcc-10-base \
    gcc-9-base \
    gpgv \
    grep \
    gzip \
    hostname \
    init-system-helpers \
    libacl1 \
    libapt-pkg6.0 \
    libattr1 \
    libaudit-common \
    libaudit1 \
    libblkid1 \
    libbz2-1.0 \
    libc-bin \
    libc6 \
    libcap-ng0 \
    libcom-err2 \
    libcrypt1 \
    libdb5.3 \
    libdebconfclient0 \
    libeudev1 \
    libext2fs2 \
    libffi7 \
    libgcc-s1 \
    libgcrypt20 \
    libgmp10 \
    libgnutls30 \
    libgpg-error0 \
    libgssapi-krb5-2 \
    libhogweed6 \
    libidn2-0 \
    libk5crypto3 \
    libkeyutils1 \
    libkrb5-3 \
    libkrb5support0 \
    liblz4-1 \
    liblzma5 \
    libmount1 \
    libnettle8 \
    libnsl2 \
    libp11-kit0 \
    libpam-modules \
    libpam-modules-bin \
    libpam-runtime \
    libpam0g \
    libpcre2-8-0 \
    libpcre3 \
    libseccomp2 \
    libselinux1 \
    libsemanage-common \
    libsemanage1 \
    libsepol1 \
    libsmartcols1 \
    libss2 \
    libssl1.1 \
    libstdc++6 \
    libtasn1-6 \
    libtinfo6 \
    libtirpc-common \
    libtirpc3 \
    libunistring2 \
    libuuid1 \
    libxxhash0 \
    libzstd1 \
    login \
    logsave \
    lsb-base \
    mawk \
    mount \
    ncurses-base \
    ncurses-bin \
    passwd \
    perl-base \
    sed \
    sysvinit-utils \
    tar \
    tzdata \
    util-linux \
    zlib1g \
  " && \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin && \
  set -x && \
  set -e && \
  umask 077 && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  cd /root && \
  export LANG=C && \
  export TMP=/tmp && \
  export TEMP="${TMP}" && \
  export TMPDIR="${TMP}" && \
  for insistence in Suggests Recommends; do echo APT::Install-"${insistence}" '"0";' | tee -a /etc/apt/apt.conf.d/42disable; done && \
  chmod --verbose go+r /etc/apt/apt.conf.d/42disable && \
  (for src in "" "-src"; do for repo in "" "-updates" "-security" "-backports"; do echo deb"${src}" http://deb.devuan.org/merged chimaera"${repo}" main contrib non-free; done; done) > /etc/apt/sources.list && \
  export DEBIAN_FRONTEND=noninteractive && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  export PYTHONDONTWRITEBYTECODE=1 && \
  exec </dev/null && \
  chmod --verbose go-w /etc /etc/apt /etc/apt/apt.conf.d /etc/dpkg /etc/dpkg/dpkg.cfg.d /usr /usr/sbin && \
  chmod --verbose go-w /etc/apt/apt.conf.d/docker-autoremove-suggests /etc/apt/apt.conf.d/docker-clean /etc/apt/apt.conf.d/docker-gzip-indexes /etc/apt/apt.conf.d/docker-no-languages /etc/dpkg/dpkg.cfg.d/docker-apt-speedup /usr/sbin/policy-rc.d && \
  apt-get -y update && \
  apt-get -y --verbose-versions dist-upgrade && \
  apt-get -y --verbose-versions install ${packages_idempotent} && \
  apt-get -y --verbose-versions install memtest86 memtest86+ && \
  (set +e; apt-get -y --verbose-versions install makedev || true; : > /var/lib/dpkg/info/makedev.postinst; apt-get -y -f install || true; true) && \
  (set +e; mkdir -v -p /var/lock/schroot || true; apt-get -y --verbose-versions install schroot schroot-common || true; : > /var/lib/dpkg/info/schroot.postinst; apt-get -y -f install || true; true) && \
  (set +e; mkdir -v -p /run/initctl || true; apt-get -y --verbose-versions install sysvinit-core || true; sed -i -e "/^restart=yes/s,restart=yes,restart=no," /var/lib/dpkg/info/sysvinit-core.postinst || true; apt-get -y -f install || true; rmdir /run/initctl || true; true) && \
  apt-get -y --verbose-versions install makedev sysvinit-core schroot schroot-common && \
  apt-get -y --verbose-versions install ${packages_devuan_base} && \
  mkdir -v ephemeral && \
  cd ephemeral && \
  apt-get download libgpgme11 && \
  package=$(ls -1d libgpgme11_*.deb) && \
  ar xv "${package}" && \
  cat control.tar.xz | xz -dvv | tar xpkvvf - && \
  sed -i -e "/^Depend/s/: gnupg[^,]*,/:/" control && \
  tar -c -v -f - control md5sums shlibs symbols triggers | xz -vv > control.tar.xz && \
  rm -v "${package}" && \
  ar rcv "${package}" debian-binary control.tar.xz data.tar.xz && \
  dpkg -i --force-all "${package}" && \
  unset package && \
  cd /root && \
  rm -rv ephemeral && \
  apt-get install -y --verbose-versions podman && \
  rm -v /etc/dropbear/dropbear_ecdsa_host_key /etc/dropbear/dropbear_ed25519_host_key /etc/dropbear/dropbear_rsa_host_key && \
  for i in auditd dnscrypt-proxy dnsmasq dnsproxy dropbear lvm2 lvm2-lvmpolld lxc lxc-net lxcfs mdadm rsync sysstat uanytun uuidd; do update-rc.d "${i}" disable && update-rc.d "${i}" remove; done && \
  apt-get -y --verbose-versions install ${packages_devuan_xen} && \
  for i in xendomains xen; do update-rc.d "${i}" disable && update-rc.d "${i}" remove; done && \
  sed -i -e "/^ENV_[SU]*PATH/s,PATH=.*,PATH=/sbin:/bin:/usr/sbin:/usr/bin," -e "/^UMASK/s,022,077," -e "/^LOG_OK_LOGINS/s,no,yes," /etc/login.defs && \
  sed -i -e '/PATH="/s,PATH="[^"]*",PATH="/sbin:/bin:/usr/sbin:/usr/bin",' /etc/profile && \
  sed -i -e '/export PATH=/s,PATH="[^"]*",PATH="/sbin:/bin:/usr/sbin:/usr/bin",' /etc/zsh/zshenv && \
  sed -i -e "s,^DSHELL=.*,DSHELL=/bin/bash-static," -e "s,^DIR_MODE=.*,DIR_MODE=0700," /etc/adduser.conf && \
  sed -i -e '/^if.*usr.lib.command-not-found.*usr.share.command-not-found.command-not-found/s,; then, \&\& false; then,' /etc/bash.bashrc && \
  mkdir -p -v /usr/local/src/attic && \
  chmod --verbose 700 /usr/local/src/attic && \
  mkdir -v /usr/local/src/attic/bin && \
  mkdir -p -v /usr/local/src/attic/usr/bin && \
  rm -v /bin/rbash && \
  ln -sv bash-static /bin/rbash && \
  ln -svf bash-static /bin/sh && \
  mv -v /bin/bash /usr/local/src/attic/bin/bash && \
  ln -sv bash-static /bin/bash && \
  for shell in zsh zsh5 zsh5-static; do mv -v /bin/"${shell}" /usr/local/src/attic/bin/"${shell}" && ln -sv zsh-static /bin/"${shell}"; done && \
  rm -rv /bin/rzsh && \
  ln -sv zsh-static /bin/rzsh && \
  mv -v /usr/bin/tini /usr/local/src/attic/usr/bin/tini && \
  ln -sv tini-static /usr/bin/tini && \
  mv -v /usr/bin/gpgv /usr/local/src/attic/usr/bin/gpgv && \
  ln -sv gpgv1 /usr/bin/gpgv && \
  rm -v /bin/mksh && \
  ln -sv mksh-static /bin/mksh && \
  rm -v /bin/rksh && \
  ln -sv mksh-static /bin/rksh && \
  rm -v /bin/rmksh && \
  ln -sv mksh-static /bin/rmksh && \
  cp -av /usr/bin/gpg1 /usr/bin/gpg && \
  for conf in /etc/bash.bashrc /etc/profile /etc/skel/.bashrc /etc/skel/.profile /root/.bashrc /root/.profile; do (echo umask 077; echo export PATH=/sbin:/bin:/usr/sbin:/usr/bin) | tee -a "${conf}"; done && \
  rm -v /etc/localtime && \
  /usr/bin/env --chdir=/etc ln -sv ../usr/share/zoneinfo/Universal ./localtime && \
  echo Universal > /etc/timezone && \
  chmod --verbose go+r /etc/timezone && \
  (for shell in /bin/bash /bin/bash-static /bin/zsh-static /usr/lib/klibc/bin/mksh /bin/sh /bin/dash /bin/rbash /bin/rzsh /bin/rksh /bin/rmksh /bin/rlksh /bin/lksh; do echo "${shell}"; done) >/etc/shells && \
  chsh --shell /bin/bash-static root && \
  sed -i -e "/^[2-6]:23:respawn:.sbin.getty [0-9][0-9]* tty[2-6]$/s/^/#/" -e "/^#T0:23:respawn:.sbin.getty -L ttyS0/s/^#//" /etc/inittab && \
  mkdir /etc/boot.d && \
  (echo '#!/bin/bash-static'; echo "if test -d /usr/local/etc/boot.d; then run-parts /usr/local/etc/boot.d; fi") >> /etc/boot.d/00local && \
  chmod u+rx /etc/boot.d/00local && \
  mkdir /usr/local/etc/boot.d && \
  (echo '#!/bin/bash-static'; echo "touch /root/local-done; sleep 3") >> /usr/local/etc/boot.d/00local && \
  (echo '#!/bin/bash-static'; echo "rm -v /init; sleep 3") >> /usr/local/etc/boot.d/04rminit && \
  chmod --verbose u+rx /usr/local/etc/boot.d/[0-9]* && \
  chmod --verbose go-rwx /usr/local/etc/boot.d/[0-9]* && \
  update-alternatives --set editor /usr/bin/vim.tiny && \
  find /usr/lib /usr/share -maxdepth 24 -name "*.pyc" -type f -ls -delete && \
  (set +e; find /usr/lib /usr/share -maxdepth 24 -name __pycache__ -type d -print | xargs rmdir -v -- || true; true) && \
  apt-get -y clean && \
  apt-get -y autoclean && \
  apt-get -y autoremove && \
  unset PYTHONDONTWRITEBYTECODE && \
  mkdir /stand && \
  chmod -v ugo+rx /stand && \
  /bin/busybox --list | while read fn; do ln /bin/busybox /stand/"${fn}"; done && \
  ln /usr/bin/dar_static /sbin/e2fsck.static /usr/bin/gpgv-static /bin/zsh-static /stand && \
  passwd --delete root && \
  rm -v /etc/group- /etc/gshadow- /etc/passwd- /etc/shadow- && \
  rm -v /var/cache/debconf/config.dat-old /var/cache/debconf/templates.dat-old /var/lib/dpkg/diversions-old /var/lib/dpkg/status-old && \
  rm -v /etc/.pwd.lock && \
  find /usr/share/doc /usr/share/info /usr/share/man -name \*.gz -type l -ls -delete && \
  find /usr/share/doc /usr/share/info /usr/share/man -name \*.gz -type f -exec gunzip -N -v -- \{\} \; && \
  rm -r -v /usr/share/man/[^m]*/ && \
  find /etc/alternatives -name \*.gz -type l -ls -delete && \
  rm -v /usr/share/man/man3/LIST_* && \
  : > /etc/issue && \
  : > /etc/issue.net && \
  : > /etc/motd && \
  : > /var/log/alternatives.log && \
  : > /var/log/dpkg.log && \
  : > /var/log/apt/term.log && \
  : > /var/log/apt/history.log && \
  : > /var/log/fontconfig.log && \
  : > /var/log/alternatives.log && \
  : |xz -vv > /var/log/apt/eipp.log.xz && \
  chmod --verbose -R go-rwx /etc/skel && \
  (echo umask 077; echo export PATH=/sbin:/bin:/usr/sbin:/usr/bin) | tee -a /etc/skel/.bashrc && \
  find /tmp /var/tmp -type f -ls -delete && \
  ( echo "# Example aliases" && \
    echo 'alias ered="env -i -- TMP=/dev/shm TEMP=/dev/shm TMPDIR=/dev/shm TERM=vt220 SHELL=/bin/false /bin/ed -E -r --"' && \
    echo 'alias eed="env -i -- TMP=/dev/shm TEMP=/dev/shm TMPDIR=/dev/shm TERM=vt220 SHELL=/bin/bash-static /bin/ed -E --"' && \
    echo 'alias eex="env -i -- TMP=/dev/shm TEMP=/dev/shm TMPDIR=/dev/shm TERM=vt220 SHELL=/bin/bash-static /usr/bin/vim.tiny -b -n -T vt220 -u /dev/null --noplugin -i /dev/null --clean -E -Z --not-a-term --"' && \
    echo 'alias evi="env -i -- TMP=/dev/shm TEMP=/dev/shm TMPDIR=/dev/shm TERM=vt220 SHELL=/bin/bash-static /usr/bin/vim.tiny -b -n -T vt220 -u /dev/null --noplugin -i /dev/null --clean --ttyfail --"') | tee -a /root/.bashrc /root/.profile && \
  chmod --verbose -R go-rwx /root && \
  chmod --verbose a-s /bin/fusermount /bin/mount /bin/ping /bin/ping6 /bin/su /bin/umount /sbin/unix_chkpwd /usr/bin/chage /usr/bin/chfn /usr/bin/chsh /usr/bin/cryptmount /usr/bin/dotlockfile /usr/bin/expiry /usr/bin/firejail /usr/bin/gpasswd /usr/bin/inetutils-traceroute /usr/bin/mail-lock /usr/bin/mail-touchlock /usr/bin/mail-unlock /usr/bin/newgidmap /usr/bin/newgrp /usr/bin/newuidmap /usr/bin/passwd /usr/bin/schroot /usr/bin/tcptraceroute.mt /usr/bin/wall /usr/bin/write.ul /usr/lib/chromium/chrome-sandbox /usr/lib/x86_64-linux-gnu/utempter/utempter /usr/libexec/lxc/lxc-user-nic /usr/sbin/rush /usr/sbin/vlock-main 2>&1 | tee -a /usr/local/etc/permissions && \
  chmod --verbose a-s /usr/bin/ssh-agent /usr/lib/openssh/ssh-keysign 2>&1 | tee -a /usr/local/etc/permissions && \
  chmod --verbose go-rwx /usr/local/etc/permissions && \
  (echo "#!/bin/bash-static"; echo 'for bin do perm=$(fgrep "mode of "\'\''"${bin}"\'\''" changed from " /usr/local/etc/permissions | head -n 1 | sed '\''s,^[^(]* changed from ,,'\'' |awk '\''{print $1}'\''|tr -cd 0-9 | head -c 4); if echo "${perm}" |grep -q "^[0-9][0-9][0-9][0-9]$"; then chmod --verbose "${perm}" "${bin}"; else echo Could not change permissions for "${bin}" 1>&2; exit 1; fi; done') > /usr/local/sbin/restore-permissions && \
  chmod --verbose 700 /usr/local/sbin/restore-permissions && \
  ln -sv /proc/mounts /etc/mtab && \
  touch /etc/init.d/.legacy-bootordering && \
  chmod --verbose o-w /run/screen /etc/hostname && \
  echo localhost > /etc/hostname && \
  find / -xdev -name "*.pyc" -ls && \
  find / -xdev -name "__pycache__" -ls && \
  find / -xdev -type f -perm -2000 -ls && \
  find / -xdev -type f -perm -4000 -ls && \
  find / -xdev -type f -perm -0002 -ls && \
  find / -xdev -type d -perm -0002 -ls && \
  true

FROM devuan-4 AS devuan-4-kicksecure

RUN \
  packages_kicksecure_dep=" \
    acpi-support \
    acpi-support-base \
    acpid \
    apparmor \
    apparmor-profiles \
    apparmor-profiles-extra \
    apparmor-utils \
    apt-transport-tor \
    apt-utils \
    autoconf \
    automake \
    autopoint \
    autotools-dev \
    bind9-dnsutils \
    codecrypt \
    console-common \
    console-data \
    console-setup \
    console-setup-linux \
    cpp \
    cpp-10 \
    cython3 \
    dbus \
    dbus-x11 \
    dconf-gsettings-backend \
    dconf-service \
    dctrl-tools \
    debhelper \
    debsums \
    dh-autoreconf \
    dh-strip-nondeterminism \
    dialog \
    diceware \
    dirmngr \
    distro-info-data \
    dkms \
    dnsutils \
    dpkg-dev \
    dwz \
    elogind \
    equivs \
    extrepo \
    fasttrack-archive-keyring \
    flatpak \
    fontconfig \
    fontconfig-config \
    fonts-dejavu-core \
    fonts-font-awesome \
    fonts-lato \
    gcc \
    gcc-10 \
    geoip-database \
    gettext \
    gettext-base \
    glib-networking \
    glib-networking-common \
    glib-networking-services \
    gnupg \
    gnupg-l10n \
    gnupg-utils \
    gpg \
    gpg-agent \
    gpg-wks-client \
    gpg-wks-server \
    gpgconf \
    gpgsm \
    gsettings-desktop-schemas \
    init \
    initramfs-tools \
    initramfs-tools-core \
    initscripts \
    inotify-tools \
    insserv \
    intltool-debian \
    iotop \
    iw \
    kbd \
    keyboard-configuration \
    libappstream-glib8 \
    libarchive-zip-perl \
    libasan6 \
    libatasmart4 \
    libatomic1 \
    libavahi-client3 \
    libavahi-common-data \
    libavahi-common3 \
    libavahi-glib1 \
    libblockdev-crypto2 \
    libblockdev-fs2 \
    libblockdev-loop2 \
    libblockdev-part-err2 \
    libblockdev-part2 \
    libblockdev-swap2 \
    libblockdev-utils2 \
    libblockdev2 \
    libbluetooth3 \
    libbytes-random-secure-perl \
    libc-dev-bin \
    libc-l10n \
    libc6-dev \
    libcc1-0 \
    libcrypt-dev \
    libcrypt-passwdmd5-perl \
    libcrypt-random-seed-perl \
    libcryptx-perl \
    libdconf1 \
    libdebhelper-perl \
    libdeflate0 \
    libdouble-conversion3 \
    libdpkg-perl \
    libdrm-amdgpu1 \
    libdrm-common \
    libdrm-intel1 \
    libdrm-nouveau2 \
    libdrm-radeon1 \
    libdrm2 \
    libegl-mesa0 \
    libegl1 \
    libelogind0 \
    libencode-locale-perl \
    libevdev2 \
    libfftw3-double3 \
    libfile-fnmatch-perl \
    libfile-listing-perl \
    libfile-stripnondeterminism-perl \
    libfontconfig1 \
    libfreetype6 \
    libgbm1 \
    libgcc-10-dev \
    libgdk-pixbuf-2.0-0 \
    libgdk-pixbuf2.0-common \
    libgeoip1 \
    libgl1 \
    libgl1-mesa-dri \
    libglapi-mesa \
    libglib2.0-bin \
    libglib2.0-data \
    libglvnd0 \
    libglx-mesa0 \
    libglx0 \
    libgpgme11 \
    libgraphite2-3 \
    libgudev-1.0-0 \
    libharfbuzz0b \
    libhtml-parser-perl \
    libhtml-tagset-perl \
    libhtml-tree-perl \
    libhttp-cookies-perl \
    libhttp-date-perl \
    libhttp-message-perl \
    libhttp-negotiate-perl \
    libice6 \
    libinotifytools0 \
    libinput-bin \
    libinput10 \
    libio-html-perl \
    libisl23 \
    libitm1 \
    libjbig0 \
    libjpeg62-turbo \
    libjs-jquery \
    libjs-sphinxdoc \
    libjs-underscore \
    libjson-glib-1.0-0 \
    libjson-glib-1.0-common \
    libksba8 \
    libllvm11 \
    liblocale-gettext-perl \
    liblsan0 \
    liblwp-mediatypes-perl \
    liblwp-protocol-https-perl \
    libmalcontent-0-0 \
    libmath-random-isaac-perl \
    libmd4c0 \
    libmm-glib0 \
    libmpc3 \
    libmpdec3 \
    libmtdev1 \
    libndp0 \
    libnet-http-perl \
    libnewt0.52 \
    libnl-route-3-200 \
    libnm0 \
    libnpth0 \
    libnsl-dev \
    libnspr4 \
    libnss3 \
    libntfs-3g883 \
    libostree-1-1 \
    libpam-elogind \
    libparted-fs-resize0 \
    libpciaccess0 \
    libpcre2-16-0 \
    libpcsclite1 \
    libpkcs11-helper1 \
    libpng16-16 \
    libpolkit-agent-1-0 \
    libpolkit-gobject-1-0 \
    libpolkit-gobject-elogind-1-0 \
    libproxy1v5 \
    libpython3-stdlib \
    libpython3.9-minimal \
    libpython3.9-stdlib \
    libqt5core5a \
    libqt5dbus5 \
    libqt5gui5 \
    libqt5network5 \
    libqt5widgets5 \
    libquadmath0 \
    libsecret-1-0 \
    libsecret-common \
    libslang2 \
    libsm6 \
    libsnappy1v5 \
    libsoup2.4-1 \
    libsqlite3-0 \
    libstemmer0d \
    libsub-override-perl \
    libsysfs2 \
    libteamdctl0 \
    libtiff5 \
    libtirpc-dev \
    libtool \
    libtry-tiny-perl \
    libtsan0 \
    libubsan1 \
    libudisks2-0 \
    liburi-perl \
    libvolume-key1 \
    libvulkan1 \
    libwacom-common \
    libwacom2 \
    libwayland-client0 \
    libwayland-server0 \
    libwebp6 \
    libwww-perl \
    libwww-robotrules-perl \
    libx11-6 \
    libx11-data \
    libx11-xcb1 \
    libxau6 \
    libxaw7 \
    libxcb-dri2-0 \
    libxcb-dri3-0 \
    libxcb-glx0 \
    libxcb-icccm4 \
    libxcb-image0 \
    libxcb-keysyms1 \
    libxcb-present0 \
    libxcb-randr0 \
    libxcb-render-util0 \
    libxcb-render0 \
    libxcb-shape0 \
    libxcb-shm0 \
    libxcb-sync1 \
    libxcb-util1 \
    libxcb-xfixes0 \
    libxcb-xinerama0 \
    libxcb-xinput0 \
    libxcb-xkb1 \
    libxcb1 \
    libxcursor1 \
    libxdamage1 \
    libxdmcp6 \
    libxext6 \
    libxfixes3 \
    libxi6 \
    libxkbcommon-x11-0 \
    libxkbcommon0 \
    libxmu6 \
    libxmuu1 \
    libxpm4 \
    libxrandr2 \
    libxrender1 \
    libxshmfence1 \
    libxt6 \
    libxxf86vm1 \
    libyaml-0-2 \
    libyaml-libyaml-perl \
    libz3-4 \
    libzulucrypt-exe1.2.0 \
    libzulucrypt-plugins \
    libzulucrypt1.2.0 \
    libzulucryptpluginmanager1.0.0 \
    linux-base \
    linux-compiler-gcc-10-x86 \
    linux-headers-5.10.0-21-amd64 \
    linux-headers-5.10.0-21-common \
    linux-headers-amd64 \
    linux-kbuild-5.10 \
    linux-libc-dev \
    live-boot \
    live-boot-initramfs-tools \
    live-tools \
    locales \
    lsb-release \
    m4 \
    magic-wormhole \
    make \
    makepasswd \
    media-types \
    menu \
    most \
    nano \
    network-manager \
    ntfs-3g \
    obfs4proxy \
    openvpn \
    p7zip \
    p7zip-full \
    po-debconf \
    policykit-1 \
    policyrcd-script-zg2 \
    pwgen \
    python3 \
    python3-apparmor \
    python3-attr \
    python3-autobahn \
    python3-automat \
    python3-bcrypt \
    python3-cbor \
    python3-certifi \
    python3-cffi-backend \
    python3-chardet \
    python3-click \
    python3-colorama \
    python3-constantly \
    python3-cryptography \
    python3-dateutil \
    python3-geoip \
    python3-hamcrest \
    python3-hkdf \
    python3-humanize \
    python3-hyperlink \
    python3-idna \
    python3-incremental \
    python3-libapparmor \
    python3-lz4 \
    python3-minimal \
    python3-nacl \
    python3-openssl \
    python3-pkg-resources \
    python3-pyasn1 \
    python3-pyasn1-modules \
    python3-pyqrcode \
    python3-requests \
    python3-scapy \
    python3-sdnotify \
    python3-service-identity \
    python3-six \
    python3-snappy \
    python3-socks \
    python3-spake2 \
    python3-stem \
    python3-tqdm \
    python3-trie \
    python3-twisted \
    python3-twisted-bin \
    python3-txaio \
    python3-txtorcon \
    python3-u-msgpack \
    python3-ubjson \
    python3-urllib3 \
    python3-wsaccel \
    python3-yaml \
    python3-zope.interface \
    python3.9 \
    python3.9-minimal \
    secure-delete \
    shared-mime-info \
    spectre-meltdown-checker \
    sphinx-rtd-theme-common \
    startpar \
    sudo \
    sysfsutils \
    sysv-rc \
    udisks2 \
    vrms \
    wpasupplicant \
    x11-common \
    x11-xserver-utils \
    xdg-dbus-proxy \
    xdg-utils \
    xkb-data \
    zulucrypt-cli \
  " && \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin && \
  set -x && \
  set -e && \
  umask 077 && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  cd /root && \
  export LANG=C && \
  export TMP=/tmp && \
  export TEMP="${TMP}" && \
  export TMPDIR="${TMP}" && \
  export DEBIAN_FRONTEND=noninteractive && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  export PYTHONDONTWRITEBYTECODE=1 && \
  exec </dev/null && \
  apt-get -y update && \
  apt-get -y --verbose-versions dist-upgrade && \
  apt-get -y --verbose-versions install ${packages_kicksecure_dep} && \
  curl --tlsv1.3 --proto =https --max-time 180 --output /usr/share/keyrings/derivative.asc https://www.kicksecure.com/keys/derivative.asc && \
  chmod --verbose go+r /usr/share/keyrings/derivative.asc && \
  adduser --disabled-password --gecos "" --force-badname --shell /bin/bash-static Administrator && \
  adduser --disabled-password --gecos "" --shell /bin/bash-static user && \
  adduser Administrator sudo && \
  addgroup --system console && \
  adduser Administrator console && \
  echo "deb [signed-by=/usr/share/keyrings/derivative.asc] https://deb.kicksecure.com bullseye main contrib non-free" | tee -a /etc/apt/sources.list.d/derivative.list && \
  chmod --verbose go+r /etc/apt/sources.list.d/derivative.list && \
  apt-get -y update && \
  apt-get -y --verbose-versions dist-upgrade && \
  apt-get -y --verbose-versions install apparmor-profiles-kicksecure debug-misc hardened-malloc kicksecure-base-files kicksecure-default-applications-cli kicksecure-dependencies-cli kicksecure-network-conf non-qubes-vm-enhancements-cli open-link-confirmation security-misc usability-misc && \
  mkdir -v ephemeral && \
  cd ephemeral && \
  apt-get download systemcheck && \
  package=$(ls -1d systemcheck_*_all.deb) && \
  ar xv "${package}" && \
  xz -dvv < control.tar.xz | tar -xpkvvf - && \
  sed -i -e "s/, systemd, /, /" control && \
  : > postinst && \
  : > postrm && \
  : > prerm && \
  tar -c -v -f - conffiles control md5sums postinst postrm preinst prerm |xz -vv > control.tar.xz && \
  rm -v "${package}" && \
  ar rcv "${package}" debian-binary control.tar.xz data.tar.xz && \
  dpkg -i --force-all "${package}" && \
  unset package && \
  cd /root && \
  rm -r -v ephemeral && \
  mkdir -v ephemeral && \
  cd ephemeral && \
  apt-get download libsystemd0 && \
  ar xv libsystemd*.deb && \
  xz -dvv < data.tar.xz |tar -x -vv -p -f - ./usr/lib/x86_64-linux-gnu && \
  tar -C ./usr/lib/ -c -v -f - x86_64-linux-gnu/ | tar -C /usr/lib/ -x -p -v -f - && \
  cd /root && \
  rm -r -v ephemeral && \
  apt-get install -y --verbose-versions kicksecure-cli-vm && \
  mkdir -p -v /usr/local/src/attic/etc/apt/sources.list.d /usr/local/src/attic/etc/profile.d && \
  mv -v /etc/apt/sources.list.d/debian.list /usr/local/src/attic/etc/apt/sources.list.d/debian.list && \
  apt-get -y update && \
  apt-get -y --verbose-versions dist-upgrade && \
  mv -v /etc/profile.d/30_setup.sh /usr/local/src/attic/etc/profile.d/ && \
  find /usr/lib /usr/share -maxdepth 24 -name "*.pyc" -ls -delete && \
  find /usr/lib /usr/share -maxdepth 24 -name __pycache__ -type d -print | xargs rmdir -v -- && \
  apt-get -y clean && \
  apt-get -y autoclean && \
  apt-get -y autoremove && \
  rm -r -v /usr/share/man/[^m]*/ && \
  (rm -v /etc/group- /etc/gshadow- /etc/passwd- /etc/shadow- /etc/subgid- /etc/subuid- || true) && \
  rm -v /var/cache/debconf/config.dat-old /var/cache/debconf/templates.dat-old /var/lib/dpkg/diversions-old /var/lib/dpkg/status-old /var/lib/dpkg/statoverride-old && \
  unset PYTHONDONTWRITEBYTECODE && \
  rm -v /etc/.pwd.lock && \
  : > /var/log/alternatives.log && \
  : > /var/log/dpkg.log && \
  : > /var/log/apt/term.log && \
  : > /var/log/apt/history.log && \
  : > /var/log/fontconfig.log && \
  : > /var/log/alternatives.log && \
  : |xz -vv > /var/log/apt/eipp.log.xz && \
  chmod --verbose -R go-rwx /home/* /etc/skel && \
  (echo umask 077; echo export PATH=/sbin:/bin:/usr/sbin:/usr/bin) | tee -a /etc/skel/.bashrc.kicksecure && \
  find /tmp /var/tmp -type f -ls -delete && \
  chmod --verbose -R go-rwx /root && \
  chmod --verbose a-s /bin/ntfs-3g /usr/bin/pkexec /usr/bin/sudo /usr/lib/dbus-1.0/dbus-daemon-launch-helper /usr/libexec/polkit-agent-helper-1 /usr/bin/schroot 2>&1 | tee -a /usr/local/etc/permissions && \
  echo /usr/lib/libhardened_malloc.so/libhardened_malloc.so |tee -a /etc/ld.so.preload && \
  find /usr/share/doc /usr/share/info /usr/share/man -name \*.gz -type l -ls -delete && \
  find /usr/share/doc /usr/share/info /usr/share/man -name \*.gz -type f -exec gunzip -N -v -- \{\} \; && \
  find /etc/alternatives -name \*.gz -type l -ls -delete && \
  find / -xdev -name "*.pyc" -ls && \
  find / -xdev -name "__pycache__" -ls && \
  find / -xdev -type f -perm -2000 -ls && \
  find / -xdev -type f -perm -4000 -ls && \
  find / -xdev -type f -perm -0002 -ls && \
  find / -xdev -type d -perm -0002 -ls && \
  true

FROM devuan-4 AS devuan-4-hardenedmalloc

COPY --from=devuan-4-kicksecure /usr/lib/libhardened_malloc.so/ /usr/lib/libhardened_malloc.so/
COPY --from=devuan-4 / /root/initrd/

ENV SHELL /bin/bash-static

RUN \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin && \
  set -x && \
  set -e && \
  umask 022 && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  cd /root && \
  export LANG=C && \
  export TMP=/tmp && \
  export TEMP="${TMP}" && \
  export TMPDIR="${TMP}" && \
  export DEBIAN_FRONTEND=noninteractive && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  export PYTHONDONTWRITEBYTECODE=1 && \
  exec </dev/null && \
  echo /usr/lib/libhardened_malloc.so/libhardened_malloc.so |tee -a /etc/ld.so.preload && \
  chmod --verbose go+r /etc/ld.so.preload && \
  apt-mark hold libgpgme11 && \
  echo libgpgme11 hold | dpkg --set-selections && \
  apt-get -y install --verbose-versions linux-image-amd64 efibootmgr qemu-system-x86 && \
  cd /root/initrd && \
  tar -C /usr/lib/ -cf - libhardened_malloc.so/ | tar -C ./usr/lib/ -xpkvvf - && \
  echo /usr/lib/libhardened_malloc.so/libhardened_malloc.so |tee -a etc/ld.so.preload && \
  mkdir -p -v dev proc sys run && \
  chmod --verbose go+rx sys proc dev run . && \
  tar -C /lib/ -cf - modules |tar -C ./lib -xpf - && \
  : > etc/modules && \
  echo 8021q ac aesni_intel async_memcpy async_pq async_raid6_recov async_tx async_xor ata_generic ata_piix bochs_drm bridge button ccp cdrom cec crc32_pclmul crc32c_generic crc32c_intel crc_ccitt crc_t10dif crct10dif_common crct10dif_generic crct10dif_pclmul cryptd crypto_simd ctr dm_crypt dm_log dm_mirror dm_mod dm_region_hash drm drm_kms_helper drm_panel_orientation_quirks drm_ttm_helper drm_vram_helper e1000 ecryptfs efi_pstore encrypted_keys evdev fat floppy garp gcm gf128mul ghash_clmulni_intel ghash_generic glue_helper i2c_piix4 ide_cd_mod ide_core ide_gd_mod ide_pci_generic intel_rapl_common intel_rapl_msr ipv6 irqbypass joydev kvm kvm_amd libaes libata libcrc32c linear llc loop md_mod mrp multipath nls_ascii nls_cp437 parport parport_pc pata_acpi pcspkr piix pktcdvd ppdev psmouse qemu_fw_cfg raid0 raid1 raid10 raid456 raid6_pq rng_core scsi_mod sd_mod serio_raw sg sr_mod stp t10_pi tpm trusted ttm tun vfat vmw_pvscsi vmw_vmci vmwgfx vmxnet3 xor |tr " " '\n'|sort |uniq >> etc/modules && \
  cd /root && \
  mkdir -v ephemeral && \
  cd ephemeral && \
  cat $(ls -1trd /boot/initrd* | tail -n 1) | cpio -imd && \
  (set +e; cp -pv kernel/x86/microcode/GenuineIntel.bin /root/initrd/boot/ || true; true) && \
  cd /root && \
  rm -rv ephemeral && \
  cp -pv /boot/vmlinuz* /boot/System.map* /boot/config* /root/initrd/boot/ && \
  cd initrd && \
  echo localhost > etc/hostname && \
  echo nameserver 1.1.1.1 > etc/resolv.conf && \
  ( echo '#!/bin/bash-static' && \
    echo "umask 022" && \
    echo "export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/stand" && \
    echo "mount -v -t proc proc /proc" && \
    echo "mount -v -t sysfs sysfs /sys" && \
    echo "mount -v -t devtmpfs devtmpfs /dev" && \
    echo "mount -v -t tmpfs tmpfs /run" && \
    echo 'grep "^[^#]" /etc/modules | awk '\''{print $1}'\'' | xargs -n 1 /sbin/modprobe \{\} \;' && \
    echo 'grep "^[^#]" /etc/modules | awk '\''{print $1}'\'' | while read module; do modprobe "${module}" || true; done' && \
    echo "mkdir /new" && \
    echo "mount -v -t tmpfs -o nosuid,sync,noatime,nodiratime,dirsync,loud,nouser tmpfs /new" && \
    echo "tar -c --one-file-system -f - / | tar -C /new/ -xpkf -" && \
    echo "rmdir -v /new/new" && \
    echo "rm -rf /usr/share/locale /usr/share/doc /usr/share/man /usr/lib/cni /usr/lib/git-core /var/lib/apt/lists /usr/share/zsh/functions /usr/bin/podman /usr/bin/git-lfs /usr/bin/containers-storage" && \
    echo "rm -v /new/init" && \
    echo "echo "\''#!/bin/bash-static'\'" > /new/init" && \
    echo "chmod --verbose u+rx /new/init" && \
    echo "chmod --verbose go-rwx /new/init" && \
    echo "echo export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/stand >>/new/init" && \
    echo "echo touch /root/init-pivot >>/new/init" && \
    echo "echo exec /sbin/init >>/new/init" && \
    echo "chmod --verbose go-rwx /sbin/init" && \
    echo "exec /sbin/switch_root /new /init" \
  ) > init && \
  chmod --verbose u+rx init && \
  chmod --verbose go-rwx init && \
  initrd_file=$(ls -1dtr /boot/initrd* | tail -n 1) && \
  find . -print0 | cpio -0 -H newc -o |gzip -9v > "${initrd_file}" && \
  cp -pv "${initrd_file}" /root/initrd/boot/ && \
  unset initrd_file && \
  mv -v sbin/init sbin/init.orig && \
  rm -v init && \
  rm -rf usr/share/locale usr/share/doc usr/share/man usr/lib/cni usr/lib/git-core var/lib/apt/lists usr/share/zsh/functions usr/bin/podman usr/bin/git-lfs usr/bin/containers-storage && \
  echo '#!/bin/bash-static' > init && \
  echo 'set -x' >> init && \
  echo 'set -e' >> init && \
  echo 'export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/stand' >> init && \
  echo 'umask 02' >> init && \
  echo 'cd /root' >> init && \
  echo 'mount -v -t proc proc /proc' >> init && \
  echo 'mount -v -t sysfs sysfs /sys' >> init && \
  echo 'mount -v -t devtmpfs devtmpfs /dev' >> init && \
  echo '(set +e; grep "^[^#]" /etc/modules | awk '\''{print $1}'\'' | xargs -n 1 /sbin/modprobe || true; true) || true' >> init && \
  echo '(set +e; grep "^[^#]" /etc/modules | awk '\''{print $1}'\'' | while read module; do modprobe "${module}" || true; done; true) || true' >> init && \
  echo '/etc/init.d/eudev start' >> init && \
  echo 'udevadm settle' >> init && \
  echo 'udevadm trigger' >> init && \
  echo 'lsblk' >> init && \
  echo 'sync' >> init && \
  echo 'ls /dev/disk/by-id/ata-QEMU_HARDDISK_QM00001' >> init && \
  echo '(for i in \
      n 1 "" +768m EF00 \
      n 2 "" +32m EF02 \
      n 3 "" +32m 8301 \
      n 4 "" +32m 8301 \
      n 5 "" +32m 8301 \
      n 6 "" +2g 8301 \
      n 7 "" +4g 8301 \
      n 8 "" +32g 8309 \
      c 1 EFI \
      c 2 BIOSGRUB \
      c 3 IDEN \
      c 4 CONF \
      c 5 ENTROPY \
      c 6 CACHE \
      c 7 VOLATILE \
      c 8 DATA \
      x a 1 2 "" \
      p w y; \
    do echo "$i"; done) | gdisk /dev/disk/by-id/ata-QEMU_HARDDISK_QM00001' >> init && \
  echo 'sync' >> init && \
  echo 'sleep 2' >> init && \
  echo 'udevadm settle' >> init && \
  echo 'udevadm trigger' >> init && \
  echo 'sleep 2' >> init && \
  echo 'sync' >> init && \
  echo '/etc/init.d/eudev stop' >> init && \
  echo 'sleep 2' >> init && \
  echo 'sync' >> init && \
  echo '/etc/init.d/eudev start' >> init && \
  echo 'sync' >> init && \
  echo 'udevadm settle' >> init && \
  echo 'udevadm trigger' >> init && \
  echo 'sync' >> init && \
  echo 'sleep 2' >> init && \
  echo 'find /dev/disk -ls' >> init && \
  echo 'sleep 2' >> init && \
  echo 'ls /dev/disk/by-partlabel/EFI' >> init && \
  echo 'mkfs.fat -F 32 -n EFI --invariant -v /dev/disk/by-partlabel/EFI' >> init && \
  echo 'mkdir -v /mnt/EFI' >> init && \
  echo 'mount -v -t vfat /dev/disk/by-partlabel/EFI /mnt/EFI' >> init && \
  echo 'mkdir -v /mnt/EFI/syslinux' >> init && \
  echo 'umount -v /mnt/EFI' >> init && \
  echo 'syslinux --install --stupid --raid --directory /syslinux /dev/disk/by-partlabel/EFI' >> init && \
  echo 'sync' >> init && \
  echo 'mount -v -t vfat /dev/disk/by-partlabel/EFI /mnt/EFI' >> init && \
  echo 'ls -la /mnt/EFI/syslinux' >> init && \
  echo 'umount -v /mnt/EFI' >> init && \
  echo 'find /dev/disk -ls' >> init && \
  echo 'sync' >> init && \
  echo 'dd if=/usr/lib/syslinux/mbr/gptmbr.bin of=/dev/disk/by-id/ata-QEMU_HARDDISK_QM00001 bs=440 count=1 conv=notrunc' >> init && \
  echo 'sync' >> init && \
  echo 'sleep 2' >> init && \
  echo 'sync' >> init && \
  echo 'udevadm settle' >> init && \
  echo 'udevadm trigger' >> init && \
  echo 'sleep 2' >> init && \
  echo 'sync' >> init && \
  echo '/etc/init.d/eudev stop' >> init && \
  echo 'sleep 2' >> init && \
  echo 'sync' >> init && \
  echo '/etc/init.d/eudev start' >> init && \
  echo 'sync' >> init && \
  echo 'udevadm settle' >> init && \
  echo 'udevadm trigger' >> init && \
  echo 'sync' >> init && \
  echo 'sleep 2' >> init && \
  echo 'mount -v -t vfat /dev/disk/by-partlabel/EFI /mnt/EFI' >> init && \
  echo 'cp -nav /usr/lib/syslinux/modules/bios/* /mnt/EFI/syslinux/' >> init && \
  echo 'ls -la /mnt/EFI/syslinux/ldlinux.c32' >> init && \
  echo 'blkid -s PTTYPE -o value /dev/disk/by-id/ata-QEMU_HARDDISK_QM00001' >> init && \
  echo 'ls -la /boot' >> init && \
  echo 'cp -p -v /boot/xen* /boot/vmlinuz* /boot/initrd* /boot/System.map* /boot/config* /boot/GenuineIntel.bin /mnt/EFI/' >> init && \
  echo 'sync' >> init && \
  echo 'cd /mnt/EFI/syslinux' >> init && \
  echo 'for i in "DEFAULT menu.c32" "PROMPT 0" "MENU TITLE Linux boot menu" "MENU AUTOBOOT Xen/Linux boot in #" "TIMEOUT 100" "LABEL xen-linux-0"; do echo "$i" >> syslinux.cfg; done' >> init && \
  echo 'echo "  MENU LABEL Xen/Linux" >> syslinux.cfg' >> init && \
  echo 'echo "  COM32 mboot.c32" >> syslinux.cfg' >> init && \
  echo 'echo "  APPEND /xen-4.14-amd64.gz dom0_mem=4096M ucode=scan --- /vmlinuz-5.10.0-21-amd64 init=/init root=tmpfs nomodeset console=hvc0 console=ttyS0 console=tty0 biosdevname=0 earlyprintk=vga,keep gpt logo.nologo loop.max_loop=256 net.ifnames=0 panic=0 printk.time=1 splash=off cgroup_enable=cpuset,memory cgroup_memory=1 cgroup_cpuset=1 swapaccount=1 extra_latent_entropy random.trust_cpu=off waitusb=3 rng_core.default_quality=256 concurrency=none --- /initrd.img-5.10.0-21-amd64" >> syslinux.cfg' >> init && \
  echo 'echo >> syslinux.cfg' >> init && \
  echo 'echo "MENU SEPARATOR" >> syslinux.cfg' >> init && \
  echo 'cat syslinux.cfg' >> init && \
  echo 'sync' >> init && \
  echo 'cd /root' >> init && \
  echo 'umount -v /mnt/EFI' >> init && \
  echo 'sync' >> init && \
  echo 'udevadm settle' >> init && \
  echo 'udevadm trigger' >> init && \
  echo 'sync' >> init && \
  echo '/etc/init.d/eudev stop' >> init && \
  echo 'sync' >> init && \
  echo 'umount /sys' >> init && \
  echo 'umount /dev' >> init && \
  echo 'for i in s s u s o o; do echo $i > /proc/sysrq-trigger; sleep 4; sync; done' >> init && \
  chmod 755 init && \
  ln init sbin/init && \
  find . -print0 | cpio -0 -H newc -o |gzip -9v > ../initrd.gz && \
  cd /root && \
  rm -r initrd && \
  qemu-img create -f qcow2 /root/disk.qcow2 48G && \
  qemu-system-x86_64 -m 4g -kernel /boot/vmlinuz-5.10.0-*-amd64 -initrd initrd.gz -drive file=disk.qcow2,format=qcow2 -append "console=ttyS0 init=/init" -nographic && \
  rm -v initrd.gz && \
  qemu-img convert -c -f qcow2 -O qcow2 disk.qcow2 Linux-Image-Devuan-4-Xen.qcow2 && \
  rm -v disk.qcow2 && \
  qemu-img snapshot -c Linux-Image-Devuan-4-Xen Linux-Image-Devuan-4-Xen.qcow2 && \
  qemu-img snapshot -l Linux-Image-Devuan-4-Xen.qcow2 && \
  true
