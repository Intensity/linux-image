#!/usr/bin/env -vS podman --runtime crun --storage-driver vfs --cgroup-manager cgroupfs --events-backend file build -t intensity/linux-image:devuan-4-hardenedmalloc . -f

FROM docker://devuan/devuan:stable AS devuan-4

RUN \
  packages_devuan_xen=" \
    xen-hypervisor-common \
    xen-system-amd64 \
    xen-tools \
    xenstore-utils \
  " && \
  packages_devuan_base=" \
    acl \
    age \
    amd64-microcode \
    apt-transport-https \
    arptables \
    attr \
    auditd \
    bash-completion \
    bash-static \
    bat \
    bc \
    bcache-tools \
    bcachefs-tools \
    bindfs \
    binutils \
    blktool \
    bridge-utils \
    brotli \
    bsdiff \
    btrfs-progs \
    bubblewrap \
    buffer \
    busybox-static \
    bzip2 \
    ca-certificates \
    care \
    catatonit \
    ccrypt \
    cdebootstrap-static \
    cgroup-tools \
    cgroupfs-mount \
    chromium-sandbox \
    chrootuid \
    chrpath \
    conmon \
    containernetworking-plugins \
    containers-storage \
    cpio \
    crun \
    cryptmount \
    cryptsetup \
    cryptsetup-bin \
    cu \
    curl \
    daemon \
    daemonize \
    daemontools \
    dar-static \
    datefudge \
    dateutils \
    dc \
    delta \
    detachtty \
    dmraid \
    dmsetup \
    dnscrypt-proxy \
    dnsmasq \
    dnsmasq-utils \
    dnsproxy \
    dosfstools \
    dropbear \
    dropbear-bin \
    dtach \
    duf \
    e2fsck-static \
    e2tools \
    ebtables \
    ecdsautils \
    ed \
    encfs \
    ethtool \
    eudev \
    exa \
    exfat-fuse \
    exfat-utils \
    ext3grep \
    ext4magic \
    extlinux \
    extundelete \
    f2fs-tools \
    fake-hwclock \
    fakechroot \
    fakeroot \
    fakeroot-ng \
    faketime \
    fd-find \
    fdflush \
    fdisk \
    file \
    firehol \
    firehol-common \
    firehol-tools \
    firejail \
    firejail-profiles \
    fireqos \
    fping \
    fscrypt \
    fuse-overlayfs \
    fuse2fs \
    fuse3 \
    fuseext2 \
    fusefat \
    fuseiso \
    fzf \
    gawk \
    gdisk \
    genisoimage \
    gfsecret \
    git-crypt \
    git-lfs \
    git-secrets \
    gnupg1 \
    gnupg1-l10n \
    gocryptfs \
    golang-github-containers-common \
    golang-github-containers-image \
    gostsum \
    gpart \
    gpgv-static \
    gpgv1 \
    gzrt \
    hashdeep \
    haveged \
    hdparm \
    ifenslave \
    ifupdown \
    ifupdown-extra \
    imvirt \
    imvirt-helper \
    inetutils-tools \
    inetutils-traceroute \
    initscripts \
    intel-microcode \
    iproute2 \
    ipset \
    iptables \
    iputils-arping \
    iputils-ping \
    iputils-tracepath \
    isc-dhcp-client \
    isc-dhcp-common \
    jfsutils \
    jitterentropy-rngd \
    jq \
    klibc-utils \
    kmod \
    kpartx \
    less \
    libarchive-tools \
    libarchive13 \
    libdevmapper1.02.1 \
    libglib2.0-0 \
    libicu67 \
    libmnl0 \
    libncursesw6 \
    libnetfilter-queue1 \
    libnfnetlink0 \
    libsodium23 \
    libxml2 \
    lockfile-progs \
    lrzip \
    lsh-client \
    lsh-server \
    lshw \
    lsof \
    lsscsi \
    ltrace \
    luksmeta \
    lvm2 \
    lxc \
    lxc-templates \
    lxcfs \
    lxctl \
    lynx \
    lz4 \
    lzip \
    lziprecover \
    lzop \
    makefs \
    makepatch \
    man-db \
    mandoc \
    manpages \
    manpages-dev \
    mbuffer \
    mdadm \
    mergerfs \
    metastore \
    moreutils \
    net-tools \
    netbase \
    netcat-openbsd \
    nettle-bin \
    nftables \
    nilfs-tools \
    ntpdate \
    ntpstat \
    nvme-cli \
    nwipe \
    openssl \
    par2 \
    parchive \
    parted \
    patch \
    patchutils \
    pax \
    paxctl \
    pciutils \
    pinentry-curses \
    pinentry-tty \
    procinfo \
    procps \
    proot \
    psmisc \
    psutils \
    pv \
    qemu-utils \
    quota \
    quotatool \
    randomsound \
    rclone \
    rdate \
    rdiff \
    reiser4progs \
    reiserfsprogs \
    rfkill \
    rhash \
    ripgrep \
    rng-tools \
    rng-tools-debian \
    rootlesskit \
    rsync \
    rsyncrypto \
    rsyslog \
    runc \
    rush \
    sdparm \
    seccomp \
    seccure \
    secure-delete \
    securefs \
    sharutils \
    signify-openbsd \
    silversearcher-ag \
    slirp \
    slirp4netns \
    socat \
    squashfs-tools \
    squashfs-tools-ng \
    squashfuse \
    sshoot \
    sshuttle \
    ssss \
    strace \
    syslinux \
    syslinux-common \
    syslinux-efi \
    syslinux-utils \
    sysstat \
    tar-scripts \
    tar-split \
    tardiff \
    tardy \
    tcpdump \
    tcpflow-nox \
    tcplay \
    tcptraceroute \
    time \
    tini \
    tinysshd \
    tldr \
    tmux \
    traceroute \
    tsocks \
    uanytun \
    ucspi-proxy \
    ucspi-tcp-ipv6 \
    ucspi-unix \
    udftools \
    udhcpc \
    uidmap \
    unionfs-fuse \
    unzip \
    usbutils \
    vim-tiny \
    vlan \
    vlock \
    vmfs6-tools \
    w3m \
    wget \
    wipe \
    wireguard-tools \
    xdelta \
    xdelta3 \
    xen-hypervisor-4.14-amd64 \
    xorriso \
    xxhash \
    xz-utils \
    zip \
    zoxide \
    zpaq \
    zsh-autosuggestions \
    zsh-static \
    zsh-syntax-highlighting \
    zstd \
  " && \
  packages_idempotent=" \
    adduser \
    apt \
    base-files \
    base-passwd \
    bash \
    bsdutils \
    coreutils \
    dash \
    debconf \
    debian-archive-keyring \
    debianutils \
    devuan-keyring \
    diffutils \
    dpkg \
    e2fsprogs \
    findutils \
    gcc-10-base \
    gcc-9-base \
    gpgv \
    grep \
    gzip \
    hostname \
    init-system-helpers \
    libacl1 \
    libapt-pkg6.0 \
    libattr1 \
    libaudit-common \
    libaudit1 \
    libblkid1 \
    libbz2-1.0 \
    libc-bin \
    libc6 \
    libcap-ng0 \
    libcom-err2 \
    libcrypt1 \
    libdb5.3 \
    libdebconfclient0 \
    libeudev1 \
    libext2fs2 \
    libffi7 \
    libgcc-s1 \
    libgcrypt20 \
    libgmp10 \
    libgnutls30 \
    libgpg-error0 \
    libgssapi-krb5-2 \
    libhogweed6 \
    libidn2-0 \
    libk5crypto3 \
    libkeyutils1 \
    libkrb5-3 \
    libkrb5support0 \
    liblz4-1 \
    liblzma5 \
    libmount1 \
    libnettle8 \
    libnsl2 \
    libp11-kit0 \
    libpam-modules \
    libpam-modules-bin \
    libpam-runtime \
    libpam0g \
    libpcre2-8-0 \
    libpcre3 \
    libseccomp2 \
    libselinux1 \
    libsemanage-common \
    libsemanage1 \
    libsepol1 \
    libsmartcols1 \
    libss2 \
    libssl1.1 \
    libstdc++6 \
    libtasn1-6 \
    libtinfo6 \
    libtirpc-common \
    libtirpc3 \
    libunistring2 \
    libuuid1 \
    libxxhash0 \
    libzstd1 \
    login \
    logsave \
    lsb-base \
    mawk \
    mount \
    ncurses-base \
    ncurses-bin \
    passwd \
    perl-base \
    sed \
    sysvinit-utils \
    tar \
    tzdata \
    util-linux \
    zlib1g \
  " && \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin && \
  set -x && \
  set -e && \
  umask 077 && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  cd /root && \
  export LANG=C && \
  export TMP=/tmp && \
  export TEMP="${TMP}" && \
  export TMPDIR="${TMP}" && \
  sed -i -e "/^Acquire/s/true/false/" /etc/apt/apt.conf.d/docker-gzip-indexes && \
  for insistence in Suggests Recommends; do echo APT::Install-"${insistence}" '"0";' | tee -a /etc/apt/apt.conf.d/42disable; done && \
  chmod --verbose go+r /etc/apt/apt.conf.d/42disable && \
  (for src in "" "-src"; do for repo in "" "-updates" "-security" "-backports"; do echo deb"${src}" http://deb.devuan.org/merged chimaera"${repo}" main contrib non-free; done; done) > /etc/apt/sources.list && \
  export DEBIAN_FRONTEND=noninteractive && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  export PYTHONDONTWRITEBYTECODE=1 && \
  exec </dev/null && \
  chmod --verbose go-w /etc /etc/apt /etc/apt/apt.conf.d /etc/dpkg /etc/dpkg/dpkg.cfg.d /usr /usr/sbin && \
  chmod --verbose go-w /etc/apt/apt.conf.d/docker-autoremove-suggests /etc/apt/apt.conf.d/docker-clean /etc/apt/apt.conf.d/docker-gzip-indexes /etc/apt/apt.conf.d/docker-no-languages /etc/dpkg/dpkg.cfg.d/docker-apt-speedup /usr/sbin/policy-rc.d && \
  apt-get -y update && \
  apt-get -y --verbose-versions dist-upgrade && \
  apt-get -y --verbose-versions install ${packages_idempotent} && \
  apt-get -y --verbose-versions install memtest86 memtest86+ && \
  (set +e; apt-get -y --verbose-versions install makedev || true; : > /var/lib/dpkg/info/makedev.postinst; apt-get -y -f install || true; true) && \
  (set +e; mkdir -v -p /var/lock/schroot || true; apt-get -y --verbose-versions install schroot schroot-common || true; : > /var/lib/dpkg/info/schroot.postinst; apt-get -y -f install || true; true) && \
  (set +e; mkdir -v -p /run/initctl || true; apt-get -y --verbose-versions install sysvinit-core || true; sed -i -e "/^restart=yes/s,restart=yes,restart=no," /var/lib/dpkg/info/sysvinit-core.postinst || true; apt-get -y -f install || true; rmdir /run/initctl || true; true) && \
  apt-get -y --verbose-versions install makedev sysvinit-core schroot schroot-common && \
  apt-get -y --verbose-versions install ${packages_devuan_base} && \
  mkdir -v ephemeral && \
  cd ephemeral && \
  apt-get download libgpgme11 && \
  package=$(ls -1d libgpgme11_*.deb) && \
  ar xv "${package}" && \
  cat control.tar.xz | xz -dvv | tar xpkvvf - && \
  sed -i -e "/^Depend/s/: gnupg[^,]*,/:/" control && \
  tar -c -v -f - control md5sums shlibs symbols triggers | xz -vv > control.tar.xz && \
  rm -v "${package}" && \
  ar rcv "${package}" debian-binary control.tar.xz data.tar.xz && \
  dpkg -i --force-all "${package}" && \
  unset package && \
  cd /root && \
  rm -rv ephemeral && \
  rm -v /etc/lsh_host_key.pub /etc/lsh_host_key && \
  apt-get install -y --verbose-versions podman && \
  rm -v /etc/dropbear/dropbear_ecdsa_host_key /etc/dropbear/dropbear_ed25519_host_key /etc/dropbear/dropbear_rsa_host_key && \
  for i in auditd dnscrypt-proxy dnsmasq dnsproxy dropbear firehol fireqos lvm2 lvm2-lvmpolld lxc lxc-net lxcfs mdadm rsync sysstat uanytun uuidd lsh-server rsyslog; do update-rc.d "${i}" disable && update-rc.d "${i}" remove; done && \
  apt-get -y --verbose-versions install ${packages_devuan_xen} python3-dotenv python-is-python3 gdb xfsprogs xfsdump initramfs-tools initramfs-tools-core klibc-utils libklibc libvirt0 libvirt-clients libxml2-utils libvirt-daemon-system distro-info && \
  for i in xendomains xen cron virtlogd libvirtd libvirt-guests; do update-rc.d "${i}" disable && update-rc.d "${i}" remove; done && \
  sed -i -e "/^ENV_[SU]*PATH/s,PATH=.*,PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/stand," -e "/^UMASK/s,022,077," -e "/^LOG_OK_LOGINS/s,no,yes," /etc/login.defs && \
  sed -i -e '/PATH="/s,PATH="[^"]*",PATH="/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/stand",' /etc/profile && \
  sed -i -e '/export PATH=/s,PATH="[^"]*",PATH="/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/stand",' /etc/zsh/zshenv && \
  sed -i -e "s,^DSHELL=.*,DSHELL=/bin/bash-static," -e "s,^DIR_MODE=.*,DIR_MODE=0700," /etc/adduser.conf && \
  sed -i -e '/^if.*usr.lib.command-not-found.*usr.share.command-not-found.command-not-found/s,; then, \&\& false; then,' /etc/bash.bashrc && \
  sed -i -e "/^START_FIREHOL/s/=.*/=YES/" /etc/default/firehol && \
  mkdir -p -v /usr/local/src/attic/etc && \
  mkdir -v /usr/local/src/attic/bin && \
  mkdir -p -v /usr/local/src/attic/usr/bin && \
  chmod --verbose 700 /usr/local/src/attic /usr/local/src/attic/etc /usr/local/src/attic/bin /usr/local/src/attic/usr /usr/local/src/attic/usr/bin && \
  rm -v /bin/rbash && \
  ln -sv bash-static /bin/rbash && \
  ln -svf bash-static /bin/sh && \
  mv -v /bin/bash /usr/local/src/attic/bin/bash && \
  ln -sv bash-static /bin/bash && \
  for shell in zsh zsh5 zsh5-static; do mv -v /bin/"${shell}" /usr/local/src/attic/bin/"${shell}" && ln -sv zsh-static /bin/"${shell}"; done && \
  rm -rv /bin/rzsh && \
  ln -sv zsh-static /bin/rzsh && \
  mv -v /usr/bin/tini /usr/local/src/attic/usr/bin/tini && \
  ln -sv tini-static /usr/bin/tini && \
  mv -v /usr/bin/gpgv /usr/local/src/attic/usr/bin/gpgv && \
  ln -sv gpgv1 /usr/bin/gpgv && \
  rm -v /bin/mksh && \
  ln -sv mksh-static /bin/mksh && \
  rm -v /bin/rksh && \
  ln -sv mksh-static /bin/rksh && \
  rm -v /bin/rmksh && \
  ln -sv mksh-static /bin/rmksh && \
  cp -av /usr/bin/gpg1 /usr/bin/gpg && \
  for conf in /etc/bash.bashrc /etc/profile /etc/skel/.bashrc /etc/skel/.profile /root/.bashrc /root/.profile; do (echo umask 077; echo export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/stand) | tee -a "${conf}"; done && \
  rm -v /etc/localtime && \
  /usr/bin/env --chdir=/etc ln -sv ../usr/share/zoneinfo/Universal ./localtime && \
  echo Universal > /etc/timezone && \
  chmod --verbose go+r /etc/timezone && \
  cp -v -p /etc/shells /usr/local/src/attic/etc/shells && \
  (for shell in /bin/bash /bin/bash-static /bin/zsh-static /usr/lib/klibc/bin/mksh /bin/sh /bin/dash /bin/rbash /bin/rzsh /bin/rksh /bin/rmksh /bin/rlksh /bin/lksh; do echo "${shell}"; done) >/etc/shells && \
  chsh --shell /bin/bash-static root && \
  sed -i -e "/^[2-6]:23:respawn:.sbin.getty [0-9][0-9]* tty[2-6]$/s/^/#/" -e "/^#T0:23:respawn:.sbin.getty -L ttyS0/s/^#/# uncomment for serial #/" /etc/inittab && \
  mkdir -v /etc/boot.d && \
  (echo '#!/bin/bash-static'; echo "set -x"; echo "if test -d /usr/local/etc/boot.d; then run-parts /usr/local/etc/boot.d; fi") >> /etc/boot.d/00local && \
  chmod --verbose u+rx /etc/boot.d/00local /etc/rc.local && \
  mkdir -v /usr/local/etc/boot.d && \
  (echo '#!/bin/bash-static'; echo "set -x"; echo "rm -v /init") >> /usr/local/etc/boot.d/00rminit && \
  (echo '#!/bin/bash-static'; echo "set -x"; echo "mount -o remount,nodev,nosuid,sync,noatime,nodiratime,dirsync,loud,nouser /") >> /usr/local/etc/boot.d/01remountroot && \
  (echo '#!/bin/bash-static'; echo "set -x"; echo "apt-mark hold libgpgme11 && echo libgpgme11 hold | dpkg --set-selections") >> /usr/local/etc/boot.d/02holdgpg1 && \
  (echo '#!/bin/bash-static'; echo "set -x"; echo 'for i in cdebootstrap dar fstype ipconfig minips nfsmount; do ln /stand/"${i}" /usr/local/bin/"${i}"; done; ln /stand/ul_* /usr/local/bin/') >> /usr/local/etc/boot.d/02standlink && \
  (echo '#!/bin/bash-static'; echo "set -x"; echo "ldconfig") >> /usr/local/etc/boot.d/02ldconfig && \
  (echo '#!/bin/bash-static'; echo "set +x"; echo 'netdevs=$( (cd /sys/class/net/ && ls -1d eth*; ifconfig -a|grep "^eth[0-9]*:" | cut -f1 -d:) |sort|uniq | sed "s,^eth,,"); for netdev in ${netdevs}; do ifconfig eth${netdev} up; brctl addbr br${netdev}; ifconfig br${netdev} up; brctl addif br${netdev} eth${netdev}; dhclient -v br${netdev}; done; iptables -v -n -L; iptables -v -n -L -t nat; ifconfig -a; ip a; brctl show; exit 0') >> /usr/local/sbin/init-naive-networking && \
  chmod --verbose 0755 /usr/local/sbin/init-naive-networking && \
  (echo '#!/bin/bash-static'; echo "set -x"; echo "/etc/init.d/eudev stop") >> /usr/local/etc/boot.d/05stopeudev && \
  (echo '#!/bin/bash-static'; echo "set -x"; echo '#if cat /proc/cmdline |grep -q removemounts >/dev/null 2>/dev/null; then for dir in /sys/fs/pstore /sys/kernel/security /run/lock; do umount -v "${dir}"; done; /etc/init.d/cgroupfs-mount stop; umount -v /sys/fs/cgroup; umount -v /sys/kernel/debug/tracing; umount -v /sys/kernel/debug; else true; fi') >> /usr/local/etc/boot.d/07umountsomedirs && \
  (echo '#!/bin/bash-static'; echo "set -x"; echo "sdmem -l -l") >> /usr/local/etc/boot.d/09wipemem && \
  (echo '#!/bin/bash-static'; echo "set -x"; echo "set +e"; echo 'mkdir -p -v /run/conf.d/ /mnt/conf && for dev in /dev/disk/by-partlabel/CONF*; do fsck.ext4 -v -p "${dev}" && mount -v -t ext4 -o debug,ro "${dev}" /mnt/conf && tar -C /mnt/conf/conf -c -v -f - . | tar -C /run/conf.d/ -x -p -v --warning=no-timestamp -f - && umount -v /mnt/conf; done && rmdir -v /mnt/conf && chmod -R --verbose go-rwx /run/conf.d/ && exec run-parts /run/conf.d/') >> /usr/local/etc/boot.d/19confrun && \
  chmod --verbose u+rx /usr/local/etc/boot.d/[0-9]* && \
  chmod --verbose go-rwx /usr/local/etc/boot.d/[0-9]* && \
  update-alternatives --set editor /usr/bin/vim.tiny && \
  find /usr/lib /usr/share -maxdepth 24 -name "*.pyc" -type f -ls -delete && \
  (set +e; find /usr/lib /usr/share -maxdepth 24 -name __pycache__ -type d -print | xargs rmdir -v -- || true; true) && \
  apt-get -y clean && \
  apt-get -y autoclean && \
  apt-get -y autoremove && \
  unset PYTHONDONTWRITEBYTECODE && \
  mkdir /stand && \
  chmod -v ugo+rx /stand && \
  /bin/busybox --list | while read fn; do ln /bin/busybox /stand/"${fn}"; done && \
  ln -v /usr/bin/dar_static /sbin/e2fsck.static /usr/bin/gpgv-static /bin/zsh-static /bin/bash-static /bin/lksh /usr/lib/klibc/bin/fstype /usr/lib/klibc/bin/ipconfig /usr/lib/klibc/bin/minips /usr/lib/klibc/bin/mksh /usr/lib/klibc/bin/nfsmount /usr/bin/catatonit /usr/bin/cdebootstrap-static /usr/bin/saveme /usr/bin/statfs /usr/bin/statvsfstat /usr/bin/tini-static /stand && \
  ln -v /stand/gpgv-static /stand/gpgv && ln -v /stand/dar_static /stand/dar && ln -v /stand/e2fsck.static /stand/e2fsck && ln -v /stand/zsh-static /stand/zsh && ln -v /stand/bash-static /stand/bash && ln -v /stand/cdebootstrap-static /stand/cdebootstrap && \
  passwd --delete root && \
  rm -v /etc/group- /etc/gshadow- /etc/passwd- /etc/shadow- && \
  rm -v /var/cache/debconf/config.dat-old /var/cache/debconf/templates.dat-old /var/lib/dpkg/diversions-old /var/lib/dpkg/status-old && \
  rm -v /etc/.pwd.lock && \
  find /usr/share/doc /usr/share/info /usr/share/man -name \*.gz -type l -ls -delete && \
  find /usr/share/doc /usr/share/info /usr/share/man -name \*.gz -type f -exec gunzip -N -v -- \{\} \; && \
  gunzip -N -v /usr/lib/debug/*.gz && \
  rm -r -v /usr/share/man/[^m]*/ && \
  find /etc/alternatives -name \*.gz -type l -ls -delete && \
  rm -v /usr/share/man/man3/LIST_* && \
  : > /etc/issue && \
  : > /etc/issue.net && \
  : > /etc/motd && \
  : > /var/log/alternatives.log && \
  : > /var/log/dpkg.log && \
  : > /var/log/apt/term.log && \
  : > /var/log/apt/history.log && \
  : > /var/log/fontconfig.log && \
  : > /var/log/alternatives.log && \
  : |xz -vv > /var/log/apt/eipp.log.xz && \
  chmod --verbose -R go-rwx /etc/skel && \
  (echo umask 077; echo export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/stand) | tee -a /etc/skel/.bashrc && \
  find /tmp /var/tmp -type f -ls -delete && \
  ( echo "# Example aliases" && \
    echo 'alias ered="env -i -- TMP=/dev/shm TEMP=/dev/shm TMPDIR=/dev/shm TERM=vt220 SHELL=/bin/false /bin/ed -E -r --"' && \
    echo 'alias eed="env -i -- TMP=/dev/shm TEMP=/dev/shm TMPDIR=/dev/shm TERM=vt220 SHELL=/bin/bash-static /bin/ed -E --"' && \
    echo 'alias eex="env -i -- TMP=/dev/shm TEMP=/dev/shm TMPDIR=/dev/shm TERM=vt220 SHELL=/bin/bash-static /usr/bin/vim.tiny -b -n -T vt220 -u /dev/null --noplugin -i /dev/null --clean -E -Z --not-a-term --"' && \
    echo 'alias evi="env -i -- TMP=/dev/shm TEMP=/dev/shm TMPDIR=/dev/shm TERM=vt220 SHELL=/bin/bash-static /usr/bin/vim.tiny -b -n -T vt220 -u /dev/null --noplugin -i /dev/null --clean --ttyfail --"') | tee -a /root/.bashrc /root/.profile && \
  chmod --verbose -R go-rwx /root && \
  chmod --verbose a-s /bin/fusermount /bin/mount /bin/ping /bin/ping6 /bin/su /bin/umount /sbin/unix_chkpwd /usr/bin/chage /usr/bin/chfn /usr/bin/chsh /usr/bin/cryptmount /usr/bin/dotlockfile /usr/bin/expiry /usr/bin/firejail /usr/bin/gpasswd /usr/bin/inetutils-traceroute /usr/bin/mail-lock /usr/bin/mail-touchlock /usr/bin/mail-unlock /usr/bin/newgidmap /usr/bin/newgrp /usr/bin/newuidmap /usr/bin/passwd /usr/bin/schroot /usr/bin/tcptraceroute.mt /usr/bin/wall /usr/bin/write.ul /usr/lib/chromium/chrome-sandbox /usr/lib/x86_64-linux-gnu/utempter/utempter /usr/libexec/lxc/lxc-user-nic /usr/sbin/rush /usr/sbin/vlock-main /usr/bin/crontab 2>&1 | tee -a /usr/local/etc/permissions && \
  chmod --verbose a-s /usr/bin/ssh-agent /usr/lib/openssh/ssh-keysign 2>&1 | tee -a /usr/local/etc/permissions && \
  chmod --verbose go-rwx /usr/local/etc/permissions && \
  (echo "#!/bin/bash-static"; echo 'for bin do perm=$(fgrep "mode of "\'\''"${bin}"\'\''" changed from " /usr/local/etc/permissions | head -n 1 | sed '\''s,^[^(]* changed from ,,'\'' |awk '\''{print $1}'\''|tr -cd 0-9 | head -c 4); if echo "${perm}" |grep -q "^[0-9][0-9][0-9][0-9]$"; then chmod --verbose "${perm}" "${bin}"; else echo Could not change permissions for "${bin}" 1>&2; exit 1; fi; done') > /usr/local/sbin/restore-permissions && \
  chmod --verbose 700 /usr/local/sbin/restore-permissions && \
  ln -sv /proc/mounts /etc/mtab && \
  touch /etc/init.d/.legacy-bootordering && \
  chmod --verbose o-w /run/screen /etc/hostname && \
  echo localhost > /etc/hostname && \
  find / -xdev -name "*.pyc" -ls && \
  find / -xdev -name "__pycache__" -ls && \
  find / -xdev -type f -perm -2000 -ls && \
  find / -xdev -type f -perm -4000 -ls && \
  find / -xdev -type f -perm -0002 -ls && \
  find / -xdev -type d -perm -0002 -ls && \
  true

FROM devuan-4 AS devuan-4-builder

RUN \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/stand && \
  set -x && \
  set -e && \
  umask 022 && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  cd /root && \
  export LANG=C && \
  export HOME=/root && \
  export TMP=/tmp && \
  export TEMP="${TMP}" && \
  export TMPDIR="${TMP}" && \
  export DEBIAN_FRONTEND=noninteractive && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  export PYTHONDONTWRITEBYTECODE=1 && \
  exec </dev/null && \
  \
  export CFLAGS=" -O -ggdb3 -fverbose-asm -mtune=generic " && \
  export CXXFLAGS=" ${CFLAGS} " && \
  \
  apt-get install -y --verbose-versions asciidoc asciidoctor autoconf automake binutils-dev bison build-essential cargo ccache cdbs clang cmake devscripts dh-autoreconf dh-exec dh-make dh-python docbook-xml docbook-xsl doxygen dpkg-dev flex fuse3 g++ golang-go help2man libacl1-dev libaio-dev libarchive-dev libarchive13 libaudit-dev libboost-context-dev libboost-filesystem-dev libboost-program-options-dev libboost-python-dev libboost-regex-dev libboost-system-dev libboost-thread-dev libbsd-dev libbz2-dev libcap-dev libcap-ng-dev libdevmapper-dev libdivsufsort-dev libdouble-conversion-dev libdrm-dev libdwarf-dev libelf-dev libevent-dev libfido2-dev libfmt-dev libfuse3-dev libgcrypt20-dev libglib2.0-dev libgnutls28-dev libgoogle-glog-dev libiberty-dev libjemalloc-dev liblz4-dev liblzma-dev liblzo2-dev libncurses-dev libncursesw5-dev libnet1-dev libnettle8 libnftables-dev libnl-3-dev libnl-route-3-dev libpam0g-dev libpkcs11-helper1-dev libprotobuf-c-dev libprotobuf-dev libprotoc-dev libsodium-dev libssl-dev libunwind-dev libwolfssl-dev libxxhash-dev libzstd-dev make musl-dev musl-tools nettle-dev ninja-build p7zip-full pandoc pkg-config protobuf-c-compiler protobuf-compiler python3-all python3-fuse python3-llfuse python3-pyfuse3 python3-setuptools ronn texinfo unrar xmlto yasm zlib1g-dev && \
  \
  : > /usr/bin/x86_64-linux-gnu-strip && \
  cd /usr/local && \
  ln -s lib lib64 && \
  \
  cd /usr/local/src && \
  mkdir -p /usr/local/src/stand && \
  git clone --recursive https://github.com/schnaader/precomp-cpp && \
  cd precomp-cpp && \
  cmake . && \
  make && \
  make install && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/Intensity/srep && \
  cd srep && ./Makefile install && mv /usr/local/bin/srep /usr/local/src/stand/ && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/Intensity/nzcc && \
  cd nzcc && ./Makefile install && mv /usr/local/bin/nzcc /usr/local/src/stand/ && \
  \
  cd /usr/local/src && \
  mkdir nanozip && \
  cd nanozip && \
  wget https://web.archive.org/web/20161102211532/http://nanozip.net/nanozip-0.09a.linux32.zip && \
  unzip nanozip-0.09a.linux32.zip && \
  cp -p nz /usr/local/src/stand/ && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/Intensity/mcm && \
  cd mcm && git checkout v0.84sk4 && \
  ./Makefile install && mv /usr/local/bin/mcm /usr/local/src/stand/ && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/IlyaGrebnov/bsc-m03 && \
  cd bsc-m03/ && \
  cmake . && \
  make && \
  cp -p bsc-m03 /usr/local/bin/ && \
  \
  cd /usr/local/src && \
  git clone https://github.com/miekg/rdup && \
  cd rdup && \
  autoreconf && \
  ./configure --enable-debug && \
  sed -i -e '/^CFLAGS=/s,$, -Wno-error,' GNUmakefile && \
  make && \
  make install && \
  : quite a few library deps && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/deadpixi/mtm && \
  cd mtm && \
  make && \
  make install && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/bwalex/tc-play && \
  cd tc-play && \
  cmake . && \
  make && \
  make install && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/ansemjo/aenker && \
  cd aenker && \
  make && \
  make install PREFIX=/usr/local && \
  \
  cd /usr/local/src && \
  git clone --recursive https://git.gavinhoward.com/gavin/bc && \
  cd bc && \
  ./configure.sh -g && \
  make && \
  make install && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/nlitsme/gnubc && \
  cd gnubc && \
  bash ./autogen.sh && \
  ./configure --program-prefix=g && \
  make && \
  make install && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/ttsiodras/rsbep-backup && \
  cd rsbep-backup && \
  aclocal && \
  ./configure && \
  make && \
  make install && \
  \
  cd /usr/local/src && \
  wget http://deb.debian.org/debian/pool/main/v/vdmfec/vdmfec_1.0-2.dsc && \
  wget http://deb.debian.org/debian/pool/main/v/vdmfec/vdmfec_1.0.orig.tar.gz && \
  wget http://deb.debian.org/debian/pool/main/v/vdmfec/vdmfec_1.0-2.diff.gz && \
  dpkg-source -x vdmfec_1.0-2.dsc && \
  cd vdmfec-1.0 && \
  ./debian/rules binary && \
  cd .. && \
  dpkg -i vdmfec_1.0-2_amd64.deb vdmfec-dbgsym_1.0-2_amd64.deb && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/Intensity/GLZA && \
  cd GLZA && \
  make && \
  cp -p ./GLZA /usr/local/bin/ && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/sisong/HDiffPatch && \
  cd HDiffPatch && \
  git clone https://github.com/sisong/libmd5.git ../libmd5 && \
  git clone https://github.com/sisong/lzma.git ../lzma && \
  git clone -b v1.5.2 https://github.com/facebook/zstd.git ../zstd && \
  make && \
  make install && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/julian-klode/ddelta && \
  cd ddelta && \
  make && \
  cp -p ddelta_generate ddelta_apply /usr/local/bin/ && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/lengfeld/blockdiff && \
  cd blockdiff && \
  make && \
  make tests && \
  make install install-doc prefix=usr/local && \
  \
  cd /usr/local/src && \
  cargo install orz --git https://github.com/richox/orz --tag v1.6.2 && \
  mv ~/.cargo/bin/orz /usr/local/bin/ && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/flanglet/kanzi-cpp && \
  cd kanzi-cpp/src && \
  git checkout b78f3d843232f225c9f9b26403fc2482649cb012 && \
  sed -i -e "s, -march=native , ${CFLAGS} ,g" Makefile && \
  make && \
  make install && \
  chmod --verbose 0755 /usr/local/bin/kanzi && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/jedisct1/dsvpn && \
  cd dsvpn && \
  echo " ${CFLAGS} " > .cflags && \
  make && \
  make install && \
  \
  cd /usr/local/src && \
  git clone --recursive https://git.sr.ht/~cmusser/vpnd && \
  cd vpnd && \
  make && \
  make install && \
  \
  cd /usr/local/src && \
  wget http://downloads.sourceforge.net/base91/base91-0.6.0.tar.gz && \
  tar xzpkf base91-*.tar.gz && \
  cd base91-0.6.0 && \
  make && \
  make install && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/wangyu-/tinyfecVPN && \
  cd tinyfecVPN && \
  make && \
  cp -p tinyvpn /usr/local/sbin/ && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/secgroup/Mignis && \
  cd Mignis && \
  python3 setup.py build && \
  python3 setup.py install && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/wangyu-/udp2raw && \
  cd udp2raw && \
  make && \
  cp -p udp2raw /usr/local/sbin/ && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/rescrv/encryptify && \
  cd encryptify && \
  autoreconf -ivf && \
  ./configure && \
  make && \
  make install && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/skeeto/enchive && \
  cd enchive && \
  make CFLAGS=" -DENCHIVE_AGENT_DEFAULT_ENABLED=0 ${CFLAGS} " install && \
  \
  cd /usr/local/src && \
  ARCH="$(uname -m)" && \
  URL=https://storage.googleapis.com/gvisor/releases/release/latest/${ARCH} && \
  wget ${URL}/runsc ${URL}/runsc.sha512 ${URL}/containerd-shim-runsc-v1 ${URL}/containerd-shim-runsc-v1.sha512 && \
  sha512sum -c runsc.sha512 -c containerd-shim-runsc-v1.sha512 && \
  chmod a+rx runsc containerd-shim-runsc-v1 && \
  mv runsc containerd-shim-runsc-v1 /usr/local/bin/ && \
  /usr/local/bin/runsc install && \
  unset ARCH && \
  unset URL && \
  \
  cd /usr/include && \
  ln -s libdrm drm && \
  cd /usr/local/src && \
  git clone --recursive https://github.com/checkpoint-restore/criu && \
  cd criu && \
  git checkout cd9680ce8935ba828ccdd59314442900c9699703 && \
  make && \
  make install && \
  rm -v /usr/include/drm && \
  \
  cd /usr/local/src && \
  wget https://openvpn.fox-it.com/repos/source/2.4.12/openvpn-nl-src-2.4.12.tar.gz && \
  tar xzpkf openvpn-nl-src-2.4.12.tar.gz && \
  cd openvpn-nl && \
  ./build-openvpn-nl.sh && \
  cp -p build-openvpn-nl/src/openvpn/openvpn /usr/local/sbin/ && \
  cp -p openvpn/doc/openvpn.8 /usr/local/share/man/man8/ && \
  mkdir -p /usr/local/share/doc/openvpn && \
  cp -a ./openvpn/sample /usr/local/share/doc/openvpn/sample/ && \
  \
  mkdir --verbose -p -m 0755 /var/empty && \
  groupadd sshd && \
  useradd -g sshd -c "sshd privsep" -d /var/empty -s /bin/false sshd && \
  cd /usr/local/src && \
  git clone --recursive https://github.com/open-quantum-safe/openssh && \
  cd openssh && \
  ./oqs-scripts/clone_liboqs.sh && \
  ./oqs-scripts/build_liboqs.sh  && \
  ./oqs-scripts/build_openssh.sh  && \
  echo ./oqs-test/run_tests.sh  && \
  make install prefix=/usr/local && \
  chmod --verbose a-s /usr/local/libexec/ssh-keysign 2>&1 | tee -a /usr/local/etc/permissions && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/openzfs/zfs && \
  cd zfs && \
  mkdir -p /usr/local/lib/udev/rules.d && \
  MAJMIN="$(git branch -a |grep staging|grep remotes/origin/zfs-2|sed 's,^ *remotes/origin/zfs-,,'|cut -d. -f1-2|sort -n | uniq  | tail -n 1 | sed 's,\.,\\.,')" && \
  git checkout zfs-$(eval echo $MAJMIN).$(git branch -a |grep staging|grep remotes/origin/zfs-2|sed 's,^ *remotes/origin/zfs-,,'|grep '^'"${MAJMIN}"'\.' | sed s,"${MAJMIN}\.",, | sort -n |uniq | tail -n 1) && \
  unset MAJMIN && \
  ./autogen.sh  && \
  ./configure --disable-nls --enable-sysvinit --disable-systemd --enable-debuginfo --with-config=user --with-mounthelperdir=/usr/local/sbin --with-udevdir=/usr/local/lib/udev && \
  make && \
  make check && \
  make install && \
  rm -r /usr/local/share/zfs/zfs-tests && \
  \
  apt-get source util-linux && \
  cd util-linux-* && \
  ./debian/rules binary && \
  for i in choom mkfs switch_root pivot_root blockdev unshare nsenter; do rm -v $i && V=1 make $i 2>&1 | grep '^libtool: link:' | tail -n 1 | sed 's,.*:,,' | sed 's,$, -static,' |sh && cp -p "$i" /usr/local/src/stand/ul_"$i"; done && \
  rm losetup && make losetup 2>&1 |grep '^libtool: link:' |tail -n 1| sed 's,.*:,,' |sed 's,$, -static ,' | sed 's,\.so ,.a ,g' | sh && cp -p .libs/losetup /usr/local/src/stand/ul_losetup && \
  \
  echo "deb-src http://deb.devuan.org/merged daedalus main contrib non-free" | tee -a /etc/apt/sources.list && \
  cd /usr/local/src && \
  apt-get update && \
  apt-get source podman-compose && \
  cd podman-compose-1* && \
  ./debian/rules binary && \
  cd .. && \
  dpkg -i podman-compose*all.deb && \
  \
  cd /usr/local/src && \
  wget https://github.com/mgoltzsche/podman-static/releases/download/v4.4.2/podman-linux-amd64.tar.gz && \
  tar -x -p -f podman-linux-amd64.tar.gz -k -v -z && \
  cd podman-linux-amd64/ && \
  tar -C usr/ -c -v -f - local/ | tar -C /usr/ -x -p -k -v -f - && \
  tar -c -v -f - etc/ | tar -C /usr/local/ -x -p -k -v -f - && \
  \
  cd /usr/local/src && \
  apt-get download binutils-x86-64-linux-gnu && \
  dpkg -i binutils-x86-64-linux-gnu_*_amd64.deb && \
  apt-get source toybox && \
  export LDFLAGS=-static && \
  export CC=musl-gcc && \
  ln -s /usr/include/asm-generic /usr/include/x86_64-linux-musl/asm-generic && \
  ln -s /usr/include/x86_64-linux-gnu/asm /usr/include/x86_64-linux-musl/asm && \
  ln -s /usr/include/linux /usr/include/x86_64-linux-musl/linux && \
  cd toybox*/ && \
  sed -i -e '/defconfig$/s/C/CC=musl-gcc C/' -e '/defconfig$/s/(LDFLAGS)"/(LDFLAGS) -static" LDFLAGS=-static /' debian/rules && \
  ./debian/rules binary && \
  dpkg -i ../toybox_*_amd64.deb && \
  ln generated/unstripped/toybox /usr/local/src/stand/ && \
  for i in acpi ascii base32 base64 blkid chattr chrt cksum comm count crc32 eject file flock fmt fsync getconf gpiodetect gpiofind gpioget gpioinfo gpioset help hexedit host iconv inotifyd install iorenice iotop killall5 lsattr lspci lsusb makedevs mcookie mix mountpoint nbd-client nbd-server netcat nice nohup oneit pgrep pkill pmap printenv prlimit pwdx pwgen readahead readelf rfkill rtcwake setfattr sha224sum sha384sum sha3sum sntp split uclampset ulimit unicode uuidgen vmstat; do ln /usr/local/src/stand/toybox /usr/local/src/stand/"$i"; done && \
  \
  cd /usr/local/src && \
  curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain stable && \
  source "/root/.cargo/env" && \
  git clone --recursive https://github.com/rosenpass/rosenpass && \
  cd rosenpass/ && \
  cargo install --path . && \
  mv -v ~/.cargo/bin/rosenpass /usr/local/sbin/ && \
  \
  cd /usr/local && \
  mkdir -v -p /opt/artifact/deb && \
  mv /usr/local/src/vdmfec*.deb /usr/local/src/podman-compose*all.deb /opt/artifact/deb/ && \
  mv /usr/local/src/stand/ /opt/artifact/stand/ && \
  rm -r src && \
  cd /usr && \
  rm -v /usr/local/lib/lib*.a /usr/local/lib/x86_64-linux-gnu/lib*.a && \
  mv local /opt/artifact/local/ && \
  rm -r /root/.cargo /root/.rustup && \
  true

FROM docker://alpine:3.17 AS alpine-builder

RUN \
  set -x && \
  set -e && \
  umask 02 && \
  cd /root && \
  export HOME=/root && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  exec </dev/null && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  export RUST_BACKTRACE=full && \
  export CXXFLAGS="-static -v" && \
  export CFLAGS="-static -v" && \
  export LDFLAGS=-static && \
  export RUST_LOG=info && \
  export PATH=/root/.cargo/bin:/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin && \
  export RUSTFLAGS=" -C link-arg=-static -C target-feature=+crt-static " && \
  export RUST_TEST_THREADS=1 && \
  apk update && \
  apk upgrade && \
  apk add asciidoctor autoconf automake bash ca-certificates cargo clang clang15-dev clang15-static cmake curl eudev-dev file findutils fuse3-dev g++ gcc git go ip6tables iptables libcap-dev libcap-static libseccomp-dev libseccomp-static libsodium-dev libsodium-static linux-headers llvm make meson musl-dev ninja openssh openssl-dev openssl-libs-static pkgconf protobuf protobuf-c-compiler protobuf-c-dev protobuf-dev protoc shadow-uidmap tzdata vim xz-dev xz-static && \
  cd /usr/local && \
  mkdir -p src bin sbin && \
  cd src && \
  for repository in zerotier/ZeroTierOne str4d/rage dpc/rdedup dswd/vpncloud BLAKE3-team/BLAKE3 dndx/phantun; do git clone --recursive https://github.com/"${repository}"; done && \
  cd /root && \
  curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain stable && rustup target add x86_64-unknown-linux-musl && \
  export CARGO_BUILD_TARGET=x86_64-unknown-linux-musl && \
  hash -r && \
  cd /usr/local/src/BLAKE3/b3sum && cargo install --path . && \
  cd /usr/local/src/phantun/phantun && cargo install --path . && \
  cd /usr/local/src/rage/rage && git checkout 7cfb7692afd4f93c52f690a40097e60bac573962 && rm ../rust-toolchain && cargo install --path . && \
  cd /usr/local/src/rdedup && mv /usr/lib/liblzma.so* /root/ && cargo install --path . && mv /root/liblzma* /usr/lib/ && \
  cd /usr/local/src/vpncloud && cargo install --path . && \
  cd /usr/local/src/ZeroTierOne && git checkout 1.10.3 && \
  (set +x; ZT_DEBUG=1 ZT_DEBUG_TRACE=1 ZT_TRACE=1 ZT_RULES_ENGINE_DEBUGGING=1 make zerotier-one || true; true) && \
  cd zeroidc/target/debug && \
  ln -s ../x86_64-unknown-linux-musl/debug/libzeroidc.a . && \
  cd ../../.. && \
  ZT_DEBUG=1 ZT_DEBUG_TRACE=1 ZT_TRACE=1 ZT_RULES_ENGINE_DEBUGGING=1 make zerotier-one && \
  mv zerotier-one /usr/local/sbin/ && \
  mkdir -p /usr/local/share/man/man8/ /usr/local/share/man/man1/ && \
  cp -p doc/zerotier-one.8 /usr/local/share/man/man8/ && \
  cp -p doc/zerotier-cli.1 /usr/local/share/man/man1/ && \
  cp -p doc/zerotier-idtool.1 /usr/local/share/man/man1/ && \
  cp -p ext/installfiles/linux/zerotier-one.te /usr/local/share/ && \
  cd /root/.cargo/bin && \
  mv b3sum rdedup rage-keygen rage /usr/local/bin/ && \
  mv vpncloud /usr/local/sbin/ && \
  mv server /usr/local/sbin/phantun-server && \
  mv client /usr/local/sbin/phantun-client && \
  cd /usr/local/sbin && \
  ln zerotier-one zerotier-cli && \
  ln zerotier-one zerotier-idtool && \
  (echo '#!/bin/sh'; echo "mkdir -p /var/lib/zerotier-one; ln -s /usr/local/sbin/zerotier-[cio]* /usr/local/share/zerotier-one.te /var/lib/zerotier-one") > /usr/local/sbin/zerotier-deploy && \
  chmod 0700 /usr/local/sbin/zerotier-deploy && \
  rm -r /usr/local/src /root/.cargo /root/.rustup /usr/lib/rustlib /usr/lib/go /usr/libexec /usr/lib/llvm15 && \
  rmdir -p --ignore-fail-on-non-empty /usr/local/lib/perl5/site_perl /usr/local/share/perl5/site_perl /usr/local/share/ca-certificates && \
  true

FROM docker://devuan/devuan:stable AS kernelbuild

ENV SHELL /bin/bash

COPY Configuration/config-5.10-hardened1-amd64 /tmp/config.amd64
COPY Configuration/config-5.10-hardened1-uml /tmp/config.uml
COPY Configuration/uml-static-build.patch /tmp/uml-static-build.patch

RUN \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin && \
  set -x && \
  set -e && \
  umask 02 && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  cd /root && \
  export LANG=C && \
  for insistence in Suggests Recommends; do echo APT::Install-"${insistence}" '"0";' | tee -a /etc/apt/apt.conf.d/42disable; done && \
  (for src in "" "-src"; do for repo in "" "-updates" "-security" "-backports"; do echo deb"${src}" http://deb.devuan.org/merged chimaera"${repo}" main contrib non-free; done; done) > /etc/apt/sources.list && \
  export DEBIAN_FRONTEND=noninteractive && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  export PYTHONDONTWRITEBYTECODE=1 && \
  export V=1 && \
  apt-get -y update && \
  apt-get -y --verbose-versions dist-upgrade && \
  apt-get -y --verbose-versions install apt-transport-https autoconf automake bash bc bear bindgen binutils binutils-common binutils-x86-64-linux-gnu bison build-essential ca-certificates cbindgen clang cmake coccinelle cpio cpp cpp-10 curl dc dpkg-dev ed file flex gcc gcc-10 git git-man gpg-agent iptables kmod less libaio-dev libasan6 libatomic1 libbinutils libbrotli1 libc-dev-bin libc6-dev libcbor-dev libcc1-0 libclang-11-dev libclang-dev libcrypt-dev libctf-nobfd0 libctf0 libcurl3-gnutls libcurl4 libedit2 libelf-dev libeudev-dev libexpat1 libgcc-10-dev libgdbm-compat4 libgdbm6 libgit2-1.1 libgomp1 libhttp-parser2.9 libisl23 libitm1 libldap-2.4-2 libllvm11 liblsan0 libmbedcrypto3 libmbedtls12 libmbedx509-0 libmpc3 libmpfr6 libncurses-dev libnghttp2-14 libnsl-dev libomp-11-dev libpcap-dev libpsl5 libquadmath0 librtmp1 libsasl2-2 libsasl2-modules-db libssh2-1 libssl-dev libtirpc-dev libtool libtsan0 libubsan1 libudev-dev libvdeplug-dev libz3-4 linux-base linux-libc-dev linux-perf llvm llvm-11-dev llvm-dev lsb-release make mandoc musl-tools nasm ninja-build openssl perf-tools-unstable pkgconf python3-pip python3-setuptools python3-wheel rsync software-properties-common sudo uuid-dev valgrind vim-common vim-tiny wget xxd zlib1g-dev zstd && \
  chmod --verbose a-s /bin/mount /bin/su /bin/umount /sbin/unix_chkpwd /usr/bin/chage /usr/bin/chfn /usr/bin/chsh /usr/bin/expiry /usr/bin/gpasswd /usr/bin/newgrp /usr/bin/passwd /usr/bin/wall /usr/bin/sudo && \
  find / -xdev -type f -perm -2000 -ls && \
  find / -xdev -type f -perm -4000 -ls && \
  rm -vf /var/cache/apt/archives/*.deb && \
  apt-get -y clean && \
  apt-get -y autoclean && \
  apt-get -y autoremove && \
  (rm -vf /etc/group- /etc/gshadow- /etc/passwd- /etc/shadow- || true) && \
  (rm -vf /etc/localtime || true) && \
  /usr/bin/env --chdir=/etc ln -svf ../usr/share/zoneinfo/Universal ./localtime && \
  cd /usr && \
  mkdir -p local/src && \
  cd local/src && \
  \
  git clone --recursive https://github.com/anthraxx/linux-hardened && \
  cd linux-hardened && \
  git checkout 5.10 && \
  git submodule init && \
  git submodule update && \
  mv -vf /tmp/config.amd64 .config && \
  \
  make deb-pkg && \
  rm -v ../linux-image-5.10.*hardened1-5.10-dbg_5.10.*-hardened1-5.10-1_amd64.deb && \
  dpkg -i ../linux*.deb && \
  make all install modules_install headers_install && \
  \
  cd .. && \
  export KERNEL_VERSION="$(ls -1trd /lib/modules/5.10.*-hardened*-5.10 | tail -n 1 | sed 's,/lib/modules/,,')" && \
  export CFLAGS=" -O2 -ggdb3 -fverbose-asm -mtune=generic " && \
  export CXXFLAGS=" ${CFLAGS} " && \
  (for line in '#!/bin/bash' 'if echo "$@" |grep -q -- -r >/dev/null' 'then' 'echo "${KERNEL_VERSION}"' 'else' 'exec /bin/uname "$@"' 'fi'; do echo "${line}"; done) > /usr/local/sbin/uname && chmod +x /usr/local/sbin/uname && \
  export PATH=/usr/local/sbin:"${PATH}" && \
  hash -r && \
  \
  git clone --recursive https://github.com/openzfs/zfs && \
  cd zfs && \
  MAJMIN="$(git branch -a |grep staging|grep remotes/origin/zfs-2|sed 's,^ *remotes/origin/zfs-,,'|cut -d. -f1-2|sort -n | uniq  | tail -n 1 | sed 's,\.,\\.,')" && \
  git checkout zfs-$(eval echo $MAJMIN).$(git branch -a |grep staging|grep remotes/origin/zfs-2|sed 's,^ *remotes/origin/zfs-,,'|grep '^'"${MAJMIN}"'\.' | sed s,"${MAJMIN}\.",, | sort -n |uniq | tail -n 1) && \
  unset MAJMIN && \
  ./autogen.sh && \
  ./configure --with-config=kernel --disable-nls --with-linux=/lib/modules/"${KERNEL_VERSION}"/source --with-linux-obj=/lib/modules/"${KERNEL_VERSION}"/build && \
  make && \
  make install && \
  cd .. && \
  \
  git clone --recursive https://github.com/amzn/amzn-drivers && \
  cd amzn-drivers/kernel/linux/ena && \
  make && \
  cp -p $(find . -name \*.ko -type f -print) /lib/modules/"${KERNEL_VERSION}"/extra/ && \
  mkdir ../efa/build && \
  cd ../efa/build && \
  cmake .. && \
  make && \
  cp -p $(find . -name \*.ko -type f -print) /lib/modules/"${KERNEL_VERSION}"/extra/ && \
  cd ../../../../.. && \
  \
  git clone --recursive https://github.com/GoogleCloudPlatform/compute-virtual-ethernet-linux && \
  cd compute-virtual-ethernet-linux && \
  SPATCH=$(which spatch) ./build_src.sh --target=oot && \
  make -C /lib/modules/"${KERNEL_VERSION}"/build M="$(pwd)"/build modules modules_install && \
  cd .. && \
  \
  git clone --recursive https://github.com/toby63/shiftfs-dkms && \
  cd shiftfs-dkms && \
  git checkout k5.10 && \
  make && \
  cp -p $(find . -name \*.ko -type f -print) /lib/modules/"${KERNEL_VERSION}"/extra/ && \
  cd .. && \
  \
  git clone --recursive https://github.com/Kicksecure/tirdad && \
  cd tirdad/module && \
  make -C /lib/modules/"${KERNEL_VERSION}"/build M="$(pwd)" modules modules_install && \
  cd ../.. && \
  \
  git clone --recursive https://github.com/intel/haxm && \
  cd haxm/platforms/linux && \
  mv -f haxm-install.sh haxm-install.sh- && \
  touch haxm-install.sh && \
  chmod +x haxm-install.sh && \
  make && \
  make install && \
  cd ../../.. && \
  \
  git clone --recursive https://github.com/mkubecek/vmware-host-modules && \
  cd vmware-host-modules && \
  git checkout $(git branch -a|grep origin/workstation- | sort|tail -n 1 | sed 's,.*/,,') && \
  make && \
  make install && \
  cd /usr/local/src && \
  \
  depmod -a "${KERNEL_VERSION}" && \
  echo Built "${KERNEL_VERSION}" && \
  export ORIG_VERSION="${KERNEL_VERSION}" && \
  sync && \
  \
  git clone --recursive https://github.com/anthraxx/linux-hardened linux-hardened-uml && \
  cd linux-hardened-uml && \
  git checkout 5.10 && \
  git submodule init && \
  git submodule update && \
  mv -vf /tmp/config.uml .config && \
  patch -p1 -F0 < /tmp/uml-static-build.patch && \
  rm -vf /tmp/uml-static-build.patch && \
  (tar -C ../linux-hardened/ -cf - certs | tar -xpvvkf - || true; true) && \
  rm -vf certs/*.o && \
  \
  unset KERNEL_VERSION && \
  mv -v /usr/local/sbin/uname /usr/local/sbin/uname-prev && \
  hash -r && \
  LDFLAGS_vmlinux=" -Wl,--start-group  -ldbus-1 -lutil -lrt -lpthread -Wl,--end-group " KBUILD_VMLINUX_LIBS=" -ldbus-1 " LDFLAGS=" -ldbus-1 " KBUILD_LDFLAGS=" -z noexecstack -z muldefs -ldbus-1 " make ARCH=um V=1 clean all modules modules_install && \
  export KERNEL_VERSION="$(ls -1trd /lib/modules/5.10.*-hardened*-5.10uml* | tail -n 1 | sed 's,/lib/modules/,,')" && \
  (for line in '#!/bin/bash' 'if echo "$@" |grep -q -- -r >/dev/null' 'then' 'echo "${KERNEL_VERSION}"' 'else' 'exec /bin/uname "$@"' 'fi'; do echo "${line}"; done) > /usr/local/sbin/uname && chmod +x /usr/local/sbin/uname && \
  hash -r && \
  cd .. && \
  \
  git clone --recursive https://github.com/Kicksecure/tirdad tirdad-uml && \
  cd tirdad-uml/module && \
  LDFLAGS_vmlinux=" -Wl,--start-group  -ldbus-1 -lutil -lrt -lpthread -Wl,--end-group " KBUILD_VMLINUX_LIBS=" -ldbus-1 " LDFLAGS=" -ldbus-1 " KBUILD_LDFLAGS=" -z noexecstack -z muldefs -ldbus-1 " make -C /lib/modules/"${KERNEL_VERSION}"/build M="${PWD}" ARCH=um V=1 clean modules modules_install && \
  cd ../.. && \
  \
  git clone --recursive https://github.com/toby63/shiftfs-dkms shiftfs-dkms-uml && \
  cd shiftfs-dkms-uml && \
  git checkout k5.10 && \
  LDFLAGS_vmlinux=" -Wl,--start-group  -ldbus-1 -lutil -lrt -lpthread -Wl,--end-group " KBUILD_VMLINUX_LIBS=" -ldbus-1 " LDFLAGS=" -ldbus-1 " KBUILD_LDFLAGS=" -z noexecstack -z muldefs -ldbus-1 " make ARCH=um V=1 clean && \
  LDFLAGS_vmlinux=" -Wl,--start-group  -ldbus-1 -lutil -lrt -lpthread -Wl,--end-group " KBUILD_VMLINUX_LIBS=" -ldbus-1 " LDFLAGS=" -ldbus-1 " KBUILD_LDFLAGS=" -z noexecstack -z muldefs -ldbus-1 " make ARCH=um V=1 && \
  cp -p $(find . -name \*.ko -type f -print) /lib/modules/"${KERNEL_VERSION}"/extra/ && \
  cd /usr/local/src && \
  depmod -a "${KERNEL_VERSION}" && \
  echo Built "${KERNEL_VERSION}" && \
  sync && \
  rm -f -v /boot/*.old && \
  rm -f -v /lib/modules/*/build && \
  rm -f -v /lib/modules/*/source && \
  find /lib/modules/5.*/*/ -type f -name '*.so' -exec strip --preserve-dates --strip-debug --no-merge-notes --keep-file-symbols --verbose -- \{\} \; && \
  find /lib/modules/5.*/*/ -type f -name '*.ko' -exec strip --preserve-dates --strip-debug --no-merge-notes --keep-file-symbols --verbose -- \{\} \; && \
  IMGFILE="$(ls -1trd linux-image-5.10.*-hardened1-5.10_5.10.*-hardened1-5.10-1_amd64.deb | tail -n 1)" && \
  mkdir ephemeral && \
  cd ephemeral && \
  ar x ../"${IMGFILE}" && \
  xz -d -v -v < data.tar.xz |tar -x -p -k -f - && \
  find usr/share/doc -name \*.gz -type f -exec gunzip -N -v -- \{\} \; && \
  cd lib/modules && \
  for i in 5.*; do rm -r "$i" && mv /lib/modules/"$i" .; done && \
  cd ../.. && \
  tar -cf - boot lib etc usr | xz --compress --stdout --check=crc32 -9 --extreme --threads=1 --verbose --verbose > data.tar.xz && \
  rm -v ../"${IMGFILE}" && \
  ar rcv ../"${IMGFILE}" debian-binary control.tar.xz data.tar.xz && \
  cd .. && \
  unset IMGFILE && \
  rm -r ephemeral && \
  rm -f /boot/* && \
  mv -v -f /usr/local/sbin/uname-prev /usr/local/sbin/uname && \
  dpkg -i linux-image-5.10.*-hardened1-5.10_5.10.*-hardened1-5.10-1_amd64.deb && \
  dpkg -i linux-libc-dev_5.10.*-hardened1-5.10-1_amd64.deb && \
  dpkg -i linux-headers-5.10.*-hardened1-5.10_5.10.*-hardened1-5.10-1_amd64.deb && \
  STDVER="$(yes n | apt-get install linux-image-amd64 2>&1 | tr ' ' '\n' |sort | uniq |grep linux-image-5.10 | tail -n 1)" && \
  apt-get download "${STDVER}" && \
  STDIMG="$(ls -1trd ${STDVER}*amd64.deb | tail -n 1)" && \
  mkdir ephemeral && \
  cd ephemeral && \
  ar x ../"${STDIMG}" && \
  mkdir ephemeral && \
  cd ephemeral && \
  xz -d -v -v < ../data.tar.xz | tar -x -p -k -f - && \
  rm -r -f lib/modules/5.10.0-*-amd64/* && \
  rm -v boot/vmlinuz-5.10.0-*-amd64  && \
  tar -cf - boot lib usr | xz --compress --stdout --check=crc32 -9 --extreme --threads=1 --verbose --verbose > ../data.tar.xz  && \
  cd .. && \
  rm -r ephemeral && \
  ar rcv ../"${STDIMG}" debian-binary control.tar.xz data.tar.xz  && \
  mkdir ephemeral && \
  cd ephemeral && \
  cat ../control.tar.xz |xz -d -v -v | tar -x -p -k -f - && \
  (grep boot/"[cS]" md5sums; grep usr/share/ md5sums) |sort | uniq > staging && \
  cat staging > md5sums && \
  rm -v staging && \
  for i in postinst postrm preinst prerm ; do : > $i ; done && \
  tar -c -v -f - control md5sums p* | xz --compress --stdout --check=crc32 -9 --extreme --threads=1 --verbose --verbose > ../control.tar.xz  && \
  cd .. && \
  rm -r ephemeral && \
  rm ../"${STDIMG}" && \
  ar rcv ../"${STDIMG}" debian-binary control.tar.xz data.tar.xz  && \
  cd .. && \
  rm -r ephemeral && \
  mkdir -p -v /opt/artifact/deb/ /opt/artifact/uml/ && \
  mv "${STDIMG}" /opt/artifact/deb/ && \
  mv -v linux-image-5.10.*-hardened1-5.10_5.10.*-hardened1-5.10-1_amd64.deb linux-libc-dev_5.10.*-hardened1-5.10-1_amd64.deb linux-headers-5.10.*-hardened1-5.10_5.10.*-hardened1-5.10-1_amd64.deb /opt/artifact/deb/ && \
  ./linux-hardened/scripts/extract-vmlinux /boot/vmlinuz-5.10.*-hardened1-5.10 > /opt/artifact/vmlinux-"${ORIG_VERSION}" && \
  unset ORIG_VERSION && \
  mv /lib/modules/5.10.*-hardened1-5.10uml-dirty/ /opt/artifact/uml/ && \
  mv linux-hardened-uml/linux /opt/artifact/uml/ && \
  cd /usr && \
  rm -r src local sbin /boot /lib/modules && \
  sync && \
  true

FROM devuan-4 AS devuan-4-local
COPY --from=devuan-4-builder /opt/artifact /root/artifact
COPY --from=alpine-builder /usr/local /root/local
COPY --from=kernelbuild /opt/artifact /root/kernel

RUN \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/stand && \
  set -x && \
  set -e && \
  umask 022 && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  cd /root && \
  export LANG=C && \
  export TMP=/tmp && \
  export TEMP="${TMP}" && \
  export TMPDIR="${TMP}" && \
  export DEBIAN_FRONTEND=noninteractive && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  export PYTHONDONTWRITEBYTECODE=1 && \
  exec </dev/null && \
  cat /root/artifact/local/etc/permissions >> /usr/local/etc/permissions && \
  rm -v /root/artifact/local/etc/permissions && \
  tar -C /root/artifact -c -v -f - local |tar -C /usr -x -p -v --warning=no-timestamp -f - && \
  tar -C /root/ -c -v -f - local|tar -C /usr -x -p -v --warning=no-timestamp -f - && \
  dpkg -i /root/artifact/deb/podman-compose*.deb /root/artifact/deb/vdmfec*.deb && \
  mv -v /root/artifact/stand/* /stand/ && \
  rm -r /root/artifact/ /root/local/ && \
  mkdir /root/ephemeral && \
  cd /root/ephemeral &&  \
  wget https://github.com/evilsocket/opensnitch/releases/download/v1.6.0-rc.5/opensnitch_1.6.0-rc.5-1_amd64.deb && \
  dpkg -i opensnitch_1.6.0-rc.5-1_amd64.deb && \
  cd /root && \
  for i in opensnitch; do update-rc.d "${i}" disable && update-rc.d "${i}" remove; done && \
  rm -r -v ephemeral && \
  for i in /root/kernel/deb/linux-image-5.10.*-hardened1-5.10_5.10.*-hardened1-5.10-1_amd64.deb /root/kernel/deb/linux-libc-dev_5.10.*-hardened1-5.10-1_amd64.deb; do dpkg -i "$i" && rm -v "${i}"; done && \
  dpkg -i /root/kernel/deb/linux-image-5.10.0-??-amd64_5.10.???-1_amd64.deb && \
  cd /lib/modules/5.10.*-hardened1-5.10 && \
  cd /root && \
  STDIMG="$(dpkg -l |grep linux-image-5.10 |grep -v linux-image-amd64 |grep -v linux-image'.*hardened' | awk '{print $2}' | tail -n 1)" && \
  apt-mark hold "${STDIMG}" && \
  echo "${STDIMG}" hold | dpkg --set-selections && \
  unset STDIMG && \
  dpkg -l >> /root/dpkg-l && \
  apt-get install -y --verbose-versions linux-image-amd64 && \
  cp -p -v /root/kernel/uml/linux /usr/local/bin/linux && \
  strip --preserve-dates --strip-debug --no-merge-notes --keep-file-symbols --verbose -- /usr/local/bin/linux && \
  mv /root/kernel/uml/5.10* /lib/modules/ && \
  mv /root/kernel/vmlinux-* /boot/ && \
  rm -r /root/kernel && \
  find /usr/local -type f -exec file -- \{\} \; |grep "ELF 64-bit LSB" |cut -f1 -d: |xargs -- strip --preserve-dates --strip-debug --no-merge-notes --keep-file-symbols --verbose -- && \
  strip --preserve-dates --strip-debug --no-merge-notes --keep-file-symbols --verbose -- /stand/[^b]* /stand/b[^a]* /stand/base* && \
  find /usr/lib /usr/share /usr/local -maxdepth 24 -name "*.pyc" -type f -ls -delete && \
  (set +e; find /usr/lib /usr/share /usr/local -maxdepth 24 -name __pycache__ -type d -print | xargs rmdir -v -- || true; true) && \
  rm -v -f /usr/share/javascript/underscore/underscore.min.js /usr/share/javascript/underscore/underscore.min.js.map /usr/share/javascript/jquery/jquery.min.map /usr/share/javascript/jquery/jquery.min.js && \
  rm -r /usr/share/locale/[^e]* /usr/share/locale/e[^n]* && \
  : > /var/log/dpkg.log && \
  rm -v -f /root/.wget-hsts && \
  rm -v -f /var/lib/dpkg/status-old && \
  find /usr/share /usr/lib/x86_64-linux-gnu /usr/local/share -name \*.gz -type l -ls -delete && \
  find /usr/share /usr/lib/x86_64-linux-gnu /usr/local/share -name \*.gz -type f -exec gunzip -N -v -- \{\} \; && \
  cd /root && \
  chown -R root:root /usr/local/etc/cni /usr/local/etc/containers /usr/local/share/man /usr/local/share/doc /usr/local/bin /usr/local/lib && \
  find / -xdev -name "*.pyc" -ls && \
  find / -xdev -name "__pycache__" -ls && \
  find / -xdev -type f -perm -2000 -ls && \
  find / -xdev -type f -perm -4000 -ls && \
  find / -xdev -type f -perm -0002 -ls && \
  find / -xdev -type d -perm -0002 -ls && \
  find /usr -type f -name \*.gz -ls && \
  true

FROM devuan-4-local AS devuan-4-kicksecure

RUN \
  packages_kicksecure_dep=" \
    acpi-support \
    acpi-support-base \
    acpid \
    apparmor \
    apparmor-profiles \
    apparmor-profiles-extra \
    apparmor-utils \
    apt-transport-tor \
    apt-utils \
    autoconf \
    automake \
    autopoint \
    autotools-dev \
    bind9-dnsutils \
    codecrypt \
    console-common \
    console-data \
    console-setup \
    console-setup-linux \
    cpp \
    cpp-10 \
    cython3 \
    dbus \
    dbus-x11 \
    dconf-gsettings-backend \
    dconf-service \
    dctrl-tools \
    debhelper \
    debsums \
    dh-autoreconf \
    dh-strip-nondeterminism \
    dialog \
    diceware \
    dirmngr \
    distro-info-data \
    dkms \
    dnsutils \
    dpkg-dev \
    dwz \
    elogind \
    equivs \
    extrepo \
    fasttrack-archive-keyring \
    flatpak \
    fontconfig \
    fontconfig-config \
    fonts-dejavu-core \
    fonts-font-awesome \
    fonts-lato \
    gcc \
    gcc-10 \
    geoip-database \
    gettext \
    gettext-base \
    glib-networking \
    glib-networking-common \
    glib-networking-services \
    gnupg \
    gnupg-l10n \
    gnupg-utils \
    gpg \
    gpg-agent \
    gpg-wks-client \
    gpg-wks-server \
    gpgconf \
    gpgsm \
    gsettings-desktop-schemas \
    init \
    initramfs-tools \
    initramfs-tools-core \
    initscripts \
    inotify-tools \
    insserv \
    intltool-debian \
    iotop \
    iw \
    kbd \
    keyboard-configuration \
    libappstream-glib8 \
    libarchive-zip-perl \
    libasan6 \
    libatasmart4 \
    libatomic1 \
    libavahi-client3 \
    libavahi-common-data \
    libavahi-common3 \
    libavahi-glib1 \
    libblockdev-crypto2 \
    libblockdev-fs2 \
    libblockdev-loop2 \
    libblockdev-part-err2 \
    libblockdev-part2 \
    libblockdev-swap2 \
    libblockdev-utils2 \
    libblockdev2 \
    libbluetooth3 \
    libbytes-random-secure-perl \
    libc-dev-bin \
    libc-l10n \
    libc6-dev \
    libcc1-0 \
    libcrypt-dev \
    libcrypt-passwdmd5-perl \
    libcrypt-random-seed-perl \
    libcryptx-perl \
    libdconf1 \
    libdebhelper-perl \
    libdeflate0 \
    libdouble-conversion3 \
    libdpkg-perl \
    libdrm-amdgpu1 \
    libdrm-common \
    libdrm-intel1 \
    libdrm-nouveau2 \
    libdrm-radeon1 \
    libdrm2 \
    libegl-mesa0 \
    libegl1 \
    libelogind0 \
    libencode-locale-perl \
    libevdev2 \
    libfftw3-double3 \
    libfile-fnmatch-perl \
    libfile-listing-perl \
    libfile-stripnondeterminism-perl \
    libfontconfig1 \
    libfreetype6 \
    libgbm1 \
    libgcc-10-dev \
    libgdk-pixbuf-2.0-0 \
    libgdk-pixbuf2.0-common \
    libgeoip1 \
    libgl1 \
    libgl1-mesa-dri \
    libglapi-mesa \
    libglib2.0-bin \
    libglib2.0-data \
    libglvnd0 \
    libglx-mesa0 \
    libglx0 \
    libgpgme11 \
    libgraphite2-3 \
    libgudev-1.0-0 \
    libharfbuzz0b \
    libhtml-parser-perl \
    libhtml-tagset-perl \
    libhtml-tree-perl \
    libhttp-cookies-perl \
    libhttp-date-perl \
    libhttp-message-perl \
    libhttp-negotiate-perl \
    libice6 \
    libinotifytools0 \
    libinput-bin \
    libinput10 \
    libio-html-perl \
    libisl23 \
    libitm1 \
    libjbig0 \
    libjpeg62-turbo \
    libjs-jquery \
    libjs-sphinxdoc \
    libjs-underscore \
    libjson-glib-1.0-0 \
    libjson-glib-1.0-common \
    libksba8 \
    libllvm11 \
    liblocale-gettext-perl \
    liblsan0 \
    liblwp-mediatypes-perl \
    liblwp-protocol-https-perl \
    libmalcontent-0-0 \
    libmath-random-isaac-perl \
    libmd4c0 \
    libmm-glib0 \
    libmpc3 \
    libmpdec3 \
    libmtdev1 \
    libndp0 \
    libnet-http-perl \
    libnewt0.52 \
    libnl-route-3-200 \
    libnm0 \
    libnpth0 \
    libnsl-dev \
    libnspr4 \
    libnss3 \
    libntfs-3g883 \
    libostree-1-1 \
    libpam-elogind \
    libparted-fs-resize0 \
    libpciaccess0 \
    libpcre2-16-0 \
    libpcsclite1 \
    libpkcs11-helper1 \
    libpng16-16 \
    libpolkit-agent-1-0 \
    libpolkit-gobject-1-0 \
    libpolkit-gobject-elogind-1-0 \
    libproxy1v5 \
    libpython3-stdlib \
    libpython3.9-minimal \
    libpython3.9-stdlib \
    libqt5core5a \
    libqt5dbus5 \
    libqt5gui5 \
    libqt5network5 \
    libqt5widgets5 \
    libquadmath0 \
    libsecret-1-0 \
    libsecret-common \
    libslang2 \
    libsm6 \
    libsnappy1v5 \
    libsoup2.4-1 \
    libsqlite3-0 \
    libstemmer0d \
    libsub-override-perl \
    libsysfs2 \
    libteamdctl0 \
    libtiff5 \
    libtirpc-dev \
    libtool \
    libtry-tiny-perl \
    libtsan0 \
    libubsan1 \
    libudisks2-0 \
    liburi-perl \
    libvolume-key1 \
    libvulkan1 \
    libwacom-common \
    libwacom2 \
    libwayland-client0 \
    libwayland-server0 \
    libwebp6 \
    libwww-perl \
    libwww-robotrules-perl \
    libx11-6 \
    libx11-data \
    libx11-xcb1 \
    libxau6 \
    libxaw7 \
    libxcb-dri2-0 \
    libxcb-dri3-0 \
    libxcb-glx0 \
    libxcb-icccm4 \
    libxcb-image0 \
    libxcb-keysyms1 \
    libxcb-present0 \
    libxcb-randr0 \
    libxcb-render-util0 \
    libxcb-render0 \
    libxcb-shape0 \
    libxcb-shm0 \
    libxcb-sync1 \
    libxcb-util1 \
    libxcb-xfixes0 \
    libxcb-xinerama0 \
    libxcb-xinput0 \
    libxcb-xkb1 \
    libxcb1 \
    libxcursor1 \
    libxdamage1 \
    libxdmcp6 \
    libxext6 \
    libxfixes3 \
    libxi6 \
    libxkbcommon-x11-0 \
    libxkbcommon0 \
    libxmu6 \
    libxmuu1 \
    libxpm4 \
    libxrandr2 \
    libxrender1 \
    libxshmfence1 \
    libxt6 \
    libxxf86vm1 \
    libyaml-0-2 \
    libyaml-libyaml-perl \
    libz3-4 \
    libzulucrypt-exe1.2.0 \
    libzulucrypt-plugins \
    libzulucrypt1.2.0 \
    libzulucryptpluginmanager1.0.0 \
    linux-base \
    linux-compiler-gcc-10-x86 \
    linux-headers-5.10.0-21-amd64 \
    linux-headers-5.10.0-21-common \
    linux-headers-amd64 \
    linux-kbuild-5.10 \
    linux-libc-dev \
    live-boot \
    live-boot-initramfs-tools \
    live-tools \
    locales \
    lsb-release \
    m4 \
    magic-wormhole \
    make \
    makepasswd \
    media-types \
    menu \
    most \
    nano \
    network-manager \
    ntfs-3g \
    obfs4proxy \
    openvpn \
    p7zip \
    p7zip-full \
    po-debconf \
    policykit-1 \
    policyrcd-script-zg2 \
    pwgen \
    python3 \
    python3-apparmor \
    python3-attr \
    python3-autobahn \
    python3-automat \
    python3-bcrypt \
    python3-cbor \
    python3-certifi \
    python3-cffi-backend \
    python3-chardet \
    python3-click \
    python3-colorama \
    python3-constantly \
    python3-cryptography \
    python3-dateutil \
    python3-geoip \
    python3-hamcrest \
    python3-hkdf \
    python3-humanize \
    python3-hyperlink \
    python3-idna \
    python3-incremental \
    python3-libapparmor \
    python3-lz4 \
    python3-minimal \
    python3-nacl \
    python3-openssl \
    python3-pkg-resources \
    python3-pyasn1 \
    python3-pyasn1-modules \
    python3-pyqrcode \
    python3-requests \
    python3-scapy \
    python3-sdnotify \
    python3-service-identity \
    python3-six \
    python3-snappy \
    python3-socks \
    python3-spake2 \
    python3-stem \
    python3-tqdm \
    python3-trie \
    python3-twisted \
    python3-twisted-bin \
    python3-txaio \
    python3-txtorcon \
    python3-u-msgpack \
    python3-ubjson \
    python3-urllib3 \
    python3-wsaccel \
    python3-yaml \
    python3-zope.interface \
    python3.9 \
    python3.9-minimal \
    secure-delete \
    shared-mime-info \
    spectre-meltdown-checker \
    sphinx-rtd-theme-common \
    startpar \
    sudo \
    sysfsutils \
    sysv-rc \
    udisks2 \
    vrms \
    wpasupplicant \
    x11-common \
    x11-xserver-utils \
    xdg-dbus-proxy \
    xdg-utils \
    xkb-data \
    zulucrypt-cli \
  " && \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/stand && \
  set -x && \
  set -e && \
  umask 077 && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  cd /root && \
  export LANG=C && \
  export TMP=/tmp && \
  export TEMP="${TMP}" && \
  export TMPDIR="${TMP}" && \
  export DEBIAN_FRONTEND=noninteractive && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  export PYTHONDONTWRITEBYTECODE=1 && \
  exec </dev/null && \
  rm -v -f /root/dpkg-l && \
  apt-get -y update && \
  apt-get -y --verbose-versions dist-upgrade && \
  apt-get -y --verbose-versions install ${packages_kicksecure_dep} && \
  curl --tlsv1.3 --proto =https --max-time 180 --output /usr/share/keyrings/derivative.asc https://www.kicksecure.com/keys/derivative.asc && \
  chmod --verbose go+r /usr/share/keyrings/derivative.asc && \
  adduser --disabled-password --gecos "" --force-badname --shell /bin/bash-static Administrator && \
  adduser --disabled-password --gecos "" --shell /bin/bash-static user && \
  adduser Administrator sudo && \
  addgroup --system console && \
  adduser Administrator console && \
  echo "deb [signed-by=/usr/share/keyrings/derivative.asc] https://deb.kicksecure.com bullseye main contrib non-free" | tee -a /etc/apt/sources.list.d/derivative.list && \
  chmod --verbose go+r /etc/apt/sources.list.d/derivative.list && \
  apt-get -y update && \
  apt-get -y --verbose-versions dist-upgrade && \
  apt-get -y --verbose-versions install apparmor-profiles-kicksecure debug-misc hardened-malloc kicksecure-base-files kicksecure-default-applications-cli kicksecure-dependencies-cli kicksecure-network-conf non-qubes-vm-enhancements-cli open-link-confirmation security-misc usability-misc && \
  mkdir -v ephemeral && \
  cd ephemeral && \
  apt-get download systemcheck && \
  package=$(ls -1d systemcheck_*_all.deb) && \
  ar xv "${package}" && \
  xz -dvv < control.tar.xz | tar -xpkvvf - && \
  sed -i -e "s/, systemd, /, /" control && \
  : > postinst && \
  : > postrm && \
  : > prerm && \
  tar -c -v -f - conffiles control md5sums postinst postrm preinst prerm |xz -vv > control.tar.xz && \
  rm -v "${package}" && \
  ar rcv "${package}" debian-binary control.tar.xz data.tar.xz && \
  dpkg -i --force-all "${package}" && \
  unset package && \
  cd /root && \
  rm -r -v ephemeral && \
  mkdir -v ephemeral && \
  cd ephemeral && \
  apt-get download libsystemd0 && \
  ar xv libsystemd*.deb && \
  xz -dvv < data.tar.xz |tar -x -vv -p -f - ./usr/lib/x86_64-linux-gnu && \
  tar -C ./usr/lib/ -c -v -f - x86_64-linux-gnu/ | tar -C /usr/lib/ -x -p -v -f - && \
  cd /root && \
  rm -r -v ephemeral && \
  apt-get install -y --verbose-versions kicksecure-cli-vm && \
  mkdir -p -v /usr/local/src/attic/etc/apt/sources.list.d /usr/local/src/attic/etc/profile.d && \
  mv -v /etc/apt/sources.list.d/debian.list /usr/local/src/attic/etc/apt/sources.list.d/debian.list && \
  apt-get -y update && \
  apt-get -y --verbose-versions dist-upgrade && \
  sed -i -e '/Defaults.*secure_path/s,secure_path="[^"]*",secure_path="/sbin:/bin:/usr/sbin:/usr/bin",' /etc/sudoers && \
  mv -v /etc/profile.d/30_setup.sh /usr/local/src/attic/etc/profile.d/ && \
  find /usr/lib /usr/share -maxdepth 24 -name "*.pyc" -ls -delete && \
  find /usr/lib /usr/share -maxdepth 24 -name __pycache__ -type d -print | xargs rmdir -v -- && \
  apt-get -y clean && \
  apt-get -y autoclean && \
  apt-get -y autoremove && \
  rm -r -v /usr/share/man/[^m]*/ && \
  (rm -v /etc/group- /etc/gshadow- /etc/passwd- /etc/shadow- /etc/subgid- /etc/subuid- || true) && \
  rm -v /var/cache/debconf/config.dat-old /var/cache/debconf/templates.dat-old /var/lib/dpkg/diversions-old /var/lib/dpkg/status-old /var/lib/dpkg/statoverride-old && \
  dpkg -l > /root/dpkg-l && \
  unset PYTHONDONTWRITEBYTECODE && \
  rm -v /etc/.pwd.lock && \
  : > /var/log/alternatives.log && \
  : > /var/log/dpkg.log && \
  : > /var/log/apt/term.log && \
  : > /var/log/apt/history.log && \
  : > /var/log/fontconfig.log && \
  : > /var/log/alternatives.log && \
  : |xz -vv > /var/log/apt/eipp.log.xz && \
  chmod --verbose -R go-rwx /home/* /etc/skel && \
  (echo umask 077; echo export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/stand) | tee -a /etc/skel/.bashrc.kicksecure && \
  find /tmp /var/tmp -type f -ls -delete && \
  chmod --verbose -R go-rwx /root && \
  chmod --verbose a-s /bin/ntfs-3g /usr/bin/pkexec /usr/bin/sudo /usr/lib/dbus-1.0/dbus-daemon-launch-helper /usr/libexec/polkit-agent-helper-1 /usr/bin/schroot 2>&1 | tee -a /usr/local/etc/permissions && \
  echo /usr/lib/libhardened_malloc.so/libhardened_malloc.so |tee -a /etc/ld.so.preload && \
  find /usr/share/doc /usr/share/info /usr/share/man -name \*.gz -type l -ls -delete && \
  find /usr/share/doc /usr/share/info /usr/share/man -name \*.gz -type f -exec gunzip -N -v -- \{\} \; && \
  find /etc/alternatives -name \*.gz -type l -ls -delete && \
  find / -xdev -name "*.pyc" -ls && \
  find / -xdev -name "__pycache__" -ls && \
  find / -xdev -type f -perm -2000 -ls && \
  find / -xdev -type f -perm -4000 -ls && \
  find / -xdev -type f -perm -0002 -ls && \
  find / -xdev -type d -perm -0002 -ls && \
  true

FROM docker://devuan/devuan:stable AS devuan-4-hardenedmalloc

COPY --from=devuan-4-kicksecure /usr/lib/libhardened_malloc.so/ /usr/lib/libhardened_malloc.so/
COPY --from=devuan-4-kicksecure /root/dpkg-l /root/dpkg-l-kicksecure
COPY --from=devuan-4-local / /root/initrd/
COPY --from=kernelbuild /opt/artifact /root/kernel
COPY Scripts/05entropy /root/

ENV SHELL /bin/bash-static

RUN \
  module_list=" 8021q ac aes_generic aesni_intel af_alg af_packet agpgart algif_skcipher async_memcpy async_pq async_raid6_recov async_tx async_xor ata_generic ata_piix blktap bochs_drm br_netfilter bridge button ccp cdrom cec cfbcopyarea cfbfillrect cfbimgblt chacha_x86_64 crc16 crc32_pclmul crc32c_generic crc32c_intel crc_ccitt crc_t10dif crct10dif_common crct10dif_generic crct10dif_pclmul cryptd crypto_simd ctr curve25519_x86_64 dm_crypt dm_log dm_mirror dm_mod dm_region_hash drm drm_kms_helper drm_panel_orientation_quirks drm_ttm_helper drm_vram_helper e1000 ecb ecryptfs efi_pstore ehci_hcd ehci_pci encrypted_keys evdev ext2 ext3 ext4 fat fb fb_sys_fops fbdev floppy fuse garp gcm gf128mul ghash_clmulni_intel ghash_generic glue_helper hid hid_generic i2c_core i2c_piix4 icp ide_cd_mod ide_core ide_gd_mod ide_pci_generic input_leds intel_agp intel_gtt intel_rapl_common intel_rapl_msr ip6_tables ip6_udp_tunnel ip6table_filter ip6table_mangle ip_tables iptable_filter iptable_mangle iptable_nat ipv6 irqbypass isofs jbd2 joydev kvm kvm_amd libaes libata libchacha libchacha20poly1305 libcrc32c libcurve25519_generic linear llc loop mbcache md_mod mousedev mptbase mptscsih mptspi mrp multipath nf_conntrack nf_conntrack_ftp nf_conntrack_irc nf_conntrack_pptp nf_conntrack_sip nf_defrag_ipv4 nf_defrag_ipv6 nf_log_common nf_log_ipv4 nf_log_ipv6 nf_nat nf_tables nfnetlink nft_chain_nat nft_compat nft_counter nls_ascii nls_cp437 nls_utf8 parport parport_pc pata_acpi pcspkr piix pktcdvd poly1305_x86_64 ppdev psmouse qemu_fw_cfg raid0 raid1 raid10 raid456 raid6_pq rng_core scsi_mod scsi_transport_spi sd_mod serio_raw serpent-avx-x86_64 serpent-avx2 serpent-sse2-x86_64 serpent_avx_x86_64 serpent_generic serpent_sse2_x86_64 sg simpledrm snd snd-pcm snd_timer soundcore spl squashfs sr_mod stp syscopyarea sysfillrect sysimgblt t10_pi tap tls tpm trusted ttm tun udp_tunnel uhci_hcd usb_common usb_storage usbcore usbhid veth vfat vmw_pvscsi vmw_vmci vmwgfx vmxnet3 wireguard x_tables xen-blkback xen-evtchn xen-gntdev xen-netback xen-pciback xen_blkback xen_evtchn xen_gntdev xen_netback xen_pciback xen_privcmd xenfs xfs xor xt_LOG xt_MASQUERADE xt_comment xt_connmark xt_conntrack xt_helper xt_limit xt_physdev xt_tcpudp xts zavl zcommon zfs zlua znvpair zunicode zzstd " && \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin && \
  set -x && \
  set -e && \
  umask 022 && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  cd /root && \
  export LANG=C && \
  export TMP=/tmp && \
  export TEMP="${TMP}" && \
  export TMPDIR="${TMP}" && \
  export DEBIAN_FRONTEND=noninteractive && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  export PYTHONDONTWRITEBYTECODE=1 && \
  exec </dev/null && \
  for insistence in Suggests Recommends; do echo APT::Install-"${insistence}" '"0";' | tee -a /etc/apt/apt.conf.d/42disable; done && \
  (for src in "" "-src"; do for repo in "" "-updates" "-security" "-backports"; do echo deb"${src}" http://deb.devuan.org/merged chimaera"${repo}" main contrib non-free; done; done) > /etc/apt/sources.list && \
  apt-get update && \
  apt-get -y --verbose-versions dist-upgrade && \
  apt-get -y install --verbose-versions linux-image-amd64 efibootmgr qemu-system-x86 tar cpio zstd findutils qemu-utils xz-utils initramfs-tools-core && \
  rm -r -f /lib/modules/5.10.0-[0-9][0-9]-amd64/ /root/initrd/lib/modules/5.10.0-[0-9][0-9]-amd64/ && \
  rm -v /boot/vmlinuz* /boot/initr* && \
  rm -v -f /boot/System.map-5.10.0-??-amd64 /boot/config-5.10.0-??-amd64 && \
  cp -p -v /root/initrd/boot/vmlinu* /boot/ && \
  mkdir -v -p /opt/artifact/meta && \
  mv -v -f /root/initrd/root/dpkg-l /opt/artifact/meta/dpkg-l-base && \
  mv -v -f /root/dpkg-l-kicksecure /opt/artifact/meta/dpkg-l-kicksecure && \
  cd /root/initrd && \
  tar -C /usr/lib/ -c -v -f - libhardened_malloc.so/ | tar -C ./usr/lib/ -x -p -k -v -v --warning=no-timestamp -f - && \
  mkdir -p -v dev proc sys run && \
  chmod --verbose go+rx sys proc dev run . && \
  : > etc/modules && \
  echo ${module_list} |tr " " '\n'|sort |uniq >> etc/modules && \
  unset module_list && \
  cat etc/modules > /etc/modules && \
  cd /root/initrd && \
  echo localhost > etc/hostname && \
  echo 0x00000000 > etc/hostid && \
  echo nameserver 1.1.1.1 > etc/resolv.conf && \
  ( echo '#!/bin/bash-static' && \
    echo "set -x" && \
    echo "exec </dev/null" && \
    echo "umask 022" && \
    echo "ulimit -v unlimited" && \
    echo "ulimit -d unlimited" && \
    echo "export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/stand:/usr/local/sbin:/usr/local/bin" && \
    echo "export LD_LIBRARY_PATH=/lib/x86_64-linux-gnu:/usr/lib/x86_64-linux-gnu:/opt/bootstrap/lib/x86_64-linux-gnu" && \
    echo "mount -v -t proc proc /proc" && \
    echo "mount -v -t sysfs sysfs /sys" && \
    echo "mount -v -t devtmpfs devtmpfs /dev" && \
    echo "mount -v -t tmpfs tmpfs /run" && \
    echo "mkdir -v -p /run/tmp" && \
    echo "mount -v -t tmpfs tmpfs /run/tmp" && \
    echo "export TMP=/run/tmp" && \
    echo 'export TEMP="${TMP}"' && \
    echo 'export TMPDIR="${TMP}"' && \
    echo "chmod --verbose go-w /run/. /dev/. /." && \
    echo 'hostname $(cat /etc/hostname)' && \
    echo "rmdir -v /usr" && \
    echo "rmdir -v /var" && \
    echo "mkdir -v /usr" && \
    echo "mv -v /opt/bootstrap/bin /usr/bin" && \
    echo "mv -v /opt/bootstrap/sbin /usr/sbin" && \
    echo "hash -r" && \
    echo '/sbin/modprobe loop max_loop=256' && \
    echo 'grep "^[^#]" /etc/modules | awk '\''{print $1}'\'' | xargs -n 1 /sbin/modprobe' && \
    echo 'grep "^[^#]" /etc/modules | awk '\''{print $1}'\'' | while read module; do modprobe "${module}" || true; done' && \
    echo "/etc/init.d/kmod start" && \
    echo "sleep 2" && \
    echo "sync" && \
    echo "/etc/init.d/eudev start" && \
    echo "sleep 2" && \
    echo "sync" && \
    echo "udevadm settle" && \
    echo "sleep 2" && \
    echo "udevadm trigger" && \
    echo "sync" && \
    echo "sleep 2" && \
    echo "/etc/init.d/eudev stop" && \
    echo "sync" && \
    echo "sleep 2" && \
    echo "mkdir /new" && \
    echo "mount -v -t tmpfs -o nosuid,nodev,sync,noatime,nodiratime,dirsync,loud,nouser tmpfs /new" && \
    echo "chmod --verbose go-w /new/." && \
    echo "mkdir -v -p /mnt/CACHE" && \
    echo "/stand/e2fsck -p -v /dev/disk/by-partlabel/CACHE || true" && \
    echo "mount -v -t ext4 -o debug,ro /dev/disk/by-partlabel/CACHE /mnt/CACHE" && \
    echo "umask 077" && \
    echo "mkdir -v -p /mnt/VOLATILE" && \
    echo 'dd if=/dev/zero of="${TMP}"/luks.header bs=1048576 count=0 seek=4' && \
    echo 'dd if=/dev/urandom bs=8192 count=1 2>/dev/null | /stand/sha512sum | /stand/awk '\''{print $1}'\'' > "${TMP}"/luks.pass' && \
    echo "/etc/init.d/eudev start" && \
    echo "sleep 2" && \
    echo 'cryptsetup luksFormat --type=luks1 --batch-mode=yes --verbose --cipher=aes-xts-plain64 --hash=sha256 --key-size=512 --header="${TMP}"/luks.header --key-file="${TMP}"/luks.pass /dev/disk/by-partlabel/VOLATILE' && \
    echo "sleep 2" && \
    echo "sync" && \
    echo 'cryptsetup luksOpen --verbose --header="${TMP}"/luks.header --key-file="${TMP}"/luks.pass /dev/disk/by-partlabel/VOLATILE VOLATILE &' && \
    echo 'PID=$!' && \
    echo "sleep 20" && \
    echo "sync" && \
    echo "dmsetup udevcomplete_all --yes" && \
    echo "sleep 5" && \
    echo "dmsetup udevcomplete_all --yes" && \
    echo "sleep 8" && \
    echo "dmsetup udevcomplete_all --yes" && \
    echo "sleep 3" && \
    echo "sync" && \
    echo 'kill "${PID}" >/dev/null 2>/dev/null' && \
    echo "sleep 3" && \
    echo 'kill -9 "${PID}" >/dev/null 2>/dev/null' && \
    echo "unset PID" && \
    echo "udevadm settle" && \
    echo "sleep 2" && \
    echo "udevadm trigger" && \
    echo "sync" && \
    echo "/etc/init.d/eudev stop" && \
    echo 'mkfs.ext4 -e continue -j -L VOLATILE-"${RANDOM}" -m 8 -M /mnt/VOLATILE -v -F -F /dev/mapper/VOLATILE' && \
    echo "mount -v -t ext4 -o debug /dev/mapper/VOLATILE /mnt/VOLATILE" && \
    echo "mkdir /mnt/VOLATILE/tmp" && \
    echo 'rm -f "${TMP}"/luks.header "${TMP}"/luks.pass' && \
    echo "export TMP=/mnt/VOLATILE/tmp" && \
    echo 'export TEMP="${TMP}"' && \
    echo 'export TMPDIR="${TMP}"' && \
    echo "zstd -dvv -T1 -single-thread --long=30 < /mnt/CACHE/overlay/overlay*tar.zst |tar -C / -x -p -k --warning=no-timestamp -f -" && \
    echo "umask 022" && \
    echo "export TMP=/run/tmp" && \
    echo 'export TEMP="${TMP}"' && \
    echo 'export TMPDIR="${TMP}"' && \
    echo "umount -v /mnt/VOLATILE" && \
    echo "sleep 3" && \
    echo "/etc/init.d/eudev start" && \
    echo "cryptsetup luksClose VOLATILE &" && \
    echo 'PID=$!' && \
    echo "sync" && \
    echo "sleep 18" && \
    echo "sync" && \
    echo "dmsetup udevcomplete_all --yes" && \
    echo "sleep 8" && \
    echo "dmsetup udevcomplete_all --yes" && \
    echo "sleep 4" && \
    echo "dmsetup udevcomplete_all --yes" && \
    echo "sleep 2" && \
    echo "sync" && \
    echo 'kill "${PID}" >/dev/null 2>/dev/null' && \
    echo "sleep 3" && \
    echo 'kill -9 "${PID}" >/dev/null 2>/dev/null' && \
    echo "unset PID" && \
    echo "udevadm settle" && \
    echo "sleep 2" && \
    echo "udevadm trigger" && \
    echo "sync" && \
    echo "rmdir -v /mnt/VOLATILE" && \
    echo "/etc/init.d/eudev stop" && \
    echo "mv -v /usr/bin /opt/bootstrap/bin" && \
    echo "mv -v /usr/sbin /opt/bootstrap/sbin" && \
    echo "tar -C /opt/bootstrap/ -c -f - bin sbin lib | tar -C /usr/ -x -p -k --warning=no-timestamp -f -" && \
    echo "umount -v /mnt/CACHE" && \
    echo "rmdir -v /mnt/CACHE" && \
    echo "rm -r /opt/bootstrap/bin /opt/bootstrap/sbin /opt/bootstrap/lib" && \
    echo "rmdir -v /opt/bootstrap" && \
    echo "unset LD_LIBRARY_PATH" && \
    echo "mkdir -v -p /mnt/EFI" && \
    echo "mount -v -t vfat -o ro /dev/disk/by-partlabel/EFI /mnt/EFI" && \
    echo "cp -p -v /mnt/EFI/xen/xen* /mnt/EFI/linux/System.map* /mnt/EFI/linux/config* /mnt/EFI/syslinux/memtest* /boot/" && \
    echo "umount -v /mnt/EFI" && \
    echo "rmdir -v /mnt/EFI" && \
    echo "mv -v /stand/mcm /stand/nzcc /stand/nz /stand/srep /usr/local/bin/" && \
    echo "mkdir -v -p /new/usr" && \
    echo "chmod --verbose 755 /new/usr" && \
    echo "cd /root" && \
    echo "mv /usr/local /new/usr/local" && \
    echo "mv /usr/share /new/usr/share" && \
    echo "mv /stand/env /stand/env-static" && \
    echo "tar -C /lib -c --remove-files -f - modules | tar -C /new/lib -x -p -f -" && \
    echo "cp -p /usr/bin/env /tmp/env" && \
    echo "mv /usr/bin /new/usr/bin" && \
    echo "mv /usr/sbin /new/usr/sbin" && \
    echo "tar -c --one-file-system -f - / | tar -C /new/ -x -p -k --warning=no-timestamp -f -" && \
    echo "rm -v /new/tmp/env" && \
    echo "mkdir /usr/bin" && \
    echo "mv -v /tmp/env /usr/bin/env" && \
    echo "echo /usr/lib/libhardened_malloc.so/libhardened_malloc.so >>/new/etc/ld.so.preload" && \
    echo "rmdir -v /new/new" && \
    echo "rm -v /new/init" && \
    echo "echo "\''#!/bin/bash-static'\'" > /new/init" && \
    echo "chmod --verbose u+rx /new/init" && \
    echo "chmod --verbose go-rwx /new/init" && \
    echo "echo set -x >>/new/init" && \
    echo "echo umask 077 >>/new/init" && \
    echo "echo export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/stand:/usr/local/sbin:/usr/local/bin >>/new/init" && \
    echo 'echo exec /usr/bin/env -i --debug PATH=/sbin:/bin:/usr/sbin:/usr/bin:/stand:/usr/local/sbin:/usr/local/bin SHELL=/bin/bash-static TERM=dumb TTY=/dev/console /sbin/init "$@" >>/new/init' && \
    echo "chmod --verbose go-rwx /sbin/init" && \
    echo "cd /" && \
    echo "umask 077" && \
    echo "unset TMP" && \
    echo "unset TEMP" && \
    echo "unset TMPDIR" && \
    echo "umount -v /run/tmp" && \
    echo 'exec /usr/bin/env -i --debug PATH=/sbin:/bin:/usr/sbin:/usr/bin:/stand:/usr/local/sbin:/usr/local/bin SHELL=/bin/bash-static /sbin/switch_root /new /init "$@"' \
  ) > init && \
  chmod --verbose u+rx init && \
  chmod --verbose go-rwx init && \
  mkdir -p -v opt/bootstrap/lib/x86_64-linux-gnu/ && \
  cd /root/initrd/usr/lib/x86_64-linux-gnu && \
  tar -c --remove-files -v -f - $(ls -1d libacl.so* libargon2.so* libattr.so* libblkid.so* libbsd.so* libcrypto.so* libgmp.so* libjson-c.so* libkmod.so* liblz4.so* libmd.so* libmount.so* libmpfr.so* libpcre2*so* libpopt.so* libsigsegv.so* libstdc++*.so* libuuid.so*) | tar -C /root/initrd/opt/bootstrap/lib/x86_64-linux-gnu/ -x -p -k -v -v --warning=no-timestamp -f - && \
  cd /root/initrd/usr && \
  tar -c --remove-files -v -f - bin/xargs bin/gawk sbin/pktsetup bin/zstd | tar -C /root/initrd/opt/bootstrap/ -x -p -k -v -v --warning=no-timestamp -f - && \
  cd /root/initrd && \
  kver=$(cd /root/initrd/lib/modules/ && ls -1dtr 5.10.*-hardened*-5.10 | tail -n 1) && \
  mkdir -v -p /root/overlay/lib/modules/"${kver}"/kernel && \
  mv lib/modules/5.10.*-hardened*-5.10uml*/ /root/overlay/lib/modules/ && \
  cd lib/modules/"${kver}"/kernel && \
  find . -type f -name '*.ko' -print > /root/modules && \
  cat /root/initrd/etc/modules |tr _- .. | while read i; do grep "/${i}\.ko\$" /root/modules >> /root/modules. || true; done && \
  cat /root/modules. |sort |uniq > /root/modules && \
  tar -c -f - --remove-files $(cat /root/modules) | tar -C /root/overlay/lib/modules/"${kver}"/kernel -x -p -k --warning=no-timestamp -f - && \
  rm -v /root/modules /root/modules. && \
  cd .. && \
  mv -v ./kernel/ ./kernel.overlay/ && \
  mv -v /root/overlay/lib/modules/"${kver}"/kernel/ ./kernel/ && \
  mv -v ./kernel.overlay/ /root/overlay/lib/modules/"${kver}"/kernel/ && \
  rm -r -v /root/initrd/run/[a-z]* && \
  rm -f -v /root/initrd/run/.containerenv && \
  unset kver && \
  cd /root/initrd && \
  mv -v usr /root/overlay/usr && \
  mv -v var /root/overlay/var && \
  mkdir -p -v usr var && \
  chmod --verbose 755 usr var && \
  rm -vf /root/initrd/etc/.pwd.lock && \
  chmod --verbose go-w /root/initrd/etc/resolv.conf && \
  ls -lasi --full-time /root/initrd/dev/ && \
  mount && \
  chmod --verbose go-w /root/initrd/dev/. && \
  mv -v /root/initrd/boot/ /root/boot/ && \
  mkdir -p -v /root/initrd/boot/ && \
  chmod --verbose 755 /root/initrd/boot/ && \
  mv -v /root/05entropy /root/overlay/usr/local/etc/boot.d/05entropy && \
  chmod --verbose 700 /root/overlay/usr/local/etc/boot.d/05entropy && \
  chown --verbose root:root /root/overlay/usr/local/etc/boot.d/05entropy && \
  find . -print0 | sort -z | cpio -0 -H newc --renumber-inodes -o |xz -1 -v -C crc32 > /boot/initrd.img && \
  rmdir -v /root/initrd/boot/ && \
  mv -v /root/boot/ /root/initrd/boot/ && \
  ulimit -d unlimited && ulimit -v unlimited && \
  mkdir -p /root/drive/mnt/CACHE/overlay /root/drive/mnt/EFI/linux && \
  tar -C /root/overlay -cf - usr var lib | zstd -v -v -v -T1 --single-thread --long=30 --ultra -22 > /root/drive/mnt/CACHE/overlay/overlay.gtar.zst && \
  ls -ldsi --full-time /root/drive/mnt/CACHE/overlay/overlay.gtar.zst && \
  rm -r -v /root/overlay/usr/local/etc/boot.d/ && \
  rmdir -v usr var && \
  mv -v /root/overlay/usr /root/overlay/var . && \
  tar -C /root/overlay/lib/ -c -v -f - modules/ | tar -C /root/initrd/lib/ -x -p -k -v -v --warning=no-timestamp -f - && \
  rm -v -r /root/overlay/lib && \
  rmdir -v /root/overlay && \
  tar -C /root/initrd/opt/bootstrap/ -c --remove-files -v -f - bin sbin lib | tar -C usr/ -x -p -v -v --warning=no-timestamp -f - && \
  rmdir -v /root/initrd/opt/bootstrap && \
  cp -pv /boot/initrd.img /root/drive/mnt/EFI/linux/ && \
  tar -C /root/drive -c -f - --remove-files mnt |gzip -1 >/root/drive.tar.gz && \
  rm -r /root/drive && \
  mv -v sbin/init sbin/init.orig && \
  rm -v init && \
  rm -rf usr/share/locale usr/share/doc usr/share/man usr/lib/cni usr/lib/git-core var/lib/apt/lists usr/share/zsh/functions usr/bin/podman usr/bin/git-lfs usr/bin/containers-storage usr/local/sbin usr/local/bin usr/local/lib* && \
  echo '#!/bin/bash-static' > init && \
  echo 'set -x' >> init && \
  echo 'set -e' >> init && \
  echo 'export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/stand:/usr/local/sbin:/usr/local/bin' >> init && \
  echo 'umask 02' >> init && \
  echo 'cd /root' >> init && \
  echo 'mount -v -t proc proc /proc' >> init && \
  echo 'mount -v -t sysfs sysfs /sys' >> init && \
  echo 'mount -v -t devtmpfs devtmpfs /dev' >> init && \
  echo '/sbin/modprobe loop max_loop=256' >> init && \
  echo '(set +e; grep "^[^#]" /etc/modules | awk '\''{print $1}'\'' | xargs -n 1 /sbin/modprobe || true; true) || true' >> init && \
  echo '(set +e; grep "^[^#]" /etc/modules | awk '\''{print $1}'\'' | while read module; do modprobe "${module}" || true; done; true) || true' >> init && \
  echo '/etc/init.d/kmod start' >> init && \
  echo '/etc/init.d/eudev start' >> init && \
  echo 'udevadm settle' >> init && \
  echo 'udevadm trigger' >> init && \
  echo 'lsblk' >> init && \
  echo 'sync' >> init && \
  echo 'ls /dev/disk/by-*/' >> init && \
  echo '(for i in \
      n 1 "" +768m EF00 \
      n 2 "" +32m EF02 \
      n 3 "" +32m 8301 \
      n 4 "" +32m 8301 \
      n 5 "" +32m 8301 \
      n 6 "" +4g 8301 \
      n 7 "" +4g 8301 \
      n 8 "" +4g 8301 \
      n 9 "" +42g 8309 \
      c 1 EFI \
      c 2 BIOSGRUB \
      c 3 IDEN \
      c 4 CONF \
      c 5 ENTROPY \
      c 6 CACHE \
      c 7 VOLATILE \
      c 8 LOG \
      c 9 DATA \
      x a 1 2 "" \
      p w y; \
    do echo "$i"; done) | gdisk /dev/disk/by-id/ata-QEMU_HARDDISK_QM00001' >> init && \
  echo '(for i in n 1 "" +32m 8301 n 2 "" "" 8301 c 2 STAGING c 1 NOOP p w y; do echo "$i"; done) | gdisk /dev/disk/by-id/ata-QEMU_HARDDISK_QM00003' >> init && \
  echo 'sync' >> init && \
  echo 'sleep 2' >> init && \
  echo 'for i in "-s" "-d" ""; do partprobe ${i}; sleep 2; sync; done' >> init && \
  echo 'udevadm settle' >> init && \
  echo 'udevadm trigger' >> init && \
  echo 'sleep 2' >> init && \
  echo 'sync' >> init && \
  echo '/etc/init.d/eudev stop' >> init && \
  echo 'sleep 2' >> init && \
  echo 'sync' >> init && \
  echo '/etc/init.d/eudev start' >> init && \
  echo 'sync' >> init && \
  echo 'udevadm settle' >> init && \
  echo 'udevadm trigger' >> init && \
  echo 'sync' >> init && \
  echo 'sleep 2' >> init && \
  echo 'find /dev/disk -ls' >> init && \
  echo 'sleep 2' >> init && \
  echo 'mkfs.ext4 -e continue -j -L STAGING -m 8 -v /dev/disk/by-partlabel/STAGING' >> init && \
  echo 'mkfs.ext4 -e continue -j -L IDEN -m 8 -M /mnt/IDEN -v /dev/disk/by-partlabel/IDEN' >> init && \
  echo 'mkfs.ext4 -e continue -j -L CONF -m 8 -M /mnt/CONF -v /dev/disk/by-partlabel/CONF' >> init && \
  echo 'mkfs.ext4 -e continue -j -L CACHE -m 8 -M /mnt/CACHE -v /dev/disk/by-partlabel/CACHE' >> init && \
  echo 'mkfs.ext4 -e continue -j -L LOG -m 8 -M /mnt/LOG -v /dev/disk/by-partlabel/LOG' >> init && \
  echo 'mkdir -v /mnt/CONF /mnt/IDEN /mnt/LOG /mnt/STAGING' >> init && \
  echo 'mount -v -t ext4 -o debug /dev/disk/by-partlabel/IDEN /mnt/IDEN' >> init && \
  echo 'mkdir -v /mnt/IDEN/iden' >> init && \
  echo 'umount -v /mnt/IDEN' >> init && \
  echo 'mount -v -t ext4 -o debug /dev/disk/by-partlabel/CONF /mnt/CONF' >> init && \
  echo 'mkdir -v /mnt/CONF/conf' >> init && \
  echo 'umount -v /mnt/CONF' >> init && \
  echo 'mount -v -t ext4 -o debug /dev/disk/by-partlabel/LOG /mnt/LOG' >> init && \
  echo 'mkdir -v /mnt/LOG/log' >> init && \
  echo 'chmod --verbose 3775 /mnt/LOG/log' >> init && \
  echo 'chattr -V +a /mnt/LOG/log' >> init && \
  echo 'chattr -V +a /mnt/LOG' >> init && \
  echo 'umount -v /mnt/LOG' >> init && \
  echo 'ls /dev/disk/by-partlabel/EFI' >> init && \
  echo 'mkfs.fat -F 32 -n EFI --invariant -v /dev/disk/by-partlabel/EFI' >> init && \
  echo 'mkdir -v /mnt/EFI' >> init && \
  echo 'mount -v -t vfat /dev/disk/by-partlabel/EFI /mnt/EFI' >> init && \
  echo 'mkdir -v /mnt/EFI/syslinux' >> init && \
  echo 'umount -v /mnt/EFI' >> init && \
  echo 'syslinux --install --stupid --raid --directory /syslinux /dev/disk/by-partlabel/EFI' >> init && \
  echo 'sync' >> init && \
  echo 'mount -v -t vfat /dev/disk/by-partlabel/EFI /mnt/EFI' >> init && \
  echo 'ls -la /mnt/EFI/syslinux' >> init && \
  echo 'umount -v /mnt/EFI' >> init && \
  echo 'find /dev/disk -ls' >> init && \
  echo 'sync' >> init && \
  echo 'dd if=/usr/lib/syslinux/mbr/gptmbr.bin of=/dev/disk/by-id/ata-QEMU_HARDDISK_QM00001 bs=440 count=1 conv=notrunc' >> init && \
  echo 'sync' >> init && \
  echo 'sleep 2' >> init && \
  echo 'sync' >> init && \
  echo 'udevadm settle' >> init && \
  echo 'udevadm trigger' >> init && \
  echo 'sleep 2' >> init && \
  echo 'sync' >> init && \
  echo '/etc/init.d/eudev stop' >> init && \
  echo 'sleep 2' >> init && \
  echo 'sync' >> init && \
  echo '/etc/init.d/eudev start' >> init && \
  echo 'sync' >> init && \
  echo 'udevadm settle' >> init && \
  echo 'udevadm trigger' >> init && \
  echo 'sync' >> init && \
  echo 'sleep 2' >> init && \
  echo 'mount -v -t vfat /dev/disk/by-partlabel/EFI /mnt/EFI' >> init && \
  echo 'cp -nav /usr/lib/syslinux/modules/bios/* /mnt/EFI/syslinux/' >> init && \
  echo 'ls -la /mnt/EFI/syslinux/ldlinux.c32' >> init && \
  echo 'blkid -s PTTYPE -o value /dev/disk/by-id/ata-QEMU_HARDDISK_QM00001' >> init && \
  echo 'ls -la /boot' >> init && \
  echo 'mkdir -v -p /mnt/EFI/xen /mnt/EFI/linux' >> init && \
  echo 'mkdir -v /mnt/CACHE' >> init && \
  echo 'mount -v -t ext4 -o debug /dev/disk/by-partlabel/CACHE /mnt/CACHE' >> init && \
  echo 'mkdir -v /mnt/CACHE/overlay' >> init && \
  echo 'mount -v -t ext4 -o debug /dev/disk/by-partlabel/STAGING /mnt/STAGING' >> init && \
  echo 'gunzip -v < /dev/disk/by-id/ata-QEMU_HARDDISK_QM00002 | tar -C /mnt/STAGING/ -x -p -v --warning=no-timestamp -f -' >> init && \
  echo 'cd /mnt/STAGING/mnt/EFI/linux' >> init && \
  echo 'mkdir dir' >> init && \
  echo 'cd dir' >> init && \
  echo 'cat ../initrd.img |xz -d -v -v | cpio -imd' >> init && \
  echo 'mkdir --verbose /mnt/dev' >> init && \
  echo 'mount -v -t devtmpfs devtmpfs /mnt/dev' >> init && \
  echo 'tar -C /mnt/ -cf - dev | tar xpf -' >> init && \
  echo 'rm -r dev/disk/' >> init && \
  echo 'umount -v /mnt/dev' >> init && \
  echo 'find . -print0 | sort -z | cpio -0 -H newc --renumber-inodes -o | xz --compress --stdout --check=crc32 -9 --extreme --threads=1 --verbose --verbose > ../initrd.img' >> init && \
  echo 'cd ..' >> init && \
  echo 'rm -r dir' >> init && \
  echo 'cd /root' >> init && \
  echo 'tar -C /mnt/STAGING/ -c -f - . | tar -C / -x -p -v --warning=no-timestamp -f -' >> init && \
  echo 'umount -v /mnt/STAGING' >> init && \
  echo 'ls -ladsi --full-time /mnt/EFI/linux/initrd* /mnt/CACHE/overlay/overlay*tar*' >> init && \
  echo '(cd /mnt/EFI/linux/; for i in initrd*; do stat -L -c%s "$i" > "$i".isize; done)' >> init && \
  echo 'umount -v /mnt/CACHE' >> init && \
  echo 'cp -p -v /boot/xen* /mnt/EFI/xen/' >> init && \
  echo 'cp -p -v /boot/System.map* /boot/config* /mnt/EFI/linux/' >> init && \
  echo 'cp -p -v /boot/vmlinuz-* /mnt/EFI/linux/vmlinuz' >> init && \
  echo 'cp -p -v /boot/memtest* /mnt/EFI/syslinux/' >> init && \
  echo 'sync' >> init && \
  echo 'cd /mnt/EFI/syslinux' >> init && \
  echo 'for i in "DEFAULT menu.c32" "PROMPT 0" "MENU TITLE Xen/Linux" "MENU AUTOBOOT Boot in #" "TIMEOUT 100" "LABEL xen-linux-0"; do echo "$i" >> syslinux.cfg; done' >> init && \
  echo 'echo "  MENU LABEL Xen/Linux" >> syslinux.cfg' >> init && \
  echo 'echo "  COM32 mboot.c32" >> syslinux.cfg' >> init && \
  echo 'echo "  APPEND /xen/xen-4.14-amd64.gz ucode=scan bootscrub=1 com1=115200,8n1 console=com1,vga console_timestamps=datems dom0=verbose=1 dom0_max_vcpus=1 dom0_mem=4352M,max:4608M guest_loglvl=all loglvl=all noreboot scrub-domheap vga=current apic_verbosity=debug console_to_ring=true no-real-mode=1 conring_size=64k console_to_ring=1 --- /linux/vmlinuz init=/init root=tmpfs rootfstype=tmpfs nomodeset console=xvc0 console=hvc0 console=ttyS0 console=tty0 biosdevname=0 earlyprintk=vga,keep gpt logo.nologo loop.max_loop=256 net.ifnames=0 panic=0 printk.time=1 splash=off cgroup_enable=cpuset,memory cgroup_memory=1 cgroup_cpuset=1 swapaccount=1 extra_latent_entropy random.trust_cpu=off waitusb=3 rng_core.default_quality=256 concurrency=none debug -- --- /linux/initrd.img" >> syslinux.cfg' >> init && \
  echo 'echo >> syslinux.cfg' >> init && \
  echo 'echo "MENU SEPARATOR" >> syslinux.cfg' >> init && \
  echo 'cat syslinux.cfg' >> init && \
  echo 'sync' >> init && \
  echo 'cd /root' >> init && \
  echo 'umount -v /mnt/EFI' >> init && \
  echo 'dd if=/dev/urandom of=/dev/disk/by-partlabel/ENTROPY bs=65536 count=1 2>/dev/null' >> init && \
  echo 'sync' >> init && \
  echo 'udevadm settle' >> init && \
  echo 'udevadm trigger' >> init && \
  echo 'sync' >> init && \
  echo '/etc/init.d/eudev stop' >> init && \
  echo 'sync' >> init && \
  echo 'umount /sys' >> init && \
  echo 'umount /dev' >> init && \
  echo 'for i in s s u s o o; do echo $i > /proc/sysrq-trigger; sleep 4; sync; done' >> init && \
  chmod 755 init && \
  ln init sbin/init && \
  find . -print0 | sort -z | cpio -0 -H newc --renumber-inodes -o |xz -2 -v -v -C crc32 > /boot/initrd.img && \
  cd /root && \
  rm -r initrd && \
  qemu-img create -f qcow2 /root/disk.qcow2 60G && \
  qemu-img create -f qcow2 /root/scratch.qcow2 8G && \
  qemu-system-x86_64 -m 5g -kernel /boot/vmlinuz* -initrd /boot/initrd.img -drive file=disk.qcow2,format=qcow2,index=0 -drive file=/root/drive.tar.gz,format=raw,index=1 -drive file=scratch.qcow2,format=qcow2,index=2 -append "console=ttyS0 init=/init" -nographic && \
  rm -v /boot/initrd.img && \
  rm -v /root/drive.tar.gz && \
  rm -r -f /usr/local && \
  qemu-img convert -c -f qcow2 -O qcow2 disk.qcow2 Linux-Image-Devuan-4-Xen.qcow2 && \
  rm -v disk.qcow2 && \
  rm -v scratch.qcow2 && \
  qemu-img snapshot -c Linux-Image-Devuan-4-Xen Linux-Image-Devuan-4-Xen.qcow2 && \
  qemu-img snapshot -l Linux-Image-Devuan-4-Xen.qcow2 && \
  mv -v /root/kernel/deb /opt/artifact/deb && \
  rm -r /root/kernel /boot && \
  mv -v Linux-Image-Devuan-4-Xen.qcow2 /opt/artifact && \
  cd / && \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin && \
  rm -r -f /usr/share/doc /usr/share/man && \
  find /opt/artifact -ls && \
  true
