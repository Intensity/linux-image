#!/usr/bin/env -vS /usr/bin/podman --runtime runc --storage-driver vfs --cgroup-manager cgroupfs --events-backend file build --pull-never -t intensity/linux-image:devuan-4-hardenedmalloc . -f

FROM docker://devuan/devuan:chimaera AS devuan-archive-pool
RUN \
  fetch_pool=" \
    2ping 6tunnel 9base 9mount a2ps aac-enc acct ack acpi-support-base acpi-support acpi acpica-tools acpid acr adb adequate adjtimex advancecomp aeskeyfind aeson-pretty aespipe afflib-tools afio agedu aglfn alien alsa-oss alsa-tools alsaplayer-text \
    altermime an anacron ancient android-libadb android-libbacktrace android-libbase android-libboringssl android-libcrypto-utils android-libcutils android-liblog android-libunwind android-libutils android-libziparchive android-sdk-platform-tools-common \
    antiword anytun aoetools aom-tools apg apkverifier apparmor-easyprof apparmor-notify apparmor-profiles-extra apparmor-profiles apparmor-utils apparmor apt-file apt-rdepends apt-show-source apt-src apt-transport-tor apt-utils aptitude-common aptitude \
    apulse arc arch-test archivemount aria2 arj arp-scan arpon arpwatch ascii2binary aspell-en aspell astyle at atfs atmel-firmware atool atop audacious-plugins-data audiofile-tools aumix-common aumix autoconf-archive autoconf automake autopkgtest \
    autopoint autotools-dev avfs away awscli bar battery-stats bbdb3 bbe bcal beep bfs bilibop-common bilibop-lockfs bilibop-rules bilibop bind9-dnsutils binfmt-support bip bison bitlbee-common bitlbee-plugin-facebook bitlbee-plugin-mastodon \
    bitlbee-plugin-otr bitlbee bluez-obexd bluez bmake bochsbios bonnie++ bosh bpfcc-introspection bpfcc-lua bpfcc-tools bpfmon bpftool bpftrace bplay bpm-tools bruteforce-luks bsd-mailx bsdgames btop btrbk btrfs-compsize build-essential buildah \
    bvi bwm-ng bximage byacc byobu cabextract calc-common calc calendar capnproto cargo catdoc ccache ccal ccdiff cd-paranoia cdck cdebootstrap cdecl cdparanoia cdpr cgmanager cgpt checkpolicy checksec checksecurity chezscheme chiark-really \
    chiark-scripts chntpw cifs-utils ckermit cksfv cl-swank clevis-luks clevis-tpm2 clevis clisp cloc clzip cmake-data cmake cmospwd codecrypt colord-data colordiff colorize colormake colortail comprez conman conmux connect-proxy console-common \
    console-data console-setup-linux console-setup conspy consul containerd coolkey corkscrew corosync-notifyd corosync-qdevice corosync-qnetd corosync cowbuilder cowdancer cpipe cpp-10 cpp cpu-checker cpufrequtils cpuid cpuidtool cpuinfo \
    cpulimit cpustat cputool crack-common crack cracklib-runtime cronutils cruft-common cruft crunch cryptcat cryptol cryptsetup-initramfs cryptsetup-run cstream csvtool cups-bsd cups-client cups-common curry-frontend cutils cvs cvsps cython3 \
    dact darcs dares dav1d dbus-x11 dbus dconf-gsettings-backend dconf-service dcraw dctrl-tools ddir ddpt debarchiver debconf-i18n debhelper debian-goodies debian-keyring debian-ports-archive-keyring debootstick debsig-verify debsigs debsums \
    debtree debugedit dejagnu depqbf desktop-file-utils desproxy devscripts devuan-baseconf dextractor dh-autoreconf dh-elpa-helper dh-exec dh-make dh-package-notes dh-python dh-runit dh-strip-nondeterminism dhcpdump dhcping di dialog diceware \
    dictionaries-common dictzip difference diffstat diod direvent dirmngr dirvish discover-data discover disorderfs distcc dkms dlocate dmg2img dns-root-data dns2tcp dnss dnstracer dnsutils doas doc-base docbook-xml docbook-xsl docker-compose \
    docker.io docutils-common docx2txt donkey dos2unix dpkg-dev dput-ng dq drbd-utils drbl dselect duc-nox duff duperemove dvd+rw-tools dvtm dwarfdump dwdiff dwz dynamite earlyoom easy-rsa ebook2epub ebook2odt ecasound ecryptfs-utils edac-utils \
    edbrowse edid-decode efibootmgr efitools efivar eject ekeyd-egd-linux electric-fence elfutils elinks-data elinks elogind emacsen-common enscript entr enum eot-utils eot2ttf equivs espeak-data espeak etherwake execline exif exifprobe exiftags \
    exiftran exiv2 expect extrace extract extrepo f-irc faac faad fair fake fam fancontrol fastd fasttrack-archive-keyring fatattr fatcat fatrace fatresize fatsort fcrackzip fdkaac fdm fdupes fdutils festival fetchmail fetchyahoo ffcvt fgetty \
    fhist fido2-tools filetraq filter finch finger firewalld firmware-amd-graphics firmware-atheros firmware-bnx2 firmware-bnx2x firmware-brcm80211 firmware-intelwimax firmware-iwlwifi firmware-linux-free firmware-linux-nonfree firmware-linux \
    firmware-misc-nonfree firmware-realtek fizsh fl-cow flac flake flatpak flex fling fondu fontconfig-config fontconfig fonts-dejavu-core fonts-font-awesome fonts-lato fonts-unifont fonts-urw-base35 foremost forkstat fprobe freeipmi-common \
    freeipmi-tools fsarchiver fspy fstransform fsverity fsvs fswatch fuse-posixovl fuse-zip fuseiso9660 fxload g++-10-multilib g++-10 g++-multilib g++ gambc gauche-gdbm gauche gcab gcal-common gcal gcc-10-doc gcc-10-locales gcc-10-multilib gcc-10 \
    gcc-doc-base gcc-multilib gcc gdal-data gdb-minimal gddrescue gdu gems genparse genromfs geoip-bin geoip-database gettext ghostscript giflib-tools gifti-bin gir1.2-glib-2.0 gir1.2-nm-1.0 gir1.2-packagekitglib-1.0 git-annex-remote-rclone git-annex \
    git-cvs git-doc git-extras git-flow git-remote-gcrypt git-repair git-secret git-svn glib-networking-common glib-networking-services glib-networking glusterfs-client glusterfs-common glusterfs-server gmime-bin gnu-standards gnunet-fuse gnunet \
    gnupg-l10n gnupg-utils gnupg gnuplot-data gnupod-tools gnustep-base-common gnustep-base-runtime gnustep-common gnutls-bin gocr golang-github-containernetworking-plugin-dnsname gom gopass gosu gotail gperf gpg-agent gpg-wks-client gpg-wks-server \
    gpg gpgconf gpgsm gpm gpp grepcidr grepmail groff grok gron growisofs grub-common grub-efi-amd64-bin grub-efi-amd64-signed grub-efi-amd64 grub-efi-ia32-bin grub-efi grub-emu grub-xen-bin grub-xen-host grub2-common gsasl-common gsettings-desktop-schemas \
    gsfonts gstreamer1.0-plugins-base gstreamer1.0-plugins-good gtk-update-icon-cache guile-2.2-libs guile-2.2 guile-3.0-libs guile-bytestructures guile-gcrypt guile-git guile-gnutls guile-json guile-lzlib guile-sqlite3 guile-ssh guile-zlib \
    guile-zstd guix gvpe gztool hadori haproxy hardlink harvest-tools hashalot hashcash hashrat hddtemp hdup hexcompare hexec hexedit hexyl hfsplus hfsprogs hfsutils hicolor-icon-theme html2text htop httptunnel httrack hunspell-en-us hwdata \
    hwinfo hwloc-nox hxtools i2util-tools iamerican-huge ibverbs-providers icmpinfo icmptx ideviceinstaller idevicerestore ieee-data ienglish-common iftop ifupdown-multi ifuse igmpproxy imagemagick-6-common imapcopy imapfilter imapproxy indent \
    inetutils-ftp inetutils-ping inetutils-telnet info init inoticoming inotify-tools install-info interimap intltool-debian inxi iodine ioping iotop-c iotop iozone3 ipcalc-ng ipcalc iperf3 ipgrab ipheth-utils ipmctl ipmitool ipmiutil iptraf-ng \
    ipv6calc ipxe-qemu ipython3 irecovery irqbalance irssi-plugin-otr irssi-scripts irssi iselect iso-codes isolinux isomd5sum isoquery ispell istgt isync itcl3 iw iwatch jam jbig2dec jdupes jhead jid jigit jo joe john-data john jose jove \
    jparse jpeginfo jpegoptim jshon julia-common julia kbd kcptun kexec-tools keyboard-configuration keyringer keyutils kickpass kpcli lame laptop-detect lastpass-cli latexdiff lbdb lbzip2 lcab lcov ldmtool ldnsutils ledit lftp lhasa lib32asan6 \
    lib32atomic1 lib32gcc-10-dev lib32gcc-s1 lib32gomp1 lib32itm1 lib32quadmath0 lib32stdc++-10-dev lib32stdc++6 lib32ubsan1 liba52-0.7.4 libaa1 libaec-tools libaec0 libafflib0v5 libalgorithm-diff-xs-perl libaliased-perl libao-common libao4 libaom0 \
    libapparmor-perl libappstream-glib8 libapr1 libaprutil1 libapt-pkg-perl libarchive-zip-perl libaria2-0 libarray-intspan-perl libasan6 libasm1 libaspell15 libass9 libasyncns0 libatasmart4 libatfs1 libatk-bridge2.0-0 libatk1.0-0 libatk1.0-data \
    libatomic1 libatspi2.0-0 libaudio-flac-header-perl libaudiofile1 libavahi-client3 libavahi-common-data libavahi-common3 libavahi-glib1 libavc1394-0 libavcodec58 libavdevice58 libavfilter7 libavformat58 libavl1 libavresample4 libavutil56 libaxc0 \
    libb-hooks-endofscope-perl libb-hooks-op-check-perl libb-keywords-perl libbcg729-0 libbfio1 libbit-vector-perl libblas3 libblockdev-btrfs2 libblockdev-crypto2 libblockdev-fs2 libblockdev-kbd2 libblockdev-loop2 libblockdev-lvm2 libblockdev-part-err2 \
    libblockdev-part2 libblockdev-swap2 libblockdev-utils2 libblockdev2 libbloom1 libbluetooth3 libbluray2 libboost-chrono1.74.0 libboost-context1.74.0 libboost-locale1.74.0 libboost-serialization1.74.0 libboost-thread1.74.0 libbpfcc libbs2b0 \
    libbtrfs0 libbytes-random-secure-perl libbytesize-common libbytesize1 libc-ares2 libc-client2007e libc-dev-bin libc-devtools libc-l10n libc6-dbg libc6-dev-i386 libc6-dev-x32 libc6-dev libc6-i386 libc6-x32 libcaca0 libcairo-gobject2 libcairo2 \
    libcapnp-0.7.0 libcapture-tiny-perl libcarp-clan-perl libcc1-0 libccid libccrtp2v5 libcdio-cdda2 libcdio-paranoia2 libcdio19 libcdparanoia0 libcfg7 libcgmanager0 libcharon-extauth-plugins libcharon-extra-plugins libchm1 libchromaprint1 libckyapplet1 \
    libclang-cpp11 libclang1-11 libclass-data-inheritable-perl libclass-method-modifiers-perl libclass-xsaccessor-perl libclone-choose-perl libclone-perl libcmap4 libcmark-gfm-extensions0 libcmark-gfm0 libcodec2-0.9 libcolord2 libcommon-sense-perl \
    libconfig-auto-perl libconfig-general-perl libconfig-simple-perl libconfig-tiny-perl libconfig9 libconvert-binhex-perl libcork16 libcorkipset1 libcorosync-common4 libcpanel-json-xs-perl libcpg4 libcpufreq0 libcpuid15 libcpuinfo0 libcpupower1 \
    libcrack2 libcrypt-dev libcrypt-passwdmd5-perl libcrypt-random-seed-perl libcrypt-rijndael-perl libcrypt-ssleay-perl libcryptx-perl libcups2 libcurses-perl libcurses-ui-perl libcwidget4 libdata-dpath-perl libdata-dumper-concise-perl \
    libdata-messagepack-perl libdata-optlist-perl libdate-manip-perl libdatrie1 libdav1d4 libdbd-sqlite3-perl libdbi-perl libdbus-glib-1-2 libdc1394-25 libdconf1 libde265-0 libdebhelper-perl libdebian-installer-extra4 libdebian-installer4 \
    libdeflate0 libdevel-callchecker-perl libdevel-caller-perl libdevel-lexalias-perl libdevel-size-perl libdevel-stacktrace-perl libdigest-hmac-perl libdiscover2 libdouble-conversion3 libdpkg-perl libdrm-amdgpu1 libdrm-common libdrm-intel1 \
    libdrm-nouveau2 libdrm-radeon1 libdrm2 libdsfmt-19937-1 libduktape205 libdumbnet1 libdv4 libdvdread8 libdwarf1 libdynaloader-functions-perl libdynamite0 libe-book-0.1-1 libebml5 libecryptfs1 libedac1 libefiboot1 libefivar1 libegl-mesa0 libegl1 \
    libelogind0 libemail-address-xs-perl libenca0 libenchant-2-2 libencode-locale-perl libeot0 libepubgen-0.1-1 libespeak1 libestools2.5 libev4 libevdev2 libevent-core-2.1-7 libevent-perl libevent-pthreads-2.1-7 libewf2 libexception-class-perl \
    libexecline2.7 libexecs0 libexif12 libexiv2-27 libexporter-declare-perl libexporter-tiny-perl libextractor3 libfaac0 libfaad2 libfarstream-0.2-5 libfdk-aac2 libffcall1b libffms2-4 libfftw3-bin libfftw3-double3 libfftw3-long3 libfftw3-quad3 \
    libfile-basedir-perl libfile-chdir-perl libfile-copy-recursive-perl libfile-dirlist-perl libfile-fcntllock-perl libfile-find-rule-perl libfile-fnmatch-perl libfile-homedir-perl libfile-keepass-perl libfile-lchown-perl libfile-listing-perl \
    libfile-next-perl libfile-stripnondeterminism-perl libfile-touch-perl libfile-util-perl libfilehandle-unget-perl libfindlib-ocaml libfl2 libflac8 libflite1 libfmt7 libfont-ttf-perl libfontconfig1 libfreeimage3 libfreeipmi17 libfreetype6 \
    libfribidi0 libfsplib0 libfsverity0 libgadu3 libgambit4-dev libgambit4 libgauche-0.97-0 libgbm1 libgcab-1.0-0 libgcc-10-dev libgccjit0 libgcrypt20-dev libgd3 libgdk-pixbuf-2.0-0 libgdk-pixbuf2.0-common libgeoip1 libgetopt-long-descriptive-perl \
    libgfapi0 libgfchangelog0 libgfortran5 libgfrpc0 libgfxdr0 libgif7 libgiftiio0 libgirepository-1.0-1 libgit-wrapper-perl libgit2-dev libgl1-mesa-dri libgl1 libglapi-mesa libglib2.0-bin libglib2.0-data libglu1-mesa libglusterd0 libglusterfs0 \
    libglvnd0 libglx-mesa0 libglx0 libgme0 libgmime-3.0-0 libgnt0 libgnustep-base1.27 libgnutls-dane0 libgnutls-openssl27 libgpac10 libgpg-error-dev libgraphite2-3 libgs9-common libgs9 libgsasl7 libgsf-1-114 libgsf-1-common libgsl25 libgslcblas0 \
    libgsm1 libgssdp-1.2-0 libgstreamer-gl1.0-0 libgstreamer-plugins-base1.0-0 libgstreamer1.0-0 libgtk-3-0 libgtk-3-common libgudev-1.0-0 libguile-ssh13 libgupnp-1.2-0 libgupnp-igd-1.0-4 libharfbuzz-icu0 libharfbuzz0b libhash-diff-perl \
    libhash-fieldhash-perl libhash-merge-perl libhash-merge-simple-perl libhd21 libhdf5-103-1 libheif1 libhfsp0 libhidapi-hidraw0 libhidapi-libusb0 libhtml-html5-entities-perl libhtml-parser-perl libhtml-tagset-perl libhtml-tree-perl \
    libhttp-cookies-perl libhttp-date-perl libhttp-message-perl libhttp-negotiate-perl libhttp-parser-dev libhttrack2 libhunspell-1.7-0 libhwloc15 libhx32 libhyphen0 libical3 libice6 libid3tag0 libiec61883-0 libijs-0.35 libilmbase25 \
    libimage-exiftool-perl libimobiledevice6 libimport-into-perl libiniparser1 libinotifytools0 libinput-bin libinput10 libinterimap libio-html-perl libio-multiplex-perl libio-string-perl libio-stringy-perl libipc-run3-perl libipc-signal-perl \
    libiperf0 libipmctl4 libipmiconsole2 libipmidetect0 libirecovery-1.0-3 libirecovery-common libiscsi7 libisl23 libisns0 libiso9660-11 libiterator-perl libiterator-util-perl libitm1 libiw30 libjack-jackd2-0 libjaula1 libjavascriptcoregtk-4.0-18 \
    libjbig0 libjbig2dec0 libjose0 libjpeg-turbo-progs libjpeg62-turbo libjson-glib-1.0-0 libjson-glib-1.0-common libjson-maybexs-perl libjson-perl libjsonparser1.1 libjudydebian1 libjulia1 libjxr0 libkickpass0 libknet1 libkpathsea6 libksba8 \
    liblangtag-common liblangtag1 liblapack3 liblcms2-2 libldb2 libldm-1.0-0 libldns3 liblexical-persistence-perl liblhasa0 liblilv-0-0 liblinear4 liblinux-inotify2-perl liblist-compare-perl liblist-moreutils-perl liblist-moreutils-xs-perl \
    liblist-someutils-perl liblist-utilsby-perl libllvm11 libllvm13 libllvm9 liblo7 liblocale-gettext-perl liblog-any-adapter-screen-perl liblog-any-perl liblog-contextual-perl liblog-log4perl-perl liblog4cpp5v5 liblqr-1-0 liblsan0 libltdl7 liblua5.1-0 \
    liblua5.2-0 liblua5.3-0 libluajit-5.1-2 libluajit-5.1-common liblwp-mediatypes-perl liblwp-protocol-https-perl liblz-dev liblz1 liblzma-dev libm17n-0 libmaa4 libmad0 libmagickcore-6.q16-6 libmagickwand-6.q16-6 libmail-mbox-messageparser-perl \
    libmail-sendmail-perl libmail-srs-perl libmalcontent-0-0 libmanette-0.2-0 libmariadb3 libmarkdown2 libmath-random-isaac-perl libmatroska7 libmbedtls-dev libmbim-glib4 libmbim-proxy libmcpp0 libmcrypt4 libmd4c0 libmeanwhile1 libmediainfo0v5 \
    libmemcached11 libmeta-builder-perl libmfx1 libmhash2 libmicrohttpd12 libmilter1.0.1 libmime-tools-perl libmime-types-perl libminiupnpc17 libminizip1 libmjpegutils-2.1-0 libmldbm-perl libmm-glib0 libmm14 libmms0 libmng1 libmodplug1 \
    libmodule-implementation-perl libmodule-refresh-perl libmodule-runtime-perl libmoo-perl libmoox-aliases-perl libmoox-struct-perl libmouse-perl libmp3-info-perl libmp3lame0 libmpc3 libmpcdec6 libmpeg3-2 libmpg123-0 libmspack0 libmtbl1 \
    libmtdev1 libmujs1 libmunge2 libmxml1 libmysofa1 libnamespace-autoclean-perl libnamespace-clean-perl libncap44 libncurses-dev libncurses5-dev libndp0 libneon27-gnutls libnet-http-perl libnetpbm10 libnewt0.52 libnfs13 libnfsidmap2 libnice10 \
    libniftiio2 libnih-dbus1 libnih1 libnitrokey-common libnitrokey3 libnm0 libnorm1 libnotify-bin libnotify4 libnotmuch5 libnozzle1 libnpth0 libnsl-dev libnspr4 libnss3-tools libnss3 libntfs-3g883 libntirpc3.4 libntlm0 libnumber-compare-perl \
    libnumber-range-perl libnuspell4 liboath0 libobjc4 libobject-id-perl libodfgen-0.1-1 libogg-vorbis-header-pureperl-perl libogg0 libomemo0 libopenal-data libopenal1 libopenconnect5 libopencore-amrnb0 libopencore-amrwb0 libopencsd0 libopendbx1 \
    libopendkim11 libopenexr25 libopengl0 libopenipmi0 libopeniscsiusr libopenjp2-7 libopenlibm3 libopenmpt0 libopts25 libopusfile0 liborc-0.4-0 libostree-1-1 libotf0 libotr5-bin libotr5 libpackage-stash-perl libpackagekit-glib2-18 libpadwalker-perl \
    libpam-cgfs libpam-elogind libpango-1.0-0 libpangocairo-1.0-0 libpangoft2-1.0-0 libparallel-forkmanager-perl libparams-classify-perl libparams-util-perl libparams-validate-perl libparmap-ocaml libparse-debian-packages-perl libparted-fs-resize0 \
    libpath-iterator-rule-perl libpath-tiny-perl libpcc-dev libpcre16-3 libpcre2-16-0 libpcre2-32-0 libpcre2-posix2 libpcre3-dev libpcre32-3 libpcrecpp0v5 libpcsclite1 libperl4-corelibs-perl libperlio-gzip-perl libpgm-5.3-0 libpipewire-0.3-0 \
    libpipewire-0.3-modules libpkcs11-helper1 libpkgconf3 libplist3 libpmem1 libpmemblk1 libpng16-16 libpocketsphinx3 libpod-constants-perl libpod-parser-perl libpolkit-agent-1-0 libpolkit-gobject-1-0 libpolkit-gobject-elogind-1-0 libportaudio2 \
    libpostproc55 libpq5 libprimesieve9 libproc-processtable-perl libproc-waitstat-perl libprotobuf23 libprotoc23 libproxy1v5 libproxychains4 libpseudo libpugixml1v5 libpulse0 libpurple0 libpwquality-common libpwquality-tools libpwquality1 \
    libqalculate20-data libqalculate20 libqb100 libqmi-glib5 libqmi-proxy libqpdf28 libqrencode4 libqt5core5a libqt5dbus5 libqt5gui5 libqt5network5 libqt5widgets5 libquadmath0 libquorum5 libquvi-0.9-0.9.3 libquvi-scripts-0.9 librabbitmq4 \
    librados2 librandomx0 libraw1394-11 libraw20 librbd1 librbl1 librcc0 librcd0 libre-engine-re2-perl libre2-9 librecode0 libref-util-perl libregexp-assemble-perl libregexp-common-perl libregexp-pattern-license-perl libregexp-pattern-perl librep16 \
    libresid-builder0c2a librest-0.7-0 librevenge-0.0-0 librole-tiny-perl librpm9 librpmbuild9 librpmio9 librpmsign9 librsvg2-2 librubberband2 libs6-2.10 libsasl2-modules libsbc1 libsctp1 libsdl1.2debian libsdl2-2.0-0 libsecret-1-0 libsecret-common \
    libserd-0-0 libsereal-decoder-perl libsereal-encoder-perl libserf-1-1 libsgutils2-2 libshairplay0 libshell-command-perl libshine3 libshout3 libsidplay2 libsidutils0 libsigc++-2.0-0v5 libsignal-protocol-c2.3.2 libskarnet2.10 libslang2 libsm6 \
    libsmbclient libsmi2ldbl libsnapper5 libsnappy1v5 libsndfile1 libsndio7.0 libsnmp-base libsnmp40 libsonic0 libsord-0-0 libsort-key-perl libsort-naturally-perl libsoup-gnome2.4-1 libsoup2.4-1 libsox-fmt-alsa libsox-fmt-base libsox3 libsoxr0 \
    libspa-0.2-modules libspandsp2 libspeex1 libspeexdsp1 libsphinxbase3 libsqlite3-dev libsratom-0-0 libsrt1.4-gnutls libssh-4 libssh-dev libssh-gcrypt-4 libssh2-1-dev libssl-dev libstatgrab10 libstdc++-10-dev libstdcompat-ocaml libstemmer0d \
    libstoken1 libstrictures-perl libstring-copyright-perl libstring-escape-perl libstrongswan-extra-plugins libstrongswan-standard-plugins libstrongswan libstrophe0 libsub-exporter-perl libsub-exporter-progressive-perl libsub-identify-perl \
    libsub-install-perl libsub-name-perl libsub-override-perl libsub-quote-perl libsub-uplevel-perl libsvn-perl libsvn1 libswresample3 libswscale5 libsys-cpuaffinity-perl libsys-hostname-long-perl libsysfs2 libsz2 libtachyon-mt-0 libtag1v5-vanilla \
    libtag1v5 libtagc0 libtcl8.6 libtcmalloc-minimal4 libtcplay libtdb1 libteamdctl0 libtelepathy-glib0 libterm-readkey-perl libterm-readline-gnu-perl libterm-shellui-perl libterm-size-perl libtest-deep-perl libtest-differences-perl libtest-exception-perl \
    libtest-most-perl libtest-warn-perl libtevent0 libtext-charwidth-perl libtext-glob-perl libtext-hogan-perl libtext-iconv-perl libtext-levenshteinxs-perl libtext-markdown-discount-perl libtext-trim-perl libtext-unidecode-perl libtext-wrapi18n-perl \
    libtext-xslate-perl libtgl-0.0.0.20160623-0 libthai-data libthai0 libtheora0 libtidy5deb1 libtiff-tools libtiff5 libtime-moment-perl libtime-parsedate-perl libtime-period-perl libtirpc-dev libtlsh0 libtokyocabinet9 libtomoyotools3 libtool libtre5 \
    libtry-tiny-perl libtsan0 libtsk19 libtspi1 libtss0 libtss2-esys-3.0.2-0 libtss2-mu0 libtss2-rc0 libtss2-sys1 libtss2-tcti-cmd0 libtss2-tcti-device0 libtss2-tcti-mssim0 libtss2-tcti-swtpm0 libtss2-tctildr0 libtty1 libturbojpeg0 libtwolame0 \
    libtype-tiny-perl libu2f-host0 libu2f-server0 libubsan1 libucl1 libucommon8 libudfread0 libudisks2-0 libunac1 libunbound8 libunicode-string-perl libunicode-utf8-perl libuniconf4.6 libuninum5 libunix-syslog-perl libunshield0 libupower-glib3 \
    liburi-perl libusb-0.1-4 libusbmuxd6 libusbredirhost1 libuserbindmount0 libuuid-perl libv4l-0 libv4l2rds0 libv4lconvert0 libva-drm2 libva-x11-2 libva2 libvamp-sdk2v5 libvariable-magic-perl libvbr2 libvde0 libvdpau1 libvformat0 libvhdi1 \
    libvidstab1.1 libvirt-daemon-driver-lxc libvirt-daemon-driver-storage-zfs libvirt-daemon-driver-xen libvisual-0.4-0 libvmdk1 libvolume-key1 libvorbis0a libvorbisenc2 libvorbisfile3 libvotequorum8 libvpx6 libvterm-bin libvterm0 libvulkan1 \
    libwacom-common libwacom2 libwavpack1 libwayland-client0 libwayland-cursor0 libwayland-egl1 libwayland-server0 libwbclient0 libwebkit2gtk-4.0-37 libwebm-tools libwebm1 libwebp6 libwebpdemux2 libwebpmux3 libwget0 libwildmidi2 libwireshark-data \
    libwireshark14 libwiretap11 libwoff1 libwpe-1.0-1 libwpebackend-fdo-1.0-1 libwsutil12 libwvstreams4.6-base libwvstreams4.6-extras libwww-curl-perl libwww-perl libwww-robotrules-perl libx11-6 libx11-data libx11-xcb1 libx264-160 libx265-192 \
    libx32asan6 libx32atomic1 libx32gcc-10-dev libx32gcc-s1 libx32gomp1 libx32itm1 libx32quadmath0 libx32stdc++-10-dev libx32stdc++6 libx32ubsan1 libx86-1 libx86emu3 libxapian30 libxaw7 libxcb-dri2-0 libxcb-dri3-0 libxcb-glx0 libxcb-icccm4 \
    libxcb-image0 libxcb-keysyms1 libxcb-present0 libxcb-randr0 libxcb-render-util0 libxcb-render0 libxcb-shape0 libxcb-shm0 libxcb-sync1 libxcb-util1 libxcb-xfixes0 libxcb-xinerama0 libxcb-xinput0 libxcb-xkb1 libxcb1 libxcomposite1 libxcursor1 \
    libxdamage1 libxdmcp6 libxext6 libxfixes3 libxft2 libxi6 libxinerama1 libxkbcommon-x11-0 libxkbcommon0 libxml-libxml-perl libxml-namespacesupport-perl libxml-parser-perl libxml-sax-base-perl libxml-sax-perl libxml-simple-perl \
    libxml-simpleobject-libxml-perl libxmu6 libxmuu1 libxpm4 libxrandr2 libxrender1 libxshmfence1 libxss1 libxt6 libxtables-dev libxv1 libxvidcore4 libxxf86vm1 libyaml-libyaml-perl libyaml-perl libyara4 libyascreen0 libykpers-1-1 libykpiv2 \
    libyubikey-udev libyubikey0 libz3-4 libzbar0 libzck1 libzen0v5 libzephyr4 libzint2.9 libzip4 libzmq5 libznz3 libzopfli1 libzstd-dev libzulucrypt-exe1.2.0 libzulucrypt-plugins libzulucrypt1.2.0 libzulucryptpluginmanager1.0.0 libzvbi-common \
    libzvbi0 libzzip-0-13 licensecheck lilypond-fonts links lintian linux-compiler-gcc-10-x86 linux-cpupower linux-headers-amd64 linux-kbuild-5.10 linux-perf-5.10 linux-perf linuxinfo \
    live-boot-initramfs-tools live-boot live-tools lksctp-tools lld-11 lld lldpd lm-sensors locales locate loggedfs logtail logtool logtools lr lrzsz lsb-release lscolors lua-bitop lua-expat lua-filesystem lua-json lua-lpeg lua-sec lua-socket \
    lua5.2 lua5.3 luajit lunzip lv lxc-tests lz4json lzd lzma-alone m17n-db m4 macutils madison-lite magic-wormhole mailagent mailcap maildir-utils maildirsync mailsync mairix make makepasswd makepp mariadb-common mason mblaze mboxgrep mbpfan \
    mbr mc-data mc mcpp mcrypt mcstrans mdevctl mediainfo memdump memlockd memstat memtester menu metamonger mg mhddfs mhonarc microcom microsocks mime-construct mime-support mimedefang mingetty minicom minilzip minizip mk-configure mkvtoolnix \
    mlock mmc-utils mmdebstrap moc module-assistant mokutil morsegen morty most mp3check mp3gain mp3guessenc mp3info mpack mpeg3-utils mpg321 mrb mscompress msmtp msort msr-tools mt-st mtbl-bin mtd-utils mtr-tiny mtree-netbsd muchsync multicat \
    multipath-tools multistrap multitail multitee multitime musl-dev musl-tools musl myrescue mysql-common n2n nano nasm nat-traverse nbd-client ncal ncaptool ncat ncdu ncompress ncurses-examples ncurses-term ndiff ndisc6 netcat netpbm netrik \
    netrw network-manager newmail newrole nfs-common nfs-ganesha-mount-9p nfs-ganesha ngrep nicstat nim ninja-build nitrocli nix-bin nmap-common nmap nomad-driver-lxc nomad nomarch notmuch nsd ntfs-3g nuspell nyacc nyancat oathtool obfs4proxy \
    ocaml-base-nox ocaml-compiler-libs ocaml-findlib ocaml-interp ocaml-nox ocl-icd-libopencl1 ocproxy ocrad odbcinst1debian2 odbcinst only opalmod open-iscsi openconnect opendkim-tools opendkim openipmi openntpd openssh-server openssh-sftp-server \
    openvpn optipng opus-tools orpie os-prober oss-compat ostree otf2bdf otp outguess ovmf p7zip-full p7zip-rar p7zip packer paexec pakcs pamix pandoc-data pandoc paperkey parallel partclone pass-extension-otp pass-extension-tail pass-extension-tomb \
    pass-git-helper pass patchelf pax-utils paxtest pbuilder pbzip2 pcaputils pcc pccts pcf2bdf pcmciautils pcscd pdlzip peg pen perceptualdiff perf-tools-unstable perforate perlconsole perltidy pexec pgpdump pick picocom pidgin-data pigz \
    pipebench pipewire-bin pipewire pipexec pixz pkgconf playmidi plocate plzip pm-utils pmidi pnopaste-cli po-debconf policycoreutils policykit-1 policyrcd-script-zg2 pollinate poppler-data posh power-calibrate powermgmt-base ppp pppconfig \
    pppoe pptp-linux primesieve-bin primesieve pristine-lfs pristine-tar privbind privoxy procmail-lib procmail profanity-light progress proj-data protobuf-compiler proxsmtp proxychains4 proxytunnel pseudo psf-unifont ptunnel-ng ptunnel \
    publicsuffix pullimap puredata-utils pwgen px pxelinux pypy-ipaddress pypy-lib pypy-pkg-resources pypy-setuptools pypy-stem pypy python-apt-common python-pip-whl python3-apparmor python3-apt python3-attr python3-autobahn python3-automat \
    python3-backcall python3-bcrypt python3-botocore python3-bpfcc python3-cached-property python3-cbor python3-certifi python3-cffi-backend python3-chardet python3-click python3-colorama python3-constantly python3-cryptography python3-dateutil \
    python3-dbus python3-debian python3-decorator python3-docker python3-dockerpty python3-docopt python3-docutils python3-dput python3-firewall python3-geoip python3-gi python3-hamcrest python3-hkdf python3-humanize python3-hyperlink python3-idna \
    python3-importlib-metadata python3-incremental python3-ipython-genutils python3-ipython python3-jedi python3-jmespath python3-jsonschema python3-jwt python3-ldb python3-libapparmor python3-lxml python3-lz4 python3-more-itertools python3-nacl \
    python3-netaddr python3-newt python3-nftables python3-openssl python3-parso python3-pexpect python3-pickleshare python3-pip python3-prompt-toolkit python3-ptyprocess python3-pyasn1-modules python3-pyasn1 python3-pycurl python3-pygments \
    python3-pyperclip python3-pyqrcode python3-pyrsistent python3-pyudev python3-requests python3-roman python3-rsa python3-s3transfer python3-scapy python3-sdnotify python3-selinux python3-service-identity python3-setuptools python3-sh python3-six \
    python3-slip-dbus python3-slip python3-snappy python3-socks python3-software-properties python3-spake2 python3-stem python3-talloc python3-termbox python3-texttable python3-tqdm python3-traitlets python3-trie python3-twisted-bin python3-twisted \
    python3-txaio python3-txtorcon python3-u-msgpack python3-ubjson python3-urllib3 python3-urwid python3-venv python3-wcwidth python3-websocket python3-wheel python3-wsaccel python3-zfec python3-zipp python3-zope.interface python3.9-venv qalc \
    qbs-common qemu-block-extra qemu-guest-agent qemu-system-data qemu-user-static qmenu qpdf qprint qrencode quicktun quilt quvi racket-common racket ragel ranger rar rarcrack rcs rdfind rdiff-backup-fs rdiff-backup re2c recode redir redsocks \
    reflex remake remote-tty rename renrot rep restic restricted-ssh-commands retry rinse ripmime rlwrap rmlint robotfindskitten roffit rover rpcbind rpm-common rpm2cpio rpm rrep rsakeyfind rsbackup rubberband-cli rubberband-ladspa rubberband-vamp \
    runawk rungetty runit runlim rzip s-nail s3fs s6-doc s6 sac safecat safecopy saidar samba-common samba-libs sanitizer sbcl sbsigntool scheme-chez-srfi scmail scrub scrypt seabios seatd secilc secrecy selinux-utils semodule-utils sendip \
    sepol-utils setserial sg3-utils-udev sg3-utils sgml-base sgml-data sgrep sha1cdsum shadowsocks-libev shairplay shared-mime-info shim-helpers-amd64-signed shim-signed-common shim-signed shim-unsigned shntool shorewall-core shorewall-lite \
    shorewall6-lite shove shtool shunit2 sia sic signify-openbsd-keys simple-obfs simpleproxy since sipcalc sipgrep sipsak skopeo slay sleepenh sleuthkit slib slice slime smartmontools smbclient smenu smstools snapper snarf snd-common snd-nox \
    sndfile-programs sndio-tools sndiod snmp snoopy sntp socket softether-common softether-vpnclient softether-vpncmd software-properties-common soong source-highlight sox spectre-meltdown-checker speech-tools speex spell sphinx-rtd-theme-common \
    spice-html5 spin splay splitvt sqlite3 squidclient sqv srs srt-tools ssdeep ssed sshguard ssl-cert ssldump sslscan sslsniff ssmtp steghide stegsnow storebackup stow stress strongswan-charon strongswan-libcharon strongswan-starter strongswan \
    stunnel4 subversion-tools subversion sudo sunxi-tools super supercat supermin swi-prolog-core-packages swi-prolog-core swi-prolog-nox swish++ swish-e sxid symlinks syncthing sysfsutils systemtap-common systemtap-runtime systemtap systune \
    sysuser-helper sysv-rc-conf t1utils tachyon-bin-nox tarlz tasksel-data tasksel tcc tcl-expect tcl8.6 tcl tcllib tcpd tcpick tcpreen tcpreplay tcpslice tcpspy tcpstat tcptrace tcptrack tcputils telegram-cli telnet-ssl telnet termrec termshark \
    tesseract-ocr-eng tesseract-ocr-osd testdisk testssl.sh tex-common texify texinfo tftp tgt-glusterfs tgt-rbd tgt thin-provisioning-tools thunderbolt-tools tinc tinyirc tinyproxy-bin tinyproxy tio tlp tlsh-tools tmfs tmux-plugin-manager \
    tnftp tofrodos tomb tomoyo-tools tor torsocks tpm-udev tpm2-tools tree triehash tripwire trousers tshark tss2 ttm tty-clock ttyrec ttysnoop tup tuxonice-userui twinkle-common twinkle-console twolame u2f-host u2f-server ucpp udev udfclient \
    udisks2-bcache udisks2-btrfs udisks2-lvm2 udisks2 udpcast udptunnel ufw ugrep uml-utilities unaccent unace-nonfree unace unadf unalz unar unbound-anchor unbound-host unbound uncrustify unhide unhtml unifdef unifont unison-2.51+4.11.1 \
    unison units universal-ctags unmass unp unrar-free unrar unshield upass update-inetd upower upx-ucl usb.ids usbip usbmuxd usbredirserver usbtop user-setup userbindmount userinfo utalk uucp uuid-dev uuid v4l-utils v86d valgrind vanguards \
    vbackup vbetool vbindiff vde-switch vde-wirefilter vde2-cryptcab vde2 vdens vdeplug vflib3 vgabios videogen vncsnapshot vobcopy vorbis-tools vpnc-scripts vpnc vpx-tools vrms vrrpd vtun wakeonlan wamerican-huge wamerican watchdog watchman \
    wavpack wbritish-huge wcalc wcanadian-huge wcc wdiff weechat-core weechat-curses weechat-perl weechat-plugins weechat-scripts weechat wget2 whichman whiptail wiggle wildmidi wireguard-go wireless-regdb wireless-tools wireshark-common wodim \
    wpasupplicant wput wvdial x11-common x11-xserver-utils x264 x265 x86info xcb-proto xdg-dbus-proxy xdg-utils xdms xe xfstt xkb-data xlunzip xml-core xmount xsltproc xstow xtables-addons-common xtables-addons-dkms xtables-addons-source xtail \
    xtermset xtitle xtrace xzdec yajl-tools yapet yara yasm ylva yubico-piv-tool yubikey-luks yubikey-personalization z3 zbackup zchunk zerofree zfs-fuse zgen zint zipalign zipcmp zipmerge ziptime ziptool zlib1g-dev znc-perl znc-push znc zopfli \
    zram-tools zulucrypt-cli zulumount-cli zulusafe-cli zutils zziplib-bin \
  " && \
  extended_pool=" \
    adwaita-icon-theme alot alsaplayer-alsa alsaplayer-common anbox apt-offline asciinema audacious audacious-plugins audiotools audtty autorandr autossh avahi-daemon bdebstrap bisonc++ bochs bochs-term bookworm borgbackup brp-pacu brz bspwm bup butt \
    ca-certificates-mono caca-utils cherrytree chromium chromium-common chromium-driver clang clang-11 clfswm cli-common clisp-module-clx cnee coccinelle comparepdf cool-retro-term cppcheck csvkit cups cups-core-drivers cups-daemon cups-filters \
    cups-filters-core-drivers cups-ipp-utils cups-ppdc cups-server-common cutycapt dconf-cli debdelta debian-builder debmake diffoscope diffoscope-minimal diffpdf dillo dirdiff dislocker dpkg-sig drm-info dtrx dunst duplicity dvi2ps ecatools \
    empathy-skype enscribe entropybroker evince evince-common facter fail2ban feh ffmpeg ffmpeg2theora ffmpegthumbnailer fftw2 fio firefox-esr flameshot font-manager-common font-viewer fontforge fontforge-common fontmake fontmatrix fonts-3270 \
    fonts-aenigma fonts-agave fonts-anonymous-pro fonts-arapey fonts-atarismall fonts-bebas-neue fonts-beteckna fonts-cantarell fonts-cardo fonts-cascadia-code fonts-century-catalogue fonts-clear-sans fonts-cmu fonts-comfortaa fonts-comic-neue \
    fonts-compagnon fonts-courier-prime fonts-croscore fonts-crosextra-caladea fonts-crosextra-carlito fonts-dejavu fonts-dejavu-extra fonts-dosis fonts-elstob fonts-engadget fonts-eurofurence fonts-fantasque-sans fonts-fanwood fonts-ferrite-core \
    fonts-firacode fonts-fork-awesome fonts-freefont-otf fonts-freefont-ttf fonts-georgewilliams fonts-glasstty fonts-gnutypewriter fonts-go fonts-gotico-antiqua fonts-hack fonts-hack-otf fonts-hack-ttf fonts-hack-web fonts-hermit fonts-humor-sans \
    fonts-inconsolata fonts-jsmath fonts-junction fonts-junicode fonts-jura fonts-katex fonts-league-mono fonts-league-spartan fonts-liberation fonts-liberation2 fonts-lindenhill fonts-linuxlibertine fonts-lmodern fonts-lyx fonts-monofur fonts-monoid \
    fonts-mononoki fonts-noto-color-emoji fonts-noto-mono fonts-ocr-a fonts-ocr-b fonts-oflb-asana-math fonts-oldstandard fonts-opensymbol fonts-pc fonts-pc-extra fonts-play fonts-povray fonts-powerline fonts-prociono fonts-proggy fonts-recommended \
    fonts-roboto fonts-roboto-fontface fonts-roboto-hinted fonts-roboto-slab fonts-roboto-unhinted fonts-spleen fonts-staypuft fonts-stick fonts-stix fonts-summersby fonts-symbola fonts-takao-mincho fonts-terminus fonts-terminus-otb fonts-tiresias \
    fonts-tuffy fonts-ubuntu fonts-ubuntu-console fonts-ubuntu-font-family-console fonts-wqy-zenhei fonty-rg foot foot-terminfo gconf2-common gcp ghostscript-x giblib1 gir1.2-atk-1.0 gir1.2-atspi-2.0 gir1.2-dbusmenu-glib-0.4 gir1.2-dbusmenu-gtk3-0.4 \
    gir1.2-freedesktop gir1.2-gdkpixbuf-2.0 gir1.2-gst-plugins-base-1.0 gir1.2-gstreamer-1.0 gir1.2-gtk-3.0 gir1.2-harfbuzz-0.0 gir1.2-ibus-1.0 gir1.2-keybinder-3.0 gir1.2-pango-1.0 gir1.2-vte-2.91 gitless gitolite3 glyphsinfo gnome-bluetooth \
    gnome-desktop3-data gnuplot-nox gobject-introspection goobook googler gpac gpac-modules-base grabc graphviz gsfonts-other gsfonts-x11 gstreamer1.0-omx-bellagio-config gstreamer1.0-omx-generic gstreamer1.0-omx-generic-config gstreamer1.0-plugins-bad \
    gstreamer1.0-plugins-ugly gstreamer1.0-pulseaudio gstreamer1.0-vaapi gstreamer1.0-x gtk2-engines-pixbuf gucharmap guncat gv handbrake-cli hardinfo hashid html2ps httpie httraqt hv3 hw-probe i965-va-driver ibus ibus-data ibus-gtk icdiff \
    icu-devtools imagemagick imagemagick-6.q16 img2pdf imv intel-media-va-driver intel-media-va-driver-non-free internetarchive iptables-converter itk3 iwidgets4 j2cli jc jgrep jsmath jsmath-fonts katarakt keepass2 keepassxc kitty kitty-terminfo \
    kodi kodi-bin kodi-data larch latex-make latex2rtf lib32z1 libalgorithm-c3-perl libann0 libantlr3c-3.4-0 libaribb24-0 libarmadillo10 libarpack2 libasound2-dev libasound2-plugins libatk-bridge2.0-dev libatk1.0-dev libatk3.0-cil libatkmm-1.6-1v5 \
    libatspi2.0-dev libaudclient2 libaudcore5 libaudgui5 libaudio2 libaudqt2 libaudtag3 libavahi-core7 libavahi-ui-gtk3-0 libayatana-appindicator3-1 libayatana-ido3-0.4-0 libayatana-indicator3-7 libbaseencode1 libbctoolbox1 libbelcard1 libbellesip1 \
    libbelr1 libblkid-dev libbluray-bin libbobcat5 libboolean-perl libboost-log1.74.0 libboost-nowide1.74.0 libbrotli-dev libbzrtp0 libc++1 libc++1-11 libc++abi1-11 libcairo-script-interpreter2 libcairo1.10-cil libcairo2-dev libcairo2-ocaml \
    libcairomm-1.0-1v5 libcanberra-gtk3-0 libcanberra0 libcddb2 libcdt5 libcec6 libcfitsio9 libcgi-pm-perl libcgraph6 libcharls2 libclang-common-11-dev libclass-accessor-chained-perl libclass-accessor-perl libclass-c3-perl libclass-errorhandler-perl \
    libclass-inspector-perl libclass-methodmaker-perl libclass-singleton-perl libclass-tiny-perl libconfig-file-perl libconfuse-common libconfuse2 libcotp12 libcpp-hocon0.3.0 libcrossguid0 libcrypt-openssl-bignum-perl libcrypt-openssl-random-perl \
    libcrypt-openssl-rsa-perl libcue2 libcupsfilters1 libdaemon0 libdap27 libdapclient6v5 libdata-page-perl libdata-perl-perl libdatetime-format-builder-perl libdatetime-format-flexible-perl libdatetime-format-iso8601-perl libdatetime-format-mail-perl \
    libdatetime-format-natural-perl libdatetime-format-strptime-perl libdatetime-format-w3cdtf-perl libdatetime-locale-perl libdatetime-perl libdatetime-timezone-perl libdatrie-dev libdbus-1-dev libdbusmenu-glib4 libdbusmenu-gtk3-4 libdca0 \
    libdirectfb-1.7-7 libdirectfb-extra libdislocker0.7 libdjvulibre-text libdjvulibre21 libdmx1 libdv-bin libdvbpsi10 libdvdnav4 libdw-dev libebur128-1 libecasoundc1v5 libegl-dev libegl1-mesa libegl1-mesa-dev libelf-dev libepoxy-dev libepsilon1 \
    libeval-closure-perl libevdocument3-4 libevview3-3 libexpat1-dev libfabric1 libfacter3.14.12 libfam0 libfaudio0 libfcft3 libfeed-find-perl libffi-dev libffmpegthumbnailer4v5 libfile-sharedir-perl libfilesys-df-perl libfltk-images1.3 \
    libfltk1.3 libfluidsynth2 libfontconfig-dev libfontconfig1-dev libfontembed1 libfontenc1 libfontforge4 libfreerdp-client2-2 libfreerdp2-2 libfreetype-dev libfreetype6-dev libfreexl1 libfribidi-dev libfs6 libfstrcmp0 libftdi1 libfyba0 \
    libgck-1-0 libgconf-2-4 libgcr-base-3-1 libgcr-ui-3-1 libgdal28 libgdcm3.0 libgdiplus libgdk-pixbuf-2.0-dev libgdk-pixbuf-xlib-2.0-0 libgdk-pixbuf2.0-0 libgdk-pixbuf2.0-bin libgdk3.0-cil libgdk3.0-cil-dev libgee-0.8-2 libgeos-3.9.0 \
    libgeos-c1v5 libgeotiff5 libgio3.0-cil libgio3.0-cil-dev libgirara-gtk3-3 libgl-dev libgl1-mesa-dev libgl1-mesa-glx libglade2-0 libgles-dev libgles1 libgles2 libglew2.1 libglib2.0-dev libglib2.0-dev-bin libglib3.0-cil libglib3.0-cil-dev \
    libglibmm-2.4-1v5 libglu1-mesa-dev libglvnd-dev libglx-dev libgnome-bluetooth13 libgnome-desktop-3-19 libgnupg-interface-perl libgphoto2-6 libgphoto2-port12 libgranite-common libgranite5 libgraphicsmagick-q16-3 libgraphite2-dev libgspell-1-2 \
    libgspell-1-common libgstreamer-plugins-bad1.0-0 libgstreamer-plugins-base1.0-dev libgstreamer1.0-dev libgtk-3-dev libgtk-layer-shell0 libgtk2.0-0 libgtk2.0-common libgtk3.0-cil libgtk3.0-cil-dev libgtkdatabox0 libgtkmm-2.4-1v5 libgtkmm-3.0-1v5 \
    libgtksourceview-3.0-1 libgtksourceview-3.0-common libgtksourceviewmm-3.0-0v5 libgts-0.7-5 libgucharmap-2-90-7 libgvc6 libgvpr2 libgxps2 libharfbuzz-dev libharfbuzz-gobject0 libhdf4-0-alt libhdf5-hl-100 libhwloc-plugins libibus-1.0-5 libice-dev \
    libicu-dev libieee1284-3 libigdgmm11 libimage-magick-perl libimage-magick-q16-perl libimagequant0 libimlib2 libinstpatch-1.0-2 libixml10 libjs-iscroll libjs-xmlextras libkate1 libkeybinder-3.0-0 libkf5completion-data libkf5completion5 \
    libkf5config-data libkf5configcore5 libkf5configgui5 libkf5coreaddons-data libkf5coreaddons5 libkf5crash5 libkf5guiaddons5 libkf5i18n-data libkf5i18n5 libkf5itemviews-data libkf5itemviews5 libkf5widgetsaddons-data libkf5widgetsaddons5 \
    libkf5windowsystem-data libkf5windowsystem5 libkmlbase1 libkmldom1 libkmlengine1 liblab-gamut1 liblablgtk3-ocaml liblablgtksourceview3-ocaml liblavfile-2.1-0 liblavjpeg-2.1-0 liblavplay-2.1-0 liblbfgsb0 libleatherman1.12.1 liblept5 \
    liblinphone10 liblirc-client0 libltc11 liblua5.4-0 liblwp-authen-wsse-perl libmailutils7 libmediastreamer11 libmikmod3 libmlt++3 libmlt-data libmlt6 libmodule-pluggable-perl libmono-2.0-dev libmono-accessibility4.0-cil libmono-cairo4.0-cil \
    libmono-cecil-private-cil libmono-cil-dev libmono-codecontracts4.0-cil libmono-compilerservices-symbolwriter4.0-cil libmono-corlib4.5-cil libmono-corlib4.5-dll libmono-cscompmgd0.0-cil libmono-csharp4.0c-cil libmono-custommarshalers4.0-cil \
    libmono-data-tds4.0-cil libmono-db2-1.0-cil libmono-debugger-soft4.0a-cil libmono-http4.0-cil libmono-i18n-cjk4.0-cil libmono-i18n-mideast4.0-cil libmono-i18n-other4.0-cil libmono-i18n-rare4.0-cil libmono-i18n-west4.0-cil libmono-i18n4.0-all \
    libmono-i18n4.0-cil libmono-ldap4.0-cil libmono-management4.0-cil libmono-messaging-rabbitmq4.0-cil libmono-messaging4.0-cil libmono-microsoft-build-engine4.0-cil libmono-microsoft-build-framework4.0-cil libmono-microsoft-build-tasks-v4.0-4.0-cil \
    libmono-microsoft-build-utilities-v4.0-4.0-cil libmono-microsoft-build4.0-cil libmono-microsoft-csharp4.0-cil libmono-microsoft-visualc10.0-cil libmono-microsoft-web-infrastructure1.0-cil libmono-oracle4.0-cil libmono-parallel4.0-cil libmono-peapi4.0a-cil \
    libmono-posix4.0-cil libmono-rabbitmq4.0-cil libmono-relaxng4.0-cil libmono-security4.0-cil libmono-sharpzip4.84-cil libmono-simd4.0-cil libmono-smdiagnostics0.0-cil libmono-sqlite4.0-cil libmono-system-componentmodel-composition4.0-cil \
    libmono-system-componentmodel-dataannotations4.0-cil libmono-system-configuration-install4.0-cil libmono-system-configuration4.0-cil libmono-system-core4.0-cil libmono-system-data-datasetextensions4.0-cil libmono-system-data-entity4.0-cil \
    libmono-system-data-linq4.0-cil libmono-system-data-services-client4.0-cil libmono-system-data-services4.0-cil libmono-system-data4.0-cil libmono-system-deployment4.0-cil libmono-system-design4.0-cil libmono-system-drawing-design4.0-cil \
    libmono-system-drawing4.0-cil libmono-system-dynamic4.0-cil libmono-system-enterpriseservices4.0-cil libmono-system-identitymodel-selectors4.0-cil libmono-system-identitymodel4.0-cil libmono-system-io-compression-filesystem4.0-cil \
    libmono-system-io-compression4.0-cil libmono-system-json-microsoft4.0-cil libmono-system-json4.0-cil libmono-system-ldap-protocols4.0-cil libmono-system-ldap4.0-cil libmono-system-management4.0-cil libmono-system-messaging4.0-cil \
    libmono-system-net-http-formatting4.0-cil libmono-system-net-http-webrequest4.0-cil libmono-system-net-http4.0-cil libmono-system-net4.0-cil libmono-system-numerics-vectors4.0-cil libmono-system-numerics4.0-cil libmono-system-reactive-core2.2-cil \
    libmono-system-reactive-debugger2.2-cil libmono-system-reactive-experimental2.2-cil libmono-system-reactive-interfaces2.2-cil libmono-system-reactive-linq2.2-cil libmono-system-reactive-observable-aliases0.0-cil \
    libmono-system-reactive-platformservices2.2-cil libmono-system-reactive-providers2.2-cil libmono-system-reactive-runtime-remoting2.2-cil libmono-system-reactive-windows-forms2.2-cil libmono-system-reactive-windows-threading2.2-cil \
    libmono-system-reflection-context4.0-cil libmono-system-runtime-caching4.0-cil libmono-system-runtime-durableinstancing4.0-cil libmono-system-runtime-serialization-formatters-soap4.0-cil libmono-system-runtime-serialization4.0-cil \
    libmono-system-runtime4.0-cil libmono-system-security4.0-cil libmono-system-servicemodel-activation4.0-cil libmono-system-servicemodel-discovery4.0-cil libmono-system-servicemodel-internals0.0-cil libmono-system-servicemodel-routing4.0-cil \
    libmono-system-servicemodel-web4.0-cil libmono-system-servicemodel4.0a-cil libmono-system-serviceprocess4.0-cil libmono-system-threading-tasks-dataflow4.0-cil libmono-system-transactions4.0-cil libmono-system-web-abstractions4.0-cil \
    libmono-system-web-applicationservices4.0-cil libmono-system-web-dynamicdata4.0-cil libmono-system-web-extensions-design4.0-cil libmono-system-web-extensions4.0-cil libmono-system-web-http-selfhost4.0-cil libmono-system-web-http-webhost4.0-cil \
    libmono-system-web-http4.0-cil libmono-system-web-mobile4.0-cil libmono-system-web-mvc3.0-cil libmono-system-web-razor2.0-cil libmono-system-web-regularexpressions4.0-cil libmono-system-web-routing4.0-cil libmono-system-web-services4.0-cil \
    libmono-system-web-webpages-deployment2.0-cil libmono-system-web-webpages-razor2.0-cil libmono-system-web-webpages2.0-cil libmono-system-web4.0-cil libmono-system-windows-forms-datavisualization4.0a-cil libmono-system-windows-forms4.0-cil \
    libmono-system-windows4.0-cil libmono-system-workflow-activities4.0-cil libmono-system-workflow-componentmodel4.0-cil libmono-system-workflow-runtime4.0-cil libmono-system-xaml4.0-cil libmono-system-xml-linq4.0-cil libmono-system-xml-serialization4.0-cil \
    libmono-system-xml4.0-cil libmono-system4.0-cil libmono-tasklets4.0-cil libmono-webbrowser4.0-cil libmono-webmatrix-data4.0-cil libmono-windowsbase4.0-cil libmono-xbuild-tasks4.0-cil libmonosgen-2.0-1 libmonosgen-2.0-dev libmoox-handlesvia-perl \
    libmoox-late-perl libmosquitto1 libmotif-common libmount-dev libmovit8 libmpdclient2 libmpeg2-4 libmpeg2encpp-2.1-0 libmplex2-2.1-0 libmpv1 libmro-compat-perl libnautilus-extension1a libnet-idn-encode-perl libnetcdf18 libnum-ocaml libnunit-cil-dev \
    libnunit-console-runner2.6.3-cil libnunit-core-interfaces2.6.3-cil libnunit-core2.6.3-cil libnunit-framework2.6.3-cil libnunit-mocks2.6.3-cil libnunit-util2.6.3-cil libnx-x11-6 libnxcl-bin libnxcl1 libobjc-10-dev libobrender32v5 libobt2v5 \
    libodbc1 libofa0 libogdi4.1 liboggkate1 libopencolorio1v5 libopencv-calib3d4.5 libopencv-contrib4.5 libopencv-core4.5 libopencv-dnn4.5 libopencv-features2d4.5 libopencv-flann4.5 libopencv-highgui4.5 libopencv-imgcodecs4.5 libopencv-imgproc4.5 \
    libopencv-ml4.5 libopencv-objdetect4.5 libopencv-superres4.5 libopencv-video4.5 libopencv-videoio4.5 libopengl-dev libopenmpi3 libopenmpt-modplug1 libopenni2-0 liborc-0.4-dev liborc-0.4-dev-bin libortp15 libout123-0 libp8-platform2 \
    libpango1.0-dev libpango3.0-cil libpangomm-1.4-1v5 libpangoxft-1.0-0 libpaper-utils libparams-validationcompiler-perl libpathplan4 libpcre2-dev libpdf-api2-perl libpeas-1.0-0 libpeas-common libphodav-2.0-0 libphodav-2.0-common libpiano0 \
    libpixman-1-dev libplacebo72 libplot2c2 libpmix2 libpng-dev libpoppler-cpp0v5 libpoppler-glib8 libpoppler-qt5-1 libpoppler102 libpotrace0 libproj19 libprotobuf-lite23 libpsm-infinipath1 libpsm2-2 libptexenc1 libpthread-stubs0-dev libpulse-dev \
    libpulse-mainloop-glib0 libpulsedsp libpurple-bin libpvm3 libpython2-stdlib libpython2.7-minimal libpython2.7-stdlib libqbscore1.18 libqhull8.0 libqt5concurrent5 libqt5designer5 libqt5help5 libqt5multimedia5 libqt5opengl5 libqt5positioning5 \
    libqt5printsupport5 libqt5qml5 libqt5qmlmodels5 libqt5qmlworkerscript5 libqt5quick5 libqt5quickwidgets5 libqt5script5 libqt5sensors5 libqt5sql5 libqt5sql5-sqlite libqt5svg5 libqt5test5 libqt5waylandclient5 libqt5webchannel5 libqt5webkit5 \
    libqt5x11extras5 libqt5xml5 libquazip5-1 libquicktime2 librsvg2-common librtaudio6 librttopo1 libruby2.7 libsane-common libsane1 libsasl2-modules-otp libsbuild-perl libsdbus-c++0 libsdl-image1.2 libsdl2-image-2.0-0 libselinux1-dev libsepol1-dev \
    libsidplay1v5 libsidplayfp5 libsm-dev libsoci-core4.0 libsoci-sqlite3-4.0 libsocket++1 libsoundtouch1 libspatialaudio0 libspatialite7 libspdlog1 libspecio-perl libspectre1 libspice-client-glib-2.0-8 libspice-client-gtk-3.0-5 libspiro1 \
    libsqlite3-tcl libsrtp2-1 libstartup-notification0 libstb0 libstd-rust-mozilla-1.59 libstd-rust-mozilla-dev libsub-handlesvia-perl libsuperlu5 libsyn123-0 libsynctex2 libsys-cpu-perl libtbb2 libteckit0 libtesseract4 libtexlua53 libtexluajit2 \
    libthai-dev libtinyxml2.6.2v5 libtk8.6 libttfautohint1 libucx0 libuninameslist1 libunwind-dev libupnp13 liburi-fetch-perl liburi-template-perl liburiparser1 libva-wayland2 libvcdinfo0 libvdpau-va-gl1 libvkd3d1 libvlc-bin libvlc5 libvlccore9 \
    libvncclient1 libvo-aacenc0 libvo-amrwbenc0 libvorbisidec1 libvte-2.91-0 libvte-2.91-common libwayland-bin libwayland-client++0 libwayland-cursor++0 libwayland-dev libwayland-egl++0 libwebrtc-audio-processing1 libweston-9-0 libwine libwinpr2-2 \
    libwlroots6 libwmf0.2-7 libwmf0.2-7-gtk libwv-1.2-4 libwww-opensearch-perl libwxbase3.0-0v5 libwxbase3.0-dev libwxgtk-media3.0-gtk3-0v5 libwxgtk-webview3.0-gtk3-0v5 libwxgtk3.0-gtk3-0v5 libwxgtk3.0-gtk3-dev libx11-dev libx11-xcb-dev libxau-dev \
    libxcb-composite0 libxcb-damage0 libxcb-ewmh2 libxcb-randr0-dev libxcb-render0-dev libxcb-res0 libxcb-screensaver0 libxcb-shape0-dev libxcb-shm0-dev libxcb-xfixes0-dev libxcb-xrm0 libxcb-xtest0 libxcb-xv0 libxcb1-dev libxcomp3 libxcomposite-dev \
    libxcompshad3 libxcursor-dev libxdamage-dev libxdg-basedir1 libxdmcp-dev libxdo-dev libxdo3 libxerces-c3.2 libxext-dev libxfixes-dev libxfont2 libxft-dev libxi-dev libxine2 libxine2-bin libxine2-console libxine2-ffmpeg libxine2-misc-plugins \
    libxine2-plugins libxinerama-dev libxkbcommon-dev libxkbfile1 libxkbregistry0 libxm4 libxml++2.6-2v5 libxml-atom-perl libxml-feed-perl libxml-libxslt-perl libxml-rss-perl libxml-xpath-perl libxmlsec1 libxmlsec1-openssl libxnee0 libxneur \
    libxnvctrl0 libxosd2 libxrandr-dev libxrender-dev libxres1 libxstring-perl libxtst-dev libxtst6 libxvmc1 libxxf86dga1 libyaml-cpp0.6 libzbarqt0 libzxcvbn0 lieer lilypond lilypond-data links2 linphone-cli linphone-common linphone-nogtk lios \
    lmodern localslackirc magicrescue magnus mailutils mailutils-common maim mandos mandos-client melt mencoder mercurial mercurial-common mesa-utils mesa-utils-extra mesa-va-drivers mesa-vdpau-drivers mesa-vulkan-drivers mftrace midori mikmod \
    minbif minbif-common minitube mitmproxy mjpegtools mkvtoolnix-gui monkeysphere mono-4.0-gac mono-devel mono-gac mono-mcs mono-runtime mono-runtime-common mono-runtime-sgen mono-xbuild mono-xsp4 mono-xsp4-base monodoc-base monodoc-gtk3.0-manual \
    monodoc-http monodoc-manual mosh motion mp3diags mpeg2dec mpg123 mplayer mpv mupdf mupdf-tools nas-bin netsurf-common netsurf-gtk nitrokey-app nitrokey-authenticator notion novnc nunit-console nx-x11-common nxagent nxdialog nxproxy offlineimap3 \
    oggvideotools open-vm-tools openbox openvswitch-common openvswitch-ipsec openvswitch-switch osdsh otpclient-cli pango1.0-tools pastebinit patool pavucontrol pdfgrep pdfproctools pepperflashplugin-nonfree perlmagick pgpgpg pianobar picom \
    pidgin-skype pidgin-skype-common pius pkg-config plotutils plover pngcrush poezio policycoreutils-python-utils poppler-utils potrace povray povray-examples povray-includes pqiv pulseaudio pulseaudio-equalizer pulseaudio-utils pvm pvm-examples \
    python-babel-localedata python2 python2-minimal python2.7 python2.7-minimal python3-agate python3-agatedbf python3-agateexcel python3-agatesql python3-aiodns python3-appdirs python3-args python3-asgiref python3-audit python3-axolotl-curve25519 \
    python3-babel python3-blinker python3-booleanoperations python3-boto3 python3-breezy python3-brotli python3-cachetools python3-cairo python3-cffi python3-clint python3-compreffor python3-configobj python3-consonance python3-construct python3-csvkit \
    python3-dbfread python3-dbus.mainloop.pyqt5 python3-debtcollector python3-defcon python3-dissononce python3-distro python3-dulwich python3-ecasound python3-ecdsa python3-enchant python3-et-xmlfile python3-fasteners python3-fastimport \
    python3-fido2 python3-fitz python3-flask python3-fontmake python3-fontmath python3-fonttools python3-fs python3-future python3-gi-cairo python3-glyphslib python3-gnupg python3-google-auth python3-google-auth-httplib2 python3-googleapi \
    python3-gpg python3-h11 python3-h2 python3-harmony python3-hid python3-hpack python3-httplib2 python3-hyperframe python3-ibus-1.0 python3-imaplib2 python3-img2pdf python3-internetarchive python3-iso8601 python3-isodate python3-itsdangerous \
    python3-jdcal python3-jeepney python3-jinja2 python3-jsmin python3-json-pointer python3-jsonpatch python3-jwcrypto python3-kaitaistruct python3-kaptan python3-keyring python3-ldap3 python3-leather python3-libarchive-c python3-librecaptcha \
    python3-libtmux python3-lockfile python3-magic python3-mako python3-markdown python3-markupsafe python3-mnemonic python3-mock python3-monotonic python3-mpmath python3-msgpack python3-netifaces python3-networkx python3-notmuch python3-novnc \
    python3-numpy python3-oauth2client python3-openpyxl python3-openvswitch python3-oslo.config python3-oslo.context python3-oslo.i18n python3-oslo.log python3-oslo.serialization python3-oslo.utils python3-packaging python3-parsedatetime \
    python3-passlib python3-pathspec python3-patiencediff python3-pbr python3-pikepdf python3-pil python3-ply python3-poezio-poopt python3-protobuf python3-publicsuffix2 python3-pycares python3-pyclipper python3-pycparser python3-pycryptodome \
    python3-pydbus python3-pygit2 python3-pyinotify python3-pylibacl python3-pyparsing python3-pyqt5 python3-pyqt5.qtopengl python3-pyqt5.qtquick python3-pyqt5.qtsql python3-pyqt5.qtwebkit python3-pyqt5.sip python3-pyscard python3-pytimeparse \
    python3-rencode python3-rfc3986 python3-rstr python3-ruamel.yaml python3-ruamel.yaml.clib python3-sane python3-schema python3-scipy python3-secretstorage python3-semanage python3-sepolgen python3-sepolicy python3-serial python3-setools \
    python3-setproctitle python3-simplejson python3-sip python3-slimit python3-slixmpp python3-slugify python3-sortedcontainers python3-speechd python3-sqlalchemy python3-stevedore python3-sympy python3-tmuxp python3-tornado python3-transitions \
    python3-trezor python3-typedload python3-typing-extensions python3-tz python3-ufo2ft python3-ufolib2 python3-ufonormalizer python3-unidecode python3-uritemplate python3-urwidtrees python3-usb1 python3-websockets python3-websockify \
    python3-werkzeug python3-wrapt python3-wsproto python3-xattr python3-xlib python3-xlrd python3-xmltodict python3-ykman qbs qemu-system qemu-system-common qemu-system-x86 qemubuilder qiv qml-module-qmltermwidget qml-module-qt-labs-folderlistmodel \
    qml-module-qt-labs-settings qml-module-qtgraphicaleffects qml-module-qtqml qml-module-qtqml-models2 qml-module-qtquick-controls qml-module-qtquick-dialogs qml-module-qtquick-layouts qml-module-qtquick-localstorage qml-module-qtquick-privatewidgets \
    qml-module-qtquick-window2 qml-module-qtquick2 qtop quicktime-utils qutebrowser qutebrowser-qtwebkit rake rdesktop recoll recollcmd recollgui recordmydesktop recoverjpeg redet remmina remmina-common remmina-plugin-nx remmina-plugin-rdp \
    remmina-plugin-spice remmina-plugin-vnc rep-gtk reprotest rofi rpl rr ruby ruby-bcrypt-pbkdf ruby-childprocess ruby-chronic ruby-concurrent ruby-ed25519 ruby-erubi ruby-excon ruby-ffi ruby-highline ruby-i18n ruby-listen ruby-locale \
    ruby-lockfile ruby-log4r ruby-mime-types ruby-mime-types-data ruby-minitest ruby-ncurses ruby-net-scp ruby-net-sftp ruby-net-ssh ruby-net-telnet ruby-numerizer ruby-optimist ruby-power-assert ruby-rb-inotify ruby-rubygems ruby-rubymail \
    ruby-sequel ruby-sqlite3 ruby-test-unit ruby-trollop ruby-unicode ruby-unicode-display-width ruby-vagrant-cloud ruby-xapian ruby-xmlrpc ruby-zip ruby2.7 rubygems-integration rust-mozilla-gdb rustc-mozilla s-tui s3cmd s4cmd sakura sawfish \
    sawfish-data sawfish-lisp-source sawfish-themes sayonara sbuild sbuild-qemu schism scrot sct searchmonkey selinux-basics selinux-policy-src semanage-utils setools shairport-sync shatag shoogle showq signing-party simplescreenrecorder \
    simplescreenrecorder-lib sirikali slop slowmovideo slurp smem smtube sndfile-tools sound-theme-freedesktop spectrwm speedtest-cli spice-client-glib-usb-acl-helper ssh-import-id ssh-tools sshfs ssvnc stgit stgit-contrib stterm subuser \
    suckless-tools sup-mail supervisor surf surfraw surfraw-extra sway sway-backgrounds swaybg swayidle sxhkd sxiv systemctl systraq t1-cyrillic t1-xfree86-nonfree tcvt telegram-purple telepathy-haze termdebug terminus termit tesseract-ocr texlive-base \
    texlive-binaries texlive-font-utils texlive-fonts-recommended texlive-latex-base tigervnc-common tigervnc-viewer timgm6mb-soundfont timidity tk tk-html3 tk8.6 tmuxp trezor trimage troffcvt ttf-ancient-fonts ttf-anonymous-pro ttf-bitstream-vera \
    ttf-engadget ttf-mscorefonts-installer ttf-ubuntu-font-family ttf-xfree86-nonfree ttf2ufm ttfautohint ttygif tv-fonts twm tz-converter uefitool-cli unagi va-driver-all vagrant vainfo vdesk vdpau-driver-all vdpauinfo vkeybd vlc vlc-bin vlc-data \
    vlc-plugin-access-extra vlc-plugin-base vlc-plugin-qt vlc-plugin-video-output vokoscreen-ng volume-key w3m-img waybar wayland-protocols wbar wbar-config wdisplays websockify weechat-python weston wev wf-recorder wine64 wininfo wl-clipboard \
    wlogout wlr-randr wmctrl wob wofi wtype wv wx-common wx3.0-headers wxedid x-tile x11-apps x11-session-utils x11-utils x11-xfs-utils x11-xkb-utils x11proto-dev x11proto-input-dev x11proto-randr-dev x11proto-record-dev x11proto-xext-dev \
    x11proto-xinerama-dev xattr xauth xaw3dg xbacklight xbanish xbindkeys xbindkeys-config xbitmaps xbuilder xcape xcb xcfa xclip xcolors xcolorsel xcompmgr xdm xdmx xdmx-tools xdo xdot xdotool xflip xfonts-100dpi xfonts-100dpi-transcoded \
    xfonts-75dpi xfonts-75dpi-transcoded xfonts-base xfonts-efont-unicode xfonts-efont-unicode-ib xfonts-encodings xfonts-nexus xfonts-scalable xfonts-terminus xfonts-terminus-oblique xfonts-traditional xfonts-utils xfonts-x3270-misc xfractint \
    xine-console xininfo xinit xinput xkbind xkbset xkeycaps xlax xli xloadimage xmacro xnee xnest xneur xorg xorg-docs-core xorg-sgml-doctools xpdf xpra xrootconsole xscreensaver xscreensaver-data xsecurelock xsel xserver-common xserver-xephyr \
    xserver-xorg xserver-xorg-core xserver-xorg-input-all xserver-xorg-input-libinput xserver-xorg-legacy xserver-xorg-video-dummy xss-lock xterm xtightvncviewer xtrans-dev xtrlock xtv xutils xvfb xvkbd xwallpaper xwayland xwit xxkb xzoom yaggo \
    yamllint yank youtube-dl yubikey-manager yudit-common zathura zathura-pdf-poppler zathura-ps zbar-tools zenity zenity-common znc-python \
  " && \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin && \
  set -x && \
  set -e && \
  umask 022 && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  cd /root && \
  export LANG=C && \
  export TMP=/tmp && \
  export TEMP="${TMP}" && \
  export TMPDIR="${TMP}" && \
  sed -i -e "/^Acquire/s/true/false/" /etc/apt/apt.conf.d/docker-gzip-indexes && \
  for insistence in Suggests Recommends; do echo APT::Install-"${insistence}" '"0";' | tee -a /etc/apt/apt.conf.d/42disable; done && \
  chmod --verbose go+r /etc/apt/apt.conf.d/42disable && \
  (for src in "" "-src"; do for repo in "" "-updates" "-security" "-backports"; do echo deb"${src}" http://deb.devuan.org/merged chimaera"${repo}" main contrib non-free; done; done) > /etc/apt/sources.list && \
  export DEBIAN_FRONTEND=noninteractive && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  export PYTHONDONTWRITEBYTECODE=1 && \
  exec </dev/null && \
  chmod --verbose go-w /etc /etc/apt /etc/apt/apt.conf.d /etc/dpkg /etc/dpkg/dpkg.cfg.d /usr /usr/sbin && \
  chmod --verbose go-w /etc/apt/apt.conf.d/docker-autoremove-suggests /etc/apt/apt.conf.d/docker-clean /etc/apt/apt.conf.d/docker-gzip-indexes /etc/apt/apt.conf.d/docker-no-languages /etc/dpkg/dpkg.cfg.d/docker-apt-speedup /usr/sbin/policy-rc.d && \
  apt-get -y update && \
  apt-get -y --verbose-versions dist-upgrade && \
  mkdir -v -p /opt/artifact/archives && \
  cd /opt/artifact/archives && \
  apt-get -y download ${fetch_pool} && \
  unset fetch_pool && \
  cd .. && \
  tar -c -f - archives |gzip -1 -v --synchronous --rsyncable > archives.gtar.gz && \
  rm -r archives && \
  mkdir -v -p /opt/artifact/extended && \
  cd /opt/artifact/extended && \
  apt-get -y download ${extended_pool} && \
  unset extended_pool && \
  cd .. && \
  tar -c -f - extended |gzip -1 -v --synchronous --rsyncable > extended.gtar.gz && \
  rm -r extended && \
  true

FROM docker://devuan/devuan:chimaera AS devuan-4

RUN \
  packages_devuan_xen=" \
    libxencall1 \
    libxendevicemodel1 \
    libxenevtchn1 \
    libxenforeignmemory1 \
    libxengnttab1 \
    libxenhypfs1 \
    libxenmisc4.14 \
    libxenstore3.0 \
    libxentoolcore1 \
    libxentoollog1 \
    xen-doc \
    xen-hypervisor-4.14-amd64 \
    xen-hypervisor-common \
    xen-system-amd64 \
    xen-tools \
    xen-utils-4.14 \
    xen-utils-common \
    xenstore-utils \
  " && \
  packages_devuan_base=" \
    acl \
    age \
    amd64-microcode \
    apt-transport-https \
    arptables \
    attr \
    auditd \
    bash-completion \
    bash-static \
    bat \
    bc \
    bcache-tools \
    bcachefs-tools \
    bind9-dnsutils \
    bindfs \
    binfmt-support \
    binutils \
    blktool \
    bridge-utils \
    brotli \
    bsdiff \
    btrfs-progs \
    bubblewrap \
    buffer \
    busybox-static \
    bzip2 \
    ca-certificates \
    care \
    catatonit \
    ccrypt \
    cdebootstrap-static \
    cgroup-tools \
    cgroupfs-mount \
    chromium-sandbox \
    chrootuid \
    chrpath \
    codecrypt \
    conmon \
    containernetworking-plugins \
    containers-storage \
    cpio \
    crun \
    cryptmount \
    cryptsetup \
    cryptsetup-bin \
    cu \
    curl \
    daemon \
    daemonize \
    daemontools \
    dar-static \
    datefudge \
    dateutils \
    dc \
    delta \
    detachtty \
    dmraid \
    dmsetup \
    dnscrypt-proxy \
    dnsmasq \
    dnsmasq-utils \
    dnsproxy \
    dosfstools \
    dpkg-dev \
    dropbear \
    dropbear-bin \
    dtach \
    duf \
    e2fsck-static \
    e2tools \
    ebtables \
    ecdsautils \
    ed \
    efibootmgr \
    emacsen-common \
    encfs \
    ethtool \
    eudev \
    exa \
    exfat-fuse \
    exfat-utils \
    expect \
    ext3grep \
    ext4magic \
    extlinux \
    extundelete \
    f2fs-tools \
    fake-hwclock \
    fakechroot \
    fakeroot \
    fakeroot-ng \
    faketime \
    fd-find \
    fdflush \
    fdisk \
    file \
    firehol \
    firehol-common \
    firehol-tools \
    firejail \
    firejail-profiles \
    fireqos \
    fping \
    fscrypt \
    fuse-overlayfs \
    fuse2fs \
    fuse3 \
    fuseext2 \
    fusefat \
    fuseiso \
    fzf \
    gawk \
    gdisk \
    genisoimage \
    gfsecret \
    git-annex \
    git-crypt \
    git-lfs \
    git-secrets \
    gnupg1 \
    gnupg1-l10n \
    gocryptfs \
    golang-github-containers-common \
    golang-github-containers-image \
    gostsum \
    gpart \
    gpgv-static \
    gpgv1 \
    grub-common \
    grub2-common \
    gzrt \
    hashdeep \
    haveged \
    hdparm \
    ibverbs-providers \
    ifenslave \
    ifupdown \
    ifupdown-extra \
    imvirt \
    imvirt-helper \
    inetutils-tools \
    inetutils-traceroute \
    initscripts \
    install-info \
    intel-microcode \
    iproute2 \
    ipset \
    iptables \
    iputils-arping \
    iputils-ping \
    iputils-tracepath \
    ipxe-qemu \
    isc-dhcp-client \
    isc-dhcp-common \
    iso-codes \
    jfsutils \
    jitterentropy-rngd \
    jq \
    klibc-utils \
    kmod \
    kpartx \
    less \
    libaio1 \
    libarchive-tools \
    libarchive13 \
    libasan6 \
    libatomic1 \
    libboost-thread1.74.0 \
    libbpf0 \
    libbrlapi0.8 \
    libc-dev-bin \
    libc6 \
    libc6-dev \
    libcacard0 \
    libcapstone4 \
    libcom-err2 \
    libcrypt-dev \
    libdaxctl1 \
    libdevmapper1.02.1 \
    libdrm-common \
    libdrm2 \
    libefiboot1 \
    libefivar1 \
    libelf1 \
    libepoxy0 \
    libeudev1 \
    libexecs0 \
    libfdt1 \
    libffi7 \
    libfreetype6 \
    libfuse3-3 \
    libgbm1 \
    libgcc-10-dev \
    libgcc-s1 \
    libgccjit0 \
    libgfapi0 \
    libgfrpc0 \
    libgfxdr0 \
    libglib2.0-0 \
    libglib2.0-data \
    libglusterfs0 \
    libgmp10 \
    libgnutls30 \
    libgpm2 \
    libgssapi-krb5-2 \
    libgstreamer-plugins-base1.0-0 \
    libgstreamer1.0-0 \
    libhogweed6 \
    libibverbs1 \
    libicu67 \
    libidn2-0 \
    libiscsi7 \
    libisl23 \
    libitm1 \
    libjpeg62-turbo \
    libk5crypto3 \
    libkeyutils1 \
    libkrb5-3 \
    libkrb5support0 \
    liblsan0 \
    liblzo2-2 \
    libmnl0 \
    libmpc3 \
    libmpfr6 \
    libmtp-runtime \
    libncursesw6 \
    libndctl6 \
    libnetfilter-queue1 \
    libnettle8 \
    libnfnetlink0 \
    libnfs13 \
    libnl-3-200 \
    libnl-route-3-200 \
    libnsl-dev \
    libnuma1 \
    libopus0 \
    liborc-0.4-0 \
    libp11-kit0 \
    libpcre2-8-0 \
    libpcre3 \
    libpcsclite1 \
    libpixman-1-0 \
    libpmem1 \
    libpng16-16 \
    libquadmath0 \
    librados2 \
    librbd1 \
    librdmacm1 \
    libseccomp2 \
    libselinux1 \
    libslirp0 \
    libsnappy1v5 \
    libsodium23 \
    libspice-server1 \
    libssh-4 \
    libssl1.1 \
    libstdc++6 \
    libtasn1-6 \
    libtinfo6 \
    libtirpc-dev \
    libtsan0 \
    libubsan1 \
    libunistring2 \
    liburing1 \
    libusb-1.0-0 \
    libusbredirparser1 \
    libvdeplug2: \
    libwayland-server0 \
    libxencall1 \
    libxendevicemodel1 \
    libxenevtchn1 \
    libxenforeignmemory1 \
    libxengnttab1 \
    libxenhypfs1 \
    libxenmisc4.14 \
    libxenstore3.0 \
    libxentoolcore1 \
    libxentoollog1 \
    libxml2 \
    libyajl2 \
    libzstd1 \
    liquidprompt \
    lockfile-progs \
    lrzip \
    lsb-release \
    lsh-client \
    lsh-server \
    lshw \
    lsof \
    lsscsi \
    ltrace \
    luksmeta \
    lvm2 \
    lxc \
    lxc-templates \
    lxcfs \
    lxctl \
    lynx \
    lz4 \
    lzip \
    lziprecover \
    lzop \
    makefs \
    makepatch \
    man-db \
    mandoc \
    manpages \
    manpages-dev \
    mbuffer \
    mdadm \
    mergerfs \
    metastore \
    mokutil \
    moreutils \
    musl \
    net-tools \
    netbase \
    netcat-openbsd \
    nettle-bin \
    nftables \
    nilfs-tools \
    ntpdate \
    ntpstat \
    nvme-cli \
    nwipe \
    openssl \
    os-prober \
    ovmf \
    par2 \
    parchive \
    parted \
    patch \
    patchutils \
    pax \
    paxctl \
    pciutils \
    pinentry-curses \
    pinentry-tty \
    procinfo \
    procps \
    proot \
    psmisc \
    psutils \
    pv \
    python3-pip \
    qemu-system-data \
    quota \
    quotatool \
    randomsound \
    rdate \
    rdiff \
    reiser4progs \
    reiserfsprogs \
    rfkill \
    rhash \
    ripgrep \
    rng-tools \
    rng-tools-debian \
    rootlesskit \
    rsync \
    rsyncrypto \
    rsyslog \
    runc \
    rush \
    sdparm \
    seabios \
    seccomp \
    seccure \
    secure-delete \
    securefs \
    shared-mime-info \
    sharutils \
    signify-openbsd \
    silversearcher-ag \
    slirp \
    slirp4netns \
    socat \
    sq \
    squashfs-tools \
    squashfs-tools-ng \
    squashfuse \
    sshoot \
    sshuttle \
    ssss \
    strace \
    syslinux \
    syslinux-common \
    syslinux-efi \
    syslinux-utils \
    sysstat \
    tar-scripts \
    tar-split \
    tardiff \
    tardy \
    tcpdump \
    tcpflow-nox \
    tcplay \
    tcptraceroute \
    time \
    tini \
    tinysshd \
    tldr \
    tmux \
    traceroute \
    tree \
    tsocks \
    uanytun \
    ucspi-proxy \
    ucspi-tcp-ipv6 \
    ucspi-unix \
    udftools \
    udhcpc \
    uidmap \
    unionfs-fuse \
    unzip \
    usbutils \
    vim-tiny \
    vlan \
    vlock \
    vmfs6-tools \
    w3m \
    wget \
    wipe \
    wireguard-tools \
    xdelta \
    xdelta3 \
    xdg-user-dirs \
    xen-hypervisor-4.14-amd64 \
    xorriso \
    xxhash \
    xz-utils \
    yash \
    zgen \
    zip \
    zlib1g \
    zoxide \
    zpaq \
    zplug \
    zsh-antigen \
    zsh-autosuggestions \
    zsh-doc \
    zsh-static \
    zsh-syntax-highlighting \
    zstd \
  " && \
  packages_idempotent=" \
    adduser \
    apt \
    base-files \
    base-passwd \
    bash \
    bsdutils \
    coreutils \
    dash \
    debconf \
    debian-archive-keyring \
    debianutils \
    devuan-keyring \
    diffutils \
    dpkg \
    e2fsprogs \
    findutils \
    gcc-10-base \
    gcc-9-base \
    gpgv \
    grep \
    gzip \
    hostname \
    init-system-helpers \
    libacl1 \
    libapt-pkg6.0 \
    libattr1 \
    libaudit-common \
    libaudit1 \
    libblkid1 \
    libbz2-1.0 \
    libc-bin \
    libc6 \
    libcap-ng0 \
    libcom-err2 \
    libcrypt1 \
    libdb5.3 \
    libdebconfclient0 \
    libeudev1 \
    libext2fs2 \
    libffi7 \
    libgcc-s1 \
    libgcrypt20 \
    libgmp10 \
    libgnutls30 \
    libgpg-error0 \
    libgssapi-krb5-2 \
    libhogweed6 \
    libidn2-0 \
    libk5crypto3 \
    libkeyutils1 \
    libkrb5-3 \
    libkrb5support0 \
    liblz4-1 \
    liblzma5 \
    libmount1 \
    libnettle8 \
    libnsl2 \
    libp11-kit0 \
    libpam-modules \
    libpam-modules-bin \
    libpam-runtime \
    libpam0g \
    libpcre2-8-0 \
    libpcre3 \
    libseccomp2 \
    libselinux1 \
    libsemanage-common \
    libsemanage1 \
    libsepol1 \
    libsmartcols1 \
    libss2 \
    libssl1.1 \
    libstdc++6 \
    libtasn1-6 \
    libtinfo6 \
    libtirpc-common \
    libtirpc3 \
    libunistring2 \
    libuuid1 \
    libxxhash0 \
    libzstd1 \
    login \
    logsave \
    lsb-base \
    mawk \
    mount \
    ncurses-base \
    ncurses-bin \
    passwd \
    perl-base \
    sed \
    sysvinit-utils \
    tar \
    tzdata \
    util-linux \
    zlib1g \
  " && \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin && \
  set -x && \
  set -e && \
  umask 077 && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  cd /root && \
  export LANG=C && \
  export TMP=/tmp && \
  export TEMP="${TMP}" && \
  export TMPDIR="${TMP}" && \
  sed -i -e "/^Acquire/s/true/false/" /etc/apt/apt.conf.d/docker-gzip-indexes && \
  for insistence in Suggests Recommends; do echo APT::Install-"${insistence}" '"0";' | tee -a /etc/apt/apt.conf.d/42disable; done && \
  chmod --verbose go+r /etc/apt/apt.conf.d/42disable && \
  (for src in "" "-src"; do for repo in "" "-updates" "-security" "-backports"; do echo deb"${src}" http://deb.devuan.org/merged chimaera"${repo}" main contrib non-free; done; done) > /etc/apt/sources.list && \
  export DEBIAN_FRONTEND=noninteractive && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  export PYTHONDONTWRITEBYTECODE=1 && \
  exec </dev/null && \
  chmod --verbose go-w /etc /etc/apt /etc/apt/apt.conf.d /etc/dpkg /etc/dpkg/dpkg.cfg.d /usr /usr/sbin && \
  chmod --verbose go-w /etc/apt/apt.conf.d/docker-autoremove-suggests /etc/apt/apt.conf.d/docker-clean /etc/apt/apt.conf.d/docker-gzip-indexes /etc/apt/apt.conf.d/docker-no-languages /etc/dpkg/dpkg.cfg.d/docker-apt-speedup /usr/sbin/policy-rc.d && \
  apt-get -y update && \
  apt-get -y --verbose-versions dist-upgrade && \
  apt-get -y --verbose-versions install ${packages_idempotent} && \
  apt-get -y --verbose-versions install memtest86 memtest86+ && \
  (set +e; apt-get -y --verbose-versions install makedev || true; : > /var/lib/dpkg/info/makedev.postinst; apt-get -y -f install || true; true) && \
  (set +e; mkdir -v -p /var/lock/schroot || true; apt-get -y --verbose-versions install schroot schroot-common || true; : > /var/lib/dpkg/info/schroot.postinst; apt-get -y -f install || true; true) && \
  (set +e; mkdir -v -p /run/initctl || true; apt-get -y --verbose-versions install sysvinit-core || true; sed -i -e "/^restart=yes/s,restart=yes,restart=no," /var/lib/dpkg/info/sysvinit-core.postinst || true; apt-get -y -f install || true; rmdir /run/initctl || true; true) && \
  apt-get -y --verbose-versions install makedev sysvinit-core schroot schroot-common && \
  apt-get -y --verbose-versions install ${packages_devuan_base} && \
  mkdir -v ephemeral && \
  cd ephemeral && \
  apt-get download libgpgme11 && \
  package=$(ls -1d libgpgme11_*.deb) && \
  ar xv "${package}" && \
  cat control.tar.xz | xz -dvv | tar xpkvvf - && \
  sed -i -e "/^Depend/s/: gnupg[^,]*,/:/" control && \
  tar -c -v -f - control md5sums shlibs symbols triggers | xz -vv > control.tar.xz && \
  rm -v "${package}" && \
  ar rcv "${package}" debian-binary control.tar.xz data.tar.xz && \
  dpkg -i --force-all "${package}" && \
  unset package && \
  cd /root && \
  rm -rv ephemeral && \
  rm -v /etc/lsh_host_key.pub /etc/lsh_host_key && \
  apt-get install -y --verbose-versions podman && \
  rm -v /etc/dropbear/dropbear_ecdsa_host_key /etc/dropbear/dropbear_ed25519_host_key /etc/dropbear/dropbear_rsa_host_key && \
  for i in auditd dnscrypt-proxy dnsmasq dnsproxy dropbear firehol fireqos lvm2 lvm2-lvmpolld lxc lxc-net lxcfs mdadm rsync sysstat uanytun uuidd lsh-server rsyslog binfmt-support; do update-rc.d "${i}" disable && update-rc.d "${i}" remove; done && \
  apt-get -y --verbose-versions install ${packages_devuan_xen} python3-dotenv python-is-python3 gdb xfsprogs xfsdump initramfs-tools initramfs-tools-core klibc-utils libklibc libvirt0 libvirt-clients libxml2-utils distro-info && \
  for i in xendomains xen; do update-rc.d "${i}" disable && update-rc.d "${i}" remove; done && \
  cd /root && \
  sed -i -e "/^ENV_[SU]*PATH/s,PATH=.*,PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/stand," -e "/^UMASK/s,022,077," -e "/^LOG_OK_LOGINS/s,no,yes," /etc/login.defs && \
  sed -i -e '/PATH="/s,PATH="[^"]*",PATH="/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/stand",' /etc/profile && \
  sed -i -e '/export PATH=/s,PATH="[^"]*",PATH="/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/stand",' /etc/zsh/zshenv && \
  sed -i -e "s,^DSHELL=.*,DSHELL=/bin/bash-static," -e "s,^DIR_MODE=.*,DIR_MODE=0700," /etc/adduser.conf && \
  sed -i -e '/^if.*usr.lib.command-not-found.*usr.share.command-not-found.command-not-found/s,; then, \&\& false; then,' /etc/bash.bashrc && \
  sed -i -e "/^START_FIREHOL/s/=.*/=YES/" /etc/default/firehol && \
  mkdir -p -v /usr/local/src/attic/etc && \
  mkdir -v /usr/local/src/attic/bin && \
  mkdir -p -v /usr/local/src/attic/usr/bin && \
  chmod --verbose 700 /usr/local/src/attic /usr/local/src/attic/etc /usr/local/src/attic/bin /usr/local/src/attic/usr /usr/local/src/attic/usr/bin && \
  rm -v /bin/rbash && \
  ln -sv bash-static /bin/rbash && \
  ln -svf bash-static /bin/sh && \
  mv -v /bin/bash /usr/local/src/attic/bin/bash && \
  ln -sv bash-static /bin/bash && \
  for shell in zsh zsh5 zsh5-static; do mv -v /bin/"${shell}" /usr/local/src/attic/bin/"${shell}" && ln -sv zsh-static /bin/"${shell}"; done && \
  rm -rv /bin/rzsh && \
  ln -sv zsh-static /bin/rzsh && \
  mv -v /usr/bin/tini /usr/local/src/attic/usr/bin/tini && \
  ln -sv tini-static /usr/bin/tini && \
  mv -v /usr/bin/gpgv /usr/local/src/attic/usr/bin/gpgv && \
  ln -sv gpgv1 /usr/bin/gpgv && \
  rm -v /bin/mksh && \
  ln -sv mksh-static /bin/mksh && \
  rm -v /bin/rksh && \
  ln -sv mksh-static /bin/rksh && \
  rm -v /bin/rmksh && \
  ln -sv mksh-static /bin/rmksh && \
  cp -av /usr/bin/gpg1 /usr/bin/gpg && \
  for conf in /etc/bash.bashrc /etc/profile /etc/skel/.bashrc /etc/skel/.profile /root/.bashrc /root/.profile; do (echo umask 077; echo export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/stand; echo unset HUSHLOGIN; echo unset MOTD_SHOWN) | tee -a "${conf}"; done && \
  rm -v /etc/localtime && \
  /usr/bin/env --chdir=/etc ln -sv ../usr/share/zoneinfo/Universal ./localtime && \
  echo Universal > /etc/timezone && \
  chmod --verbose go+r /etc/timezone && \
  cp -v -p /etc/shells /usr/local/src/attic/etc/shells && \
  (for shell in /bin/bash /bin/bash-static /bin/zsh-static /usr/lib/klibc/bin/mksh /bin/sh /bin/dash /bin/rbash /bin/rzsh /bin/rksh /bin/rmksh /bin/rlksh /bin/lksh; do echo "${shell}"; done) >/etc/shells && \
  chsh --shell /bin/bash-static root && \
  sed -i -e "/^[2-6]:23:respawn:.sbin.getty [0-9][0-9]* tty[2-6]$/s/^/#/" -e "/^#T0:23:respawn:.sbin.getty -L ttyS0/s/^#//" /etc/inittab && \
  mkdir -v /etc/boot.d && \
  (echo '#!/bin/bash-static'; echo "set -x"; echo "if test -d /usr/local/etc/boot.d; then run-parts /usr/local/etc/boot.d; fi") >> /etc/boot.d/00local && \
  chmod --verbose u+rx /etc/boot.d/00local /etc/rc.local && \
  mkdir -v /usr/local/etc/boot.d && \
  (echo '#!/bin/bash-static'; echo "set -x"; echo "rm -v /init") >> /usr/local/etc/boot.d/00rminit && \
  (echo '#!/bin/bash-static'; echo "set -x"; echo "mount -o remount,nodev,nosuid,sync,noatime,nodiratime,dirsync,loud,nouser /") >> /usr/local/etc/boot.d/01remountroot && \
  (echo '#!/bin/bash-static'; echo "set -x"; echo 'for i in cdebootstrap fstype ipconfig nfsmount; do ln -v /stand/"${i}" /usr/local/sbin/"${i}"; done; ln -v /stand/minips /usr/local/bin; ln -v /stand/dar /usr/local/bin; ln -v /stand/ul_* /usr/local/sbin/') >> /usr/local/etc/boot.d/02standlink && \
  (echo '#!/bin/bash-static'; echo "set -x"; echo "ldconfig") >> /usr/local/etc/boot.d/02ldconfig && \
  (echo '#!/bin/bash-static'; echo "set +e"; echo 'netdevs=$( (cd /sys/class/net/ && ls -1d eth*; ifconfig -a|grep "^eth[0-9]*:" | cut -f1 -d:) |sort|uniq | sed "s,^eth,,"); for netdev in ${netdevs}; do ifconfig eth${netdev} up; brctl addbr br${netdev}; ifconfig br${netdev} up; brctl addif br${netdev} eth${netdev}; dhclient -v br${netdev}; done; iptables -v -n -L; iptables -v -n -L -t nat; ifconfig -a; ip a; brctl show; /usr/sbin/ntpdate-debian; exit 0') >> /usr/local/sbin/init-naive-networking && \
  chmod --verbose 0755 /usr/local/sbin/init-naive-networking && \
  (echo '#!/bin/bash-static'; echo "set -x"; echo "/etc/init.d/eudev stop") >> /usr/local/etc/boot.d/05stopeudev && \
  (echo '#!/bin/bash-static'; echo "set -x"; echo '#if cat /proc/cmdline |grep -q removemounts >/dev/null 2>/dev/null; then for dir in /sys/fs/pstore /sys/kernel/security /run/lock; do umount -v "${dir}"; done; /etc/init.d/cgroupfs-mount stop; umount -v /sys/fs/cgroup; umount -v /sys/kernel/debug/tracing; umount -v /sys/kernel/debug; else true; fi') >> /usr/local/etc/boot.d/07umountsomedirs && \
  (echo '#!/bin/bash-static'; echo "set +e"; echo 'set +x; for i in dev.tty.ldisc_autoload=0 fs.protected_fifos=2 fs.protected_hardlinks=1 fs.protected_regular=2 fs.protected_symlinks=1 fs.suid_dumpable=0 kernel.dmesg_restrict=1 kernel.kexec_load_disabled=1 kernel.kptr_restrict=2 kernel.perf_event_paranoid=3 kernel.randomize_va_space=2 kernel.unprivileged_bpf_disabled=1 net.core.bpf_jit_harden=2 net.ipv4.conf.all.accept_redirects=0 net.ipv4.conf.all.accept_source_route=0 net.ipv4.conf.all.rp_filter=1 net.ipv4.conf.all.secure_redirects=0 net.ipv4.conf.all.send_redirects=0 net.ipv4.conf.default.accept_redirects=0 net.ipv4.conf.default.accept_source_route=0 net.ipv4.conf.default.rp_filter=1 net.ipv4.conf.default.secure_redirects=0 net.ipv4.conf.default.send_redirects=0 net.ipv4.icmp_ignore_bogus_error_responses=1 net.ipv4.tcp_rfc1337=1 net.ipv4.tcp_syncookies=1 net.ipv4.tcp_timestamps=0 net.ipv6.conf.all.accept_ra=0 net.ipv6.conf.all.accept_redirects=0 net.ipv6.conf.all.accept_source_route=0 net.ipv6.conf.default.accept_ra=0 net.ipv6.conf.default.accept_redirects=0 net.ipv6.conf.default.accept_source_route=0 vm.mmap_rnd_bits=32 vm.mmap_rnd_compat_bits=16 vm.swappiness=1 vm.unprivileged_userfaultfd=0; do sysctl -w "${i}" 2>/dev/null || true; done; true') >> /usr/local/etc/boot.d/08sysctl && \
  (echo '#!/bin/bash-static'; echo "set -x"; echo "sdmem -l -l") >> /usr/local/etc/boot.d/09wipemem && \
  (echo '#!/bin/bash-static'; echo "set -x"; echo "set +e"; echo 'mkdir -p -v /run/conf.d/ /mnt/CONF && lsblk -l -p | grep part | cut -f1 -d" " | while read part; do if blkid -s LABEL -s PARTLABEL -o value "${part}" |grep -q "^CONF"; then fsck.ext4 -v -p "${part}" || true; mount -v -t ext4 -o debug,ro "${part}" /mnt/CONF && tar -C /mnt/CONF/CONF -c -v -f - . | tar -C /run/conf.d/ -x -p -v --warning=no-timestamp -f - && umount -v /mnt/CONF; fi; done && rmdir -v /mnt/CONF && chmod -R --verbose go-rwx /run/conf.d/ && exec run-parts /run/conf.d/') >> /usr/local/etc/boot.d/19confrun && \
  chmod --verbose u+rx /usr/local/etc/boot.d/[0-9]* && \
  chmod --verbose go-rwx /usr/local/etc/boot.d/[0-9]* && \
  update-alternatives --set editor /usr/bin/vim.tiny && \
  pip3 install podman-compose awscli && \
  find /usr/lib /usr/share /usr/local/bin /usr/local/lib -maxdepth 24 -name "*.pyc" -type f -ls -delete && \
  (set +e; find /usr/lib /usr/share /usr/local/bin /usr/local/lib -maxdepth 24 -name __pycache__ -type d -print | xargs rmdir -v -- || true; true) && \
  apt-get -y clean && \
  apt-get -y autoclean && \
  apt-get -y autoremove && \
  unset PYTHONDONTWRITEBYTECODE && \
  mkdir /stand && \
  chmod -v ugo+rx /stand && \
  /bin/busybox --list | while read fn; do ln /bin/busybox /stand/"${fn}"; done && \
  ln -v /usr/bin/dar_static /sbin/e2fsck.static /usr/bin/gpgv-static /bin/zsh-static /bin/bash-static /bin/lksh /usr/lib/klibc/bin/fstype /usr/lib/klibc/bin/ipconfig /usr/lib/klibc/bin/minips /usr/lib/klibc/bin/mksh /usr/lib/klibc/bin/nfsmount /usr/bin/catatonit /usr/bin/cdebootstrap-static /usr/bin/saveme /usr/bin/statfs /usr/bin/statvsfstat /usr/bin/tini-static /stand && \
  ln -v /stand/gpgv-static /stand/gpgv && ln -v /stand/dar_static /stand/dar && ln -v /stand/e2fsck.static /stand/e2fsck && ln -v /stand/zsh-static /stand/zsh && ln -v /stand/bash-static /stand/bash && ln -v /stand/cdebootstrap-static /stand/cdebootstrap && \
  passwd --delete root && \
  rm -v /etc/group- /etc/gshadow- /etc/passwd- /etc/shadow- && \
  rm -v /var/cache/debconf/config.dat-old /var/cache/debconf/templates.dat-old /var/lib/dpkg/diversions-old /var/lib/dpkg/status-old && \
  rm -v /etc/.pwd.lock && \
  find /usr/share/doc /usr/share/info /usr/share/man -name \*.gz -type l -ls -delete && \
  find /usr/share/doc /usr/share/info /usr/share/man -name \*.gz -type f -exec gunzip -N -v -f -- \{\} \; && \
  gunzip -N -v -f /usr/lib/debug/*.gz && \
  rm -r -v /usr/share/man/[^m]*/ && \
  find /etc/alternatives -name \*.gz -type l -ls -delete && \
  rm -v /usr/share/man/man3/LIST_* && \
  : > /etc/issue && \
  : > /etc/issue.net && \
  : > /etc/motd && \
  : > /var/log/alternatives.log && \
  : > /var/log/dpkg.log && \
  : > /var/log/apt/term.log && \
  : > /var/log/apt/history.log && \
  : > /var/log/fontconfig.log && \
  : > /var/log/alternatives.log && \
  : |xz -vv > /var/log/apt/eipp.log.xz && \
  chmod --verbose -R go-rwx /etc/skel && \
  (echo umask 077; echo export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/stand; echo unset HUSHLOGIN; echo unset MOTD_SHOWN) | tee -a /etc/skel/.bashrc && \
  find /tmp /var/tmp -type f -ls -delete && \
  ( echo "# Example aliases" && \
    echo 'alias ered="env -i -- TMP=/dev/shm TEMP=/dev/shm TMPDIR=/dev/shm TERM=vt220 SHELL=/bin/false /bin/ed -E -r --"' && \
    echo 'alias eed="env -i -- TMP=/dev/shm TEMP=/dev/shm TMPDIR=/dev/shm TERM=vt220 SHELL=/bin/bash-static /bin/ed -E --"' && \
    echo 'alias eex="env -i -- TMP=/dev/shm TEMP=/dev/shm TMPDIR=/dev/shm TERM=vt220 SHELL=/bin/bash-static /usr/bin/vim.tiny -b -n -T vt220 -u /dev/null --noplugin -i /dev/null --clean -E -Z --not-a-term --"' && \
    echo 'alias evi="env -i -- TMP=/dev/shm TEMP=/dev/shm TMPDIR=/dev/shm TERM=vt220 SHELL=/bin/bash-static /usr/bin/vim.tiny -b -n -T vt220 -u /dev/null --noplugin -i /dev/null --clean --ttyfail --"') | tee -a /root/.bashrc /root/.profile && \
  rm -r -f /root/.cache/ && \
  chmod --verbose -R go-rwx /root && \
  chmod --verbose a-s /bin/fusermount /bin/mount /bin/ping /bin/ping6 /bin/su /bin/umount /sbin/unix_chkpwd /usr/bin/chage /usr/bin/chfn /usr/bin/chsh /usr/bin/cryptmount /usr/bin/dotlockfile /usr/bin/expiry /usr/bin/firejail /usr/bin/gpasswd /usr/bin/inetutils-traceroute /usr/bin/mail-lock /usr/bin/mail-touchlock /usr/bin/mail-unlock /usr/bin/newgidmap /usr/bin/newgrp /usr/bin/newuidmap /usr/bin/passwd /usr/bin/schroot /usr/bin/tcptraceroute.mt /usr/bin/wall /usr/bin/write.ul /usr/lib/chromium/chrome-sandbox /usr/lib/x86_64-linux-gnu/utempter/utempter /usr/libexec/lxc/lxc-user-nic /usr/sbin/rush /usr/sbin/vlock-main 2>&1 | tee -a /usr/local/etc/permissions && \
  chmod --verbose a-s /usr/bin/ssh-agent /usr/lib/openssh/ssh-keysign 2>&1 | tee -a /usr/local/etc/permissions && \
  chmod --verbose go-rwx /usr/local/etc/permissions && \
  (echo "#!/bin/bash-static"; echo 'for bin do perm=$(fgrep "mode of "\'\''"${bin}"\'\''" changed from " /usr/local/etc/permissions | head -n 1 | sed '\''s,^[^(]* changed from ,,'\'' |awk '\''{print $1}'\''|tr -cd 0-9 | head -c 4); if echo "${perm}" |grep -q "^[0-9][0-9][0-9][0-9]$"; then chmod --verbose "${perm}" "${bin}"; else echo Could not change permissions for "${bin}" 1>&2; exit 1; fi; done') > /usr/local/sbin/restore-permissions && \
  chmod --verbose 700 /usr/local/sbin/restore-permissions && \
  ln -sv /proc/mounts /etc/mtab && \
  touch /etc/init.d/.legacy-bootordering && \
  chmod --verbose o-w /run/screen /etc/hostname && \
  echo localhost > /etc/hostname && \
  find / -xdev -name "*.pyc" -ls && \
  find / -xdev -name "__pycache__" -ls && \
  find / -xdev -type f -perm -2000 -ls && \
  find / -xdev -type f -perm -4000 -ls && \
  find / -xdev -type f -perm -0002 -ls && \
  find / -xdev -type d -perm -0002 -ls && \
  true

FROM devuan-4 AS devuan-4-builder

RUN \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/stand && \
  set -x && \
  set -e && \
  umask 022 && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  cd /root && \
  export LANG=C && \
  export HOME=/root && \
  export TMP=/tmp && \
  export TEMP="${TMP}" && \
  export TMPDIR="${TMP}" && \
  export DEBIAN_FRONTEND=noninteractive && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  export PYTHONDONTWRITEBYTECODE=1 && \
  exec </dev/null && \
  \
  export CFLAGS=" -O -ggdb3 -fverbose-asm -mtune=generic " && \
  export CXXFLAGS=" ${CFLAGS} " && \
  \
  apt-get install -y --verbose-versions asciidoc asciidoctor autoconf automake binutils-dev bison build-essential cargo ccache cdbs clang cmake devscripts dh-autoreconf dh-exec dh-make dh-python docbook-xml docbook-xsl doxygen dpkg-dev flex fuse3 g++ golang-go help2man libacl1-dev libaio-dev libarchive-dev libarchive13 libaudit-dev libboost-context-dev libboost-filesystem-dev libboost-program-options-dev libboost-python-dev libboost-regex-dev libboost-system-dev libboost-thread-dev libbsd-dev libbz2-dev libcap-dev libcap-ng-dev libdevmapper-dev libdivsufsort-dev libdouble-conversion-dev libdrm-dev libdwarf-dev libelf-dev libevent-dev libfido2-dev libfmt-dev libfuse3-dev libgcrypt20-dev libglib2.0-dev libgnutls28-dev libgoogle-glog-dev libiberty-dev libjemalloc-dev liblz4-dev liblzma-dev liblzo2-dev libncurses-dev libncursesw5-dev libnet1-dev libnettle8 libnftables-dev libnl-3-dev libnl-route-3-dev libpam0g-dev libpkcs11-helper1-dev libprotobuf-c-dev libprotobuf-dev libprotoc-dev libsodium-dev libssl-dev libunwind-dev libwolfssl-dev libxxhash-dev libzstd-dev make musl-dev musl-tools nettle-dev ninja-build p7zip-full pandoc pkg-config protobuf-c-compiler protobuf-compiler python3-all python3-fuse python3-llfuse python3-pyfuse3 python3-setuptools ronn texinfo unrar xmlto yasm zlib1g-dev && \
  apt-get install -y --verbose-versions adwaita-icon-theme autoconf automake autopoint autotools-dev binutils binutils-common binutils-x86-64-linux-gnu bsdextrautils build-essential bzip2 comerr-dev cpp cpp-10 dbus dbus-x11 dconf-gsettings-backend dconf-service debhelper dh-autoreconf dh-exec dh-runit dh-strip-nondeterminism dpkg-dev dwz file fontconfig fontconfig-config fonts-dejavu-core g++ g++-10 gcc gcc-10 gettext gettext-base gir1.2-atk-1.0 gir1.2-atspi-2.0 gir1.2-freedesktop gir1.2-gdkpixbuf-2.0 gir1.2-glib-2.0 gir1.2-gtk-3.0 gir1.2-harfbuzz-0.0 gir1.2-pango-1.0 glib-networking glib-networking-common glib-networking-services groff-base gsettings-desktop-schemas gtk-update-icon-cache hicolor-icon-theme icu-devtools intltool-debian krb5-multidev libapparmor1 libarchive-zip-perl libasan6 libatk-bridge2.0-0 libatk-bridge2.0-dev libatk1.0-0 libatk1.0-data libatk1.0-dev libatomic1 libatspi2.0-0 libatspi2.0-dev libaudit-dev libavahi-client3 libavahi-common-data libavahi-common3 libbinutils libblkid-dev libbrotli-dev libbrotli1 libbsd-dev libbsd0 libc-dev-bin libc6-dev libcairo-gobject2 libcairo-script-interpreter2 libcairo2 libcairo2-dev libcap-ng-dev libcbor0 libcc1-0 libclone-perl libcolord2 libcrypt-dev libctf-nobfd0 libctf0 libcups2 libdatrie-dev libdatrie1 libdbus-1-3 libdbus-1-dev libdconf1 libdebhelper-perl libdeflate0 libdpkg-perl libdrm-amdgpu1 libdrm-common libdrm-intel1 libdrm-nouveau2 libdrm-radeon1 libdrm2 libedit-dev libedit2 libegl-dev libegl-mesa0 libegl1 libegl1-mesa-dev libelf1 libepoxy-dev libepoxy0 libexpat1 libexpat1-dev libffi-dev libfido2-1 libfido2-dev libfile-copy-recursive-perl libfile-slurp-perl libfile-stripnondeterminism-perl libfontconfig-dev libfontconfig1 libfontconfig1-dev libfreetype-dev libfreetype6 libfreetype6-dev libfribidi-dev libfribidi0 libgbm1 libgcc-10-dev libgdbm-compat4 libgdbm6 libgdk-pixbuf-2.0-0 libgdk-pixbuf-2.0-dev libgdk-pixbuf2.0-bin libgdk-pixbuf2.0-common libgirepository-1.0-1 libgl-dev libgl1 libgl1-mesa-dri libglapi-mesa libgles-dev libgles1 libgles2 libglib2.0-0 libglib2.0-bin libglib2.0-data libglib2.0-dev libglib2.0-dev-bin libglvnd-dev libglvnd0 libglx-dev libglx-mesa0 libglx0 libgomp1 libgraphite2-3 libgraphite2-dev libgssrpc4 libgtk-3-0 libgtk-3-common libgtk-3-dev libharfbuzz-dev libharfbuzz-gobject0 libharfbuzz-icu0 libharfbuzz0b libice-dev libice6 libicu-dev libicu67 libisl23 libitm1 libjbig0 libjpeg62-turbo libjson-glib-1.0-0 libjson-glib-1.0-common libkadm5clnt-mit12 libkadm5srv-mit12 libkdb5-10 libkrb5-dev liblcms2-2 libllvm11 liblsan0 liblzo2-2 libmagic-mgc libmagic1 libmd-dev libmd0 libmount-dev libmpc3 libmpdec3 libmpfr6 libncurses-dev libncurses6 libncursesw6 libnsl-dev libopengl-dev libopengl0 libpam0g-dev libpango-1.0-0 libpango1.0-dev libpangocairo-1.0-0 libpangoft2-1.0-0 libpangoxft-1.0-0 libpciaccess0 libpcre16-3 libpcre2-16-0 libpcre2-32-0 libpcre2-dev libpcre2-posix2 libpcre3-dev libpcre32-3 libpcrecpp0v5 libperl5.32 libpipeline1 libpixman-1-0 libpixman-1-dev libpng-dev libpng16-16 libproxy1v5 libpsl5 libpthread-stubs0-dev libpython3-stdlib libpython3.9-minimal libpython3.9-stdlib libquadmath0 libreadline8 libref-util-perl librest-0.7-0 libselinux1-dev libsensors-config libsensors5 libsepol1-dev libsigsegv2 libsm-dev libsm6 libsoup-gnome2.4-1 libsoup2.4-1 libsqlite3-0 libssl-dev libstdc++-10-dev libsub-override-perl libsystemd-dev libsystemd0 libtext-hogan-perl libtext-trim-perl libthai-data libthai-dev libthai0 libtiff5 libtirpc-dev libtool libtsan0 libubsan1 libuchardet0 libvulkan1 libwayland-bin libwayland-client0 libwayland-cursor0 libwayland-dev libwayland-egl1 libwayland-server0 libwebp6 libwrap0 libwrap0-dev libx11-6 libx11-data libx11-dev libx11-xcb1 libxau-dev libxau6 libxcb-dri2-0 libxcb-dri3-0 libxcb-glx0 libxcb-present0 libxcb-render0 libxcb-render0-dev libxcb-shm0 libxcb-shm0-dev libxcb-sync1 libxcb-xfixes0 libxcb1 libxcb1-dev libxcomposite-dev libxcomposite1 libxcursor-dev libxcursor1 libxdamage-dev libxdamage1 libxdmcp-dev libxdmcp6 libxext-dev libxext6 libxfixes-dev libxfixes3 libxft-dev libxft2 libxi-dev libxi6 libxinerama-dev libxinerama1 libxkbcommon-dev libxkbcommon0 libxml2 libxrandr-dev libxrandr2 libxrender-dev libxrender1 libxshmfence1 libxtst-dev libxtst6 libxxf86vm1 libz3-4 linux-libc-dev m4 make man-db media-types pango1.0-tools patch perl perl-modules-5.32 pkg-config po-debconf python3 python3-distutils python3-lib2to3 python3-minimal python3.9 python3.9-minimal readline-common sensible-utils shared-mime-info ucf uuid-dev wayland-protocols x11-common x11proto-dev x11proto-input-dev x11proto-randr-dev x11proto-record-dev x11proto-xext-dev x11proto-xinerama-dev xkb-data xorg-sgml-doctools xtrans-dev xz-utils zlib1g-dev libcap2 libprocps8 procps psmisc runit-helper && \
  apt-get install -y --verbose-versions bsd-mailx diffstat exim4-base exim4-config exim4-daemon-light gir1.2-rsvg-2.0 imagemagick imagemagick-6-common imagemagick-6.q16 libacl1-dev libaom0 libasound2-dev libattr1-dev libbz2-dev libdav1d4 libde265-0 libdeflate-dev libdjvulibre-dev libdjvulibre-text libdjvulibre21 libexif-dev libexif12 libfftw3-double3 libgd3 libgif-dev libgif7 libgmp-dev libgmpxx4ldbl libgnutls-dane0 libgnutls-openssl27 libgnutls28-dev libgnutlsxx28 libgpm-dev libheif1 libidn2-dev libilmbase-dev libilmbase25 libjansson-dev libjbig-dev libjpeg-dev libjpeg62-turbo-dev liblcms2-dev liblockfile-dev liblqr-1-0 liblqr-1-0-dev libltdl-dev libltdl7 liblzma-dev libm17n-0 libm17n-dev libmagick++-6-headers libmagick++-6.q16-8 libmagick++-6.q16-dev libmagickcore-6-arch-config libmagickcore-6-headers libmagickcore-6.q16-6 libmagickcore-6.q16-6-extra libmagickcore-6.q16-dev libmagickwand-6-headers libmagickwand-6.q16-6 libmagickwand-6.q16-dev libopenexr-dev libopenexr25 libopenjp2-7 libopenjp2-7-dev libotf-dev libotf0 libp11-kit-dev librsvg2-2 librsvg2-common librsvg2-dev libtasn1-6-dev libtext-unidecode-perl libtiff-dev libtiffxx5 libunbound8 libwebpdemux2 libwebpmux3 libwmf-dev libwmf0.2-7 libx265-192 libxaw7 libxaw7-dev libxml-libxml-perl libxml-namespacesupport-perl libxml-sax-base-perl libxml-sax-perl libxml2-dev libxmu-dev libxmu-headers libxmu6 libxpm-dev libxpm4 libxt-dev libxt6 m17n-db nettle-dev quilt tex-common texinfo xaw3dg xaw3dg-dev xutils-dev  gnupg-agent libgccjit-10-dev libgccjit0 libncurses5-dev   emacsen-common install-info  libtinfo6 zlib1g libgccjit0 libgmp10 libisl23 libmpc3 libmpfr6 libzstd1 && \
  \
  : > /usr/bin/x86_64-linux-gnu-strip && \
  cd /usr/local && \
  ln -s lib lib64 && \
  \
  cd /usr/local/src && \
  mkdir -p /usr/local/src/stand && \
  git clone --recursive https://github.com/schnaader/precomp-cpp && \
  cd precomp-cpp && \
  cmake . && \
  make && \
  make install && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/Intensity/srep && \
  cd srep && ./Makefile install && mv /usr/local/bin/srep /usr/local/src/stand/ && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/Intensity/nzcc && \
  cd nzcc && ./Makefile install && mv /usr/local/bin/nzcc /usr/local/src/stand/ && \
  \
  cd /usr/local/src && \
  mkdir nanozip && \
  cd nanozip && \
  wget https://web.archive.org/web/20161102211532/http://nanozip.net/nanozip-0.09a.linux32.zip && \
  unzip nanozip-0.09a.linux32.zip && \
  cp -p nz /usr/local/src/stand/ && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/Intensity/mcm && \
  cd mcm && git checkout v0.84sk4 && \
  sed -i -e "/^STATIC/s/^/#/" Makefile && \
  ./Makefile install && mv /usr/local/bin/mcm /usr/local/src/stand/ && \
  \
  cd /usr/local/src && \
  wget https://nishi.dreamhosters.com/u/mcm_084_textprep_v1.7z && \
  7z x mcm_084_textprep_v1.7z && \
  cd mcm_084_textprep_v1/src && \
  sh g && \
  cp -p ./mcmwrt /usr/local/bin/ && \
  \
  cd /usr/local/src && \
  git clone --recursive https://git.gavinhoward.com/gavin/bc && \
  cd bc && \
  ./configure.sh -g && \
  make && \
  make install && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/IlyaGrebnov/bsc-m03 && \
  cd bsc-m03/ && \
  cmake . && \
  make && \
  cp -p bsc-m03 /usr/local/bin/ && \
  \
  cd /usr/local/src && \
  git clone https://github.com/miekg/rdup && \
  cd rdup && \
  autoreconf && \
  ./configure --enable-debug && \
  sed -i -e '/^CFLAGS=/s,$, -Wno-error,' GNUmakefile && \
  make && \
  make install && \
  : quite a few library deps && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/deadpixi/mtm && \
  cd mtm && \
  make && \
  make install && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/bwalex/tc-play && \
  cd tc-play && \
  cmake . && \
  make && \
  make install && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/ansemjo/aenker && \
  cd aenker && \
  make && \
  make install PREFIX=/usr/local && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/nlitsme/gnubc && \
  cd gnubc && \
  bash ./autogen.sh && \
  ./configure --program-prefix=g && \
  make && \
  make install && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/ttsiodras/rsbep-backup && \
  cd rsbep-backup && \
  aclocal && \
  ./configure && \
  make && \
  make install && \
  \
  cd /usr/local/src && \
  wget http://deb.debian.org/debian/pool/main/v/vdmfec/vdmfec_1.0-2.dsc && \
  wget http://deb.debian.org/debian/pool/main/v/vdmfec/vdmfec_1.0.orig.tar.gz && \
  wget http://deb.debian.org/debian/pool/main/v/vdmfec/vdmfec_1.0-2.diff.gz && \
  dpkg-source -x vdmfec_1.0-2.dsc && \
  cd vdmfec-1.0 && \
  ./debian/rules binary && \
  cd .. && \
  dpkg -i vdmfec_1.0-2_amd64.deb && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/Intensity/GLZA && \
  cd GLZA && \
  make && \
  cp -p ./GLZA /usr/local/bin/ && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/sisong/HDiffPatch && \
  cd HDiffPatch && \
  git clone https://github.com/sisong/libmd5.git ../libmd5 && \
  git clone https://github.com/sisong/lzma.git ../lzma && \
  git clone -b v1.5.2 https://github.com/facebook/zstd.git ../zstd && \
  make && \
  make install && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/julian-klode/ddelta && \
  cd ddelta && \
  make && \
  cp -p ddelta_generate ddelta_apply /usr/local/bin/ && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/lengfeld/blockdiff && \
  cd blockdiff && \
  make && \
  make tests && \
  make install install-doc prefix=usr/local && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/dm-vdo/vdo.git && \
  cd vdo/ && \
  make bindir=/usr/local/bin mandir=/usr/local/share/man defaultdocdir=/usr/local/share/doc sysconfdir=/usr/local/etc && \
  make install bindir=/usr/local/bin mandir=/usr/local/share/man defaultdocdir=/usr/local/share/doc sysconfdir=/usr/local/etc && \
  \
  cd /usr/local/src && \
  cargo install orz --git https://github.com/richox/orz --tag v1.6.2 && \
  mv ~/.cargo/bin/orz /usr/local/bin/ && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/flanglet/kanzi-cpp && \
  cd kanzi-cpp/src && \
  git checkout b78f3d843232f225c9f9b26403fc2482649cb012 && \
  sed -i -e "s, -march=native , ${CFLAGS} ,g" Makefile && \
  make && \
  make install && \
  chmod --verbose 0755 /usr/local/bin/kanzi && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/jedisct1/dsvpn && \
  cd dsvpn && \
  echo " ${CFLAGS} " > .cflags && \
  make && \
  make install && \
  \
  cd /usr/local/src && \
  git clone --recursive https://git.sr.ht/~cmusser/vpnd && \
  cd vpnd && \
  make && \
  make install && \
  \
  cd /usr/local/src && \
  wget http://downloads.sourceforge.net/base91/base91-0.6.0.tar.gz && \
  tar xzpkf base91-*.tar.gz && \
  cd base91-0.6.0 && \
  make && \
  make install && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/wangyu-/tinyfecVPN && \
  cd tinyfecVPN && \
  make && \
  cp -p tinyvpn /usr/local/sbin/ && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/secgroup/Mignis && \
  cd Mignis && \
  python3 setup.py build && \
  python3 setup.py install && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/wangyu-/udp2raw && \
  cd udp2raw && \
  make && \
  cp -p udp2raw /usr/local/sbin/ && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/rescrv/encryptify && \
  cd encryptify && \
  autoreconf -ivf && \
  ./configure && \
  make && \
  make install && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/skeeto/enchive && \
  cd enchive && \
  sed -i -e "s,/dev/tty,/bin/false/skip," src/enchive.c && \
  make CFLAGS=" -DENCHIVE_AGENT_DEFAULT_ENABLED=0 -DENCHIVE_OPTION_AGENT=0 ${CFLAGS} " install && \
  \
  cd /usr/local/src && \
  ARCH="$(uname -m)" && \
  URL=https://storage.googleapis.com/gvisor/releases/release/latest/${ARCH} && \
  wget ${URL}/runsc ${URL}/runsc.sha512 ${URL}/containerd-shim-runsc-v1 ${URL}/containerd-shim-runsc-v1.sha512 && \
  sha512sum -c runsc.sha512 -c containerd-shim-runsc-v1.sha512 && \
  chmod a+rx runsc containerd-shim-runsc-v1 && \
  mv runsc containerd-shim-runsc-v1 /usr/local/bin/ && \
  /usr/local/bin/runsc install && \
  unset ARCH && \
  unset URL && \
  \
  cd /usr/include && \
  ln -s libdrm drm && \
  cd /usr/local/src && \
  git clone --recursive https://github.com/checkpoint-restore/criu && \
  cd criu && \
  git checkout cd9680ce8935ba828ccdd59314442900c9699703 && \
  make && \
  make install && \
  rm -v /usr/include/drm && \
  \
  cd /usr/local/src/ && \
  apt-get -y install --verbose-versions autoconf automake autopoint autotools-dev bash-completion binutils binutils-common binutils-x86-64-linux-gnu bsdextrautils build-essential bzip2 cpp cpp-10 debhelper dh-autoreconf dh-strip-nondeterminism docbook-xml docbook-xsl dpkg-dev dwz eudev file flex g++ g++-10 gcc gcc-10 gettext gettext-base groff-base intltool-debian libarchive-zip-perl libasan6 libatomic1 libbinutils libc-dev-bin libc6-dev libcc1-0 libcrypt-dev libctf-nobfd0 libctf0 libdebhelper-perl libdpkg-perl libelf1 libfile-stripnondeterminism-perl libgcc-10-dev libgdbm-compat4 libgdbm6 libgomp1 libicu67 libisl23 libitm1 libkmod2 liblsan0 libmagic-mgc libmagic1 libmpc3 libmpfr6 libncurses6 libncursesw6 libnsl-dev libosp5 libperl5.32 libpipeline1 libpod-parser-perl libprocps8 libquadmath0 libsgmls-perl libsigsegv2 libstdc++-10-dev libsub-override-perl libtirpc-dev libtool libtsan0 libubsan1 libuchardet0 libxml2 libxslt1.1 libyaml-tiny-perl linux-libc-dev m4 make man-db opensp patch perl perl-modules-5.32 po-debconf po4a procps sensible-utils sgml-base sgml-data udev xml-core xsltproc xz-utils iproute2 python3-docutils cmake gcc libtool libssl-dev make ninja-build git bc libc6-dev libldns-dev libbsd-dev libssl-dev libgmp-dev && \
  git clone --recursive -b 9.23.1 https://github.com/LINBIT/drbd-utils && \
  cd drbd-utils/ && \
  ./autogen.sh && \
  ./configure --with-xen --with-distro=debian --with-initscripttype=sysv --with-bashcompletion --with-udev && \
  make && \
  make install && \
  \
  cd /usr/local/src/ && \
  wget https://openvpn.fox-it.com/repos/source/2.5.6nl1/openvpn-nl-src-2.5.6nl1.tar.gz && \
  tar xzpkf openvpn-nl-src-2.5.6nl1.tar.gz && \
  cd openvpn-nl && \
  sed -i -e "/--enable-systemd/s/--enable-systemd/ --disable-systemd --disable-plugins /" configure-openvpn.sh && \
  sed -i -e "/SYSTEMD_FILES='build-openvpn-nl/s,'[^']*',''," archive.sh && \
  ./build-openvpn-nl.sh && \
  cd build-openvpn-nl && \
  make prefix=/usr/local install && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/openzfs/zfs && \
  cd zfs && \
  mkdir -p /usr/local/lib/udev/rules.d && \
  MAJMIN="$(git branch -a |grep staging|grep remotes/origin/zfs-2|sed 's,^ *remotes/origin/zfs-,,'|cut -d. -f1-2|sort -n | uniq  | tail -n 1 | sed 's,\.,\\.,')" && \
  git checkout zfs-$(eval echo $MAJMIN).$(git branch -a |grep staging|grep remotes/origin/zfs-2|sed 's,^ *remotes/origin/zfs-,,'|grep '^'"${MAJMIN}"'\.' | sed s,"${MAJMIN}\.",, | sort -n |uniq | tail -n 1) && \
  unset MAJMIN && \
  ./autogen.sh  && \
  ./configure --disable-nls --enable-sysvinit --disable-systemd --enable-debuginfo --with-config=user --with-mounthelperdir=/usr/local/sbin --with-udevdir=/usr/local/lib/udev && \
  make && \
  make check && \
  make install && \
  rm -r /usr/local/share/zfs/zfs-tests && \
  \
  apt-get source util-linux && \
  cd util-linux-* && \
  ./debian/rules binary && \
  for i in choom mkfs switch_root pivot_root blockdev unshare nsenter; do rm -v $i && V=1 make $i 2>&1 | grep '^libtool: link:' | tail -n 1 | sed 's,.*:,,' | sed 's,$, -static,' |sh && cp -p "$i" /usr/local/src/stand/ul_"$i"; done && \
  rm losetup && make losetup 2>&1 |grep '^libtool: link:' |tail -n 1| sed 's,.*:,,' |sed 's,$, -static ,' | sed 's,\.so ,.a ,g' | sh && cp -p .libs/losetup /usr/local/src/stand/ul_losetup && \
  \
  echo "deb-src http://deb.devuan.org/merged daedalus main contrib non-free" | tee -a /etc/apt/sources.list && \
  apt-get update && \
  \
  cd /usr/local/src && \
  apt-get source openssh-server && \
  cd ./openssh-9.?p?/ && \
  sed -i -e '/confflags .*with-default-path/s,confflags.*,confflags += --with-cppflags=" -UWITH_XMSS -DWITH_XMSS ${CPPFLAGS} " --with-ldns --without-libedit --without-security-key-builtin --with-ssl-engine --without-kerberos5 --with-default-path=/sbin:/bin:/usr/sbin:/usr/bin:/usr/games:/usr/local/sbin:/usr/local/bin:/stand --with-superuser-path=/sbin:/bin:/usr/sbin:/usr/bin:/usr/games:/usr/local/sbin:/usr/local/bin:/stand  --disable-strip --disable-security-key --disable-pkcs11 ,' -e "/^cflags.*CFLAGS/s,$, -UWITH_XMSS -DWITH_XMSS -Og -ggdb3 -fverbose-asm -mtune=generic ," debian/rules && \
  ./debian/rules binary && \
  mkdir -p -v /opt/artifact/deb && \
  cd ../ && \
  packages="$(ls -1trd openssh-client_9.?p*_amd64.deb openssh-server_9.?p*_amd64.deb openssh-sftp-server_9.?p*_amd64.deb ssh_9.?p*_all.deb )" && \
  dpkg -i ${packages} && \
  cp -p -v ${packages} /opt/artifact/deb/ && \
  unset packages && \
  \
  cd /usr/local/src && \
  apt-get source emacs-nox && \
  cd ./emacs-28.?+?/ && \
  sed -i -e "/CC=gcc-12/d" -e "/confflags_nox.*without-gsettings/s/without-gsettings/without-gsettings --disable-build-details --disable-acl --without-all --without-mailutils --without-pop --without-kerberos --without-kerberos5 --without-hesiod --with-sound=no --without-xpm --without-jpeg --without-tiff --without-gif --without-png --without-rsvg --without-lcms2 --without-libsystemd --without-cairo --without-xml2 --without-imagemagick --without-native-image-api --without-json --without-xft --without-harfbuzz --without-libotf --without-m17n-flt --without-toolkit-scroll-bars --without-xaw3d --without-xim --without-xdbe --without-gpm --without-dbus --without-gconf --without-selinux --without-gnutls --with-zlib --with-native-compilation --without-xwidgets --without-x --without-libgmp --without-included-regex /" debian/rules && \
  DEB_BUILD_OPTIONS=nocheck ./debian/rules binary && \
  cd ../ && \
  packages="$(ls -1trd emacs-nox_28.?+*_amd64.deb emacs-el_28.?+*_all.deb emacs-common_28.?+*_all.deb emacs-bin-common_28.?+*_amd64.deb emacs_28.*_all.deb)" && \
  dpkg -i ${packages} && \
  cp -p -v ${packages} /opt/artifact/deb/ && \
  \
  cd /usr/local/src && \
  apt-get source podman-compose && \
  cd podman-compose-1* && \
  ./debian/rules binary && \
  cd .. && \
  dpkg -i podman-compose*all.deb && \
  \
  cd /usr/local/src && \
  wget https://github.com/mgoltzsche/podman-static/releases/download/v4.4.2/podman-linux-amd64.tar.gz && \
  tar -x -p -f podman-linux-amd64.tar.gz -k -v -z && \
  cd podman-linux-amd64/ && \
  tar -C usr/ -c -v -f - local/ | tar -C /usr/ -x -p -k -v -f - && \
  tar -c -v -f - etc/ | tar -C /usr/local/ -x -p -k -v -f - && \
  \
  cd /usr/local/src && \
  apt-get download binutils-x86-64-linux-gnu && \
  dpkg -i binutils-x86-64-linux-gnu_*_amd64.deb && \
  apt-get source toybox && \
  export LDFLAGS=-static && \
  export CC=musl-gcc && \
  ln -s /usr/include/asm-generic /usr/include/x86_64-linux-musl/asm-generic && \
  ln -s /usr/include/x86_64-linux-gnu/asm /usr/include/x86_64-linux-musl/asm && \
  ln -s /usr/include/linux /usr/include/x86_64-linux-musl/linux && \
  cd toybox*/ && \
  sed -i -e '/defconfig$/s/C/CC=musl-gcc C/' -e '/defconfig$/s/(LDFLAGS)"/(LDFLAGS) -static" LDFLAGS=-static /' debian/rules && \
  ./debian/rules binary && \
  dpkg -i ../toybox_*_amd64.deb && \
  ln generated/unstripped/toybox /usr/local/src/stand/ && \
  for i in acpi ascii base32 base64 blkid chattr chrt cksum comm count crc32 eject file flock fmt fsync getconf gpiodetect gpiofind gpioget gpioinfo gpioset help hexedit host iconv inotifyd install iorenice iotop killall5 lsattr lspci lsusb makedevs mcookie mix mountpoint nbd-client nbd-server netcat nice nohup oneit pgrep pkill pmap printenv prlimit pwdx pwgen readahead readelf rfkill rtcwake setfattr sha224sum sha384sum sha3sum sntp split uclampset ulimit unicode uuidgen vmstat; do ln /usr/local/src/stand/toybox /usr/local/src/stand/"$i"; done && \
  \
  cd /usr/local/src && \
  curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain stable && \
  source "/root/.cargo/env" && \
  git clone --recursive https://github.com/rosenpass/rosenpass && \
  cd rosenpass/ && \
  cargo install --path . && \
  mv -v ~/.cargo/bin/rosenpass /usr/local/sbin/ && \
  \
  cd /usr/local && \
  mv /usr/local/src/vdmfec*.deb /usr/local/src/podman-compose*all.deb /opt/artifact/deb/ && \
  mv /usr/local/src/stand/ /opt/artifact/stand/ && \
  rm -r src && \
  cd /usr && \
  rm -v /usr/local/lib/lib*.a /usr/local/lib/x86_64-linux-gnu/lib*.a && \
  mv local /opt/artifact/local/ && \
  rm -r /root/.cargo /root/.rustup && \
  true

FROM docker://devuan/devuan:chimaera AS devuan-4-builder2
COPY --from=devuan-4 /usr/local/etc/permissions /usr/local/etc/permissions

RUN \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/stand && \
  set -x && \
  set -e && \
  umask 022 && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  cd /root && \
  export LANG=C && \
  export HOME=/root && \
  export TMP=/tmp && \
  export TEMP="${TMP}" && \
  export TMPDIR="${TMP}" && \
  export DEBIAN_FRONTEND=noninteractive && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  export PYTHONDONTWRITEBYTECODE=1 && \
  exec </dev/null && \
  \
  export CFLAGS=" -O -ggdb3 -fverbose-asm -mtune=generic " && \
  export CXXFLAGS=" ${CFLAGS} " && \
  for insistence in Suggests Recommends; do echo APT::Install-"${insistence}" '"0";' | tee -a /etc/apt/apt.conf.d/42disable; done && \
  chmod --verbose go+r /etc/apt/apt.conf.d/42disable && \
  (for src in "" "-src"; do for repo in "" "-updates" "-security" "-backports"; do echo deb"${src}" http://deb.devuan.org/merged chimaera"${repo}" main contrib non-free; done; done) > /etc/apt/sources.list && \
  apt-get update && \
  apt-get -y dist-upgrade && \
  \
  apt-get install -y --verbose-versions asciidoc asciidoctor autoconf automake binutils-dev bison build-essential cargo ccache cdbs clang cmake devscripts dh-autoreconf dh-exec dh-make dh-python docbook-xml docbook-xsl doxygen dpkg-dev flex fuse3 g++ golang-1.19 golang-1.19-go help2man libacl1-dev libaio-dev libarchive-dev libarchive13 libaudit-dev libboost-context-dev libboost-filesystem-dev libboost-program-options-dev libboost-python-dev libboost-regex-dev libboost-system-dev libboost-thread-dev libbsd-dev libbz2-dev libcap-dev libcap-ng-dev libdevmapper-dev libdivsufsort-dev libdouble-conversion-dev libdrm-dev libdwarf-dev libelf-dev libevent-dev libfido2-dev libfmt-dev libfuse3-dev libgcrypt20-dev libglib2.0-dev libgnutls28-dev libgoogle-glog-dev libiberty-dev libjemalloc-dev liblz4-dev liblzma-dev liblzo2-dev libncurses-dev libncursesw5-dev libnet1-dev libnettle8 libnftables-dev libnl-3-dev libnl-route-3-dev libpam0g-dev libpkcs11-helper1-dev libprotobuf-c-dev libprotobuf-dev libprotoc-dev libsodium-dev libssl-dev libunwind-dev libwolfssl-dev libxxhash-dev libzstd-dev make musl-dev musl-tools nettle-dev ninja-build p7zip-full pandoc pkg-config protobuf-c-compiler protobuf-compiler python3-all python3-fuse python3-llfuse python3-pyfuse3 python3-setuptools ronn texinfo unrar xmlto yasm zlib1g-dev && \
  apt-get install -y --verbose-versions adwaita-icon-theme autoconf automake autopoint autotools-dev binutils binutils-common binutils-x86-64-linux-gnu bsdextrautils build-essential bzip2 comerr-dev cpp cpp-10 dbus dbus-x11 dconf-gsettings-backend dconf-service debhelper dh-autoreconf dh-exec dh-runit dh-strip-nondeterminism dpkg-dev dwz file fontconfig fontconfig-config fonts-dejavu-core g++ g++-10 gcc gcc-10 gettext gettext-base gir1.2-atk-1.0 gir1.2-atspi-2.0 gir1.2-freedesktop gir1.2-gdkpixbuf-2.0 gir1.2-glib-2.0 gir1.2-gtk-3.0 gir1.2-harfbuzz-0.0 gir1.2-pango-1.0 glib-networking glib-networking-common glib-networking-services groff-base gsettings-desktop-schemas gtk-update-icon-cache hicolor-icon-theme icu-devtools intltool-debian krb5-multidev libapparmor1 libarchive-zip-perl libasan6 libatk-bridge2.0-0 libatk-bridge2.0-dev libatk1.0-0 libatk1.0-data libatk1.0-dev libatomic1 libatspi2.0-0 libatspi2.0-dev libaudit-dev libavahi-client3 libavahi-common-data libavahi-common3 libbinutils libblkid-dev libbrotli-dev libbrotli1 libbsd-dev libbsd0 libc-dev-bin libc6-dev libcairo-gobject2 libcairo-script-interpreter2 libcairo2 libcairo2-dev libcap-ng-dev libcbor0 libcc1-0 libclone-perl libcolord2 libcrypt-dev libctf-nobfd0 libctf0 libcups2 libdatrie-dev libdatrie1 libdbus-1-3 libdbus-1-dev libdconf1 libdebhelper-perl libdeflate0 libdpkg-perl libdrm-amdgpu1 libdrm-common libdrm-intel1 libdrm-nouveau2 libdrm-radeon1 libdrm2 libedit-dev libedit2 libegl-dev libegl-mesa0 libegl1 libegl1-mesa-dev libelf1 libepoxy-dev libepoxy0 libexpat1 libexpat1-dev libffi-dev libfido2-1 libfido2-dev libfile-copy-recursive-perl libfile-slurp-perl libfile-stripnondeterminism-perl libfontconfig-dev libfontconfig1 libfontconfig1-dev libfreetype-dev libfreetype6 libfreetype6-dev libfribidi-dev libfribidi0 libgbm1 libgcc-10-dev libgdbm-compat4 libgdbm6 libgdk-pixbuf-2.0-0 libgdk-pixbuf-2.0-dev libgdk-pixbuf2.0-bin libgdk-pixbuf2.0-common libgirepository-1.0-1 libgl-dev libgl1 libgl1-mesa-dri libglapi-mesa libgles-dev libgles1 libgles2 libglib2.0-0 libglib2.0-bin libglib2.0-data libglib2.0-dev libglib2.0-dev-bin libglvnd-dev libglvnd0 libglx-dev libglx-mesa0 libglx0 libgomp1 libgraphite2-3 libgraphite2-dev libgssrpc4 libgtk-3-0 libgtk-3-common libgtk-3-dev libharfbuzz-dev libharfbuzz-gobject0 libharfbuzz-icu0 libharfbuzz0b libice-dev libice6 libicu-dev libicu67 libisl23 libitm1 libjbig0 libjpeg62-turbo libjson-glib-1.0-0 libjson-glib-1.0-common libkadm5clnt-mit12 libkadm5srv-mit12 libkdb5-10 libkrb5-dev liblcms2-2 libllvm11 liblsan0 liblzo2-2 libmagic-mgc libmagic1 libmd-dev libmd0 libmount-dev libmpc3 libmpdec3 libmpfr6 libncurses-dev libncurses6 libncursesw6 libnsl-dev libopengl-dev libopengl0 libpam0g-dev libpango-1.0-0 libpango1.0-dev libpangocairo-1.0-0 libpangoft2-1.0-0 libpangoxft-1.0-0 libpciaccess0 libpcre16-3 libpcre2-16-0 libpcre2-32-0 libpcre2-dev libpcre2-posix2 libpcre3-dev libpcre32-3 libpcrecpp0v5 libperl5.32 libpipeline1 libpixman-1-0 libpixman-1-dev libpng-dev libpng16-16 libproxy1v5 libpsl5 libpthread-stubs0-dev libpython3-stdlib libpython3.9-minimal libpython3.9-stdlib libquadmath0 libreadline8 libref-util-perl librest-0.7-0 libselinux1-dev libsensors-config libsensors5 libsepol1-dev libsigsegv2 libsm-dev libsm6 libsoup-gnome2.4-1 libsoup2.4-1 libsqlite3-0 libssl-dev libstdc++-10-dev libsub-override-perl libsystemd-dev libsystemd0 libtext-hogan-perl libtext-trim-perl libthai-data libthai-dev libthai0 libtiff5 libtirpc-dev libtool libtsan0 libubsan1 libuchardet0 libvulkan1 libwayland-bin libwayland-client0 libwayland-cursor0 libwayland-dev libwayland-egl1 libwayland-server0 libwebp6 libwrap0 libwrap0-dev libx11-6 libx11-data libx11-dev libx11-xcb1 libxau-dev libxau6 libxcb-dri2-0 libxcb-dri3-0 libxcb-glx0 libxcb-present0 libxcb-render0 libxcb-render0-dev libxcb-shm0 libxcb-shm0-dev libxcb-sync1 libxcb-xfixes0 libxcb1 libxcb1-dev libxcomposite-dev libxcomposite1 libxcursor-dev libxcursor1 libxdamage-dev libxdamage1 libxdmcp-dev libxdmcp6 libxext-dev libxext6 libxfixes-dev libxfixes3 libxft-dev libxft2 libxi-dev libxi6 libxinerama-dev libxinerama1 libxkbcommon-dev libxkbcommon0 libxml2 libxrandr-dev libxrandr2 libxrender-dev libxrender1 libxshmfence1 libxtst-dev libxtst6 libxxf86vm1 libz3-4 linux-libc-dev m4 make man-db media-types pango1.0-tools patch perl perl-modules-5.32 pkg-config po-debconf python3 python3-distutils python3-lib2to3 python3-minimal python3.9 python3.9-minimal readline-common sensible-utils shared-mime-info ucf uuid-dev wayland-protocols x11-common x11proto-dev x11proto-input-dev x11proto-randr-dev x11proto-record-dev x11proto-xext-dev x11proto-xinerama-dev xkb-data xorg-sgml-doctools xtrans-dev xz-utils zlib1g-dev libcap2 libprocps8 procps psmisc runit-helper && \
  apt-get install -y --verbose-versions bsd-mailx diffstat exim4-base exim4-config exim4-daemon-light gir1.2-rsvg-2.0 imagemagick imagemagick-6-common imagemagick-6.q16 libacl1-dev libaom0 libasound2-dev libattr1-dev libbz2-dev libdav1d4 libde265-0 libdeflate-dev libdjvulibre-dev libdjvulibre-text libdjvulibre21 libexif-dev libexif12 libfftw3-double3 libgd3 libgif-dev libgif7 libgmp-dev libgmpxx4ldbl libgnutls-dane0 libgnutls-openssl27 libgnutls28-dev libgnutlsxx28 libgpm-dev libheif1 libidn2-dev libilmbase-dev libilmbase25 libjansson-dev libjbig-dev libjpeg-dev libjpeg62-turbo-dev liblcms2-dev liblockfile-dev liblqr-1-0 liblqr-1-0-dev libltdl-dev libltdl7 liblzma-dev libm17n-0 libm17n-dev libmagick++-6-headers libmagick++-6.q16-8 libmagick++-6.q16-dev libmagickcore-6-arch-config libmagickcore-6-headers libmagickcore-6.q16-6 libmagickcore-6.q16-6-extra libmagickcore-6.q16-dev libmagickwand-6-headers libmagickwand-6.q16-6 libmagickwand-6.q16-dev libopenexr-dev libopenexr25 libopenjp2-7 libopenjp2-7-dev libotf-dev libotf0 libp11-kit-dev librsvg2-2 librsvg2-common librsvg2-dev libtasn1-6-dev libtext-unidecode-perl libtiff-dev libtiffxx5 libunbound8 libwebpdemux2 libwebpmux3 libwmf-dev libwmf0.2-7 libx265-192 libxaw7 libxaw7-dev libxml-libxml-perl libxml-namespacesupport-perl libxml-sax-base-perl libxml-sax-perl libxml2-dev libxmu-dev libxmu-headers libxmu6 libxpm-dev libxpm4 libxt-dev libxt6 m17n-db nettle-dev quilt tex-common texinfo xaw3dg xaw3dg-dev xutils-dev  gnupg-agent libgccjit-10-dev libgccjit0 libncurses5-dev   emacsen-common install-info  libtinfo6 zlib1g libgccjit0 libgmp10 libisl23 libmpc3 libmpfr6 libzstd1 && \
  apt-get -y install --verbose-versions autoconf automake autopoint autotools-dev bash-completion binutils binutils-common binutils-x86-64-linux-gnu bsdextrautils build-essential bzip2 cpp cpp-10 debhelper dh-autoreconf dh-strip-nondeterminism docbook-xml docbook-xsl dpkg-dev dwz eudev file flex g++ g++-10 gcc gcc-10 gettext gettext-base groff-base intltool-debian libarchive-zip-perl libasan6 libatomic1 libbinutils libc-dev-bin libc6-dev libcc1-0 libcrypt-dev libctf-nobfd0 libctf0 libdebhelper-perl libdpkg-perl libelf1 libfile-stripnondeterminism-perl libgcc-10-dev libgdbm-compat4 libgdbm6 libgomp1 libicu67 libisl23 libitm1 libkmod2 liblsan0 libmagic-mgc libmagic1 libmpc3 libmpfr6 libncurses6 libncursesw6 libnsl-dev libosp5 libperl5.32 libpipeline1 libpod-parser-perl libprocps8 libquadmath0 libsgmls-perl libsigsegv2 libstdc++-10-dev libsub-override-perl libtirpc-dev libtool libtsan0 libubsan1 libuchardet0 libxml2 libxslt1.1 libyaml-tiny-perl linux-libc-dev m4 make man-db opensp patch perl perl-modules-5.32 po-debconf po4a procps sensible-utils sgml-base sgml-data udev xml-core xsltproc xz-utils iproute2 python3-docutils cmake gcc libtool libssl-dev make ninja-build git bc libc6-dev wget && \
  \
  mkdir -p -v /opt/artifact/deb && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/Intensity/xsplit && \
  cd ./xsplit/ && \
  ./Makefile install && \
  \
  cd /usr/local/src && \
  wget http://deb.debian.org/debian/pool/main/s/sks-ecc/sks-ecc_0.93-6.dsc && \
  wget http://deb.debian.org/debian/pool/main/s/sks-ecc/sks-ecc_0.93.orig.tar.gz && \
  wget http://deb.debian.org/debian/pool/main/s/sks-ecc/sks-ecc_0.93-6.debian.tar.xz && \
  dpkg-source -x sks-ecc_0.93-6.dsc && \
  cd sks-ecc-0.93 && \
  ./debian/rules binary && \
  cd .. && \
  mv --verbose sks-ecc_0.93-6_amd64.deb sks-ecc-doc_0.93-6_all.deb /opt/artifact/deb/ && \
  \
  cd /usr/local/src && \
  mkdir --verbose -p -m 0755 /var/empty && \
  groupadd sshd && \
 echo SKIP useradd -g sshd -c "sshd privsep" -d /var/empty -s /bin/false sshd && \
  git clone --recursive https://github.com/open-quantum-safe/openssh && \
  cd openssh && \
  ./oqs-scripts/clone_liboqs.sh && \
  ./oqs-scripts/build_liboqs.sh  && \
  ./oqs-scripts/build_openssh.sh  && \
  echo ./oqs-test/run_tests.sh  && \
  make install prefix=/usr/local && \
  chmod --verbose a-s /usr/local/libexec/ssh-keysign 2>&1 | tee -a /usr/local/etc/permissions && \
  \
  cd /usr/local/src && \
  git clone --recursive https://github.com/open-quantum-safe/openssl && \
  cd openssl && \
  git checkout 613d1bea7afa23dc11f340e75990cb47d77711e9 && \
  git submodule init && \
  git submodule update && \
  cd .. && \
  git clone --branch main https://github.com/open-quantum-safe/liboqs.git && \
  cd liboqs && \
  mkdir build && \
  cd build && \
  cmake -GNinja -DCMAKE_INSTALL_PREFIX=/usr/local/src/openssl/oqs .. && \
  ninja && \
  ninja install && \
  cd ../../openssl && \
  ./Configure no-shared linux-x86_64 -lm && \
  make && \
  make test && \
  make install prefix=/usr/local && \
  cd /usr/local/src && \
  PATH=/usr/lib/go-1.19/bin:"${PATH}" env go install github.com/jrick/ss@latest && \
  cp -p /root/go/bin/ss /usr/local/bin/ss && \
  \
  cd /usr/ && \
  rm -r -f local/src && \
  rm -v -f /usr/local/lib/lib*.a /usr/local/lib/x86_64-linux-gnu/lib*.a && \
  mv local /opt/artifact/local/ && \
  true


FROM docker://devuan/devuan:chimaera AS devuan-4-builder3

RUN \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/stand && \
  set -x && \
  set -e && \
  umask 022 && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  cd /root && \
  export LANG=C && \
  export HOME=/root && \
  export TMP=/tmp && \
  export TEMP="${TMP}" && \
  export TMPDIR="${TMP}" && \
  export DEBIAN_FRONTEND=noninteractive && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  export PYTHONDONTWRITEBYTECODE=1 && \
  exec </dev/null && \
  \
  export CFLAGS=" -O -ggdb3 -fverbose-asm -mtune=generic " && \
  export CXXFLAGS=" ${CFLAGS} " && \
  for insistence in Suggests Recommends; do echo APT::Install-"${insistence}" '"0";' | tee -a /etc/apt/apt.conf.d/42disable; done && \
  chmod --verbose go+r /etc/apt/apt.conf.d/42disable && \
  (for src in "" "-src"; do for repo in "" "-updates" "-security" "-backports"; do echo deb"${src}" http://deb.devuan.org/merged chimaera"${repo}" main contrib non-free; done; done) > /etc/apt/sources.list && \
  apt-get update && \
  apt-get -y dist-upgrade && \
  \
  apt-get install -y --verbose-versions git ca-certificates && \
  apt-get -y build-dep uanytun && \
  \
  mkdir -p -v /opt/artifact/deb && \
  cd /usr/local/src && \
  mkdir upstream && \
  cd upstream && \
  git clone --recursive https://git.spreadspace.org/anytun/uanytun.git && \
  mkdir -v ../debian/ && \
  cd ../debian/ && \
  git clone --recursive https://salsa.debian.org/debian/uanytun.git && \
  cd ../upstream/uanytun && \
  tar -cf - AUTHORS ChangeLog LICENSE LICENSE.OpenSSL README doc etc src version | tar -C ../../debian/uanytun/ -xpf - && \
  cd ../../debian/uanytun/ && \
  sed -i -e '1s,),r),' debian/changelog && \
  ./debian/rules binary && \
  cd ../ && \
  mv -v uanytun_0.?.?-?r_amd64.deb /opt/artifact/deb/ && \
  cd /root/ && \
  rm -r /usr/local/ && \
  true


FROM docker://devuan/devuan:ascii AS ascii-builder

RUN \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin && \
  set -x && \
  set -e && \
  umask 022 && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  cd /root && \
  export LANG=C && \
  export TMP=/tmp && \
  export TEMP="${TMP}" && \
  export TMPDIR="${TMP}" && \
  sed -i -e "/^Acquire/s/true/false/" /etc/apt/apt.conf.d/docker-gzip-indexes && \
  for insistence in Suggests Recommends; do echo APT::Install-"${insistence}" '"0";' | tee -a /etc/apt/apt.conf.d/42disable; done && \
  chmod --verbose go+r /etc/apt/apt.conf.d/42disable && \
  (for src in "" "-src"; do for repo in "" "-updates" "-security"; do echo deb"${src}" http://deb.devuan.org/merged ascii"${repo}" main contrib non-free; done; done) > /etc/apt/sources.list && \
  export DEBIAN_FRONTEND=noninteractive && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  export PYTHONDONTWRITEBYTECODE=1 && \
  exec </dev/null && \
  chmod --verbose go-w /etc /etc/apt /etc/apt/apt.conf.d /etc/dpkg /etc/dpkg/dpkg.cfg.d /usr /usr/sbin && \
  chmod --verbose go-w /etc/apt/apt.conf.d/docker-autoremove-suggests /etc/apt/apt.conf.d/docker-clean /etc/apt/apt.conf.d/docker-gzip-indexes /etc/apt/apt.conf.d/docker-no-languages /etc/dpkg/dpkg.cfg.d/docker-apt-speedup /usr/sbin/policy-rc.d && \
  apt-get -y update && \
  apt-get -y --verbose-versions dist-upgrade && \
  apt-get -y install --verbose-versions build-essential git-core zlib1g-dev libbz2-dev libwavpack-dev yasm file libssl1.0-dev ca-certificates && \
  mkdir -p -v /usr/local/src /usr/local/bin && \
  cd /usr/local/src && \
  apt-get source wavpack && \
  git clone --recursive https://github.com/gema-arta/pcompress && \
  cd pcompress && \
  export CFLAGS=" -Og -ggdb3 -fverbose-asm -mtune=generic " && \
  export CXXFLAGS=" ${CFLAGS} " && \
  ./config --prefix=/usr/local --enable-debug --enable-debug-stats --no-1.3-archive-compat --wavpack-dir=/usr/local/src/wavpack-5.0.0 && \
  make && \
  g++ -pthread -fopenmp -fno-inline -fopenmp -fPIC -o /usr/local/bin/pcompress utils/utils.o allocator.o lzma_compress.o ppmd_compress.o adaptive_compress.o lzfx_compress.o lz4_compress.o none_compress.o utils/xxhash_base.o utils/heap.o utils/cpuid.o filters/analyzer/analyzer.o meta_stream.o pcompress.o lzma/LzmaEnc.o lzma/LzFind.o lzma/LzmaDec.o lzma/Threads.o lzma/LzFindMt.o lzma/Ppmd8.o lzma/Ppmd8Enc.o lzma/Ppmd8Dec.o lzfx/lzfx.o lz4/lz4.o lz4/lz4hc.o lzma/crc64_fast.o lzma/crc64_table.o lzma/crc32_fast.o lzma/crc32_table.o rabin/rabin_dedup.o rabin/global/index.o rabin/global/dedupe_config.o bsdiff/bsdiff.o bsdiff/bspatch.o bsdiff/rle_encoder.o filters/lzp/lzp.o filters/delta2/delta2.o libbsc_compress.o crypto/skein/SHA3api_ref.o crypto/skein/skein.o crypto/skein/skein_debug.o crypto/skein/skein_block.o crypto/sha2/intel/sha512_avx.o crypto/sha2/intel/sha512_sse4.o crypto/sha2/sha512.o crypto/keccak/genKAT.o crypto/keccak/KeccakDuplex.o crypto/keccak/KeccakNISTInterface.o crypto/keccak/KeccakSponge.o crypto/keccak/KeccakF-1600-opt64.o filters/transpose/transpose.o crypto/aes/crypto_aes.o crypto/scrypt/crypto_scrypt-nosse.o crypto/scrypt/sha256.o crypto/scrypt/crypto_aesctr.o crypto/crypto_utils.o crypto/sha2_utils.o crypto/sha3_utils.o crypto/xsalsa20/xsalsa20_xor.o crypto/xsalsa20/hsalsa_core.o crypto/xsalsa20/stream.o zlib_compress.o bzip2_compress.o utils/xxhash_sse4.o utils/xxhash_sse2.o crypto/blake2/blake2b_sse2.o crypto/blake2/blake2b_ssse3.o crypto/blake2/blake2b_sse41.o crypto/blake2/blake2b_avx.o crypto/blake2/blake2bp_sse2.o crypto/blake2/blake2bp_ssse3.o crypto/blake2/blake2bp_sse41.o crypto/blake2/blake2bp_avx.o crypto/aes/vpaes-x86_64.o crypto/aes/aesni-x86_64.o archive/pc_archive.o archive/pc_arc_filter.o utils/phash/phash.o utils/phash/lookupa.o utils/phash/recycle.o filters/packjpg/aricoder.o filters/packjpg/bitops.o filters/packjpg/packjpg.o archive/pjpg_helper.o filters/dispack/dis.o archive/dispack_helper.o filters/packpnm/packpnm.o archive/ppnm_helper.o archive/wavpack_helper.o filters/dict/DictFilter.o -ldl main.o -L./buildtmp -lbz2 -L./buildtmp -lz -lm -L./bsc -lbsc -L./buildtmp -lcrypto -lrt -Larchive/libarchive/.libs -larchive -L/usr/local/src/wavpack-5.0.0/src/.libs -lwavpack -static && \
  cd ../.. && \
  rm -r src && \
  cd /root && \
  true

FROM docker://alpine:3.17 AS alpine-builder

RUN \
  set -x && \
  set -e && \
  umask 02 && \
  cd /root && \
  export HOME=/root && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  exec </dev/null && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  export RUST_BACKTRACE=full && \
  export CXXFLAGS="-static -v" && \
  export CFLAGS="-static -v" && \
  export LDFLAGS=-static && \
  export RUST_LOG=info && \
  export PATH=/root/.cargo/bin:/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin && \
  export RUSTFLAGS=" -C link-arg=-static -C target-feature=+crt-static " && \
  export RUST_TEST_THREADS=1 && \
  apk update && \
  apk upgrade && \
  apk add asciidoctor autoconf automake bash ca-certificates cargo clang clang15-dev clang15-static cmake curl eudev-dev file findutils fuse3-dev g++ gcc git go ip6tables iptables libcap-dev libcap-static libseccomp-dev libseccomp-static libsodium-dev libsodium-static linux-headers llvm make meson musl-dev ninja openssh openssl-dev openssl-libs-static pkgconf protobuf protobuf-c-compiler protobuf-c-dev protobuf-dev protoc shadow-uidmap tzdata vim xz-dev xz-static && \
  cd /usr/local && \
  mkdir -p src bin sbin && \
  cd src && \
  for repository in zerotier/ZeroTierOne str4d/rage dpc/rdedup dswd/vpncloud BLAKE3-team/BLAKE3 dndx/phantun; do git clone --recursive https://github.com/"${repository}"; done && \
  cd /root && \
  curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain stable && rustup target add x86_64-unknown-linux-musl && \
  export CARGO_BUILD_TARGET=x86_64-unknown-linux-musl && \
  hash -r && \
  cd /usr/local/src/BLAKE3/b3sum && cargo install --path . && \
  cd /usr/local/src/phantun/phantun && git checkout 1f11d618e04837b1bba854a559610641da98851b && cargo install --path . && \
  cd /usr/local/src/rage/rage && git checkout 7cfb7692afd4f93c52f690a40097e60bac573962 && rm ../rust-toolchain && cargo install --path . && \
  cd /usr/local/src/rdedup && mv /usr/lib/liblzma.so* /root/ && cargo install --path . && mv /root/liblzma* /usr/lib/ && \
  cd /usr/local/src/vpncloud && cargo install --path . && \
  cd /usr/local/src/ZeroTierOne && git checkout 1.10.3 && \
  (set +e; ZT_DEBUG=1 ZT_DEBUG_TRACE=1 ZT_TRACE=1 ZT_RULES_ENGINE_DEBUGGING=1 make zerotier-one || true; true) && \
  cd zeroidc/target/debug && \
  ln -s ../x86_64-unknown-linux-musl/debug/libzeroidc.a . && \
  cd ../../.. && \
  ZT_DEBUG=1 ZT_DEBUG_TRACE=1 ZT_TRACE=1 ZT_RULES_ENGINE_DEBUGGING=1 make zerotier-one && \
  mv zerotier-one /usr/local/sbin/ && \
  mkdir -p /usr/local/share/man/man8/ /usr/local/share/man/man1/ && \
  cp -p doc/zerotier-one.8 /usr/local/share/man/man8/ && \
  cp -p doc/zerotier-cli.1 /usr/local/share/man/man1/ && \
  cp -p doc/zerotier-idtool.1 /usr/local/share/man/man1/ && \
  cp -p ext/installfiles/linux/zerotier-one.te /usr/local/share/ && \
  cd /root/.cargo/bin && \
  mv b3sum rdedup rage-keygen rage /usr/local/bin/ && \
  mv vpncloud /usr/local/sbin/ && \
  mv server /usr/local/sbin/phantun-server && \
  mv client /usr/local/sbin/phantun-client && \
  cd /usr/local/sbin && \
  ln zerotier-one zerotier-cli && \
  ln zerotier-one zerotier-idtool && \
  (echo '#!/bin/sh'; echo "mkdir -p /var/lib/zerotier-one; ln -s /usr/local/sbin/zerotier-[cio]* /usr/local/share/zerotier-one.te /var/lib/zerotier-one") > /usr/local/sbin/zerotier-deploy && \
  chmod 0700 /usr/local/sbin/zerotier-deploy && \
  rm -r /usr/local/src /root/.cargo /root/.rustup /usr/lib/rustlib /usr/lib/go /usr/libexec /usr/lib/llvm15 && \
  rmdir -p --ignore-fail-on-non-empty /usr/local/lib/perl5/site_perl /usr/local/share/perl5/site_perl /usr/local/share/ca-certificates && \
  true

FROM docker://devuan/devuan:chimaera AS kernelbuild

ENV SHELL /bin/bash

COPY Configuration/config-5.10-hardened1-amd64 /tmp/config.amd64
COPY Configuration/config-5.10-hardened1-uml /tmp/config.uml
COPY Configuration/uml-static-build.patch /tmp/uml-static-build.patch

RUN \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin && \
  set -x && \
  set -e && \
  umask 02 && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  cd /root && \
  export LANG=C && \
  for insistence in Suggests Recommends; do echo APT::Install-"${insistence}" '"0";' | tee -a /etc/apt/apt.conf.d/42disable; done && \
  (for src in "" "-src"; do for repo in "" "-updates" "-security" "-backports"; do echo deb"${src}" http://deb.devuan.org/merged chimaera"${repo}" main contrib non-free; done; done) > /etc/apt/sources.list && \
  export DEBIAN_FRONTEND=noninteractive && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  export PYTHONDONTWRITEBYTECODE=1 && \
  export V=1 && \
  apt-get -y update && \
  apt-get -y --verbose-versions dist-upgrade && \
  apt-get -y --verbose-versions install apt-transport-https autoconf automake bash bc bear bindgen binutils binutils-common binutils-x86-64-linux-gnu bison build-essential ca-certificates cbindgen clang cmake coccinelle cpio cpp cpp-10 curl dc dpkg-dev dkms ed file flex gcc gcc-10 git git-man gpg-agent iptables kmod less libaio-dev libasan6 libatomic1 libbinutils libbrotli1 libc-dev-bin libc6-dev libcbor-dev libcc1-0 libclang-11-dev libclang-dev libcrypt-dev libctf-nobfd0 libctf0 libcurl3-gnutls libcurl4 libedit2 libelf-dev libeudev-dev libexpat1 libgcc-10-dev libgdbm-compat4 libgdbm6 libgit2-1.1 libgomp1 libhttp-parser2.9 libisl23 libitm1 libldap-2.4-2 libllvm11 liblsan0 libmbedcrypto3 libmbedtls12 libmbedx509-0 libmpc3 libmpfr6 libncurses-dev libnghttp2-14 libnsl-dev libomp-11-dev libpcap-dev libpsl5 libquadmath0 librtmp1 libsasl2-2 libsasl2-modules-db libssh2-1 libssl-dev libtirpc-dev libtool libtsan0 libubsan1 libudev-dev libvdeplug-dev libz3-4 linux-base linux-libc-dev linux-perf llvm llvm-11-dev llvm-dev lsb-release make mandoc musl-tools nasm ninja-build openssl perf-tools-unstable pkgconf python3-pip python3-setuptools python3-wheel rsync software-properties-common sudo uuid-dev valgrind vim-common vim-tiny wget xxd zlib1g-dev zstd && \
  chmod --verbose a-s /bin/mount /bin/su /bin/umount /sbin/unix_chkpwd /usr/bin/chage /usr/bin/chfn /usr/bin/chsh /usr/bin/expiry /usr/bin/gpasswd /usr/bin/newgrp /usr/bin/passwd /usr/bin/wall /usr/bin/sudo && \
  find / -xdev -type f -perm -2000 -ls && \
  find / -xdev -type f -perm -4000 -ls && \
  rm -vf /var/cache/apt/archives/*.deb && \
  apt-get -y clean && \
  apt-get -y autoclean && \
  apt-get -y autoremove && \
  (rm -vf /etc/group- /etc/gshadow- /etc/passwd- /etc/shadow- || true) && \
  (rm -vf /etc/localtime || true) && \
  /usr/bin/env --chdir=/etc ln -svf ../usr/share/zoneinfo/Universal ./localtime && \
  cd /usr && \
  mkdir -p local/src && \
  cd local/src && \
  \
  git clone --depth 1 --single-branch -b 5.10 https://github.com/anthraxx/linux-hardened && \
  cd linux-hardened && \
  mv -vf /tmp/config.amd64 .config && \
  \
  (echo '#!/bin/sh'; echo exec echo localhost) >/bin/hostname && \
  make deb-pkg && \
  rm -v ../linux-image-5.10.*hardened1-5.10-dbg_5.10.*-hardened1-5.10-1_amd64.deb && \
  dpkg -i ../linux*.deb && \
  make all install modules_install headers_install && \
  mkdir -v -p /opt/artifact/certs/ && \
  cp -p certs/signing_key.x509 certs/signing_key.pem /opt/artifact/certs/ && \
  \
  cd .. && \
  export KERNEL_VERSION="$(ls -1trd /lib/modules/5.10.*-hardened*-5.10 | tail -n 1 | sed 's,/lib/modules/,,')" && \
  export CFLAGS=" -O2 -ggdb3 -fverbose-asm -mtune=generic " && \
  export CXXFLAGS=" ${CFLAGS} " && \
  (for line in '#!/bin/bash' 'if echo "$@" |grep -q -- -r >/dev/null' 'then' 'echo "${KERNEL_VERSION}"' 'else' 'exec /bin/uname "$@"' 'fi'; do echo "${line}"; done) > /usr/local/sbin/uname && chmod +x /usr/local/sbin/uname && \
  export PATH=/usr/local/sbin:"${PATH}" && \
  hash -r && \
  \
  git clone --recursive https://github.com/openzfs/zfs && \
  cd zfs && \
  MAJMIN="$(git branch -a |grep staging|grep remotes/origin/zfs-2|sed 's,^ *remotes/origin/zfs-,,'|cut -d. -f1-2|sort -n | uniq  | tail -n 1 | sed 's,\.,\\.,')" && \
  git checkout zfs-$(eval echo $MAJMIN).$(git branch -a |grep staging|grep remotes/origin/zfs-2|sed 's,^ *remotes/origin/zfs-,,'|grep '^'"${MAJMIN}"'\.' | sed s,"${MAJMIN}\.",, | sort -n |uniq | tail -n 1) && \
  unset MAJMIN && \
  ./autogen.sh && \
  ./configure --with-config=kernel --disable-nls --with-linux=/lib/modules/"${KERNEL_VERSION}"/source --with-linux-obj=/lib/modules/"${KERNEL_VERSION}"/build && \
  make && \
  make install && \
  cd .. && \
  \
  git clone --recursive https://github.com/amzn/amzn-drivers && \
  cd amzn-drivers/kernel/linux/ena && \
  make && \
  cp -p $(find . -name \*.ko -type f -print) /lib/modules/"${KERNEL_VERSION}"/extra/ && \
  mkdir ../efa/build && \
  cd ../efa/build && \
  cmake .. && \
  make && \
  cp -p $(find . -name \*.ko -type f -print) /lib/modules/"${KERNEL_VERSION}"/extra/ && \
  cd ../../../../.. && \
  \
  git clone --recursive https://github.com/GoogleCloudPlatform/compute-virtual-ethernet-linux && \
  cd compute-virtual-ethernet-linux && \
  SPATCH=$(which spatch) ./build_src.sh --target=oot && \
  make -C /lib/modules/"${KERNEL_VERSION}"/build M="$(pwd)"/build modules modules_install && \
  cd .. && \
  \
  git clone --recursive https://github.com/toby63/shiftfs-dkms && \
  cd shiftfs-dkms && \
  git checkout k5.10 && \
  make && \
  cp -p $(find . -name \*.ko -type f -print) /lib/modules/"${KERNEL_VERSION}"/extra/ && \
  cd .. && \
  \
  git clone --recursive https://github.com/Kicksecure/tirdad && \
  cd tirdad/module && \
  make -C /lib/modules/"${KERNEL_VERSION}"/build M="$(pwd)" modules modules_install && \
  cd ../.. && \
  \
  git clone --recursive https://github.com/intel/haxm && \
  cd haxm/platforms/linux && \
  mv -f haxm-install.sh haxm-install.sh- && \
  touch haxm-install.sh && \
  chmod +x haxm-install.sh && \
  make && \
  make install && \
  cd ../../.. && \
  \
  (git clone --recursive https://github.com/mkubecek/vmware-host-modules || git clone --recursive https://github.com/mkubecek/vmware-host-modules || git clone --recursive https://github.com/mkubecek/vmware-host-modules) && \
  cd vmware-host-modules && \
  git checkout $(git branch -a|grep origin/workstation- | sort|tail -n 1 | sed 's,.*/,,') && \
  make && \
  make install && \
  \
  cd /usr/src && \
  mver=8.2.1.6.fixed && \
  wget https://github.com/tigerblue77/kvdo/archive/refs/tags/"${mver}".tar.gz && \
  tar xzpkf "${mver}".tar.gz && \
  (echo 'PACKAGE_NAME="kvdo"'; echo 'PACKAGE_VERSION="'"${mver}"\"; echo 'AUTOINSTALL="yes"'; echo 'BUILT_MODULE_NAME[0]="kvdo"'; echo 'BUILT_MODULE_LOCATION[0]="vdo"'; echo 'DEST_MODULE_LOCATION[0]="/kernel/drivers/block/"'; echo 'BUILD_DEPENDS[0]=LZ4_COMPRESS'; echo 'BUILD_DEPENDS[0]=LZ4_DECOMPRESS'; echo 'STRIP[0]="no"') > kvdo-"${mver}"/dkms.conf && \
  dkms add kvdo/"${mver}" && \
  dkms build kvdo/"${mver}" -k "${KERNEL_VERSION}" && \
  dkms install kvdo/"${mver}" -k "${KERNEL_VERSION}" && \
  unset mver && \
  \
  depmod -a "${KERNEL_VERSION}" && \
  echo Built "${KERNEL_VERSION}" && \
  export ORIG_VERSION="${KERNEL_VERSION}" && \
  sync && \
  \
  cd /usr/local/src && \
  git clone --depth 1 --single-branch -b 5.10 https://github.com/anthraxx/linux-hardened linux-hardened-uml && \
  cd linux-hardened-uml && \
  mv -vf /tmp/config.uml .config && \
  patch -p1 -F0 < /tmp/uml-static-build.patch && \
  rm -vf /tmp/uml-static-build.patch && \
  (tar -C ../linux-hardened/ -cf - certs | tar -xpvvkf - || true; true) && \
  rm -vf certs/*.o && \
  \
  unset KERNEL_VERSION && \
  mv -v /usr/local/sbin/uname /usr/local/sbin/uname-prev && \
  hash -r && \
  LDFLAGS_vmlinux=" -Wl,--start-group  -ldbus-1 -lutil -lrt -lpthread -Wl,--end-group " KBUILD_VMLINUX_LIBS=" -ldbus-1 " LDFLAGS=" -ldbus-1 " KBUILD_LDFLAGS=" -z noexecstack -z muldefs -ldbus-1 " make ARCH=um V=1 clean all modules modules_install && \
  export KERNEL_VERSION="$(ls -1trd /lib/modules/5.10.*-hardened*-5.10uml* | tail -n 1 | sed 's,/lib/modules/,,')" && \
  (for line in '#!/bin/bash' 'if echo "$@" |grep -q -- -r >/dev/null' 'then' 'echo "${KERNEL_VERSION}"' 'else' 'exec /bin/uname "$@"' 'fi'; do echo "${line}"; done) > /usr/local/sbin/uname && chmod +x /usr/local/sbin/uname && \
  hash -r && \
  cd .. && \
  \
  git clone --recursive https://github.com/Kicksecure/tirdad tirdad-uml && \
  cd tirdad-uml/module && \
  LDFLAGS_vmlinux=" -Wl,--start-group  -ldbus-1 -lutil -lrt -lpthread -Wl,--end-group " KBUILD_VMLINUX_LIBS=" -ldbus-1 " LDFLAGS=" -ldbus-1 " KBUILD_LDFLAGS=" -z noexecstack -z muldefs -ldbus-1 " make -C /lib/modules/"${KERNEL_VERSION}"/build M="${PWD}" ARCH=um V=1 clean modules modules_install && \
  cd ../.. && \
  \
  git clone --recursive https://github.com/toby63/shiftfs-dkms shiftfs-dkms-uml && \
  cd shiftfs-dkms-uml && \
  git checkout k5.10 && \
  LDFLAGS_vmlinux=" -Wl,--start-group  -ldbus-1 -lutil -lrt -lpthread -Wl,--end-group " KBUILD_VMLINUX_LIBS=" -ldbus-1 " LDFLAGS=" -ldbus-1 " KBUILD_LDFLAGS=" -z noexecstack -z muldefs -ldbus-1 " make ARCH=um V=1 clean && \
  LDFLAGS_vmlinux=" -Wl,--start-group  -ldbus-1 -lutil -lrt -lpthread -Wl,--end-group " KBUILD_VMLINUX_LIBS=" -ldbus-1 " LDFLAGS=" -ldbus-1 " KBUILD_LDFLAGS=" -z noexecstack -z muldefs -ldbus-1 " make ARCH=um V=1 && \
  cp -p $(find . -name \*.ko -type f -print) /lib/modules/"${KERNEL_VERSION}"/extra/ && \
  cd /usr/local/src && \
  depmod -a "${KERNEL_VERSION}" && \
  echo Built "${KERNEL_VERSION}" && \
  sync && \
  rm -f -v /boot/*.old && \
  rm -f -v /lib/modules/*/build && \
  rm -f -v /lib/modules/*/source && \
  find /lib/modules/5.*/*/ -type f -name '*.so' -exec strip --preserve-dates --strip-debug --no-merge-notes --keep-file-symbols --verbose -- \{\} \; && \
  find /lib/modules/5.*/*/ -type f -name '*.ko' -exec strip --preserve-dates --strip-debug --no-merge-notes --keep-file-symbols --verbose -- \{\} \; && \
  IMGFILE="$(ls -1trd linux-image-5.10.*-hardened1-5.10_5.10.*-hardened1-5.10-1_amd64.deb | tail -n 1)" && \
  mkdir ephemeral && \
  cd ephemeral && \
  ar x ../"${IMGFILE}" && \
  xz -d -v -v < data.tar.xz |tar -x -p -k -f - && \
  find usr/share/doc -name \*.gz -type f -exec gunzip -N -v -f -- \{\} \; && \
  cd lib/modules && \
  for i in 5.*; do rm -r "$i" && mv /lib/modules/"$i" .; done && \
  cd ../.. && \
  tar -cf - boot lib etc usr | xz --compress --stdout --check=crc32 -9 --extreme --threads=1 --verbose --verbose > data.tar.xz && \
  rm -v ../"${IMGFILE}" && \
  ar rcv ../"${IMGFILE}" debian-binary control.tar.xz data.tar.xz && \
  cd .. && \
  unset IMGFILE && \
  rm -r ephemeral && \
  rm -f /boot/* && \
  mv -v -f /usr/local/sbin/uname-prev /usr/local/sbin/uname && \
  dpkg -i linux-image-5.10.*-hardened1-5.10_5.10.*-hardened1-5.10-1_amd64.deb && \
  dpkg -i linux-libc-dev_5.10.*-hardened1-5.10-1_amd64.deb && \
  dpkg -i linux-headers-5.10.*-hardened1-5.10_5.10.*-hardened1-5.10-1_amd64.deb && \
  STDVER="$(yes n | apt-get install linux-image-amd64 2>&1 | tr ' ' '\n' |sort | uniq |grep linux-image-5.10 | tail -n 1)" && \
  apt-get download "${STDVER}" && \
  STDIMG="$(ls -1trd ${STDVER}*amd64.deb | tail -n 1)" && \
  mkdir ephemeral && \
  cd ephemeral && \
  ar x ../"${STDIMG}" && \
  mkdir ephemeral && \
  cd ephemeral && \
  xz -d -v -v < ../data.tar.xz | tar -x -p -k -f - && \
  rm -r -f lib/modules/5.10.0-*-amd64/* && \
  rm -v boot/vmlinuz-5.10.0-*-amd64  && \
  tar -cf - boot lib usr | xz --compress --stdout --check=crc32 -9 --extreme --threads=1 --verbose --verbose > ../data.tar.xz  && \
  cd .. && \
  rm -r ephemeral && \
  ar rcv ../"${STDIMG}" debian-binary control.tar.xz data.tar.xz  && \
  mkdir ephemeral && \
  cd ephemeral && \
  cat ../control.tar.xz |xz -d -v -v | tar -x -p -k -f - && \
  (grep boot/"[cS]" md5sums; grep usr/share/ md5sums) |sort | uniq > staging && \
  cat staging > md5sums && \
  rm -v staging && \
  for i in postinst postrm preinst prerm ; do : > $i ; done && \
  tar -c -v -f - control md5sums p* | xz --compress --stdout --check=crc32 -9 --extreme --threads=1 --verbose --verbose > ../control.tar.xz  && \
  cd .. && \
  rm -r ephemeral && \
  rm ../"${STDIMG}" && \
  ar rcv ../"${STDIMG}" debian-binary control.tar.xz data.tar.xz  && \
  cd .. && \
  rm -r ephemeral && \
  mkdir -p -v /opt/artifact/deb/ /opt/artifact/uml/ && \
  mv "${STDIMG}" /opt/artifact/deb/ && \
  mv -v linux-image-5.10.*-hardened1-5.10_5.10.*-hardened1-5.10-1_amd64.deb linux-libc-dev_5.10.*-hardened1-5.10-1_amd64.deb linux-headers-5.10.*-hardened1-5.10_5.10.*-hardened1-5.10-1_amd64.deb /opt/artifact/deb/ && \
  ./linux-hardened/scripts/extract-vmlinux /boot/vmlinuz-5.10.*-hardened1-5.10 > /opt/artifact/vmlinux-"${ORIG_VERSION}" && \
  unset ORIG_VERSION && \
  mv /lib/modules/5.10.*-hardened1-5.10uml-dirty/ /opt/artifact/uml/ && \
  mv linux-hardened-uml/linux /opt/artifact/uml/ && \
  cd /usr && \
  rm -r src local sbin /boot /lib/modules && \
  sync && \
  true

FROM docker://devuan/devuan:daedalus AS kernelbuild5
COPY --from=kernelbuild /opt/artifact /root/artifact

RUN \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin && \
  set -x && \
  set -e && \
  umask 02 && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  cd /root && \
  export LANG=C && \
  export DEBIAN_FRONTEND=noninteractive && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  export PYTHONDONTWRITEBYTECODE=1 && \
  export V=1 && \
  (echo deb http://deb.devuan.org/merged daedalus main contrib non-free && echo deb-src http://deb.devuan.org/merged daedalus main contrib non-free) > /etc/apt/sources.list && \
  apt-get -y update && \
  apt-get -y --verbose-versions dist-upgrade && \
  apt-get -y --verbose-versions install apt-transport-https autoconf automake bash bc bear bindgen binutils binutils-common binutils-x86-64-linux-gnu bison build-essential ca-certificates cbindgen clang cmake coccinelle cpio cpp cpp-11 curl dc dpkg-dev dkms ed file flex gcc gcc-11 git git-man gpg-agent iptables kmod less libaio-dev libasan6 libatomic1 libbinutils libbrotli1 libc-dev-bin libc6-dev libcbor-dev libcc1-0 libclang-dev libcrypt-dev libctf-nobfd0 libctf0 libcurl3-gnutls libcurl4 libedit2 libelf-dev libeudev-dev libexpat1 libgcc-11-dev libgdbm-compat4 libgdbm6 libgit2-1.5 libgomp1 libhttp-parser2.9 libisl23 libitm1 libldap-common libldap-2.5-0 liblsan0 libmbedcrypto7 libmbedtls14 libmbedx509-1 libmpc3 libmpfr6 libncurses-dev libnghttp2-14 libnsl-dev libomp-dev libpcap-dev libpsl5 libquadmath0 librtmp1 libsasl2-2 libsasl2-modules-db libssh2-1 libssl-dev libtirpc-dev libtool libtsan0 libubsan1 libudev-dev libvdeplug-dev libz3-4 linux-base linux-libc-dev linux-perf llvm llvm-dev lsb-release make mandoc musl-tools nasm ninja-build openssl perf-tools-unstable pkgconf python3-pip python3-setuptools python3-wheel rsync software-properties-common sudo uuid-dev valgrind vim-common vim-tiny wget xxd zlib1g-dev zstd && \
  apt-get -y --verbose-versions install autoconf automake autopoint autotools-dev binutils binutils-common binutils-x86-64-linux-gnu bsdextrautils build-essential bzip2 ca-certificates cpio cpp cpp-11 debhelper dh-autoreconf dh-strip-nondeterminism distro-info-data docutils-common dpkg-dev dwz eudev file g++ g++-11 gcc gcc-11 gettext gettext-base groff-base html2text initramfs-tools initramfs-tools-core intltool-debian kernel-wedge klibc-utils kmod libarchive-zip-perl libasan6 libatomic1 libbinutils libc-dev-bin libc6-dev libcc1-0 libcrypt-dev libctf-nobfd0 libctf0 libdebhelper-perl libdpkg-perl libelf1 libexpat1 libfile-stripnondeterminism-perl libgcc-11-dev libgdbm-compat4 libgdbm6 libgomp1 libicu72 libisl23 libitm1 libjs-jquery libjs-sphinxdoc libjs-underscore libklibc libkmod2 liblsan0 libmagic-mgc libmagic1 libmpc3 libmpfr6 libncurses6 libncursesw6 libnsl-dev libperl5.36 libpipeline1 libpopt0 libpython3-stdlib libpython3.11-minimal libpython3.11-stdlib libquadmath0 libreadline8 libsigsegv2 libsqlite3-0 libstdc++-11-dev libsub-override-perl libtirpc-dev libtool libtsan0 libubsan1 libuchardet0 libxml2 linux-base linux-kbuild-6.1 linux-libc-dev lsb-release m4 make man-db media-types openssl patch perl perl-modules-5.36 po-debconf procps python-babel-localedata python3 python3-alabaster python3-babel python3-certifi python3-chardet python3-distutils python3-docutils python3-idna python3-imagesize python3-jinja2 python3-lib2to3 python3-markupsafe python3-minimal python3-packaging python3-pkg-resources python3-pygments python3-pyparsing python3-requests python3-roman python3-six python3-snowballstemmer python3-sphinx python3-tz python3-urllib3 python3.11 python3.11-minimal readline-common rsync sbsigntool sensible-utils sgml-base sphinx-common udev xml-core xz-utils && \
  apt-get -y --verbose-versions install coccinelle wget git-core python3 python3-dev libeudev-dev libxen-dev pkgconf gcc-11 asciidoctor && \
  apt-get -y build-dep linux-image-amd64 && \
  dpkg -i /root/artifact/deb/*.deb && \
  update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-11 200 && \
  \
  cd /usr/local/src && \
  export KERNEL_VERSION="$(ls -1d /lib/modules/5.10.*-hardened*-5.10 | tail -n 1 | sed 's,/lib/modules/,,')" && \
  (for line in '#!/bin/bash' 'if echo "$@" |grep -q -- -r >/dev/null' 'then' 'echo "${KERNEL_VERSION}"' 'else' 'exec /bin/uname "$@"' 'fi'; do echo "${line}"; done) > /usr/local/sbin/uname && chmod +x /usr/local/sbin/uname && \
  git clone --recursive -b drbd-9.1 https://github.com/LINBIT/drbd && \
  cd drbd/ && \
  V=1 KVER="${KERNEL_VERSION}" make V=1 && \
  V=1 KVER="${KERNEL_VERSION}" make V=1 install && \
  \
  cd /usr/local/src/ && \
  mkdir ung && \
  cd ung && \
  wget 'https://cdn.electronic.us/products/usb-over-ethernet/linux/download/usb_network_gate_x64-2.deb?_ga=2.180708775.1242351919.1676292214-133569265.1676292213' && \
  mv usb_network_gate_x64-2.deb* usb_network_gate_x64-2.deb && \
  ar x usb_network_gate_x64-2.deb && \
  cat data.tar.xz |xz -dvv|tar -x -p -f - && \
  mv opt/ElectronicTeam/eveusb ../eveusb && \
  cd ../eveusb/module && \
  rm -r ../../ung && \
  PATH=/usr/local/sbin:"${PATH}" make && \
  PATH=/usr/local/sbin:"${PATH}" make install && \
  \
  cd /usr/local/src/ && \
  mkdir nx && \
  cd nx && \
  wget "https://download.nomachine.com/download/8.4/Linux/nomachine_8.4.2_1_x86_64.tar.gz" && \
  tar xpkzf nomachine_8.4.2_1_x86_64.tar.gz && \
  mkdir ../nxr && \
  cat NX/etc/NX/server/packages/nxrunner.tar.gz  |gunzip -v | tar -C ../nxr -x -p -v -f - && \
  cd ../nxr/NX/share/src/nxusb && \
  sed -i -e s,bin/uname,usr/local/sbin/uname, Makefile && \
  make && \
  make install && \
  \
  cd /usr/local/src/ && \
  wget http://www.openafs.org/dl/openafs/1.8.9/openafs-1.8.9-src.tar.gz && \
  tar xzpkf openafs-1.8.9-src.tar.gz && \
  cd openafs-1.8.9 && \
  PATH=/usr/local/sbin:"${PATH}" ./configure --enable-supergroups --disable-strip-binaries --enable-debug --disable-optimize --enable-debug-locks --enable-debug-kernel --disable-optimize-kernel --enable-debug-pam --disable-optimize-pam && \
  (set +e; export PATH=/usr/local/sbin:"${PATH}"; make || true; make -k || true; make -i || true; cp -p $(find . -name \*.ko -type f -print | grep -v libafs-5.10) /lib/modules/"${KERNEL_VERSION}"/extra/) && \
  \
  cd /usr/local/src/ && \
  depmod -a "${KERNEL_VERSION}" && \
  rm -f -v /boot/*.old && \
  rm -f -v /lib/modules/*/build && \
  rm -f -v /lib/modules/*/source && \
  find /lib/modules/5.*/*/ -type f -name '*.so' -exec strip --preserve-dates --strip-debug --no-merge-notes --keep-file-symbols --verbose -- \{\} \; && \
  find /lib/modules/5.*/*/ -type f -name '*.ko' -exec strip --preserve-dates --strip-debug --no-merge-notes --keep-file-symbols --verbose -- \{\} \; && \
  IMGFILE="$(cd /root/artifact/deb && ls -1d linux-image-5.10.*-hardened1-5.10_5.10.*-hardened1-5.10-1_amd64.deb | tail -n 1)" && \
  mkdir ephemeral && \
  cd ephemeral && \
  ar x /root/artifact/deb/"${IMGFILE}" && \
  xz -d -v -v < data.tar.xz |tar -x -p -k -f - && \
  find usr/share/doc -name \*.gz -type f -exec gunzip -N -v -f -- \{\} \; && \
  cd lib/modules && \
  for i in 5.*; do rm -r "$i" && mv /lib/modules/"$i" .; done && \
  cd ../.. && \
  tar -cf - boot lib etc usr | xz --compress --stdout --check=crc32 -9 --extreme --threads=1 --verbose --verbose > data.tar.xz && \
  rm -v /root/artifact/deb/"${IMGFILE}" && \
  ar rcv /root/artifact/deb/"${IMGFILE}" debian-binary control.tar.xz data.tar.xz && \
  unset IMGFILE && \
  cd /usr/local/ && \
  rm -r src/ && \
  rm -f /boot/* && \
  mv /root/artifact /opt/artifact && \
  true


FROM docker://devuan/devuan:chimaera AS kernelsign
COPY --from=kernelbuild5 /opt/artifact /root/artifact

RUN \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin && \
  set -x && \
  set -e && \
  umask 02 && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  cd /root && \
  export LANG=C && \
  export DEBIAN_FRONTEND=noninteractive && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  export PYTHONDONTWRITEBYTECODE=1 && \
  export V=1 && \
  (for src in "" "-src"; do for repo in "" "-updates" "-security" "-backports"; do echo deb"${src}" http://deb.devuan.org/merged chimaera"${repo}" main contrib non-free; done; done) > /etc/apt/sources.list && \
  apt-get -y update && \
  apt-get -y --verbose-versions dist-upgrade && \
  apt-get -y --verbose-versions install apt-transport-https autoconf automake bash bc bear bindgen binutils binutils-common binutils-x86-64-linux-gnu bison build-essential ca-certificates cbindgen clang cmake coccinelle cpio cpp cpp-10 curl dc dpkg-dev dkms ed file flex gcc gcc-10 git git-man gpg-agent iptables kmod less libaio-dev libasan6 libatomic1 libbinutils libbrotli1 libc-dev-bin libc6-dev libcbor-dev libcc1-0 libclang-dev libcrypt-dev libctf-nobfd0 libctf0 libcurl3-gnutls libcurl4 libedit2 libelf-dev libeudev-dev libexpat1 libgcc-10-dev libgdbm-compat4 libgdbm6 libgomp1 libhttp-parser2.9 libisl23 libitm1 libldap-common liblsan0 libmpc3 libmpfr6 libncurses-dev libnghttp2-14 libnsl-dev libomp-dev libpcap-dev libpsl5 libquadmath0 librtmp1 libsasl2-2 libsasl2-modules-db libssh2-1 libssl-dev libtirpc-dev libtool libtsan0 libubsan1 libudev-dev libvdeplug-dev libz3-4 linux-base linux-libc-dev linux-perf llvm llvm-dev lsb-release make mandoc musl-tools nasm ninja-build openssl perf-tools-unstable pkgconf python3-pip python3-setuptools python3-wheel rsync software-properties-common sudo uuid-dev valgrind vim-common vim-tiny wget xxd zlib1g-dev zstd && \
  apt-get -y --verbose-versions install autoconf automake autopoint autotools-dev binutils binutils-common binutils-x86-64-linux-gnu bsdextrautils build-essential bzip2 ca-certificates cpio cpp cpp-10 debhelper dh-autoreconf dh-strip-nondeterminism distro-info-data docutils-common dpkg-dev dwz eudev file g++ g++-10 gcc gcc-10 gettext gettext-base groff-base html2text initramfs-tools initramfs-tools-core intltool-debian kernel-wedge klibc-utils kmod libarchive-zip-perl libasan6 libatomic1 libbinutils libc-dev-bin libc6-dev libcc1-0 libcrypt-dev libctf-nobfd0 libctf0 libdebhelper-perl libdpkg-perl libelf1 libexpat1 libfile-stripnondeterminism-perl libgcc-10-dev libgdbm-compat4 libgdbm6 libgomp1 libisl23 libitm1 libjs-jquery libjs-sphinxdoc libjs-underscore libklibc libkmod2 liblsan0 libmagic-mgc libmagic1 libmpc3 libmpfr6 libncurses6 libncursesw6 libnsl-dev libpipeline1 libpopt0 libpython3-stdlib libquadmath0 libreadline8 libsigsegv2 libsqlite3-0 libstdc++-10-dev libsub-override-perl libtirpc-dev libtool libtsan0 libubsan1 libuchardet0 libxml2 linux-base linux-libc-dev lsb-release m4 make man-db media-types openssl patch perl po-debconf procps python-babel-localedata python3 python3-alabaster python3-babel python3-certifi python3-chardet python3-distutils python3-docutils python3-idna python3-imagesize python3-jinja2 python3-lib2to3 python3-markupsafe python3-minimal python3-packaging python3-pkg-resources python3-pygments python3-pyparsing python3-requests python3-roman python3-six python3-snowballstemmer python3-sphinx python3-tz python3-urllib3 readline-common rsync sbsigntool sensible-utils sgml-base sphinx-common udev xml-core xz-utils && \
  apt-get -y --verbose-versions install coccinelle wget git-core python3 python3-dev libeudev-dev libxen-dev pkgconf gcc-10 asciidoctor && \
  apt-get -y build-dep linux-image-amd64 && \
  dpkg -i /root/artifact/deb/*.deb && \
  rm -r -f /lib/modules/5.* && \
  dpkg -i /root/artifact/deb/*.deb && \
  \
  cd /usr/local/src && \
  export KERNEL_VERSION="$(ls -1d /lib/modules/5.10.*-hardened*-5.10 | tail -n 1 | sed 's,/lib/modules/,,')" && \
  depmod -a "${KERNEL_VERSION}" && \
  rm -f -v /boot/*.old && \
  rm -f -v /lib/modules/*/build && \
  rm -f -v /lib/modules/*/source && \
  find /lib/modules/5.*/*/ -type f -name '*.so' -exec strip --preserve-dates --strip-debug --no-merge-notes --keep-file-symbols --verbose -- \{\} \; && \
  find /lib/modules/5.*/*/ -type f -name '*.ko' -exec strip --preserve-dates --strip-debug --no-merge-notes --keep-file-symbols --verbose -- \{\} \; && \
  IMGFILE="$(cd /root/artifact/deb && ls -1d linux-image-5.10.*-hardened1-5.10_5.10.*-hardened1-5.10-1_amd64.deb | tail -n 1)" && \
  mkdir ephemeral && \
  cd ephemeral && \
  ar x /root/artifact/deb/"${IMGFILE}" && \
  xz -d -v -v < data.tar.xz |tar -x -p -k -f - && \
  find usr/share/doc -name \*.gz -type f -exec gunzip -N -v -f -- \{\} \; && \
  cd lib/modules && \
  for i in 5.*; do rm -r "$i" && mv /lib/modules/"$i" .; done && \
  SIGN_FILE="$(ls -1d /usr/src/linux-headers-5.10.*-hardened1-5.10/scripts/sign-file | tail -n 1)" && \
  find ./5.*/ -type f -name "*.ko" -exec "${SIGN_FILE}" sha512 /root/artifact/certs/signing_key.pem /root/artifact/certs/signing_key.x509 \{\} \; && \
  find ./5.*/ -type f -name "*.so" -exec "${SIGN_FILE}" sha512 /root/artifact/certs/signing_key.pem /root/artifact/certs/signing_key.x509 \{\} \; && \
  unset SIGN_FILE && \
  cd ../.. && \
  tar -cf - boot lib etc usr | xz --compress --stdout --check=crc32 -9 --extreme --threads=1 --verbose --verbose > data.tar.xz && \
  rm -v /root/artifact/deb/"${IMGFILE}" && \
  ar rcv /root/artifact/deb/"${IMGFILE}" debian-binary control.tar.xz data.tar.xz && \
  unset IMGFILE && \
  cd /usr/local/ && \
  rm -r src/ && \
  rm -f /boot/* && \
  mv /root/artifact /opt/artifact && \
  true

FROM docker://devuan/devuan:chimaera AS qemubuilder

RUN \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin && \
  set -x && \
  set -e && \
  umask 02 && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  cd /root && \
  export LANG=C && \
  export DEBIAN_FRONTEND=noninteractive && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  export PYTHONDONTWRITEBYTECODE=1 && \
  export V=1 && \
  (for src in "" "-src"; do for repo in "" "-updates" "-security" "-backports"; do echo deb"${src}" http://deb.devuan.org/merged chimaera"${repo}" main contrib non-free; done; done) > /etc/apt/sources.list && \
  apt-get -y update && \
  apt-get -y --verbose-versions dist-upgrade && \
  apt-get install -y --verbose-versions adwaita-icon-theme attr autoconf automake autopoint autotools-dev binutils binutils-alpha-linux-gnu binutils-arm-none-eabi binutils-common binutils-hppa-linux-gnu binutils-powerpc64-linux-gnu binutils-riscv64-linux-gnu binutils-s390x-linux-gnu binutils-sparc64-linux-gnu binutils-x86-64-linux-gnu bsdextrautils build-essential bzip2 ca-certificates cpp cpp-10 cpp-10-alpha-linux-gnu cpp-10-hppa-linux-gnu cpp-10-powerpc64-linux-gnu cpp-10-riscv64-linux-gnu cpp-10-s390x-linux-gnu cpp-10-sparc64-linux-gnu cpp-alpha-linux-gnu cpp-hppa-linux-gnu cpp-powerpc64-linux-gnu cpp-riscv64-linux-gnu cpp-s390x-linux-gnu cpp-sparc64-linux-gnu dbus dbus-x11 dconf-gsettings-backend dconf-service debhelper device-tree-compiler dh-autoreconf dh-strip-nondeterminism dirmngr dmsetup docutils-common dpkg-dev dwz fakeroot fcode-utils file fontconfig fontconfig-config fonts-dejavu-core fonts-font-awesome fonts-lato g++ g++-10 gcc gcc-10 gcc-10-alpha-linux-gnu gcc-10-alpha-linux-gnu-base gcc-10-cross-base gcc-10-cross-base-ports gcc-10-hppa-linux-gnu gcc-10-hppa-linux-gnu-base gcc-10-powerpc64-linux-gnu gcc-10-powerpc64-linux-gnu-base gcc-10-riscv64-linux-gnu gcc-10-riscv64-linux-gnu-base gcc-10-s390x-linux-gnu gcc-10-s390x-linux-gnu-base gcc-10-sparc64-linux-gnu gcc-10-sparc64-linux-gnu-base gcc-alpha-linux-gnu gcc-arm-none-eabi gcc-hppa-linux-gnu gcc-powerpc64-linux-gnu gcc-riscv64-linux-gnu gcc-s390x-linux-gnu gcc-sparc64-linux-gnu gettext gettext-base gir1.2-atk-1.0 gir1.2-atspi-2.0 gir1.2-freedesktop gir1.2-gdkpixbuf-2.0 gir1.2-glib-2.0 gir1.2-gtk-3.0 gir1.2-harfbuzz-0.0 gir1.2-ibus-1.0 gir1.2-pango-1.0 gir1.2-vte-2.91 glib-networking glib-networking-common glib-networking-services glusterfs-common gnupg gnupg-l10n gnupg-utils gpg gpg-agent gpg-wks-client gpg-wks-server gpgconf gpgsm groff-base gsettings-desktop-schemas gtk-update-icon-cache hicolor-icon-theme ibverbs-providers icu-devtools intltool-debian iso-codes libacl1-dev libaio-dev libaio1 libalgorithm-diff-perl libalgorithm-diff-xs-perl libalgorithm-merge-perl libapparmor1 libarchive-zip-perl libasan6 libasan6-ppc64-cross libasan6-s390x-cross libasan6-sparc64-cross libasound2 libasound2-data libasound2-dev libassuan0 libasyncns0 libatk-bridge2.0-0 libatk-bridge2.0-dev libatk1.0-0 libatk1.0-data libatk1.0-dev libatomic1 libatomic1-alpha-cross libatomic1-hppa-cross libatomic1-ppc64-cross libatomic1-riscv64-cross libatomic1-s390x-cross libatomic1-sparc64-cross libatspi2.0-0 libatspi2.0-dev libattr1-dev libavahi-client3 libavahi-common-data libavahi-common3 libbinutils libblkid-dev libboost-iostreams1.74.0 libboost-thread1.74.0 libbpf-dev libbpf0 libbrlapi-dev libbrlapi0.8 libbrotli-dev libbrotli1 libbsd0 libc-dev-bin libc-devtools libc6-dev libc6-hppa-cross libc6-ppc64-cross libc6-riscv64-cross libc6-s390x-cross libc6-sparc64-cross libc6.1-alpha-cross libcacard-dev libcacard0 libcairo-gobject2 libcairo-script-interpreter2 libcairo2 libcairo2-dev libcap-ng-dev libcap2 libcap2-bin libcapstone-dev libcapstone4 libcc1-0 libcolord2 libcrypt-dev libctf-nobfd0 libctf0 libcups2 libcurl3-gnutls libcurl4-gnutls-dev libdatrie-dev libdatrie1 libdaxctl1 libdbus-1-3 libdbus-1-dev libdconf1 libdebhelper-perl libdeflate0 libdevmapper1.02.1 libdpkg-perl libdrm-amdgpu1 libdrm-common libdrm-dev libdrm-intel1 libdrm-nouveau2 libdrm-radeon1 libdrm2 libdw1 libedit2 libegl-dev libegl-mesa0 libegl1 libegl1-mesa-dev libelf-dev libelf1 libepoxy-dev libepoxy0 libeudev-dev libevent-2.1-7 libexecs0 libexpat1 libexpat1-dev libfakeroot libfdt-dev libfdt1 libffi-dev libfile-fcntllock-perl libfile-stripnondeterminism-perl libflac8 libfontconfig-dev libfontconfig1 libfontconfig1-dev libfreetype-dev libfreetype6 libfreetype6-dev libfribidi-dev libfribidi0 libfuse3-3 libfuse3-dev libgbm-dev libgbm1 libgcc-10-dev libgcc-10-dev-alpha-cross libgcc-10-dev-hppa-cross libgcc-10-dev-ppc64-cross libgcc-10-dev-riscv64-cross libgcc-10-dev-s390x-cross libgcc-10-dev-sparc64-cross libgcc-s1-alpha-cross libgcc-s1-ppc64-cross libgcc-s1-riscv64-cross libgcc-s1-s390x-cross libgcc-s1-sparc64-cross libgcc-s4-hppa-cross libgd3 libgdbm-compat4 libgdbm6 libgdk-pixbuf-2.0-0 libgdk-pixbuf-2.0-dev libgdk-pixbuf2.0-bin libgdk-pixbuf2.0-common libgfapi0 libgfchangelog0 libgfrpc0 libgfxdr0 libgirepository-1.0-1 libgl-dev libgl1 libgl1-mesa-dev libgl1-mesa-dri libglapi-mesa libgles-dev libgles1 libgles2 libglib2.0-0 libglib2.0-bin libglib2.0-data libglib2.0-dev libglib2.0-dev-bin libglu1-mesa libglu1-mesa-dev libglusterd0 libglusterfs-dev libglusterfs0 libglvnd-dev libglvnd0 libglx-dev libglx-mesa0 libglx0 libgmp-dev libgmpxx4ldbl libgnutls-dane0 libgnutls-openssl27 libgnutls28-dev libgnutlsxx28 libgomp1 libgomp1-alpha-cross libgomp1-hppa-cross libgomp1-ppc64-cross libgomp1-riscv64-cross libgomp1-s390x-cross libgomp1-sparc64-cross libgpm2 libgraphite2-3 libgraphite2-dev libgstreamer-plugins-base1.0-0 libgstreamer1.0-0 libgtk-3-0 libgtk-3-common libgtk-3-dev libharfbuzz-dev libharfbuzz-gobject0 libharfbuzz-icu0 libharfbuzz0b libibumad-dev libibumad3 libibus-1.0-5 libibus-1.0-dev libibverbs-dev libibverbs1 libice-dev libice6 libicu-dev libicu67 libidn2-dev libinih1 libiscsi-dev libiscsi7 libisl23 libitm1 libitm1-alpha-cross libitm1-ppc64-cross libitm1-s390x-cross libitm1-sparc64-cross libjack-dev libjack0 libjbig0 libjpeg-dev libjpeg62-turbo libjpeg62-turbo-dev libjs-jquery libjs-sphinxdoc libjs-underscore libjson-glib-1.0-0 libjson-glib-1.0-common libkmod2 libksba8 liblcms2-2 libldap-2.4-2 libldap-common libllvm11 liblocale-gettext-perl liblsan0 liblsan0-ppc64-cross liblzo2-2 liblzo2-dev libmagic-mgc libmagic1 libmd0 libmount-dev libmpc3 libmpdec3 libmpfr6 libncurses-dev libncurses6 libncursesw6 libndctl6 libnfs-dev libnfs13 libnghttp2-14 libnl-3-200 libnl-3-dev libnl-route-3-200 libnl-route-3-dev libnpth0 libnsl-dev libnspr4 libnspr4-dev libnss3 libnss3-dev libnuma-dev libnuma1 libogg0 libopengl-dev libopengl0 libopus0 liborc-0.4-0 libp11-kit-dev libpango-1.0-0 libpango1.0-dev libpangocairo-1.0-0 libpangoft2-1.0-0 libpangoxft-1.0-0 libpciaccess0 libpcre16-3 libpcre2-16-0 libpcre2-32-0 libpcre2-dev libpcre2-posix2 libpcre3-dev libpcre32-3 libpcrecpp0v5 libpcsclite-dev libpcsclite1 libperl5.32 libpipeline1 libpixman-1-0 libpixman-1-dev libpkgconf3 libpmem-dev libpmem1 libpng-dev libpng16-16 libproxy1v5 libpsl5 libpthread-stubs0-dev libpulse-dev libpulse-mainloop-glib0 libpulse0 libpython3-stdlib libpython3.9-minimal libpython3.9-stdlib libquadmath0 librados-dev librados2 librbd-dev librbd1 librdmacm-dev librdmacm1 libreadline8 librest-0.7-0 librtmp1 libsasl2-2 libsasl2-dev libsasl2-modules libsasl2-modules-db libsdl2-2.0-0 libsdl2-dev libseccomp-dev libselinux1-dev libsensors-config libsensors5 libsepol1-dev libset-scalar-perl libsigsegv2 libslirp-dev libslirp0 libsm-dev libsm6 libsnappy-dev libsnappy1v5 libsndfile1 libsndio-dev libsndio7.0 libsoup-gnome2.4-1 libsoup2.4-1 libspice-protocol-dev libspice-server-dev libspice-server1 libsqlite3-0 libssh-4 libssh-dev libssh2-1 libssl-dev libstdc++-10-dev libstdc++6-ppc64-cross libstdc++6-s390x-cross libstdc++6-sparc64-cross libsub-override-perl libsystemd0 libtasn1-6-dev libtext-unidecode-perl libthai-data libthai-dev libthai0 libtiff5 libtirpc-dev libtool libtsan0 libtsan0-ppc64-cross libubsan1 libubsan1-ppc64-cross libubsan1-s390x-cross libubsan1-sparc64-cross libuchardet0 libudev-dev libunbound8 libunwind8 liburcu6 liburing-dev liburing1 libusb-1.0-0 libusb-1.0-0-dev libusbredirparser-dev libusbredirparser1 libva-dev libva-drm2 libva-glx2 libva-wayland2 libva-x11-2 libva2 libvdeplug-dev libvdeplug2 libvirglrenderer-dev libvirglrenderer1 libvorbis0a libvorbisenc2 libvte-2.91-0 libvte-2.91-common libvte-2.91-dev libvulkan1 libwayland-bin libwayland-client0 libwayland-cursor0 libwayland-dev libwayland-egl1 libwayland-server0 libwebp6 libwrap0 libx11-6 libx11-data libx11-dev libx11-xcb1 libxau-dev libxau6 libxcb-dri2-0 libxcb-dri3-0 libxcb-glx0 libxcb-present0 libxcb-render0 libxcb-render0-dev libxcb-shm0 libxcb-shm0-dev libxcb-sync1 libxcb-xfixes0 libxcb1 libxcb1-dev libxcomposite-dev libxcomposite1 libxcursor-dev libxcursor1 libxdamage-dev libxdamage1 libxdmcp-dev libxdmcp6 libxen-dev libxencall1 libxendevicemodel1 libxenevtchn1 libxenforeignmemory1 libxengnttab1 libxenhypfs1 libxenmisc4.14 libxenstore3.0 libxentoolcore1 libxentoollog1 libxext-dev libxext6 libxfixes-dev libxfixes3 libxft-dev libxft2 libxi-dev libxi6 libxinerama-dev libxinerama1 libxkbcommon-dev libxkbcommon0 libxml-libxml-perl libxml-namespacesupport-perl libxml-sax-base-perl libxml-sax-perl libxml2 libxpm4 libxrandr-dev libxrandr2 libxrender-dev libxrender1 libxshmfence1 libxslt1.1 libxss-dev libxss1 libxt-dev libxt6 libxtst-dev libxtst6 libxv-dev libxv1 libxxf86vm-dev libxxf86vm1 libyajl2 libyaml-0-2 libz3-4 libzstd-dev linux-libc-dev m4 make man-db manpages manpages-dev media-types netbase nettle-dev ninja-build openssl pango1.0-tools patch perl perl-modules-5.32 pinentry-curses pkg-config po-debconf psmisc python-babel-localedata python3 python3-alabaster python3-babel python3-certifi python3-cffi-backend python3-chardet python3-cryptography python3-distutils python3-docutils python3-idna python3-imagesize python3-jinja2 python3-jwt python3-lib2to3 python3-markupsafe python3-minimal python3-packaging python3-pkg-resources python3-prettytable python3-pygments python3-pyparsing python3-requests python3-roman python3-setuptools python3-six python3-snowballstemmer python3-sphinx python3-sphinx-rtd-theme python3-tz python3-urllib3 python3.9 python3.9-minimal readline-common sensible-utils sgml-base shared-mime-info sphinx-common sphinx-rtd-theme-common tex-common texinfo ucf uuid-dev wayland-protocols x11-common x11proto-dev x11proto-input-dev x11proto-randr-dev x11proto-record-dev x11proto-scrnsaver-dev x11proto-xext-dev x11proto-xf86vidmode-dev x11proto-xinerama-dev xfsprogs xkb-data xml-core xorg-sgml-doctools xsltproc xtrans-dev xz-utils zlib1g-dev && \
  apt-get -t chimaera-backports -y --verbose-versions install meson && \
  cd /usr/local/src && \
  apt-get -t chimaera-backports source qemu-system-x86 && \
  apt-get -y install --verbose-versions acpica-tools bcc bin86 bison comerr-dev dh-exec dh-python distro-info-data flex gcc-10-multilib gcc-multilib lib32asan6 lib32atomic1 lib32gcc-10-dev lib32gcc-s1 lib32gomp1 lib32itm1 lib32quadmath0 lib32stdc++6 lib32ubsan1 libc6-dev-i386 libc6-dev-x32 libc6-i386 libc6-x32 libcmark-gfm-extensions0 libcmark-gfm0 libext2fs-dev libfindlib-ocaml liblzma-dev libpython3-dev libpython3.9 libpython3.9-dev libx32asan6 libx32atomic1 libx32gcc-10-dev libx32gcc-s1 libx32gomp1 libx32itm1 libx32quadmath0 libx32stdc++6 libx32ubsan1 libyajl-dev lsb-release markdown ocaml-base-nox ocaml-compiler-libs ocaml-findlib ocaml-interp ocaml-nox pandoc pandoc-data python3-dev python3.9-dev rdfind seabios wget && \
  apt-get -y install --verbose-versions bcc bison debhelper debhelper-compat dh-exec dh-python dpkg-dev e2fslibs-dev file flex gcc-multilib iasl libaio-dev libext2fs-dev libfdt-dev libglib2.0-dev liblzma-dev libncurses-dev libpixman-1-dev libpython3-dev libyajl-dev libzstd-dev lsb-release markdown ocaml ocaml-findlib ocaml-native-compilers ocaml-nox pandoc pkg-config python3-dev python3-dev:any rdfind seabios uuid-dev zlib1g-dev && \
  wget http://deb.debian.org/debian/pool/main/x/xen/xen_4.17.0+74-g3eac216e6e-1.dsc && \
  wget http://deb.debian.org/debian/pool/main/x/xen/xen_4.17.0+74-g3eac216e6e.orig.tar.xz && \
  wget http://deb.debian.org/debian/pool/main/x/xen/xen_4.17.0+74-g3eac216e6e-1.debian.tar.xz && \
  dpkg-source -x xen_4.17.0+74-g3eac216e6e-1.dsc && \
  cd xen-4*/ && \
  ./debian/rules binary && \
  cd ../ && \
  dpkg --purge libxen-dev libxenmisc4.14 libxenstore3.0 gcc-multilib && \
  apt-get -y install --verbose-versions debhelper-compat device-tree-compiler fcode-utils gcc-alpha-linux-gnu gcc-arm-none-eabi gcc-hppa-linux-gnu gcc-powerpc64-linux-gnu gcc-riscv64-linux-gnu gcc-s390x-linux-gnu gcc-sparc64-linux-gnu glusterfs-common gnutls-dev libaio-dev libasound2-dev libbpf-dev libbrlapi-dev libcacard-dev libcap-ng-dev libcapstone-dev libcurl4-gnutls-dev libdrm-dev libepoxy-dev libfdt-dev libfuse3-dev libgbm-dev libglusterfs-dev libgtk-3-dev libibumad-dev libibverbs-dev libiscsi-dev libjack-dev libjpeg-dev libncurses-dev libnfs-dev libnuma-dev libpixman-1-dev libpmem-dev libpng-dev libpulse-dev librbd-dev librdmacm-dev libsasl2-dev libsdl2-dev libseccomp-dev libslirp-dev libspice-server-dev libssh-dev libudev-dev liburing-dev libusb-1.0-0-dev libusbredirparser-dev libva-dev libvdeplug-dev libvirglrenderer-dev libvte-2.91-dev libzstd-dev meson nettle-dev ninja-build python3-sphinx-rtd-theme python3-sphinx:native python3:any texinfo uuid-dev xsltproc zlib1g-dev && \
  apt-get -y install --verbose-versions eudev libprocps8 procps udev  gcc-10-alpha-linux-gnu gcc-10-hppa-linux-gnu gcc-10-powerpc64-linux-gnu gcc-10-riscv64-linux-gnu gcc-10-s390x-linux-gnu gcc-10-sparc64-linux-gnu gcc-alpha-linux-gnu gcc-hppa-linux-gnu gcc-powerpc64-linux-gnu gcc-riscv64-linux-gnu gcc-s390x-linux-gnu gcc-sparc64-linux-gnu ipxe-qemu && \
  xen_packages="$(for i in libxencall1 libxendevicemodel1 libxenevtchn1 libxenforeignmemory1 libxengnttab1 libxenhypfs1 libxenmisc4.17 libxenstore4 libxentoolcore1 libxentoollog1 xen-doc xen-hypervisor-4.17-amd64 xen-hypervisor-common xen-system-amd64 xen-utils-4.17 xen-utils-common xenstore-utils libxen-dev; do ls -1d ${i}_*.deb; done)" && \
  dpkg -i ${xen_packages} && \
  mkdir -p /opt/artifact/deb/ && \
  mv -v ${xen_packages} /opt/artifact/deb/ && \
  rm -v *.deb && \
  unset xen_packages && \
  cd qemu-7.?+dfsg && \
  : ./configure --without-default-features --enable-debug --disable-plugins --disable-containers --disable-strip --enable-avx2 --enable-avx512f --enable-bpf --enable-cloop --enable-iconv --enable-curses --enable-fuse --enable-kvm --enable-libiscsi --enable-libnfs --enable-libssh --enable-libusb --enable-linux-aio --enable-linux-io-uring --enable-live-block-migration --enable-lzo --enable-replication --enable-seccomp --enable-selinux --enable-slirp --enable-snappy --enable-tcg --enable-tools --enable-tpm --enable-usb-redir --enable-vde --enable-pie --target-list="x86_64-linux-user x86_64-softmmu aarch64-linux-user aarch64-softmmu" --enable-virtfs --enable-virtiofsd --enable-xen --enable-xen-pci-passthrough --enable-zstd --enable-attr --enable-cap-ng --enable-vhost-user --enable-vduse-blk-export --enable-vhost-vdpa --enable-libvduse --enable-nettle --enable-gnutls --enable-crypto-afalg --enable-fuse-lseek --enable-l2tpv3 --enable-libudev --enable-malloc-trim --enable-membarrier --enable-numa --enable-rdma --enable-vhost-crypto --enable-vhost-kernel --enable-vhost-net && \
  ./debian/rules binary && \
  cd ../ && \
  rm -v *dbgsym*.deb && \
  mv -v qemu-block-extra_7.?+dfsg-*_amd64.deb qemu-system-common_7.?+dfsg-*_amd64.deb qemu-system-data_7.?+dfsg-*_all.deb qemu-system-x86_7.?+dfsg-*_amd64.deb qemu-system-xen_7.?+dfsg-*_amd64.deb qemu-utils_7.?+dfsg-*_amd64.deb qemu-user_7.?+dfsg-*_amd64.deb /opt/artifact/deb/ && \
  rm -v *.deb && \
  cd /usr && \
  rm -r local && \
  cd /root && \
  true


FROM devuan-4 AS devuan-4-local
COPY --from=devuan-4-builder /opt/artifact /root/artifact
COPY --from=devuan-4-builder2 /opt/artifact /root/artifact2
COPY --from=qemubuilder /opt/artifact /root/artifact3
COPY --from=devuan-4-builder3 /opt/artifact /root/artifact4
COPY --from=alpine-builder /usr/local /root/local
COPY --from=kernelsign /opt/artifact /root/kernel
COPY --from=ascii-builder /usr/local/bin/pcompress /root/artifact/local/bin/pcompress

RUN \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/stand && \
  set -x && \
  set -e && \
  umask 022 && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  cd /root && \
  export LANG=C && \
  export TMP=/tmp && \
  export TEMP="${TMP}" && \
  export TMPDIR="${TMP}" && \
  export DEBIAN_FRONTEND=noninteractive && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  export PYTHONDONTWRITEBYTECODE=1 && \
  exec </dev/null && \
  cat /root/artifact2/local/etc/permissions /usr/local/etc/permissions |sort |uniq >> /usr/local/etc/permissions. && \
  mv -f /usr/local/etc/permissions. /usr/local/etc/permissions && \
  rm -f /root/artifact/local/etc/permissions /root/artifact2/local/etc/permissions && \
  cd /root/artifact3/deb/ && \
  dpkg -i qemu-block-extra_7.?+dfsg-*_amd64.deb qemu-system-common_7.?+dfsg-*_amd64.deb qemu-system-data_7.?+dfsg-*_all.deb qemu-system-x86_7.?+dfsg-*_amd64.deb qemu-system-xen_7.?+dfsg-*_amd64.deb qemu-utils_7.?+dfsg-*_amd64.deb qemu-user_7.?+dfsg-*_amd64.deb $(for i in libxencall1 libxendevicemodel1 libxenevtchn1 libxenforeignmemory1 libxengnttab1 libxenhypfs1 libxenmisc4.17 libxenstore4 libxentoolcore1 libxentoollog1 xen-doc xen-hypervisor-4.17-amd64 xen-hypervisor-common xen-system-amd64 xen-utils-4.17 xen-utils-common xenstore-utils; do ls -1d ${i}_*.deb; done) && \
  dpkg --purge libxenmisc4.14 libxenstore3.0 xen-hypervisor-4.14-amd64 xen-utils-4.14 && \
  rm -r -f /usr/lib/debug/xen-syms-4.14-shim && \
  rm -v /usr/bin/qemu-aarch64_be /usr/bin/qemu-alpha /usr/bin/qemu-arm /usr/bin/qemu-armeb /usr/bin/qemu-cris /usr/bin/qemu-hexagon /usr/bin/qemu-hppa /usr/bin/qemu-loongarch64 /usr/bin/qemu-m68k /usr/bin/qemu-microblaze /usr/bin/qemu-microblazeel /usr/bin/qemu-mips /usr/bin/qemu-mips64 /usr/bin/qemu-mips64el /usr/bin/qemu-mipsel /usr/bin/qemu-mipsn32 /usr/bin/qemu-mipsn32el /usr/bin/qemu-nios2 /usr/bin/qemu-or1k /usr/bin/qemu-ppc /usr/bin/qemu-ppc64 /usr/bin/qemu-ppc64le /usr/bin/qemu-riscv32 /usr/bin/qemu-riscv64 /usr/bin/qemu-s390x /usr/bin/qemu-sh4 /usr/bin/qemu-sh4eb /usr/bin/qemu-sparc /usr/bin/qemu-sparc32plus /usr/bin/qemu-sparc64 /usr/bin/qemu-xtensa /usr/bin/qemu-xtensaeb && \
  cd /root && \
  rm -r /root/artifact3/ && \
  tar -C /root/artifact2 -c -f - local |tar -C /usr -x -p --warning=no-timestamp -f - && \
  rm -r /root/artifact2/local && \
  cd /root/artifact4/deb/ && \
  dpkg -i uanytun*.deb && \
  cd /root/artifact2/deb/ && \
  rm -r /root/artifact4/ && \
  dpkg -i sks-ecc_0.93-6_amd64.deb sks-ecc-doc_0.93-6_all.deb && \
  cd /root && \
  tar -C /root/artifact -c -f - local |tar -C /usr -x -p --warning=no-timestamp -f - && \
  tar -C /root/ -c -f - local|tar -C /usr -x -p --warning=no-timestamp -f - && \
  dpkg -i /root/artifact/deb/vdmfec*.deb && \
  mv -v /root/artifact/stand/* /stand/ && \
  mkdir /root/ephemeral && \
  cd /root/ephemeral &&  \
  wget https://github.com/rclone/rclone/releases/download/v1.62.2/rclone-v1.62.2-linux-amd64.deb && \
  dpkg -i rclone-v1.62.2-linux-amd64.deb && \
  rm -v rclone-v1.62.2-linux-amd64.deb && \
  wget 'https://vault.bitwarden.com/download/?app=cli&platform=linux' && \
  mv -i index.* foo.zip && \
  unzip foo.zip && \
  rm -v foo.zip && \
  chmod 755 bw && \
  chown root bw && \
  mv -i bw /usr/local/bin/ && \
  wget 'https://github.com/bitwarden/sdk/releases/download/bws-v0.2.1/bws-x86_64-unknown-linux-gnu-0.2.1.zip' && \
  mv -i bws-* bws.zip && \
  unzip bws.zip && \
  rm -v bws.zip && \
  strip bws && \
  chmod 755 bws && \
  chown root bws && \
  mv -v bws /usr/local/bin/ && \
  wget https://github.com/evilsocket/opensnitch/releases/download/v1.6.0-rc.5/opensnitch_1.6.0-rc.5-1_amd64.deb && \
  dpkg -i opensnitch_1.6.0-rc.5-1_amd64.deb && \
  cd /root && \
  for i in opensnitch; do update-rc.d "${i}" disable && update-rc.d "${i}" remove; done && \
  rm -r -v ephemeral && \
  for i in /root/kernel/deb/linux-image-5.10.*-hardened1-5.10_5.10.*-hardened1-5.10-1_amd64.deb /root/kernel/deb/linux-libc-dev_5.10.*-hardened1-5.10-1_amd64.deb; do dpkg -i "$i" && rm -v "${i}"; done && \
  dpkg -i /root/kernel/deb/linux-image-5.10.0-??-amd64_5.10.???-1_amd64.deb && \
  cd /lib/modules/5.10.*-hardened1-5.10 && \
  cd /root && \
  STDIMG="$(dpkg -l |grep linux-image-5.10 |grep -v linux-image-amd64 |grep -v linux-image'.*hardened' | awk '{print $2}' | tail -n 1)" && \
  apt-mark hold "${STDIMG}" && \
  echo "${STDIMG}" hold | dpkg --set-selections && \
  apt-mark hold linux-libc-dev && \
  echo linux-libc-dev hold | dpkg --set-selections && \
  unset STDIMG && \
  cd /root/artifact/deb/ && \
  apt-get -f install --verbose-versions libldns3 && \
  packages="$(ls -1d openssh-client_9.?p*_amd64.deb openssh-server_9.?p*_amd64.deb openssh-sftp-server_9.?p*_amd64.deb ssh_9.?p*_all.deb emacs-nox_28.?+*_amd64.deb emacs-el_28.?+*_all.deb emacs-common_28.?+*_all.deb emacs-bin-common_28.?+*_amd64.deb emacs_28.*_all.deb)" && \
  dpkg -i ${packages} && \
  unset packages && \
  sed -i -e "/GSSAPI/s,^,# ," /etc/ssh/ssh_config && \
  find /usr/share/emacs/28.?/ /usr/share/emacs/site-lisp/ -type f -name "*.gz" -exec gunzip -N -v -f -- \{\} \; && \
  find /usr/share/emacs/28.?/ /usr/share/emacs/site-lisp/ -type f -name "*.el" -exec rm -v -f -- \{\}c \; && \
  for i in ssh; do update-rc.d "${i}" disable && update-rc.d "${i}" remove; done && \
  rm -v /etc/ssh/ssh_host_ecdsa_key /etc/ssh/ssh_host_ecdsa_key.pub /etc/ssh/ssh_host_ed25519_key /etc/ssh/ssh_host_ed25519_key.pub /etc/ssh/ssh_host_rsa_key /etc/ssh/ssh_host_rsa_key.pub /etc/ssh/sshd_not_to_be_run && \
  chmod --verbose a-s /usr/bin/ssh-agent /usr/lib/openssh/ssh-keysign 2>&1 | tee -a /usr/local/etc/permissions && \
  cd /root && \
  rm -r /root/artifact/ /root/local/ && \
  curl -fsSL https://raw.githubusercontent.com/mviereck/x11docker/master/x11docker | bash -s -- --update && \
  apt-get install -y --verbose-versions openntpd grub-efi grub-efi-amd64 grub-efi-amd64-bin grub-efi-ia32-bin cpuid refind sbsigntool && \
  for i in openntpd; do update-rc.d "${i}" disable && update-rc.d "${i}" remove; done && \
  apt-get install -y --verbose-versions linux-image-amd64 && \
  mkdir -p ephemeral/ && \
  cd ephemeral/ && \
  echo deb http://deb.devuan.org/merged daedalus main contrib non-free >> /etc/apt/sources.list && \
  apt-get update && \
  apt-get download xen-hypervisor-4.17-amd64 && \
  sed -i -e "/ daedalus main contrib non-free/d" /etc/apt/sources.list && \
  apt-get update && \
  ar x xen-hypervisor-4.17-amd64_4.17.*_amd64.deb && \
  xz -d -v -v < data.tar.xz |tar -x -p -f - && \
  cd boot/ && \
  rm -f /boot/xen-4.14-amd64.config /boot/xen-4.14-amd64.efi /boot/xen-4.14-amd64.gz >/dev/null 2>/dev/null && \
  for i in xen-4.17-amd64.config xen-4.17-amd64.efi xen-4.17-amd64.gz; do mv -i -v "${i}" "$(echo -n "$i" | sed 's,4\.17-,,')"; done && \
  mv -v xen* /boot/ && \
  cd /root/ && \
  rm -r -v ephemeral/ && \
  cp -p -v /root/kernel/uml/linux /usr/local/bin/linux && \
  strip --preserve-dates --strip-debug --no-merge-notes --keep-file-symbols --verbose -- /usr/local/bin/linux && \
  mv /root/kernel/uml/5.10* /lib/modules/ && \
  mv /root/kernel/vmlinux-* /boot/ && \
  rm -r /root/kernel && \
  dpkg -l >> /root/dpkg-l && \
  find /usr/local -type f -exec file -- \{\} \; |grep "ELF 64-bit LSB" |cut -f1 -d: |xargs -- strip --preserve-dates --strip-debug --no-merge-notes --keep-file-symbols --verbose -- && \
  strip --preserve-dates --strip-debug --no-merge-notes --keep-file-symbols --verbose -- /stand/[^b]* /stand/b[^a]* /stand/base* && \
  find /usr/lib /usr/share /usr/local -maxdepth 24 -name "*.pyc" -type f -ls -delete && \
  (set +e; find /usr/lib /usr/share /usr/local -maxdepth 24 -name __pycache__ -type d -print | xargs rmdir -v -- || true; true) && \
  rm -v -f /usr/share/javascript/underscore/underscore.min.js /usr/share/javascript/underscore/underscore.min.js.map /usr/share/javascript/jquery/jquery.min.map /usr/share/javascript/jquery/jquery.min.js && \
  rm -r /usr/share/locale/[^e]* /usr/share/locale/e[^n]* && \
  rm -f -v /etc/skel/.bash_logout && \
  : > /var/log/dpkg.log && \
  rm -v -f /root/.wget-hsts && \
  rm -r -f /root/.cache && \
  rm -v -f /var/lib/dpkg/status-old && \
  find /usr/share /usr/lib/x86_64-linux-gnu /usr/local/share -name \*.gz -type l -ls -delete && \
  find /usr/share /usr/lib/x86_64-linux-gnu /usr/local/share -name \*.gz -type f -exec gunzip -N -v -f -- \{\} \; && \
  umask 077 && \
  (echo; echo /usr/bin/uptime; echo echo '$(/bin/date) $HOST $SHLVL $PPID $$ $DISPLAY $USER $TERM $TTY $COLUMNS $LINES') >> /root/.zlogin && \
  (echo; echo 'export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/games:/usr/local/sbin:/usr/local/bin:/stand') >> /root/.zshenv && \
  (echo; echo 'setopt ALIASES ALWAYS_LAST_PROMPT APPEND_CREATE APPEND_HISTORY AUTO_LIST AUTO_PARAM_KEYS AUTO_PARAM_SLASH AUTO_PUSHD BAD_PATTERN BANG_HIST BARE_GLOB_QUAL BEEP BRACE_CCL BSD_ECHO CASE_GLOB CASE_MATCH CHASE_DOTS CHECK_JOBS CHECK_RUNNING_JOBS CLOBBER COMPLETE_ALIASES CONTINUE_ON_ERROR C_BASES C_PRECEDENCES DEBUG_BEFORE_CMD EQUALS EXTENDED_GLOB EXTENDED_HISTORY FUNCTION_ARGZERO GLOB GLOBAL_EXPORT GLOBAL_RCS GLOB_ASSIGN HASH_CMDS HASH_DIRS HASH_EXECUTABLES_ONLY HASH_LIST_ALL HIST_BEEP HIST_EXPIRE_DUPS_FIRST HIST_FIND_NO_DUPS HIST_IGNORE_ALL_DUPS HIST_IGNORE_DUPS HIST_LEX_WORDS HIST_SAVE_BY_COPY HIST_SAVE_NO_DUPS HIST_SUBST_PATTERN IGNORE_EOF INC_APPEND_HISTORY INTERACTIVE_COMMENTS KSH_ARRAYS KSH_AUTOLOAD KSH_OPTION_PRINT KSH_ZERO_SUBSCRIPT LIST_AMBIGUOUS LIST_PACKED LIST_TYPES LOCAL_LOOPS LOCAL_OPTIONS LOCAL_PATTERNS LOCAL_TRAPS LONG_LIST_JOBS MAGIC_EQUAL_SUBST MARK_DIRS MONITOR MULTIBYTE MULTIOS NOMATCH NOTIFY NO_ALIAS_FUNC_DEF NO_ALL_EXPORT NO_ALWAYS_TO_END NO_AUTO_CD NO_AUTO_CONTINUE NO_AUTO_MENU NO_AUTO_NAME_DIRS NO_AUTO_REMOVE_SLASH NO_AUTO_RESUME NO_BASH_AUTO_LIST NO_BASH_REMATCH NO_BG_NICE NO_CDABLE_VARS NO_CD_SILENT NO_CHASE_LINKS NO_COMPLETE_IN_WORD NO_CORRECT NO_CORRECT_ALL NO_CSH_JUNKIE_HISTORY NO_CSH_JUNKIE_LOOPS NO_CSH_JUNKIE_QUOTES NO_CSH_NULLCMD NO_CSH_NULL_GLOB NO_DVORAK NO_ERR_EXIT NO_ERR_RETURN NO_EVAL_LINENO NO_FLOW_CONTROL NO_FORCE_FLOAT NO_GLOB_COMPLETE NO_GLOB_DOTS NO_GLOB_STAR_SHORT NO_GLOB_SUBST NO_HIST_ALLOW_CLOBBER NO_HIST_FCNTL_LOCK NO_HIST_IGNORE_SPACE NO_HIST_NO_FUNCTIONS NO_HIST_NO_STORE NO_HIST_REDUCE_BLANKS NO_HIST_VERIFY NO_HUP NO_IGNORE_BRACES NO_IGNORE_CLOSE_BRACES NO_INC_APPEND_HISTORY_TIME NO_KSH_GLOB NO_KSH_TYPESET NO_LIST_BEEP NO_LIST_ROWS_FIRST NO_MAIL_WARNING NO_MENU_COMPLETE NO_MULTI_FUNC_DEF NO_NULL_GLOB NO_NUMERIC_GLOB_SORT NO_OCTAL_ZEROES NO_PATH_SCRIPT NO_PIPE_FAIL NO_POSIX_ARGZERO NO_POSIX_CD NO_POSIX_IDENTIFIERS NO_POSIX_JOBS NO_POSIX_STRINGS NO_POSIX_TRAPS NO_PROMPT_SP NO_PUSHD_MINUS NO_PUSHD_SILENT NO_RC_EXPAND_PARAM NO_RC_QUOTES NO_REC_EXACT NO_REMATCH_PCRE NO_RM_STAR_SILENT NO_SHARE_HISTORY NO_SH_FILE_EXPANSION NO_SH_GLOB NO_SH_NULLCMD NO_SH_OPTION_LETTERS NO_SH_WORD_SPLIT NO_SOURCE_TRACE NO_SUN_KEYBOARD_HACK NO_TYPESET_SILENT NO_VERBOSE NO_XTRACE PATH_DIRS POSIX_ALIASES POSIX_BUILTINS PRINT_EIGHT_BIT PRINT_EXIT_VALUE PROMPT_BANG PROMPT_CR PROMPT_PERCENT PROMPT_SUBST PUSHD_IGNORE_DUPS PUSHD_TO_HOME RCS RM_STAR_WAIT SHORT_LOOPS TRANSIENT_RPROMPT TRAPS_ASYNC UNSET WARN_CREATE_GLOBAL WARN_NESTED_VAR'; echo 'if test x"${IDEN_PATH}" "==" x || test x"${IDEN_PATH}" "==" "x "; then if test -r /run/iden/path; then export IDEN_PATH="$( (cat /run/iden/path 2>/dev/null | tr -cd 0-9A-Za-z@_/." "- | head -c 32 || true; echo -n " "; true)|sed "s,^ *,,")"; fi; fi'; echo 'if test "${HOST}" "==" localhost; then HOSTUNIQ="${IDEN_PATH}"; else HOSTUNIQ="${IDEN_PATH}${HOST} "; fi; PROMPT="%(1j.<%j> .)${HOSTUNIQ}%(2L.%L .)%(#..${USER} )%(1e.+%e .)%l %4~ [%h]"; unset HOSTUNIQ'; echo 'REPORTMEMORY=524288'; echo 'REPORTTIME=128'; echo 'WATCHFMT="%D %T %n %a %l %M"'; echo 'HISTSIZE=16384'; echo 'NULLCMD=more'; echo 'READNULLCMD="${NULLCMD}"'; echo 'watch=(all)'; echo 'alias dirs="dirs -v"'; echo 'alias jobs="jobs -pl"'; echo 'alias history="fc -l -t %Y.%m.%d-%H.%M.%S.%4."'; echo 'set -o emacs') >> /root/.zshrc && \
  cd /root && \
  cp -p -f /root/.zshrc /root/.zshenv /root/.zlogin /etc/skel/ && \
  adduser --disabled-password --gecos "" --shell /bin/bash-static user && \
  adduser --disabled-password --gecos "" --force-badname --shell /bin/bash-static Administrator && \
  adduser --disabled-password --gecos "" --force-badname --shell /bin/bash-static Gateway && \
  chsh -s /bin/zsh-static root && \
  chsh -s /bin/zsh-static user && \
  chsh -s /bin/zsh-static Administrator && \
  chsh -s /bin/rksh Gateway && \
  rm -v -f /etc/subuid- /etc/subgid- && \
  : > /etc/subuid && \
  : > /etc/subgid && \
  rm -r -f .local/ && \
  ((for i in "127.0.0.1 localhost" "::1 localhost ip6-localhost ip6-loopback" "ff02::1 ip6-allnodes" "ff02::2 ip6-allrouters"; do echo $i; done) > /etc/hosts || true) && \
  (chmod a-x /etc/hosts || true) && \
  chown -R root:root /usr/local/etc/cni /usr/local/etc/containers /usr/local/share/man /usr/local/share/doc /usr/local/bin /usr/local/lib && \
  rm -v -f /etc/group- /etc/gshadow- /etc/passwd- /etc/shadow- && \
  rm -v -f /var/cache/debconf/config.dat-old /var/cache/debconf/templates.dat-old /var/lib/dpkg/diversions-old /var/lib/dpkg/status-old /var/lib/dpkg/statoverride-old && \
  rm -r -f /root/artifact2 && \
  : > /var/log/alternatives.log && \
  : > /var/log/dpkg.log && \
  : > /var/log/apt/term.log && \
  : > /var/log/apt/history.log && \
  : > /var/log/fontconfig.log && \
  : > /var/log/alternatives.log && \
  : |xz -vv > /var/log/apt/eipp.log.xz && \
  chmod --verbose +t /tmp /var/tmp /tmp/. /var/tmp/. && \
  find / -xdev -name "*.pyc" -ls && \
  find / -xdev -name "__pycache__" -ls && \
  find / -xdev -type f -perm -2000 -ls && \
  find / -xdev -type f -perm -4000 -ls && \
  find / -xdev -type f -perm -0002 -ls && \
  find / -xdev -type d -perm -0002 -ls && \
  find /usr -type f -name \*.gz -ls && \
  true

FROM devuan-4-local AS devuan-4-kicksecure

RUN \
  packages_kicksecure_dep=" \
    acpi-support \
    acpi-support-base \
    acpid \
    apparmor \
    apparmor-profiles \
    apparmor-profiles-extra \
    apparmor-utils \
    apt-transport-tor \
    apt-utils \
    autoconf \
    automake \
    autopoint \
    autotools-dev \
    bind9-dnsutils \
    codecrypt \
    console-common \
    console-data \
    console-setup \
    console-setup-linux \
    cpp \
    cpp-10 \
    cython3 \
    dbus \
    dbus-x11 \
    dconf-gsettings-backend \
    dconf-service \
    dctrl-tools \
    debhelper \
    debsums \
    dh-autoreconf \
    dh-strip-nondeterminism \
    dialog \
    diceware \
    dirmngr \
    distro-info-data \
    dkms \
    dnsutils \
    dpkg-dev \
    dwz \
    elogind \
    equivs \
    extrepo \
    fasttrack-archive-keyring \
    flatpak \
    fontconfig \
    fontconfig-config \
    fonts-dejavu-core \
    fonts-font-awesome \
    fonts-lato \
    gcc \
    gcc-10 \
    geoip-database \
    gettext \
    gettext-base \
    glib-networking \
    glib-networking-common \
    glib-networking-services \
    gnupg \
    gnupg-l10n \
    gnupg-utils \
    gpg \
    gpg-agent \
    gpg-wks-client \
    gpg-wks-server \
    gpgconf \
    gpgsm \
    gsettings-desktop-schemas \
    init \
    initramfs-tools \
    initramfs-tools-core \
    initscripts \
    inotify-tools \
    insserv \
    intltool-debian \
    iotop \
    iw \
    kbd \
    keyboard-configuration \
    libappstream-glib8 \
    libarchive-zip-perl \
    libasan6 \
    libatasmart4 \
    libatomic1 \
    libavahi-client3 \
    libavahi-common-data \
    libavahi-common3 \
    libavahi-glib1 \
    libblockdev-crypto2 \
    libblockdev-fs2 \
    libblockdev-loop2 \
    libblockdev-part-err2 \
    libblockdev-part2 \
    libblockdev-swap2 \
    libblockdev-utils2 \
    libblockdev2 \
    libbluetooth3 \
    libbytes-random-secure-perl \
    libc-dev-bin \
    libc-l10n \
    libc6-dev \
    libcc1-0 \
    libcrypt-dev \
    libcrypt-passwdmd5-perl \
    libcrypt-random-seed-perl \
    libcryptx-perl \
    libdconf1 \
    libdebhelper-perl \
    libdeflate0 \
    libdouble-conversion3 \
    libdpkg-perl \
    libdrm-amdgpu1 \
    libdrm-common \
    libdrm-intel1 \
    libdrm-nouveau2 \
    libdrm-radeon1 \
    libdrm2 \
    libegl-mesa0 \
    libegl1 \
    libelogind0 \
    libencode-locale-perl \
    libevdev2 \
    libfftw3-double3 \
    libfile-fnmatch-perl \
    libfile-listing-perl \
    libfile-stripnondeterminism-perl \
    libfontconfig1 \
    libfreetype6 \
    libgbm1 \
    libgcc-10-dev \
    libgdk-pixbuf-2.0-0 \
    libgdk-pixbuf2.0-common \
    libgeoip1 \
    libgl1 \
    libgl1-mesa-dri \
    libglapi-mesa \
    libglib2.0-bin \
    libglib2.0-data \
    libglvnd0 \
    libglx-mesa0 \
    libglx0 \
    libgpgme11 \
    libgraphite2-3 \
    libgudev-1.0-0 \
    libharfbuzz0b \
    libhtml-parser-perl \
    libhtml-tagset-perl \
    libhtml-tree-perl \
    libhttp-cookies-perl \
    libhttp-date-perl \
    libhttp-message-perl \
    libhttp-negotiate-perl \
    libice6 \
    libinotifytools0 \
    libinput-bin \
    libinput10 \
    libio-html-perl \
    libisl23 \
    libitm1 \
    libjbig0 \
    libjpeg62-turbo \
    libjs-jquery \
    libjs-sphinxdoc \
    libjs-underscore \
    libjson-glib-1.0-0 \
    libjson-glib-1.0-common \
    libksba8 \
    libllvm11 \
    liblocale-gettext-perl \
    liblsan0 \
    liblwp-mediatypes-perl \
    liblwp-protocol-https-perl \
    libmalcontent-0-0 \
    libmath-random-isaac-perl \
    libmd4c0 \
    libmm-glib0 \
    libmpc3 \
    libmpdec3 \
    libmtdev1 \
    libndp0 \
    libnet-http-perl \
    libnewt0.52 \
    libnl-route-3-200 \
    libnm0 \
    libnpth0 \
    libnsl-dev \
    libnspr4 \
    libnss3 \
    libntfs-3g883 \
    libostree-1-1 \
    libpam-elogind \
    libparted-fs-resize0 \
    libpciaccess0 \
    libpcre2-16-0 \
    libpcsclite1 \
    libpkcs11-helper1 \
    libpng16-16 \
    libpolkit-agent-1-0 \
    libpolkit-gobject-1-0 \
    libpolkit-gobject-elogind-1-0 \
    libproxy1v5 \
    libpython3-stdlib \
    libpython3.9-minimal \
    libpython3.9-stdlib \
    libqt5core5a \
    libqt5dbus5 \
    libqt5gui5 \
    libqt5network5 \
    libqt5widgets5 \
    libquadmath0 \
    libsecret-1-0 \
    libsecret-common \
    libslang2 \
    libsm6 \
    libsnappy1v5 \
    libsoup2.4-1 \
    libsqlite3-0 \
    libstemmer0d \
    libsub-override-perl \
    libsysfs2 \
    libteamdctl0 \
    libtiff5 \
    libtirpc-dev \
    libtool \
    libtry-tiny-perl \
    libtsan0 \
    libubsan1 \
    libudisks2-0 \
    liburi-perl \
    libvolume-key1 \
    libvulkan1 \
    libwacom-common \
    libwacom2 \
    libwayland-client0 \
    libwayland-server0 \
    libwebp6 \
    libwww-perl \
    libwww-robotrules-perl \
    libx11-6 \
    libx11-data \
    libx11-xcb1 \
    libxau6 \
    libxaw7 \
    libxcb-dri2-0 \
    libxcb-dri3-0 \
    libxcb-glx0 \
    libxcb-icccm4 \
    libxcb-image0 \
    libxcb-keysyms1 \
    libxcb-present0 \
    libxcb-randr0 \
    libxcb-render-util0 \
    libxcb-render0 \
    libxcb-shape0 \
    libxcb-shm0 \
    libxcb-sync1 \
    libxcb-util1 \
    libxcb-xfixes0 \
    libxcb-xinerama0 \
    libxcb-xinput0 \
    libxcb-xkb1 \
    libxcb1 \
    libxcursor1 \
    libxdamage1 \
    libxdmcp6 \
    libxext6 \
    libxfixes3 \
    libxi6 \
    libxkbcommon-x11-0 \
    libxkbcommon0 \
    libxmu6 \
    libxmuu1 \
    libxpm4 \
    libxrandr2 \
    libxrender1 \
    libxshmfence1 \
    libxt6 \
    libxxf86vm1 \
    libyaml-0-2 \
    libyaml-libyaml-perl \
    libz3-4 \
    libzulucrypt-exe1.2.0 \
    libzulucrypt-plugins \
    libzulucrypt1.2.0 \
    libzulucryptpluginmanager1.0.0 \
    linux-base \
    linux-compiler-gcc-10-x86 \
    linux-headers-amd64 \
    linux-kbuild-5.10 \
    linux-libc-dev \
    live-boot \
    live-boot-initramfs-tools \
    live-tools \
    locales \
    lsb-release \
    m4 \
    magic-wormhole \
    make \
    makepasswd \
    media-types \
    menu \
    most \
    nano \
    network-manager \
    ntfs-3g \
    obfs4proxy \
    openvpn \
    p7zip \
    p7zip-full \
    po-debconf \
    policykit-1 \
    policyrcd-script-zg2 \
    pwgen \
    python3 \
    python3-apparmor \
    python3-attr \
    python3-autobahn \
    python3-automat \
    python3-bcrypt \
    python3-cbor \
    python3-certifi \
    python3-cffi-backend \
    python3-chardet \
    python3-click \
    python3-colorama \
    python3-constantly \
    python3-cryptography \
    python3-dateutil \
    python3-geoip \
    python3-hamcrest \
    python3-hkdf \
    python3-humanize \
    python3-hyperlink \
    python3-idna \
    python3-incremental \
    python3-libapparmor \
    python3-lz4 \
    python3-minimal \
    python3-nacl \
    python3-openssl \
    python3-pkg-resources \
    python3-pyasn1 \
    python3-pyasn1-modules \
    python3-pyqrcode \
    python3-requests \
    python3-scapy \
    python3-sdnotify \
    python3-service-identity \
    python3-six \
    python3-snappy \
    python3-socks \
    python3-spake2 \
    python3-stem \
    python3-tqdm \
    python3-trie \
    python3-twisted \
    python3-twisted-bin \
    python3-txaio \
    python3-txtorcon \
    python3-u-msgpack \
    python3-ubjson \
    python3-urllib3 \
    python3-wsaccel \
    python3-yaml \
    python3-zope.interface \
    python3.9 \
    python3.9-minimal \
    secure-delete \
    shared-mime-info \
    spectre-meltdown-checker \
    sphinx-rtd-theme-common \
    startpar \
    sudo \
    sysfsutils \
    sysv-rc \
    udisks2 \
    vrms \
    wpasupplicant \
    x11-common \
    x11-xserver-utils \
    xdg-dbus-proxy \
    xdg-utils \
    xkb-data \
    zulucrypt-cli \
  " && \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/stand && \
  set -x && \
  set -e && \
  umask 077 && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  cd /root && \
  export LANG=C && \
  export TMP=/tmp && \
  export TEMP="${TMP}" && \
  export TMPDIR="${TMP}" && \
  export DEBIAN_FRONTEND=noninteractive && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  export PYTHONDONTWRITEBYTECODE=1 && \
  exec </dev/null && \
  rm -v -f /root/dpkg-l && \
  apt-get -y update && \
  apt-get -y --verbose-versions dist-upgrade && \
  apt-get -y --verbose-versions --allow-change-held-packages install ${packages_kicksecure_dep} && \
  curl --tlsv1.3 --proto =https --max-time 180 --output /usr/share/keyrings/derivative.asc https://www.kicksecure.com/keys/derivative.asc && \
  chmod --verbose go+r /usr/share/keyrings/derivative.asc && \
  adduser Administrator sudo && \
  addgroup --system console && \
  adduser Administrator console && \
  echo "deb [signed-by=/usr/share/keyrings/derivative.asc] https://deb.kicksecure.com bullseye main contrib non-free" | tee -a /etc/apt/sources.list.d/derivative.list && \
  chmod --verbose go+r /etc/apt/sources.list.d/derivative.list && \
  apt-get -y update && \
  rm -f /etc/skel/.zshrc /etc/skel/.zlogin /etc/skel/.zshenv && \
  apt-get -y --verbose-versions dist-upgrade && \
  apt-get -y --verbose-versions install apparmor-profiles-kicksecure debug-misc hardened-malloc kicksecure-base-files kicksecure-default-applications-cli kicksecure-dependencies-cli kicksecure-network-conf non-qubes-vm-enhancements-cli open-link-confirmation security-misc usability-misc && \
  mkdir -v ephemeral && \
  cd ephemeral && \
  apt-get download systemcheck && \
  package=$(ls -1d systemcheck_*_all.deb) && \
  ar xv "${package}" && \
  xz -dvv < control.tar.xz | tar -xpkvvf - && \
  sed -i -e "s/, systemd, /, /" control && \
  : > postinst && \
  : > postrm && \
  : > prerm && \
  tar -c -v -f - conffiles control md5sums postinst postrm preinst prerm |xz -vv > control.tar.xz && \
  rm -v "${package}" && \
  ar rcv "${package}" debian-binary control.tar.xz data.tar.xz && \
  dpkg -i --force-all "${package}" && \
  unset package && \
  cd /root && \
  rm -r -v ephemeral && \
  mkdir -v ephemeral && \
  cd ephemeral && \
  apt-get download libsystemd0 && \
  ar xv libsystemd*.deb && \
  xz -dvv < data.tar.xz |tar -x -vv -p -f - ./usr/lib/x86_64-linux-gnu && \
  tar -C ./usr/lib/ -c -v -f - x86_64-linux-gnu/ | tar -C /usr/lib/ -x -p -v -f - && \
  cd /root && \
  rm -r -v ephemeral && \
  apt-get install -y --verbose-versions kicksecure-cli-vm && \
  mkdir -p -v /usr/local/src/attic/etc/apt/sources.list.d /usr/local/src/attic/etc/profile.d && \
  mv -v /etc/apt/sources.list.d/debian.list /usr/local/src/attic/etc/apt/sources.list.d/debian.list && \
  apt-get -y update && \
  apt-get -y --verbose-versions dist-upgrade && \
  mkdir -v -p /opt/artifact/archives && \
  tar -c -f - /var/lib/apt/lists /usr/share/keyrings/derivative.asc |xz -9 -e -v -v -C crc32 > /opt/artifact/lists-key.gtar.xz && \
  sed -i -e '/Defaults.*secure_path/s,secure_path="[^"]*",secure_path="/sbin:/bin:/usr/sbin:/usr/bin",' /etc/sudoers && \
  mv -v /etc/profile.d/30_setup.sh /usr/local/src/attic/etc/profile.d/ && \
  cd /opt/artifact/archives && \
  apt-get download anon-apt-sources-list apparmor-profile-dist apparmor-profile-hexchat apparmor-profile-thunderbird apparmor-profile-torbrowser apparmor-profiles-kicksecure bootclockrandomization damngpl debug-misc desktop-config-dist dist-base-files grub-live grub-live-initramfs-tools hardened-malloc helper-scripts icon-pack-dist initializer-dist kicksecure-base-files kicksecure-cli kicksecure-cli-vm kicksecure-default-applications-cli kicksecure-dependencies-cli kicksecure-dependencies-system kicksecure-network-conf kicksecure-recommended-cli msgcollector non-qubes-vm-enhancements-cli open-link-confirmation repository-dist sdwdate security-misc setup-dist swap-file-creator systemcheck timesanitycheck tirdad tirdad-dkms tor usability-misc vm-config-dist && \
  cd .. && \
  tar -c -f - archives |gzip -1 -v --synchronous --rsyncable > archives.gtar.gz && \
  rm -r archives && \
  cd /root && \
  find /usr/lib /usr/share -maxdepth 24 -name "*.pyc" -ls -delete && \
  find /usr/lib /usr/share -maxdepth 24 -name __pycache__ -type d -print | xargs rmdir -v -- && \
  apt-get -y clean && \
  apt-get -y autoclean && \
  apt-get -y autoremove && \
  rm -r -v /usr/share/man/[^m]*/ && \
  rm -v -f /etc/group- /etc/gshadow- /etc/passwd- /etc/shadow- /etc/subgid- /etc/subuid- && \
  dpkg -l > /root/dpkg-l && \
  unset PYTHONDONTWRITEBYTECODE && \
  rm -v /etc/.pwd.lock && \
  rm -v -f /var/cache/debconf/config.dat-old /var/cache/debconf/templates.dat-old /var/lib/dpkg/diversions-old /var/lib/dpkg/status-old /var/lib/dpkg/statoverride-old && \
  : > /var/log/alternatives.log && \
  : > /var/log/dpkg.log && \
  : > /var/log/apt/term.log && \
  : > /var/log/apt/history.log && \
  : > /var/log/fontconfig.log && \
  : > /var/log/alternatives.log && \
  : |xz -vv > /var/log/apt/eipp.log.xz && \
  chmod --verbose -R go-rwx /home/* /etc/skel && \
  chmod --verbose go-w /etc/hostname && \
  (echo umask 077; echo export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/stand; echo unset HUSHLOGIN; echo unset MOTD_SHOWN) | tee -a /etc/skel/.bashrc.kicksecure && \
  find /tmp /var/tmp -type f -ls -delete && \
  chmod --verbose -R go-rwx /root && \
  chmod --verbose a-s /bin/ntfs-3g /usr/bin/pkexec /usr/bin/sudo /usr/lib/dbus-1.0/dbus-daemon-launch-helper /usr/libexec/polkit-agent-helper-1 /usr/bin/schroot 2>&1 | tee -a /usr/local/etc/permissions && \
  echo /usr/lib/libhardened_malloc.so/libhardened_malloc.so |tee -a /etc/ld.so.preload && \
  find /usr/share/doc /usr/share/info /usr/share/man -name \*.gz -type l -ls -delete && \
  find /usr/share/doc /usr/share/info /usr/share/man -name \*.gz -type f -exec gunzip -N -v -f -- \{\} \; && \
  find /etc/alternatives -name \*.gz -type l -ls -delete && \
  find / -xdev -name "*.pyc" -ls && \
  find / -xdev -name "__pycache__" -ls && \
  find / -xdev -type f -perm -2000 -ls && \
  find / -xdev -type f -perm -4000 -ls && \
  find / -xdev -type f -perm -0002 -ls && \
  find / -xdev -type d -perm -0002 -ls && \
  true

FROM docker://devuan/devuan:chimaera AS devuan-4-hardenedmalloc

COPY --from=devuan-4-kicksecure /usr/lib/libhardened_malloc.so/ /usr/lib/libhardened_malloc.so/
COPY --from=devuan-4-kicksecure /root/dpkg-l /root/dpkg-l-kicksecure
COPY --from=devuan-4-local / /root/initrd/
COPY --from=kernelsign /opt/artifact /root/kernel
COPY Scripts/05entropy /root/
COPY --from=devuan-archive-pool /opt/artifact/archives.gtar.gz /root/archives-devuan.gtar.gz
COPY --from=devuan-archive-pool /opt/artifact/extended.gtar.gz /root/extended-devuan.gtar.gz
COPY --from=devuan-4-kicksecure /opt/artifact/archives.gtar.gz /root/archives-kicksecure.gtar.gz
COPY --from=devuan-4-kicksecure /opt/artifact/lists-key.gtar.xz /root/kicksecure-lists-key.gtar.xz

RUN \
  module_list=" 3c574_cs 3c589_cs 3c59x 3w-9xxx 3w-sas 3w-xxxx 8021q 8139cp 8139too 8390 88pg86x 88pm800 88pm800-regulator 88pm805 88pm80x BusLogic a100u2w aacraid ac ac97_bus acard-ahci acenic acpi_call acpi_pad acpi_tad acpi_thermal_rel act8865-regulator ad5398 adc-keys adf7242 adin adp5588-keys adp5589-keys advansys aec62xx aes_generic aesni_intel af_alg af_packet agpgart aha152x_cs ahci aic79xx aic7xxx aic94xx alcor alcor_pci algif_hash algif_skcipher alim15x3 altera_tse alx am53c974 amd amd-xgbe amd74xx amd8111e android-goldfish applespi aquantia ar9331 arcmsr arizona-i2c arizona-ldo1 arizona-micsupp arizona-spi asus-wmi async_memcpy async_pq async_raid6_recov async_tx async_xor at803x at86rf230 ata_generic ata_piix aten atiixp atl1 atl1c atl1e atl2 atlantic atp870u atusb aufs autofs4 ax88796b axnet_cs axp20x axp20x-i2c axp20x-regulator b44 b53_common b53_mdio b53_mmap b53_serdes b53_spi b53_srab bareudp battery bcm-phy-lib bcm-sf2 bcm54140 bcm590xx bcm590xx-regulator bcm7xxx bcm84881 bcm87xx bcma bcma-hcd bd9571mwv bd9571mwv-regulator be2iscsi be2net binfmt_misc blake2b_generic blktap bna bnx2 bnx2fc bnx2i bnx2x bnxt_en bochs bochs_drm bpck br_netfilter brd bridge broadcom bsd_comp btrfs button ca8210 cassini cb710 cb710-mmc cc2520 ccp cdrom cec cfbcopyarea cfbfillrect cfbimgblt ch chacha-x86_64 chacha_x86_64 ci_hdrc ci_hdrc_msm ci_hdrc_pci ci_hdrc_usb2 cicada cirrus clk-cdce706 clk-cs2000-cp clk-max9485 clk-pwm clk-s2mps11 clk-si5341 clk-si5351 clk-si544 cmd640 cmd64x cnic comm configfs coretemp cortina cpuid cqhci crc-ccitt crc-itu-t crc16 crc32-pclmul crc32_pclmul crc32c-intel crc32c_generic crc32c_intel crc64 crc64_rocksoft crc64_rocksoft_generic crc7 crc8 crc_ccitt crc_t10dif crct10dif_common crct10dif_generic crct10dif_pclmul cros_ec cros_ec_dev cros_ec_keyb cros_ec_lpcs cros_ec_spi cryptd crypto_simd cryptoloop ctr curve25519-x86_64 curve25519_x86_64 cxgb cxgb3 cxgb3i cxgb4 cxgb4i cxgb4vf da9062-core da9062-regulator da9063 da9150-core da9210-regulator da9211-regulator davicom dc395x dca dcdbas de2104x defxx delkin_cb dell_rbu dl2k dlink-dir685-touchkeys dln2 dm_crypt dm_log dm_mirror dm_mod dm_multipath dm_region_hash dmfe dmx3191d dnet dns_resolver dp83822 dp83848 dp83867 dp83869 dp83tc811 dpt_i2o drm drm_buddy drm_display_helper drm_kms_helper drm_panel_orientation_quirks drm_ttm_helper drm_vram_helper dsa_core dsa_loop dsa_loop_bdinfo dstr dw_dmac dw_dmac_core dwc2 dwc3 dwc3-haps dwc3-pci e100 e1000 e1000e ec_bhf ecb ecryptfs edac_mce_amd eeprom_93cx6 efi-pstore efi_pstore efivarfs efivars ehci-hcd ehci-pci ehci-platform ehci_hcd ehci_pci ena enclosure encrypted_keys enic epat epia epic100 eql esas2r esp_scsi et1011c et131x evdev ext2 ext3 ext4 extcon-usb-gpio extcon-usbc-cros-ec failover fakelb fan fan53555 fat fb fb_sys_fops fbdev fcoe fealnx ff-memless firewire-core firewire-ohci firewire-sbp2 fit2 fit3 fixed fixed_phy fjes floppy fm10k fmvj18x_cs fnic forcedeth fotg210-hcd friq frpw fscache ftsteutates fuse garp gcm gdth geneve gf128mul ghash_clmulni_intel ghash_generic glue_helper goldfish_events gpio-adp5588 gpio-aggregator gpio-amd-fch gpio-amd8111 gpio-amdpt gpio-dwapb gpio-exar gpio-f7188x gpio-generic gpio-ich gpio-it87 gpio-kempld gpio-max3191x gpio-max7300 gpio-max7301 gpio-max730x gpio-max732x gpio-mb86s7x gpio-mc33880 gpio-ml-ioh gpio-mockup gpio-pca953x gpio-pca9570 gpio-pcf857x gpio-pci-idio-16 gpio-pcie-idio-24 gpio-pisosr gpio-rdc321x gpio-regulator gpio-sch gpio-sch311x gpio-tpic2810 gpio-viperboard gpio-vx855 gpio-winbond gpio-ws16c48 gpio-xilinx gpio-xra1403 gpio_keys gpio_keys_polled grace gre gtp gve hamachi hid hid-accutouch hid-alps hid-apple hid-appleir hid-asus hid-aureal hid-belkin hid-cherry hid-chicony hid-cmedia hid-corsair hid-cougar hid-cp2112 hid-creative-sb0540 hid-elan hid-elo hid-ezkey hid-gembird hid-generic hid-gfrm hid-glorious hid-gt683r hid-holtek-kbd hid-holtek-mouse hid-hyperv hid-ite hid-jabra hid-keytouch hid-led hid-lenovo hid-lg-g15 hid-logitech hid-logitech-dj hid-logitech-hidpp hid-macally hid-maltron hid-mcp2221 hid-mf hid-microsoft hid-monterey hid-nti hid-ortek hid-penmount hid-plantronics hid-primax hid-prodikeys hid-redragon hid-retrode hid-rmi hid-roccat hid-roccat-arvo hid-roccat-common hid-roccat-isku hid-roccat-lua hid-roccat-ryos hid-roccat-savu hid-samsung hid-sensor-custom hid-sensor-hub hid-sjoy hid-steam hid-steelseries hid-sunplus hid-topseed hid-u2fzero hid-udraw-ps3 hid-viewsonic hid-vivaldi hid-xinmo hid_generic hinic hpsa hpt366 hptiop htc-pasic3 hv_netvsc hv_storvsc hv_vmbus hwmon_vid i2c-algo-bit i2c-algo-pca i2c-ali1535 i2c-ali1563 i2c-ali15x3 i2c-amd756 i2c-amd756-s4882 i2c-amd8111 i2c-cht-wc i2c-cros-ec-tunnel i2c-designware-pci i2c-diolan-u2c i2c-hid i2c-i801 i2c-isch i2c-ismt i2c-kempld i2c-nforce2 i2c-nforce2-s4985 i2c-ocores i2c-parport i2c-pca-platform i2c-piix4 i2c-robotfuzz-osif i2c-scmi i2c-simtec i2c-sis5595 i2c-sis630 i2c-sis96x i2c-smbus i2c-taos-evm i2c-tiny-usb i2c-via i2c-viapro i2c-viperboard i2c_algo_bit i2c_core i2c_hid i2c_hid_acpi i2c_i801 i2c_piix4 i2c_smbus i40e i915 iTCO_vendor_support iTCO_wdt iavf ib_cm ib_core ib_uverbs ice icp icplus ide-cd_mod ide-core ide-cs ide-gd_mod ide-generic ide-pci-generic ide-pnp ide-tape ide_cd_mod ide_core ide_gd_mod ide_pci_generic ide_platform idma64 ieee802154 igb igbvf igc industrialio initio input_leds intel-ish-ipc intel-ishtp intel-ishtp-hid intel-ishtp-loader intel-lpss intel-lpss-acpi intel-lpss-pci intel-m10-bmc intel-xway intel_agp intel_gtt intel_pmc_bxt intel_pmc_core intel_powerclamp intel_quark_i2c_gpio intel_rapl_common intel_rapl_msr intel_soc_pmic_bxtwc intel_soc_pmic_chtdc_ti intel_soc_pmic_mrfld iosf_mbi ip6_tables ip6_udp_tunnel ip6table_filter ip6table_mangle ip6table_nat ip_tables ipmi_devintf ipmi_msghandler ipr ips ipt_REJECT iptable_filter iptable_mangle iptable_nat ipv6 ipvlan ipvtap iqs62x iqs62x-keys irqbypass isci isl6271a-regulator isl9305 isofs isp116x-hcd isp1760 it8172 it8213 it821x iw_cm ixgb ixgbe ixgbevf janz-cmodio jbd2 jc42 jfs jme jmicron joydev kbic kempld-core ks8842 ks8851_common ks8851_par ks8851_spi ksz8795 ksz8795_spi ksz884x ksz9477 ksz9477_i2c ksz9477_spi ksz_common ktti kvdo kvm kvm_amd kvm_intel lan743x lan9303-core lan9303_i2c lan9303_mdio lantiq_gswip ledtrig_audio libaes libahci libarc4 libata libceph libchacha libchacha20poly1305 libcrc32c libcurve25519-generic libcurve25519_generic libcxgb libcxgbi libfc libfcoe libphy linear liquidio liquidio_vf lkkbd llc lm3533-core lm3533-ctrlbank lm363x-regulator lm8323 lm8333 lockd loop lp3943 lp3971 lp3972 lp872x lp873x lp8755 lpc_ich lpc_sch lpfc ltc3589 ltc3676 lxt mac802154 mac802154_hwsim macsec madera madera-i2c madera-spi marvell marvell10g matrix-keymap matrix_keypad max14577 max14577-regulator max1586 max3421-hcd max7359_keypad max77693 max77693-regulator max77826-regulator max8649 max8660 max8907 max8907-regulator max8952 mbcache mc13783-regulator mc13892-regulator mc13xxx-core mc13xxx-i2c mc13xxx-regulator-core mc13xxx-spi mcr20a mcs_touchkey md_mod mdio mdio-bcm-unimac mdio-bitbang mdio-cavium mdio-gpio mdio-i2c mdio-mscc-miim mdio-mvusb mdio-thunder mdio_devres megaraid megaraid_mbox megaraid_mm megaraid_sas mei mei_hdcp mei_me menf21bmc mhi micrel microchip microchip_t1 mii mlx4_core mlx4_en mlx4_ib mlx5_core mlx5_ib mlxfw mmc_block mmc_core mmc_hsq mmc_spi mousedev mp2629 mp8859 mpr121_touchkey mpt3sas mptbase mptfc mptsas mptscsih mptspi mrf24j40 mrp mscc mscc_ocelot_switch_lib mscc_seville msdos mt6311-regulator mt6323-regulator mt6358-regulator mt6360-core mt6360-regulator mt6397 mt6397-regulator mt7530 mtd mtip32xx mtk-pmic-keys mtk-sd multipath musb_hdrc mux-core mv88e6060 mv88e6xxx mvmdio mvsas mvumi myri10ge national natsemi nct6775 nct6775_core ne2k-pci net_failover netconsole netxen_nic newtonkbd nf_conntrack nf_conntrack_ftp nf_conntrack_irc nf_conntrack_netlink nf_conntrack_pptp nf_conntrack_sip nf_defrag_ipv4 nf_defrag_ipv6 nf_log_common nf_log_ipv4 nf_log_ipv6 nf_nat nf_reject_ipv4 nf_tables nfnetlink nfp nfs nfs_acl nfs_ssc nfsv2 nfsv3 nfsv4 nft_chain_nat nft_compat nft_counter nft_ct nft_masq niu nlmon nls_ascii nls_cp437 nls_iso8859_1 nls_utf8 nmclan_cs ns83820 ns87415 ntb ntb_netdev ntb_transport ntfs null_blk nvme nvme-loop nvme-rdma nvme_core nvmet nvmet-fc nvmet-rdma nvmet-tcp nxp-tja11xx ohci-hcd ohci-pci ohci-platform on20 on26 opencores-kbd opti621 overlay oxu210hp-hcd paride parport parport_pc pata_acpi pata_ali pata_amd pata_artop pata_atiixp pata_atp867x pata_cmd64x pata_efar pata_hpt366 pata_hpt37x pata_hpt3x2n pata_hpt3x3 pata_it8213 pata_it821x pata_jmicron pata_marvell pata_mpiix pata_netcell pata_ninja32 pata_ns87410 pata_ns87415 pata_oldpiix pata_pcmcia pata_pdc2027x pata_pdc202xx_old pata_piccolo pata_platform pata_rdc pata_rz1000 pata_sch pata_serverworks pata_sil680 pata_sis pata_triflex pata_via pca9450-regulator pcd pcf50633 pcf50633-regulator pci-hyperv pci-hyperv-intf pcmcia pcmcia_core pcnet32 pcnet_cs pcs-lynx pcs-xpcs pcspkr pd pdc202xx_new pdc202xx_old pdc_adma pf pfuze100-regulator pg phy-bcm-kona-usb2 phy-cpcap-usb phy-exynos-usb2 phy-generic phy-gpio-vbus-usb phy-intel-lgm-emmc phy-isp1301 phy-lgm-usb phy-pxa-28nm-hsic phy-pxa-28nm-usb2 phy-qcom-usb-hs phy-qcom-usb-hsic phy-tahvo phy-tusb1210 phylink piix pinctrl-emmitsburg pinctrl-jasperlake pinctrl-lynxpoint pinctrl-madera pinctrl-tigerlake pktcdvd plip pm80xx pmcraid poly1305-x86_64 poly1305_x86_64 ppdev ppp_async ppp_deflate ppp_generic ppp_mppe ppp_synctty pppoe pppox pptp psmouse pt pv88060-regulator pv88080-regulator pv88090-regulator pvpanic pwm-cros-ec pwm-regulator pwm_bl qca8k qcom-labibb-regulator qcom_spmi-regulator qcom_usb_vbus-regulator qed qede qedf qedi qemu_fw_cfg qla1280 qla2xxx qla3xxx qla4xxx qlcnic qlogic_cs qlogicfas408 qsemi qt1050 qt1070 qt2160 r6040 r8169 r8a66597-hcd raid0 raid1 raid10 raid456 raid6_pq ramoops rapidio rapl rave-sp rbd rdc321x-southbridge rdma_cm realtek realtek-smi reed_solomon regmap-spi regmap-spi-avmm regmap_i2c reiserfs retu-mfd rfkill rionet rmi_core rnbd-client rnbd-server rng_core rockchip roles rpi-panel-attiny-regulator rsxx rt4801-regulator rt5033 rt5033-regulator rtc-88pm80x rtc-ab-b5ze-s3 rtc-ab-eoz9 rtc-abx80x rtc-bq32k rtc-bq4802 rtc-da9063 rtc-ds1286 rtc-ds1302 rtc-ds1305 rtc-ds1307 rtc-ds1343 rtc-ds1347 rtc-ds1374 rtc-ds1390 rtc-ds1511 rtc-ds1553 rtc-ds1672 rtc-ds1685 rtc-ds1742 rtc-ds2404 rtc-ds3232 rtc-em3027 rtc-fm3130 rtc-ftrtc010 rtc-isl12022 rtc-isl1208 rtc-m41t80 rtc-m41t93 rtc-m41t94 rtc-m48t35 rtc-m48t59 rtc-m48t86 rtc-max6900 rtc-max6902 rtc-max6916 rtc-max8907 rtc-mc13xxx rtc-mcp795 rtc-msm6242 rtc-mt6397 rtc-pcf2123 rtc-pcf2127 rtc-pcf50633 rtc-pcf85063 rtc-pcf8523 rtc-pcf85363 rtc-pcf8563 rtc-pcf8583 rtc-r9701 rtc-rp5c01 rtc-rs5c348 rtc-rs5c372 rtc-rv3028 rtc-rv3029c2 rtc-rv3032 rtc-rv8803 rtc-rx4581 rtc-rx6110 rtc-rx8010 rtc-rx8025 rtc-rx8581 rtc-s35390a rtc-s5m rtc-sd3078 rtc-stk17ta8 rtc-v3020 rtc-wilco-ec rtc-x1205 rtmv20-regulator rtrs-client rtrs-core rtrs-server rtsx_pci rtsx_pci_sdmmc rtsx_usb rtsx_usb_sdmmc rz1000 s2io s2mpa01 s2mps11 s5m8767 samsung-keypad sata_mv sata_nv sata_promise sata_qstor sata_sil sata_sil24 sata_sis sata_svw sata_sx4 sata_uli sata_via sata_vsc sc92031 sch_fq_codel scsi_debug scsi_dh_alua scsi_dh_emc scsi_dh_hp_sw scsi_dh_rdac scsi_mod scsi_transport_spi sd_mod sdhci sdhci-acpi sdhci-pci sdhci-pltfm sdhci-xenon-driver sdhci_f_sdh30 sdio_uart sdricoh_cs sec-core sec-irq serio_raw serpent-avx-x86_64 serpent-avx2 serpent-sse2-x86_64 serpent_avx2 serpent_avx_x86_64 serpent_generic serpent_sse2_x86_64 serverworks ses sfc sfc-falcon sfp sg sha512-ssse3 sha512_ssse3 siimage simpledrm sis190 sis5513 sis900 sja1105 skd skfp skge sky2 sky81452 sky81452-regulator slc90e66 slg51000-regulator slhc slip sm501 smartpqi smc91c92_cs smsc smsc9420 snd snd-compress snd-intel-dspcfg snd-pcm snd-pcm-dmaengine snd-rawmidi snd-seq-device snd-soc-core snd-timer snd_compress snd_hda_codec snd_hda_codec_generic snd_hda_core snd_hda_intel snd_hwdep snd_intel_dspcfg snd_pcm snd_pcm_dmaengine snd_pcsp snd_soc_core snd_timer snic soundcore soundwire-intel soundwire_bus soundwire_cadence soundwire_generic_allocation soundwire_intel sparse-keymap spi-altera spi-amd spi-axi-spi-engine spi-bitbang spi-butterfly spi-cadence spi-dw spi-gpio spi-lantiq-ssc spi-lm70llp spi-loopback-test spi-mux spi-mxic spi-nxp-fspi spi-oc-tiny spi-pxa2xx-pci spi-pxa2xx-platform spi-rockchip spi-sc18is602 spi-sifive spi-tle62x0 spi-xcomm spi-xilinx spi-zynqmp-gqspi spi_ks8995 spl squashfs sr_mod ssb ssb-hcd st starfire ste10Xp stex stowaway stp sundance sungem sungem_phy sunhme sunkbd sunrpc sx8 sym53c500_cs sym53c8xx syscopyarea sysfillrect sysimgblt t10_pi tag_8021q tap target_core_mod tc86c001 tca6416-keypad tca8418_keypad tcm_qla2xxx tehuti teranetics tg3 thermal thunderbolt thunderbolt-net ti-lmu ti_am335x_tscadc tifm_core tifm_sd tlan tls tm2-touchkey toshsd tpm tpm_crb tpm_tis tpm_tis_core tps51632-regulator tps6105x tps6105x-regulator tps62360-regulator tps65010 tps65023-regulator tps6507x tps6507x-regulator tps65086 tps65086-regulator tps65132-regulator tps6524x-regulator tps65912-core tps65912-i2c tps65912-regulator tps65912-spi tqmx86 triflex trm290 trusted ttm tulip tun typhoon uPD60620 uas ucb1400_core udc-core udf udp_tunnel ufshcd-core ufshcd-pci uhci-hcd uhci_hcd uhid uio uli526x ulpi umem ums-alauda ums-cypress ums-datafab ums-eneub6250 ums-freecom ums-isd200 ums-jumpshot ums-karma ums-onetouch ums-realtek ums-sddr09 ums-sddr55 ums-usbat usb-common usb-storage usb_common usb_storage usbcore usbhid usbkbd usbmouse usdhi6rol0 userspace-consumer ushc veth vfat via-rhine via-sdmmc via-velocity via82cxxx video viperboard virtio virtio_balloon virtio_blk virtio_console virtio_dma_buf virtio_gpu virtio_mmio virtio_net virtio_pci virtio_pci_modern_dev virtio_ring virtio_rng virtual vitesse vitesse-vsc73xx-core vitesse-vsc73xx-platform vitesse-vsc73xx-spi vmd vmw_pvscsi vmw_vmci vmwgfx vmxnet3 vrf vub300 vx855 vxge vxlan wacom watchdog wbsd wd719x wilco_ec winbond-840 wireguard wl1273-core wm8994 wm8994-regulator wmi wmi-bmof wmi_bmof x86_pkg_temp_thermal x_tables xen-acpi-processor xen-blkback xen-evtchn xen-gntdev xen-netback xen-pciback xen_blkback xen_evtchn xen_gntdev xen_netback xen_netfront xen_pciback xen_privcmd xenfs xfrm_algo xfs xhci-hcd xhci-pci xhci-plat-hcd xhci_hcd xhci_pci xilinx_gmii2rgmii xirc2ps_cs xircom_cb xor xt_CHECKSUM xt_LOG xt_MASQUERADE xt_addrtype xt_comment xt_connmark xt_conntrack xt_helper xt_limit xt_nat xt_physdev xt_tcpudp xtkbd xts yellowfin zavl zcommon zfs zlua znvpair zram zsmalloc zstd_compress zunicode zzstd " && \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin && \
  set -x && \
  set -e && \
  umask 022 && \
  ulimit -d unlimited && \
  ulimit -v unlimited && \
  cd /root && \
  export LANG=C && \
  export TMP=/tmp && \
  export TEMP="${TMP}" && \
  export TMPDIR="${TMP}" && \
  export DEBIAN_FRONTEND=noninteractive && \
  export TERM=dumb && \
  export TTY=/dev/null && \
  export PYTHONDONTWRITEBYTECODE=1 && \
  export BUILD_IDENTIFIER="$(TZ=Universal date +%Y.%m.%d-%H.%M.%S-%N)" && \
  exec </dev/null && \
  for insistence in Suggests Recommends; do echo APT::Install-"${insistence}" '"0";' | tee -a /etc/apt/apt.conf.d/42disable; done && \
  (for src in "" "-src"; do for repo in "" "-updates" "-security" "-backports"; do echo deb"${src}" http://deb.devuan.org/merged chimaera"${repo}" main contrib non-free; done; done) > /etc/apt/sources.list && \
  apt-get update && \
  apt-get -y --verbose-versions dist-upgrade && \
  apt-get -y install --verbose-versions linux-image-amd64 efibootmgr tar cpio zstd findutils wget curl ca-certificates qemu-utils qemu-system-x86 xz-utils jq initramfs-tools-core amd64-microcode intel-microcode file binutils-x86-64-linux-gnu binutils dosfstools && \
  echo AMD64UCODE_INITRAMFS=early >> /etc/default/amd64-microcode && \
  echo IUCODE_TOOL_INITRAMFS=early >> /etc/default/intel-microcode && \
  echo IUCODE_TOOL_SCANCPUS=no >> /etc/default/intel-microcode && \
  wget http://http.us.debian.org/debian/pool/non-free-firmware/i/intel-microcode/intel-microcode_3.20230214.1_amd64.deb && \
  dpkg -i intel-microcode_3.20230214.1_amd64.deb && \
  rm -v intel-microcode_3.20230214.1_amd64.deb && \
  mkdir -v -p /opt/artifact/meta && \
  nerdctl_version="$(curl -sL https://api.github.com/repos/containerd/nerdctl/releases/latest | jq -r .tag_name | tr -d v)" && \
  wget https://github.com/containerd/nerdctl/releases/download/v"${nerdctl_version}"/nerdctl-full-"${nerdctl_version}"-linux-amd64.tar.gz && \
  gunzip -v -N nerdctl-full-"${nerdctl_version}"-linux-amd64.tar.gz && \
  zstd --verbose --verbose --threads=1 --single-thread --memory=256M --long=30 --keep --ultra -22 nerdctl-full-"${nerdctl_version}"-linux-amd64.tar && \
  rm -v nerdctl-full-"${nerdctl_version}"-linux-amd64.tar && \
  mv -v nerdctl-full-"${nerdctl_version}"-linux-amd64.tar.zst /opt/artifact/nerdctl-full-"${nerdctl_version}"-linux-amd64.gtar.zst && \
  wget https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-cli-426.0.0-linux-x86_64.tar.gz && \
  gunzip -v < google-cloud-cli-426.0.0-linux-x86_64.tar.gz | zstd -v -v -v --keep --threads=1 --single-thread --memory=256M --long=30 --ultra -22 > /opt/artifact/google-cloud-cli-426.0.0-linux-x86_64.tar.zst && \
  rm -v google-cloud-cli-426.0.0-linux-x86_64.tar.gz && \
  kver_debian="$(ls -1rd /lib/modules/5.10.0-[0-9][0-9]-amd64 | tail -n 1 | sed 's,.*/,,')" && \
  rm -v -f /boot/initrd.img-"${kver_debian}" && \
  update-initramfs -v -c -k "${kver_debian}" && \
  unmkinitramfs /boot/initrd.img-"${kver_debian}" /root/initramfs && \
  rm -v /boot/initrd.img-"${kver_debian}" && \
  mkdir -p -v /root/initramfs/cons/ && \
  for i in /root/initramfs/early*; do tar -C "$i"/./ -cf - kernel |tar -C /root/initramfs/cons/./ -xpf - || true; true; done && \
  (cd /root/initramfs/cons/ && rmdir -v -- $(find kernel -name .enuineIntel.align\* -type d -print) && find kernel -print0 |sort -z |cpio -0 -H newc --renumber-inodes -o > /root/initramfs-microcode.cpio) && \
  mkdir -p -v /root/microcode && \
  cp -p /root/initramfs/cons/kernel/x86/microcode/*.bin /root/microcode/ && \
  cp -p --verbose /root/initramfs-microcode.cpio /opt/artifact/meta/ && \
  cd /root/initramfs/main && \
  tar -c -v -v -f - init conf scripts etc > /root/initramfs-extra.gtar && \
  cd /root && \
  rm -r initramfs && \
  rm -r -f /lib/modules/"${kver_debian}"/ /root/initrd/lib/modules/"${kver_debian}"/ && \
  rm -v -f /boot/vmlinuz* /boot/initr* && \
  rm -v -f /boot/System.map-"${kver_debian}" /boot/config-"${kver_debian}" && \
  unset kver_debian && \
  cp -p -v /root/initrd/boot/vmlinu* /boot/ && \
  mv -v -f /root/initrd/root/dpkg-l /opt/artifact/meta/dpkg-l-base && \
  mv -v -f /root/dpkg-l-kicksecure /opt/artifact/meta/dpkg-l-kicksecure && \
  cd /root/initrd && \
  find usr/local/lib/python* -type f -name "*.gz" -exec gunzip -N -f -- \{\} \; && \
  ((for i in "127.0.0.1 localhost" "::1 localhost ip6-localhost ip6-loopback" "ff02::1 ip6-allnodes" "ff02::2 ip6-allrouters"; do echo $i; done) > ./etc/hosts || true) && \
  (echo '#!/bin/bash-static'; echo "set -x"; echo 'umask 02 && export LANG=C && modprobe zzstd && modprobe zram && ZRDEV="$(zramctl --find --size 768M -a zstd)" && mkfs.xfs -m rmapbt=1 -f -L ZRAM "${ZRDEV}" && mkdir -p /mnt/ZRAM && mount -v -t xfs -o nodev,noatime,noexec,nosuid,dirsync,loud "${ZRDEV}" /mnt/ZRAM && unset ZRDEV && mkdir -p /mnt/ZRAM/usr/share && for i in emacs doc man; do mv -f /usr/share/"${i}"/ /mnt/ZRAM/usr/share/"${i}" && mkdir -p /usr/share/"${i}"/ && sync && mount --bind /mnt/ZRAM/usr/share/"${i}" /usr/share/"${i}"; done && zramctl --output-all') >> ./usr/local/etc/boot.d/22compshare && \
  (echo '#!/bin/bash-static'; echo "set -x"; echo 'umask 02; export LANG=C; modprobe efivarfs || true; modprobe efi_pstore || true; if test -e /sys/firmware/efi/systab; then mount -v -t efivarfs none /sys/firmware/efi/efivars || true; fi; true') >> ./usr/local/etc/boot.d/24efi && \
  (echo '#!/bin/bash-static'; echo "set -x"; echo "set +e"; echo 'umask 002 && mkdir -p -v /run/iden.d/ /mnt/IDEN && lsblk -l -p | grep part | cut -f1 -d" " | while read part; do if blkid -s LABEL -s PARTLABEL -o value "${part}" |grep -q "^IDEN"; then fsck.ext4 -v -p "${part}" || true; mount -v -t ext4 -o debug,ro "${part}" /mnt/IDEN && tar -C /mnt/IDEN/IDEN -c -v -f - . | tar -C /run/iden.d/ -x -p -v --warning=no-timestamp -f - && umount -v /mnt/IDEN; fi; done && rmdir -v /mnt/IDEN && chmod -R --verbose go-rwx /run/iden.d/ && mkdir -p /run/iden && if test -e /run/iden.d/path; then mv -v /run/iden.d/path /run/iden/path; fi && rm -r -v /run/iden.d && chmod -R go+r /run/iden && touch /run/iden/path && true') >> ./usr/local/etc/boot.d/25iden && \
  chmod --verbose 700 ./usr/local/etc/boot.d/22compshare ./usr/local/etc/boot.d/24efi ./usr/local/etc/boot.d/25iden && \
  (chmod 0644 ./etc/hosts || true) && \
  chmod --verbose go-w ./etc/hostname && \
  tar -C /usr/lib/ -c -v -f - libhardened_malloc.so/ | tar -C ./usr/lib/ -x -p -k -v -v --warning=no-timestamp -f - && \
  sed -i -e "/DO_CABLETEST/s/DO_CABLETEST.*/DO_CABLETEST=no/" -e "/DO_ARPING/s/DO_ARPING.*/DO_ARPING=no/" etc/default/network-test && \
  echo SKIP sed -i -e "/T0:23:respawn:.sbin.getty -L ttyS0/s/^/#/" etc/inittab && \
  echo "T9:23:respawn:/sbin/getty --nohostname -L hvc0 115200 ansi" | tee -a etc/inittab && \
  sed -i -e "/^1:[2-5]*:respawn:.sbin.getty .* tty1$/s/ --noclear / --noclear --nohostname /" etc/inittab && \
  sed -i -e "/sbin.sulogin/s,^,#," etc/inittab && \
  (echo tty1; echo ttyS0; echo ttyUSB0; echo hvc0; echo xvc0; echo console) >> etc/securetty && \
  mkdir -p -v dev proc sys run && \
  chmod --verbose go+rx sys proc dev run . && \
  echo loop max_loop=256 > etc/modules && \
  : > etc/modules.inc && \
  echo ${module_list} |tr " " '\n'|sort |uniq >> etc/modules.inc && \
  unset module_list && \
  cat etc/modules.inc >> /etc/modules && \
  echo localhost > etc/hostname && \
  echo 0x00000000 > etc/hostid && \
  echo nameserver 1.1.1.1 > etc/resolv.conf && \
  find stand usr/local/sbin usr/local/bin usr/local/libexec -type f -exec file -- \{\} \; |grep ELF |grep "not stripped" |cut -f1 -d: | xargs -r strip && \
  rm -r -v /root/initrd/run/[a-z]* && \
  rm -f -v /root/initrd/run/.containerenv && \
  rm -vf /root/initrd/etc/.pwd.lock && \
  chmod --verbose go-w /root/initrd/etc/resolv.conf && \
  ls -lasi --full-time /root/initrd/dev/ && \
  mount && \
  chmod --verbose go-w /root/initrd/dev/. && \
  (cd ./var/cache/apt/archives && apt-get download grub-xen grub-xen-bin grub-xen-host grub-pc grub-pc-bin) && \
  cp -a /root/initrd /opt/artifact/layer && \
  rm -f -r /opt/artifact/layer/usr/local/etc/boot.d /opt/artifact/layer/etc/boot.d /opt/artifact/layer/etc/rc.local /opt/artifact/layer/boot /opt/artifact/layer/lib/modules && \
  mkdir -v -p /opt/artifact/layer/boot /opt/artifact/layer/lib/modules && \
  (cd /opt/artifact/layer && tar -c -f - . > ../Linux-Image-Devuan-4-RawLayer.gtar && cd .. && zstd -v -v -v --keep --threads=1 --single-thread --memory=256M --long=30 --ultra -22 Linux-Image-Devuan-4-RawLayer.gtar && rm -r layer && rm -v Linux-Image-Devuan-4-RawLayer.gtar) && \
  ( echo '#!/bin/bash-static' && \
    echo "set -x" && \
    echo "set +h" && \
    echo "set +e" && \
    echo "cd /" && \
    echo "exec </dev/null" && \
    echo "umask 022" && \
    echo "ulimit -v unlimited" && \
    echo "ulimit -d unlimited" && \
    echo "export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/stand:/usr/local/sbin:/usr/local/bin" && \
    echo "export LD_LIBRARY_PATH=/lib/x86_64-linux-gnu:/usr/lib/x86_64-linux-gnu:/opt/bootstrap/lib/x86_64-linux-gnu:/opt/bootstrap/lib" && \
    echo "mount -v -t proc proc /proc" && \
    echo "mount -v -t sysfs sysfs /sys" && \
    echo "mount -v -t devtmpfs devtmpfs /dev" && \
    echo "mount -v -t tmpfs tmpfs /run" && \
    echo "mkdir -v -p /run/tmp" && \
    echo "mount -v -t tmpfs tmpfs /run/tmp" && \
    echo "export TMP=/run/tmp" && \
    echo 'export TEMP="${TMP}"' && \
    echo 'export TMPDIR="${TMP}"' && \
    echo "chmod --verbose go-w /run/. /dev/. /." && \
    echo 'hostname $(cat /etc/hostname)' && \
    echo "mkdir -v -p /usr" && \
    echo "tar -C /opt/bootstrap/ -c -f - bin sbin lib | tar -C /usr/ -x -p -k --warning=no-timestamp -f -" && \
    echo "rm -r /opt/bootstrap/bin /opt/bootstrap/sbin /opt/bootstrap/lib" && \
    echo "unset LD_LIBRARY_PATH" && \
    echo '/sbin/modprobe loop max_loop=256' && \
    echo 'grep "^[^#]" /etc/modules | awk '\''{print $1}'\'' | xargs -n 1 /sbin/modprobe' && \
    echo "/etc/init.d/kmod start" && \
    echo "sleep 1" && \
    echo "sync" && \
    echo "/etc/init.d/eudev start" && \
    echo "sleep 1" && \
    echo "sync" && \
    echo "udevadm settle" && \
    echo "sleep 2" && \
    echo "udevadm trigger" && \
    echo "sync" && \
    echo "sleep 2" && \
    echo "/etc/init.d/eudev stop" && \
    echo "sync" && \
    echo "sleep 2" && \
    echo "mkdir /new" && \
    echo "mount -v -t tmpfs -o nosuid,nodev,sync,noatime,nodiratime,dirsync,loud,nouser,size=70% tmpfs /new" && \
    echo "chmod --verbose go-w /new/." && \
    echo 'lsblk -l -p | grep part | cut -f1 -d" " | while read part; do if blkid -s LABEL -s PARTLABEL -o value "${part}" |grep -q "^CACHE"; then d=$(basename "${part}"); /stand/e2fsck -p -v "${part}" || true; R="${RANDOM}"; mkdir -v -p /mnt/CACHE-"${d}"-"${R}"; mount -v -t ext4 -o debug,ro "${part}" /mnt/CACHE-"${d}"-"${R}"; fi; done' && \
    echo "umask 077" && \
    echo "mkdir -v -p /mnt/VOLATILE" && \
    echo 'dd if=/dev/zero of="${TMP}"/luks.header bs=1048576 count=0 seek=4' && \
    echo 'dd if=/dev/urandom bs=8192 count=1 2>/dev/null | /stand/sha512sum | /stand/awk '\''{print $1}'\'' > "${TMP}"/luks.pass' && \
    echo "/etc/init.d/eudev start" && \
    echo "sleep 2" && \
    echo 'VOLATILE=$( (lsblk -l -p | grep part | cut -f1 -d" " | while read part; do if blkid -s LABEL -s PARTLABEL -o value "${part}" | grep -q "^VOLATILE"; then echo "${part}"; fi; done) |head -n 1)' && \
    echo 'cryptsetup luksFormat --type=luks1 --batch-mode=yes --verbose --cipher=aes-xts-plain64 --hash=sha256 --key-size=512 --header="${TMP}"/luks.header --key-file="${TMP}"/luks.pass "${VOLATILE}"' && \
    echo "sleep 4" && \
    echo "sync" && \
    echo 'cryptsetup luksOpen --verbose --header="${TMP}"/luks.header --key-file="${TMP}"/luks.pass "${VOLATILE}" VOLATILE &' && \
    echo 'PID=$!' && \
    echo "sleep 10" && \
    echo "sync" && \
    echo "dmsetup udevcomplete_all --yes" && \
    echo "sleep 2" && \
    echo "dmsetup udevcomplete_all --yes" && \
    echo "sleep 1" && \
    echo "dmsetup udevcomplete_all --yes" && \
    echo "sleep 1" && \
    echo "sync" && \
    echo 'kill "${PID}" >/dev/null 2>/dev/null' && \
    echo "sleep 2" && \
    echo 'kill -9 "${PID}" >/dev/null 2>/dev/null' && \
    echo "unset PID" && \
    echo "udevadm settle" && \
    echo "sleep 1" && \
    echo "udevadm trigger" && \
    echo "sync" && \
    echo "/etc/init.d/eudev stop" && \
    echo 'mkfs.ext4 -e continue -j -F -F -L VOLATILE-"${RANDOM}" -m 8 -M /mnt/VOLATILE -v -F -F /dev/mapper/VOLATILE' && \
    echo "mount -v -t ext4 -o debug /dev/mapper/VOLATILE /mnt/VOLATILE" && \
    echo "mkdir /mnt/VOLATILE/tmp" && \
    echo 'rm -f "${TMP}"/luks.header "${TMP}"/luks.pass' && \
    echo "export TMP=/mnt/VOLATILE/tmp" && \
    echo 'export TEMP="${TMP}"' && \
    echo 'export TMPDIR="${TMP}"' && \
    echo '(set +e; for i in /mnt/CACHE-*/overlay/overlay*tar.zst; do zstd --decompress --verbose --verbose --threads=1 --single-thread --long=30 < "${i}" |tar -C / -x -p --warning=no-timestamp -f - || true; done; true)' && \
    echo "umask 022" && \
    echo "export TMP=/run/tmp" && \
    echo 'export TEMP="${TMP}"' && \
    echo 'export TMPDIR="${TMP}"' && \
    echo "umount -v /mnt/VOLATILE" && \
    echo "sleep 3" && \
    echo "/etc/init.d/eudev start" && \
    echo "cryptsetup luksClose VOLATILE &" && \
    echo 'PID=$!' && \
    echo "sync" && \
    echo "sleep 9" && \
    echo "sync" && \
    echo "dmsetup udevcomplete_all --yes" && \
    echo "sleep 4" && \
    echo "dmsetup udevcomplete_all --yes" && \
    echo "sleep 2" && \
    echo "dmsetup udevcomplete_all --yes" && \
    echo "sleep 1" && \
    echo "sync" && \
    echo 'kill "${PID}" >/dev/null 2>/dev/null' && \
    echo "sleep 1" && \
    echo 'kill -9 "${PID}" >/dev/null 2>/dev/null' && \
    echo "unset PID" && \
    echo "udevadm settle" && \
    echo "sleep 2" && \
    echo "udevadm trigger" && \
    echo "sync" && \
    echo "rmdir -v /mnt/VOLATILE" && \
    echo "unset VOLATILE" && \
    echo "/etc/init.d/eudev stop" && \
    echo 'lsblk -l -p | grep part | cut -f1 -d" " | while read part; do if blkid -s LABEL -s PARTLABEL -o value "${part}" |grep -q "^CACHE"; then umount -v "${part}"; fi; done' && \
    echo 'for i in /mnt/CACHE-*; do umount "${i}" >/dev/null 2>/dev/null || true; done' && \
    echo "rmdir -v /mnt/CACHE-*" && \
    echo "if test -d /opt/bootstrap/etc/boot.d; then run-parts /opt/bootstrap/etc/boot.d; rm -r /opt/bootstrap/etc; fi" && \
    echo "rmdir -v /opt/bootstrap" && \
    echo "mkdir -v -p /mnt/EFI" && \
    echo 'lsblk -l -p | grep part | cut -f1 -d" " | while read part; do if blkid -s LABEL -s PARTLABEL -o value "${part}" | grep -q "^EFI"; then mount -v -t vfat -o ro "${part}" /mnt/EFI; cp -p -v /mnt/EFI/xen/xen* /mnt/EFI/linux/System.map* /mnt/EFI/linux/config* /mnt/EFI/syslinux/memtest* /boot/; sync; sleep 1; umount -v /mnt/EFI; sync; fi; done' && \
    echo "rmdir -v /mnt/EFI" && \
    echo "mv -v /stand/mcm /stand/nzcc /stand/nz /stand/srep /usr/local/bin/" && \
    echo "mkdir -v -p /new/usr" && \
    echo "chmod --verbose 755 /new/usr" && \
    echo "cd /root" && \
    echo "mv /usr/local /new/usr/local" && \
    echo "mv /usr/share /new/usr/share" && \
    echo "mv /stand/env /stand/env-static" && \
    echo "mkdir -p -v /new/usr/lib/x86_64-linux-gnu" && \
    echo "(set +e; cd /usr/lib/x86_64-linux-gnu/; tar -c --remove-files -f - libgccjit.so* libicudata.so* libasan.so* libtsan.so* libc.a libpython3.9.so* libpthread.a | tar -C /new/usr/lib/x86_64-linux-gnu/ -x -p -f -; true) || true" && \
    echo "mkdir -p -v /new/lib" && \
    echo "tar -C /lib -c --remove-files -f - modules | tar -C /new/lib --warning=no-timestamp -x -p -f -" && \
    echo "cp -p /usr/bin/env /tmp/env" && \
    echo "mv /usr/bin /new/usr/bin" && \
    echo "mv /usr/sbin /new/usr/sbin" && \
    echo "tar -c --one-file-system -f - / | tar -C /new/ -x -p -k --warning=no-timestamp -f -" && \
    echo "rm -v /new/tmp/env" && \
    echo "mkdir /usr/bin" && \
    echo "mv -v /tmp/env /usr/bin/env" && \
    echo "echo /usr/lib/libhardened_malloc.so/libhardened_malloc.so >>/new/etc/ld.so.preload" && \
    echo "rmdir -v /new/new" && \
    echo "rm -v /new/init" && \
    echo "echo "\''#!/bin/bash-static'\'" > /new/init" && \
    echo "chmod --verbose u+rx /new/init" && \
    echo "chmod --verbose go-rwx /new/init" && \
    echo "echo set -x >>/new/init" && \
    echo "echo set +h >>/new/init" && \
    echo "echo umask 077 >>/new/init" && \
    echo "echo export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/stand:/usr/local/sbin:/usr/local/bin >>/new/init" && \
    echo 'echo "if test -e /dev/hvc0; then echo SKIP sed -i -e \"/getty.* ttyS0 /s,^,#,\" /etc/inittab; else echo SKIP sed -i -e \"/getty.* hvc0 /s,^,#,\" /etc/inittab; fi" >>/new/init' && \
    echo 'echo exec /usr/bin/env -i --debug PATH=/sbin:/bin:/usr/sbin:/usr/bin:/stand:/usr/local/sbin:/usr/local/bin SHELL=/bin/bash-static TERM=dumb TTY=/dev/console /sbin/init "$@" >>/new/init' && \
    echo "chmod --verbose go-rwx /sbin/init" && \
    echo "cd /" && \
    echo "umask 077" && \
    echo "unset TMP" && \
    echo "unset TEMP" && \
    echo "unset TMPDIR" && \
    echo "umount -v /run/tmp" && \
    echo 'exec /usr/bin/env -i --debug PATH=/sbin:/bin:/usr/sbin:/usr/bin:/stand:/usr/local/sbin:/usr/local/bin SHELL=/bin/bash-static /sbin/switch_root /new /init "$@"' \
  ) > init && \
  chmod --verbose u+rx init && \
  chmod --verbose go-rwx init && \
  mkdir -p -v opt/bootstrap/lib/x86_64-linux-gnu/ && \
  cd /root/initrd/usr/lib/x86_64-linux-gnu && \
  tar -c --remove-files -v -f - $(ls -1d libacl.so* libaio.so* libargon2.so* libattr.so* libblkid.so* libbsd.so* libcrypto.so* libedit.so* libfftw3.so* libgcrypt* libgmp.so* libhogweed.so* libjson-c.so* libkmod.so* liblz4.so* libmd.so* libmount.so* libmpfr.so* libnettle.so* libpcre2*so* libpopt.so* libsigsegv.so* libsmartcols.so* libsodium.so* libstdc++*.so* libsystemd.so* liburcu.so* libuuid.so* libzstd.so*) | tar -C /root/initrd/opt/bootstrap/lib/x86_64-linux-gnu/ -x -p -k -v -v --warning=no-timestamp -f - && \
  cd /root/initrd/usr/lib && \
  tar -c --remove-files -v -f - $(ls -1d libscrypt.so*) | tar -C /root/initrd/opt/bootstrap/lib/ -x -p -k -v -v --warning=no-timestamp -f - && \
  cd /root/initrd/usr && \
  tar -c --remove-files -v -f - bin/xargs bin/gawk sbin/pktsetup bin/zstd | tar -C /root/initrd/opt/bootstrap/ -x -p -k -v -v --warning=no-timestamp -f - && \
  cd /root/initrd && \
  kver=$(cd /root/initrd/lib/modules/ && ls -1dtr 5.10.*-hardened*-5.10 | tail -n 1) && \
  mkdir -v -p /root/overlay/lib/modules/"${kver}"/kernel && \
  mv lib/modules/5.10.*-hardened*-5.10uml*/ /root/overlay/lib/modules/ && \
  cd lib/modules/"${kver}"/kernel && \
  find . -type f -name '*.ko' -print > /root/modules && \
  cat /root/initrd/etc/modules.inc |tr _- .. | while read i; do grep "/${i}\.ko\$" /root/modules >> /root/modules. || true; done && \
  rm -v /root/initrd/etc/modules.inc && \
  cat /root/modules. |sort |uniq > /root/modules && \
  tar -c -f - --remove-files $(cat /root/modules) | tar -C /root/overlay/lib/modules/"${kver}"/kernel -x -p -k --warning=no-timestamp -f - && \
  rm -v /root/modules /root/modules. && \
  cd .. && \
  mv -v ./kernel/ ./kernel.overlay/ && \
  mv -v /root/overlay/lib/modules/"${kver}"/kernel/ ./kernel/ && \
  mv -v ./kernel.overlay/ /root/overlay/lib/modules/"${kver}"/kernel/ && \
  unset kver && \
  cd /root/initrd && \
  mv -v usr /root/overlay/usr && \
  mv -v var /root/overlay/var && \
  mkdir -v -p /root/overlay/var/tmp && \
  chmod --verbose 1777 /root/overlay/var/tmp && \
  mkdir -p -v usr var && \
  chmod --verbose 755 usr var && \
  mkdir -p -v var/tmp/ && \
  chmod 1777 var/tmp/ && \
  mv -v /root/initrd/boot/ /root/boot/ && \
  mkdir -p -v /root/initrd/boot/ && \
  chmod --verbose 755 /root/initrd/boot/ && \
  mv -v /root/05entropy /root/overlay/usr/local/etc/boot.d/05entropy && \
  chmod --verbose 700 /root/overlay/usr/local/etc/boot.d/05entropy && \
  chown --verbose root:root /root/overlay/usr/local/etc/boot.d/05entropy && \
  chmod --verbose +t ./tmp ./tmp/. && \
  find . -print0 | sort -z | cpio -0 -H newc --renumber-inodes -o |xz -1 -v -C crc32 > /boot/initrd.img && \
  rmdir -v /root/initrd/boot/ && \
  mv -v /root/boot/ /root/initrd/boot/ && \
  ulimit -d unlimited && ulimit -v unlimited && \
  mkdir -p -v /root/drive/mnt/CACHE/overlay /root/drive/mnt/CACHE/lists /root/drive/mnt/EFI/linux /root/drive/root/ && \
  mv -v /root/initramfs-microcode.cpio /root/microcode/ /root/drive/root/ && \
  (cd /root/drive/root/ && wget https://downloads.sourceforge.net/project/supergrub2/2.06s2-beta1/super_grub2_disk_2.06s2-beta1/supergrub2-classic-2.06s2-beta1-multiarch-CD.iso) && \
  (cd /root/drive/root && wget https://github.com/Intensity/FreeBSD-12-bin/raw/main/mfsbsd-mini-12.3-STABLE-amd64.iso.gz && gunzip -N -v mfsbsd-mini-12.3-STABLE-amd64.iso.gz) && \
  (cd /root/drive/root && wget https://github.com/Intensity/FreeBSD-12-bin/raw/main/mfsbsd-mini-12.3-STABLE-amd64.bsdtar.zst) && \
  mkdir -v -p /root/overlay/usr/local/etc/initramfs-stock.d && \
  cat /root/initramfs-extra.gtar |tar -C /root/overlay/usr/local/etc/initramfs-stock.d -x -p -v -v -f - && \
  rm -v /root/initramfs-extra.gtar && \
  tar -C /root/overlay -cf - usr var lib > /root/drive/mnt/CACHE/overlay/overlay.gtar && \
  (cd /root/drive/mnt/CACHE/overlay/ && zstd --verbose --verbose --threads=1 --single-thread --memory=256M --long=30 --keep --ultra -22 overlay.gtar && rm -v overlay.gtar) && \
  ls -ldsi --full-time /root/drive/mnt/CACHE/overlay/overlay.gtar.zst && \
  rm -r -v /root/overlay/usr/local/etc/boot.d/ && \
  rmdir -v var/tmp && \
  rmdir -v usr var && \
  mv -v /root/overlay/usr /root/overlay/var . && \
  tar -C /root/overlay/lib/ -c -v -f - modules/ | tar -C /root/initrd/lib/ -x -p -k --warning=no-timestamp -f - && \
  rm -r /root/overlay/lib && \
  rmdir -v /root/overlay && \
  tar -C /root/initrd/opt/bootstrap/ -c --remove-files -v -f - bin sbin lib | tar -C usr/ -x -p -v -v --warning=no-timestamp -f - && \
  rmdir -v /root/initrd/opt/bootstrap && \
  cp -pv /boot/initrd.img /root/drive/mnt/EFI/linux/ && \
  tar -C /root/drive -c -f - --remove-files mnt root |gzip -1 -v --synchronous --rsyncable >/root/drive.tar.gz && \
  rm -r /root/drive && \
  mv -v sbin/init sbin/init.orig && \
  rm -v init && \
  rm -rf usr/share/doc usr/share/man usr/lib/cni usr/lib/git-core var/lib/apt/lists usr/share/zsh/functions usr/bin/podman usr/bin/git-lfs usr/bin/containers-storage usr/local/sbin usr/local/bin usr/local/lib* && \
  echo '#!/bin/bash-static' > init && \
  echo 'set -x' >> init && \
  echo 'set +h' >> init && \
  echo 'set -e' >> init && \
  echo 'export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/stand:/usr/local/sbin:/usr/local/bin' >> init && \
  echo 'umask 02' >> init && \
  echo 'cd /root' >> init && \
  echo 'mount -v -t proc proc /proc' >> init && \
  echo 'mount -v -t sysfs sysfs /sys' >> init && \
  echo 'mount -v -t devtmpfs devtmpfs /dev' >> init && \
  echo '/sbin/modprobe loop max_loop=256' >> init && \
  echo '(set +e; grep "^[^#]" /etc/modules | awk '\''{print $1}'\'' | xargs -n 1 /sbin/modprobe || true; true) || true' >> init && \
  echo '/etc/init.d/kmod start' >> init && \
  echo '/etc/init.d/eudev start' >> init && \
  echo 'udevadm settle' >> init && \
  echo 'udevadm trigger' >> init && \
  echo 'lsblk' >> init && \
  echo 'sync' >> init && \
  echo '(for i in \
      n 1 "" +768m EF00 \
      n 2 "" +32m EF02 \
      n 3 "" +32m 8301 \
      n 4 "" +32m 8301 \
      n 5 "" +32m 8301 \
      n 6 "" +5g 8301 \
      n 7 "" +4g 8301 \
      n 8 "" +3g 8301 \
      n 9 "" +42g 8309 \
      c 1 EFI \
      c 2 BIOSGRUB \
      c 3 IDEN \
      c 4 CONF \
      c 5 ENTROPY \
      c 6 CACHE \
      c 7 VOLATILE \
      c 8 LOG \
      c 9 DATA \
      x a 1 2 "" \
      p w y; \
    do echo "$i"; done) | gdisk /dev/hda' >> init && \
  echo '(for i in n 1 "" +32m 8301 n 2 "" "" 8301 c 2 STAGING c 1 NOOP p w y; do echo "$i"; done) | gdisk /dev/hdc' >> init && \
  echo 'sync' >> init && \
  echo 'sleep 2' >> init && \
  echo 'for i in "-s" "-d" ""; do partprobe ${i}; sleep 1; sync; done' >> init && \
  echo 'udevadm settle' >> init && \
  echo 'udevadm trigger' >> init && \
  echo 'sleep 1' >> init && \
  echo 'sync' >> init && \
  echo '/etc/init.d/eudev stop' >> init && \
  echo 'sleep 1' >> init && \
  echo 'sync' >> init && \
  echo '/etc/init.d/eudev start' >> init && \
  echo 'sync' >> init && \
  echo 'udevadm settle' >> init && \
  echo 'udevadm trigger' >> init && \
  echo 'sync' >> init && \
  echo 'sleep 1' >> init && \
  echo 'sleep 1' >> init && \
  echo 'mkdir -v /mnt/CONF /mnt/IDEN /mnt/LOG /mnt/STAGING' >> init && \
  echo 'for partname in IDEN CONF CACHE STAGING; do lsblk -l -p |grep part |cut -f1 -d" " | while read part; do if blkid -s LABEL -s PARTLABEL -o value "${part}" |grep -q "^${partname}"; then mkfs.ext4 -e continue -j -F -F -L "${partname}" -m 8 -M /mnt/"${partname}" -v "${part}" && mount -v -t ext4 -o debug "${part}" /mnt/"${partname}" && mkdir -v -p /mnt/"${partname}"/"${partname}" && umount /mnt/"${partname}"; fi; done; done' >> init && \
  echo 'lsblk -l -p |grep part |cut -f1 -d" " | while read part; do if blkid -s LABEL -s PARTLABEL -o value "${part}" |grep -q "^LOG"; then mkfs.ext4 -e continue -j -F -F -L "LOG" -m 8 -M /mnt/LOG -v "${part}" && mount -v -t ext4 -o debug "${part}" /mnt/LOG && mkdir -v -p /mnt/LOG/LOG && chmod --verbose 3775 /mnt/LOG/LOG && chattr -V +a /mnt/LOG/LOG && chattr -V +a /mnt/LOG && umount -v /mnt/LOG; fi; done' >> init && \
  echo 'EFI=$( (lsblk -l -p | grep part | cut -f1 -d" " | while read part; do if blkid -s LABEL -s PARTLABEL -o value "${part}" | grep -q "^EFI"; then echo "${part}"; fi; done) |head -n 1)' >> init && \
  echo 'mkfs.fat -F 32 -n EFI -I -v "${EFI}"' >> init && \
  echo 'mkdir -v /mnt/EFI' >> init && \
  echo 'mount -v -t vfat "${EFI}" /mnt/EFI' >> init && \
  echo 'mkdir -v /mnt/EFI/syslinux /mnt/EFI/intel-ucode /mnt/EFI/amd-ucode' >> init && \
  echo 'umount -v /mnt/EFI' >> init && \
  echo 'syslinux --install --stupid --raid --force --directory /syslinux "${EFI}"' >> init && \
  echo 'sync' >> init && \
  echo 'mount -v -t vfat "${EFI}" /mnt/EFI' >> init && \
  echo 'ls -la /mnt/EFI/syslinux' >> init && \
  echo 'umount -v /mnt/EFI' >> init && \
  echo 'sync' >> init && \
  echo 'dd if=/usr/lib/syslinux/mbr/gptmbr.bin of=/dev/hda bs=440 count=1 conv=notrunc' >> init && \
  echo 'sync' >> init && \
  echo 'sleep 1' >> init && \
  echo 'sync' >> init && \
  echo 'udevadm settle' >> init && \
  echo 'udevadm trigger' >> init && \
  echo 'sleep 1' >> init && \
  echo 'sync' >> init && \
  echo '/etc/init.d/eudev stop' >> init && \
  echo 'sleep 1' >> init && \
  echo 'sync' >> init && \
  echo '/etc/init.d/eudev start' >> init && \
  echo 'sync' >> init && \
  echo 'udevadm settle' >> init && \
  echo 'udevadm trigger' >> init && \
  echo 'sync' >> init && \
  echo 'sleep 1' >> init && \
  echo 'mount -v -t vfat "${EFI}" /mnt/EFI' >> init && \
  echo "unset EFI" >> init && \
  echo 'cp -nav /usr/lib/syslinux/modules/bios/* /mnt/EFI/syslinux/' >> init && \
  echo 'ls -la /mnt/EFI/syslinux/ldlinux.c32' >> init && \
  echo 'blkid -s PTTYPE -o value /dev/hda' >> init && \
  echo 'ls -la /boot' >> init && \
  echo 'mkdir -v -p /mnt/EFI/xen /mnt/EFI/linux' >> init && \
  echo 'mkdir -v /mnt/CACHE' >> init && \
  echo 'CACHE=$( (lsblk -l -p | grep part | cut -f1 -d" " | while read part; do if blkid -s LABEL -s PARTLABEL -o value "${part}" | grep -q "^CACHE"; then echo "${part}"; fi; done) |head -n 1)' >> init && \
  echo 'mount -v -t ext4 -o debug "${CACHE}" /mnt/CACHE' >> init && \
  echo 'unset CACHE' >> init && \
  echo 'mkdir -v /mnt/CACHE/overlay /mnt/CACHE/CACHE' >> init && \
  echo 'STAGING=$( (lsblk -l -p | grep part | cut -f1 -d" " | while read part; do if blkid -s LABEL -s PARTLABEL -o value "${part}" | grep -q "^STAGING"; then echo "${part}"; fi; done) |head -n 1)' >> init && \
  echo 'mount -v -t ext4 -o debug "${STAGING}" /mnt/STAGING' >> init && \
  echo 'unset STAGING' >> init && \
  echo 'gunzip -v < /dev/hdb | tar -C /mnt/STAGING/ -x -p -v -v --warning=no-timestamp -f -' >> init && \
  echo 'mkdir -p /mnt/STAGING/mnt/EFI/intel-ucode /mnt/STAGING/mnt/EFI/amd-ucode' >> init && \
  echo 'cd /mnt/STAGING/mnt/EFI/linux' >> init && \
  echo 'mkdir dir' >> init && \
  echo 'cd dir' >> init && \
  echo 'cat ../initrd.img |xz -d -v -v | cpio -imd' >> init && \
  echo 'mkdir --verbose /mnt/dev' >> init && \
  echo 'mount -v -t devtmpfs devtmpfs /mnt/dev' >> init && \
  echo 'tar -C /mnt/ -cf - dev | tar xpf -' >> init && \
  echo 'rm -r -f dev/disk/' >> init && \
  echo 'umount -v /mnt/dev' >> init && \
  echo 'find . -print0 | sort -z | cpio -0 -H newc --renumber-inodes -o | xz --compress --stdout --check=crc32 -9 --extreme --threads=1 --verbose --verbose > ../initrd.img-post' >> init && \
  echo 'mkdir -v -p /mnt/STAGING/mnt/EFI/FreeBSD/ /mnt/STAGING/mnt/EFI/syslinux/' >> init && \
  echo 'mv -v /mnt/STAGING/root/mfsbsd-mini-12.3-STABLE-amd64.iso /mnt/STAGING/mnt/EFI/FreeBSD/FreeBSD-12.3-STABLE-amd64-MFS.iso' >> init && \
  echo 'mv -v /mnt/STAGING/root/mfsbsd-mini-12.3-STABLE-amd64.bsdtar.zst /mnt/STAGING/mnt/EFI/FreeBSD/FreeBSD-12.3-STABLE-amd64-MFS.bsdtar.zst' >> init && \
  echo 'mv -v /mnt/STAGING/root/supergrub2-classic-2.06s2-beta1-multiarch-CD.iso /mnt/STAGING/mnt/EFI/syslinux/' >> init && \
  echo 'mv -v ../initrd.img-post ../initrd.img' >> init && \
  echo 'mv -v /mnt/STAGING/root/initramfs-microcode.cpio ../microcode.cpio' >> init && \
  echo 'cp -p -v ../microcode.cpio ../early_ucode.cpio' >> init && \
  echo 'cp -p -v ../microcode.cpio ../..' >> init && \
  echo 'cp -p -v ../early_ucode.cpio ../..' >> init && \
  echo 'if test -f /mnt/STAGING/root/microcode/GenuineIntel.bin; then mv -v /mnt/STAGING/root/microcode/GenuineIntel.bin /mnt/STAGING/mnt/EFI/intel-ucode/; fi' >> init && \
  echo 'if test -f /mnt/STAGING/root/microcode/AuthenticAMD.bin; then mv -v /mnt/STAGING/root/microcode/AuthenticAMD.bin /mnt/STAGING/mnt/EFI/amd-ucode/; fi' >> init && \
  echo 'rm -r -f /mnt/STAGING/root/microcode/' >> init && \
  echo 'cd ..' >> init && \
  echo 'rm -r -f -v /mnt/STAGING/root' >> init && \
  echo 'rm -r dir' >> init && \
  echo 'cd /root' >> init && \
  echo 'tar -C /mnt/STAGING/ -c -f - . | tar -C / -x -p -v -v --warning=no-timestamp -f -' >> init && \
  echo 'umount -v /mnt/STAGING' >> init && \
  echo 'ls -ladsi --full-time /mnt/EFI/linux/initrd* /mnt/CACHE/overlay/overlay*tar*' >> init && \
  echo 'mkdir -v -p /mnt/EFI/metadata' >> init && \
  echo '(cd /mnt/EFI/linux/; for i in initrd*; do stat -L -c%s -- "$i" > ../metadata/"$i".isize; done)' >> init && \
  echo "echo ${BUILD_IDENTIFIER} >> /mnt/EFI/metadata/origin" >> init && \
  echo 'umount -v /mnt/CACHE' >> init && \
  echo 'cp -p -v /boot/xen* /mnt/EFI/xen/' >> init && \
  echo 'cp -p -v /boot/System.map* /boot/config* /mnt/EFI/linux/' >> init && \
  echo 'cp -p -v /boot/vmlinuz-* /mnt/EFI/linux/vmlinuz' >> init && \
  echo 'mv -v /boot/memtest86.bin /boot/memtest86' >> init && \
  echo 'mv -v /boot/memtest86+.bin /boot/memtest86+' >> init && \
  echo 'cp -p -v /boot/memtest* /mnt/EFI/syslinux/' >> init && \
  echo 'sync' >> init && \
  echo 'cd /tmp' >> init && \
  echo 'for i in "SERIAL 0 115200" "NOHALT 1" "DEFAULT menu.c32" "PROMPT 0" "MENU TITLE Xen/Linux" "MENU AUTOBOOT Boot in #" "TIMEOUT 100" "LABEL xen-linux-0"; do echo "$i" >> syslinux.cfg; done' >> init && \
  echo 'echo "  MENU LABEL Xen/Linux serial - USB disabled" >> syslinux.cfg' >> init && \
  echo 'echo "  COM32 mboot.c32" >> syslinux.cfg' >> init && \
  echo 'echo "  APPEND /xen/xen-amd64.gz ucode=scan bootscrub=1 com1=115200,8n1 console=com1,vga console_timestamps=datems dom0=verbose=1 dom0_max_vcpus=1 dom0_mem=5G,max:6G guest_loglvl=all loglvl=all noreboot scrub-domheap vga=current apic_verbosity=debug console_to_ring=true no-real-mode=1 conring_size=64k console_to_ring=1 --- /linux/vmlinuz init=/init root=tmpfs rootfstype=tmpfs nomodeset serial console=ttyS0,115200 console=tty0 console=xvc0,115200 console=hvc0,115200 biosdevname=0 earlyprintk=xen,keep gpt net.ifnames=0 panic=0 printk.time=1 cgroup_enable=cpuset,memory cgroup_memory=1 cgroup_cpuset=1 swapaccount=1 extra_latent_entropy random.trust_cpu=off iommu=soft rng_core.default_quality=256 concurrency=none debug apic=verbose apm=off bochs_drm.fbdev=off consoleblank=0 cpuidle.off=1 elevator=noop no_timer_check nofb nohibernate noresume nosoftlockup nowatchdog numa=off rfkill.default_state=0 rfkill.master_switch_mode=0 video=efifb:off,vesafb:off efi=disable_early_pci_dma l1tf=full,force mce=0 mds=full,nosmt no_timer_check nosmt=force pti=on slab_nomerge slub_debug=FZP spec_store_bypass_disable=on spectre_v2=on tsx=off tsx_async_abort=full,nosmt lockdown=confidentiality vsyscall=none kpti=on nopcid usbcore.nousb eagerfpu=on -- --- /linux/initrd.img --- /linux/microcode.cpio" >> syslinux.cfg' >> init && \
  echo 'echo >> syslinux.cfg' >> init && \
  echo 'echo "LABEL xen-linux-1" >> syslinux.cfg' >> init && \
  echo 'echo "  MENU LABEL Xen/Linux display" >> syslinux.cfg' >> init && \
  echo 'echo "  COM32 mboot.c32" >> syslinux.cfg' >> init && \
  echo 'echo "  APPEND /xen/xen-amd64.gz ucode=scan bootscrub=1 com1=115200,8n1 console=com1,vga console_timestamps=datems dom0=verbose=1 dom0_max_vcpus=1 dom0_mem=5G,max:6G guest_loglvl=all loglvl=all noreboot scrub-domheap vga=current apic_verbosity=debug console_to_ring=true no-real-mode=1 conring_size=64k console_to_ring=1 --- /linux/vmlinuz init=/init root=tmpfs rootfstype=tmpfs nomodeset console=ttyUSB0,115200 console=ttyS0,115200 console=xvc0,115200 console=hvc0,115200 console=tty0 biosdevname=0 earlyprintk=xen,keep gpt net.ifnames=0 panic=0 printk.time=1 cgroup_enable=cpuset,memory cgroup_memory=1 cgroup_cpuset=1 swapaccount=1 extra_latent_entropy random.trust_cpu=off iommu=soft rng_core.default_quality=256 concurrency=none debug apic=verbose apm=off bochs_drm.fbdev=off consoleblank=0 cpuidle.off=1 elevator=noop no_timer_check nofb nohibernate noresume nosoftlockup nowatchdog numa=off rfkill.default_state=0 rfkill.master_switch_mode=0 video=vesafb:off efi=disable_early_pci_dma l1tf=full,force mce=0 mds=full,nosmt no_timer_check nosmt=force pti=on slab_nomerge slub_debug=FZP spec_store_bypass_disable=on spectre_v2=on tsx=off tsx_async_abort=full,nosmt vsyscall=none kpti=on nopcid lockdown=confidentiality eagerfpu=on -- --- /linux/initrd.img --- /linux/microcode.cpio" >> syslinux.cfg' >> init && \
  echo 'echo >> syslinux.cfg' >> init && \
  echo 'echo "LABEL linux-0" >> syslinux.cfg' >> init && \
  echo 'echo "  MENU LABEL Linux serial - USB disabled" >> syslinux.cfg' >> init && \
  echo 'echo "  LINUX /linux/vmlinuz" >> syslinux.cfg' >> init && \
  echo 'echo "  APPEND init=/init root=tmpfs rootfstype=tmpfs early_microcode nomodeset serial console=tty0 console=xvc0,115200 console=hvc0,115200 console=ttyS0,115200 biosdevname=0 earlyprintk=serial,keep gpt net.ifnames=0 panic=0 printk.time=1 cgroup_enable=cpuset,memory cgroup_memory=1 cgroup_cpuset=1 swapaccount=1 extra_latent_entropy random.trust_cpu=off iommu=soft rng_core.default_quality=256 concurrency=none debug apic=verbose apm=off bochs_drm.fbdev=off consoleblank=0 cpuidle.off=1 elevator=noop no_timer_check nofb nohibernate noresume nosoftlockup nowatchdog numa=off rfkill.default_state=0 rfkill.master_switch_mode=0 video=vesafb:off efi=disable_early_pci_dma l1tf=full,force mce=0 mds=full,nosmt no_timer_check nosmt=force pti=on slab_nomerge slub_debug=FZP spec_store_bypass_disable=on spectre_v2=on tsx=off tsx_async_abort=full,nosmt vsyscall=none kpti=on nopcid usbcore.nousb lockdown=confidentiality eagerfpu=on --" >> syslinux.cfg' >> init && \
  echo 'echo "  INITRD /linux/microcode.cpio,/linux/initrd.img" >> syslinux.cfg' >> init && \
  echo 'echo >> syslinux.cfg' >> init && \
  echo 'echo "LABEL linux-1" >> syslinux.cfg' >> init && \
  echo 'echo "  MENU LABEL Linux display" >> syslinux.cfg' >> init && \
  echo 'echo "  LINUX /linux/vmlinuz" >> syslinux.cfg' >> init && \
  echo 'echo "  APPEND init=/init root=tmpfs rootfstype=tmpfs early_microcode nomodeset console=ttyUSB0,115200 console=ttyS0,115200 console=xvc0,115200 console=hvc0,115200 console=tty0 biosdevname=0 earlyprintk=vga,keep gpt net.ifnames=0 panic=0 printk.time=1 cgroup_enable=cpuset,memory cgroup_memory=1 cgroup_cpuset=1 swapaccount=1 extra_latent_entropy random.trust_cpu=off iommu=soft rng_core.default_quality=256 concurrency=none debug apic=verbose apm=off bochs_drm.fbdev=off consoleblank=0 cpuidle.off=1 elevator=noop no_timer_check nofb nohibernate noresume nosoftlockup nowatchdog numa=off rfkill.default_state=0 rfkill.master_switch_mode=0 video=vesafb:off efi=disable_early_pci_dma l1tf=full,force mce=0 mds=full,nosmt no_timer_check nosmt=force pti=on slab_nomerge slub_debug=FZP spec_store_bypass_disable=on spectre_v2=on tsx=off tsx_async_abort=full,nosmt vsyscall=none kpti=on nopcid lockdown=confidentiality eagerfpu=on simplefb --" >> syslinux.cfg' >> init && \
  echo 'echo "  INITRD /linux/microcode.cpio,/linux/initrd.img" >> syslinux.cfg' >> init && \
  echo 'echo >> syslinux.cfg' >> init && \
  echo 'echo "LABEL linux-2" >> syslinux.cfg' >> init && \
  echo 'echo "  MENU LABEL Linux display failsafe" >> syslinux.cfg' >> init && \
  echo 'echo "  LINUX /linux/vmlinuz" >> syslinux.cfg' >> init && \
  echo 'echo "  APPEND init=/init root=tmpfs rootfstype=tmpfs console=ttyUSB0,115200 console=ttyS0,115200 console=xvc0,115200 console=hvc0,115200 console=tty0 biosdevname=0 earlyprintk=vga,keep gpt logo.nologo loop.max_loop=256 net.ifnames=0 panic=0 printk.time=1 cgroup_enable=cpuset,memory cgroup_memory=1 cgroup_cpuset=1 swapaccount=1 extra_latent_entropy concurrency=none debug apic=verbose consoleblank=0 nohibernate noresume nosoftlockup nosplash nowatchdog efi=no_disable_early_pci_dma no_timer_check splash=off waitusb=3 --" >> syslinux.cfg' >> init && \
  echo 'echo "  INITRD /linux/initrd.img" >> syslinux.cfg' >> init && \
  echo 'echo >> syslinux.cfg' >> init && \
  echo 'echo "LABEL SuperGrubDisk" >> syslinux.cfg' >> init && \
  echo 'echo "  MENU LABEL SuperGrubDisk" >> syslinux.cfg' >> init && \
  echo 'echo "  LINUX /syslinux/memdisk" >> syslinux.cfg' >> init && \
  echo 'echo "  INITRD /syslinux/supergrub2-classic-2.06s2-beta1-multiarch-CD.iso" >> syslinux.cfg' >> init && \
  echo 'echo "  APPEND iso" >> syslinux.cfg' >> init && \
  echo 'echo >> syslinux.cfg' >> init && \
  echo 'echo "LABEL FreeBSD 12 mfsbsd" >> syslinux.cfg' >> init && \
  echo 'echo "  MENU LABEL FreeBSD 12 mfsbsd" >> syslinux.cfg' >> init && \
  echo 'echo "  LINUX /syslinux/memdisk" >> syslinux.cfg' >> init && \
  echo 'echo "  INITRD /FreeBSD/FreeBSD-12.3-STABLE-amd64-MFS.iso" >> syslinux.cfg' >> init && \
  echo 'echo "  APPEND iso" >> syslinux.cfg' >> init && \
  echo 'echo >> syslinux.cfg' >> init && \
  echo 'echo "LABEL Memtest86" >> syslinux.cfg' >> init && \
  echo 'echo "  MENU LABEL Memtest86" >> syslinux.cfg' >> init && \
  echo 'echo "  LINUX /syslinux/memtest86" >> syslinux.cfg' >> init && \
  echo 'echo >> syslinux.cfg' >> init && \
  echo 'echo "LABEL Memtest86+" >> syslinux.cfg' >> init && \
  echo 'echo "  MENU LABEL Memtest86+" >> syslinux.cfg' >> init && \
  echo 'echo "  LINUX /syslinux/memtest86+" >> syslinux.cfg' >> init && \
  echo 'echo >> syslinux.cfg' >> init && \
  echo 'echo "LABEL Hardware detection" >> syslinux.cfg' >> init && \
  echo 'echo "  MENU LABEL Hardware detection" >> syslinux.cfg' >> init && \
  echo 'echo "  COM32 hdt.c32" >> syslinux.cfg' >> init && \
  echo 'echo >> syslinux.cfg' >> init && \
  echo 'echo "LABEL Memory information" >> syslinux.cfg' >> init && \
  echo 'echo "  MENU LABEL Memory information" >> syslinux.cfg' >> init && \
  echo 'echo "  COM32 meminfo.c32" >> syslinux.cfg' >> init && \
  echo 'echo >> syslinux.cfg' >> init && \
  echo 'echo "LABEL Read-only shell" >> syslinux.cfg' >> init && \
  echo 'echo "  MENU LABEL Read-only shell" >> syslinux.cfg' >> init && \
  echo 'echo "  COM32 rosh.c32" >> syslinux.cfg' >> init && \
  echo 'echo >> syslinux.cfg' >> init && \
  echo 'echo "LABEL Boot current drive" >> syslinux.cfg' >> init && \
  echo 'echo "  MENU LABEL Boot current drive" >> syslinux.cfg' >> init && \
  echo 'echo "  COM32 chain.c32" >> syslinux.cfg' >> init && \
  echo 'echo "  APPEND boot" >> syslinux.cfg' >> init && \
  echo 'echo >> syslinux.cfg' >> init && \
  echo 'echo "LABEL Boot current filesystem" >> syslinux.cfg' >> init && \
  echo 'echo "  MENU LABEL Boot current filesystem" >> syslinux.cfg' >> init && \
  echo 'echo "  COM32 chain.c32" >> syslinux.cfg' >> init && \
  echo 'echo "  APPEND fs" >> syslinux.cfg' >> init && \
  echo 'echo >> syslinux.cfg' >> init && \
  echo 'echo "LABEL Boot first drive" >> syslinux.cfg' >> init && \
  echo 'echo "  MENU LABEL Boot first drive" >> syslinux.cfg' >> init && \
  echo 'echo "  COM32 chain.c32" >> syslinux.cfg' >> init && \
  echo 'echo "  APPEND hd0" >> syslinux.cfg' >> init && \
  echo 'echo >> syslinux.cfg' >> init && \
  echo 'echo "LABEL Boot fail" >> syslinux.cfg' >> init && \
  echo 'echo "  MENU LABEL fail" >> syslinux.cfg' >> init && \
  echo 'echo "  localboot -1" >> syslinux.cfg' >> init && \
  echo 'echo >> syslinux.cfg' >> init && \
  echo 'echo "LABEL Reboot" >> syslinux.cfg' >> init && \
  echo 'echo "  MENU LABEL Reboot" >> syslinux.cfg' >> init && \
  echo 'echo "  COM32 reboot.c32" >> syslinux.cfg' >> init && \
  echo 'echo >> syslinux.cfg' >> init && \
  echo 'echo "LABEL Power off" >> syslinux.cfg' >> init && \
  echo 'echo "  MENU LABEL Power off" >> syslinux.cfg' >> init && \
  echo 'echo "  COM32 poweroff.c32" >> syslinux.cfg' >> init && \
  echo 'echo >> syslinux.cfg' >> init && \
  echo 'echo "MENU SEPARATOR" >> syslinux.cfg' >> init && \
  echo 'cat /tmp/syslinux.cfg | tee -a /mnt/EFI/syslinux/syslinux.cfg' >> init && \
  echo 'mkdir -p -v /mnt/EFI/EFI/BOOT' >> init && \
  echo 'cp -p -v /mnt/EFI/syslinux/syslinux.cfg /mnt/EFI/EFI/BOOT/syslinux.cfg' >> init && \
  echo 'cp -p -v /usr/lib/syslinux/memdisk /mnt/EFI/syslinux/memdisk' >> init && \
  echo 'cp -p -v /usr/lib/SYSLINUX.EFI/efi64/syslinux.efi /mnt/EFI/EFI/BOOT/BOOTx64.EFI' >> init && \
  echo 'cp -p -v /usr/lib/SYSLINUX.EFI/efi32/syslinux.efi /mnt/EFI/EFI/BOOT/BOOTia32.EFI' >> init && \
  echo 'cp -p -v /usr/lib/syslinux/modules/efi64/* /mnt/EFI/EFI/BOOT/' >> init && \
  echo 'cat syslinux.cfg' >> init && \
  echo 'sync' >> init && \
  echo 'cd /root' >> init && \
  echo 'umount -v /mnt/EFI' >> init && \
  echo 'ENTROPY=$( (lsblk -l -p | grep part | cut -f1 -d" " | while read part; do if blkid -s LABEL -s PARTLABEL -o value "${part}" | grep -q "^ENTROPY"; then echo "${part}"; fi; done) |head -n 1)' >> init && \
  echo 'dd if=/dev/urandom of="${ENTROPY}" bs=65536 count=1 2>/dev/null' >> init && \
  echo 'unset ENTROPY' >> init && \
  echo 'EFI=$( (lsblk -l -p | grep part | cut -f1 -d" " | while read part; do if blkid -s LABEL -s PARTLABEL -o value "${part}" | grep -q "^EFI"; then echo "${part}"; fi; done) |head -n 1)' >> init && \
  echo 'mount -v -t vfat "${EFI}" /boot' >> init && \
  echo 'grub-install --target=i386-efi --skip-fs-probe --force --removable --boot-directory=/boot/EFI/BOOT/i386 --bootloader-id=Xen/Linux/i386 --efi-directory=/boot --recheck /dev/hda1 || true' >> init && \
  echo 'sync' >> init && \
  echo 'grub-install --target=x86_64-efi --skip-fs-probe --force --removable --boot-directory=/boot/EFI/BOOT/x86_64 --bootloader-id=Xen/Linux/x86_64 --efi-directory=/boot --recheck /dev/hda1 || true' >> init && \
  echo 'sync' >> init && \
  echo 'umount -v /boot' >> init && \
  echo 'sync' >> init && \
  echo 'udevadm settle' >> init && \
  echo 'udevadm trigger' >> init && \
  echo 'sync' >> init && \
  echo 'sync' >> init && \
  echo 'fsck.vfat -a -v "${EFI}" || true' >> init && \
  echo 'unset EFI' >> init && \
  echo 'sync' >> init && \
  echo 'udevadm settle' >> init && \
  echo 'udevadm trigger' >> init && \
  echo '/etc/init.d/eudev stop' >> init && \
  echo 'umount /sys' >> init && \
  echo 'umount /dev' >> init && \
  echo 'for i in s s u s o o; do echo $i > /proc/sysrq-trigger; sleep 4; sync; done' >> init && \
  chmod 755 init && \
  ln init sbin/init && \
  find . -print0 | sort -z | cpio -0 -H newc --renumber-inodes -o |xz -2 -v -v -C crc32 > /boot/initrd.img && \
  cd /root && \
  rm -r initrd && \
  qemu-img create -f qcow2 /root/disk.qcow2 60G && \
  qemu-img create -f qcow2 /root/scratch.qcow2 8G && \
  qemu-system-x86_64 -m 5g -device virtio-rng-pci -kernel /boot/vmlinuz* -initrd /boot/initrd.img -drive file=disk.qcow2,format=qcow2,index=0 -drive file=/root/drive.tar.gz,format=raw,index=1 -drive file=scratch.qcow2,format=qcow2,index=2 -append "console=ttyS0 init=/init" -nographic && \
  rm -v /boot/initrd.img && \
  rm -v /root/drive.tar.gz && \
  rm -r -f /usr/local && \
  qemu-img convert -c -f qcow2 -O qcow2 disk.qcow2 Linux-Image-Devuan-4-Xen.qcow2 && \
  rm -v disk.qcow2 && \
  rm -v scratch.qcow2 && \
  qemu-img snapshot -c Linux-Image-Devuan-4-Xen Linux-Image-Devuan-4-Xen.qcow2 && \
  qemu-img snapshot -l Linux-Image-Devuan-4-Xen.qcow2 && \
  mv -v /root/kernel/deb /opt/artifact/deb && \
  mv -v /root/kernel/certs /opt/artifact/certs && \
  rm -r /root/kernel /boot && \
  mv -v Linux-Image-Devuan-4-Xen.qcow2 /opt/artifact && \
  cd / && \
  export PATH=/sbin:/bin:/usr/sbin:/usr/bin && \
  rm -r -f /usr/share/doc /usr/share/man && \
  mkdir -v -p /opt/artifact/archives && \
  mv -v /root/archives-devuan.gtar.gz /root/extended-devuan.gtar.gz /root/archives-kicksecure.gtar.gz /opt/artifact/archives/ && \
  mv -v /root/kicksecure-lists-key.gtar.xz /opt/artifact/meta/ && \
  find /opt/artifact -ls && \
  true
